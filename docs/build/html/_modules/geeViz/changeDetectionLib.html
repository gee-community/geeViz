<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>geeViz.changeDetectionLib - geeViz &#34;2024.11.2&#34; docs</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/style/custom.css?v=ebb50e13" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #00897b;
  --color-brand-content: #00897b;
  --font-stack: Roboto, sans-serif;
  --font-stack--monospace: Courier, monospace;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  --color-brand-primary: #00bfa5;
  --color-brand-content: #00bfa5;
  --font-stack: Roboto, sans-serif;
  --font-stack--monospace: Courier, monospace;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  --color-brand-primary: #00bfa5;
  --color-brand-content: #00bfa5;
  --font-stack: Roboto, sans-serif;
  --font-stack--monospace: Courier, monospace;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     <i>geeViz</i> docs are still in development 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">geeViz "2024.11.2" docs</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/RCR-logo.jpg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">geeViz "2024.11.2" docs</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../overview.html">Overview</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Overview</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.geeView.html">geeViz.geeView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.getImagesLib.html">geeViz.getImagesLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.changeDetectionLib.html">geeViz.changeDetectionLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.taskManagerLib.html">geeViz.taskManagerLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.assetManagerLib.html">geeViz.assetManagerLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.cloudStorageManagerLib.html">geeViz.cloudStorageManagerLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.gee2Pandas.html">geeViz.gee2Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.foliumView.html">geeViz.foliumView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.phEEnoViz.html">geeViz.phEEnoViz</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Details</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/geeViewExampleNotebook.html">Starter geeViz geeView Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/lcmsViewerExampleNotebook.html">LCMS Viewer Intro Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/Annual_NLCD_Viewer_Notebook.html">Annual NLCD <code class="docutils literal notranslate"><span class="pre">geeViz</span></code> Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/mapBiomasViewerExampleNotebook.html">Visualizing MapBiomas Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/dynamicWorldExampleNotebook.html">Visualizing Dynamic World</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/global_land_cover_example_notebook.html">Visualizing Global Land Cover</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/LCMAP_and_LCMS_Viewer_Notebook.html">LCMAP and LCMS Outputs Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/getLandsatWrapperNotebook.html">Create High Quality Landsat Composites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/areaChart_examples.html">Visualizing Area Summaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/geeViz_geeMap_comparison_tutorial.html">A comparison between geeViz and geeMap’s map visualization capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/LANDTRENDRWrapperNotebook.html">Run LandTrendr and Visualize Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/LCMAP_and_LCMS_Viewer_Notebook.html">LCMAP and LCMS Outputs Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/CCDCVizNotebook.html">CCDC Visualization Notebook</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for geeViz.changeDetectionLib</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Apply change detection methods usin GEE</span>

<span class="sd">geeViz.changeDetectionLib is the core module for setting up various change detection algorithms within GEE. Notably, it facilitates the use of LandTrendr and CCDC data preparation, application, and output formatting, compression, and decompression. </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Copyright 2024 Ian Housman, Leah Campbell, Josh Heyer</span>

<span class="sd">   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">   you may not use this file except in compliance with the License.</span>
<span class="sd">   You may obtain a copy of the License at</span>

<span class="sd">       http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">   Unless required by applicable law or agreed to in writing, software</span>
<span class="sd">   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="sd">   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="sd">   See the License for the specific language governing permissions and</span>
<span class="sd">   limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Script to help with basic change detection</span>
<span class="c1"># Intended to work within the geeViz package</span>
<span class="c1">######################################################################</span>
<span class="c1"># Adapted from changeDetectionLib.js</span>

<span class="kn">from</span> <span class="nn">geeViz.getImagesLib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">ee</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1">#             Image and array manipulation</span>
<span class="c1"># ------------------------------------------------------------------------</span>
<span class="n">lossYearPalette</span> <span class="o">=</span> <span class="s2">&quot;ffffe5,fff7bc,fee391,fec44f,fe9929,ec7014,cc4c02&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">lossMagPalette</span> <span class="o">=</span> <span class="s2">&quot;D00,F5DEB3&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">gainYearPalette</span> <span class="o">=</span> <span class="s2">&quot;c5ee93,00a398&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">gainMagPalette</span> <span class="o">=</span> <span class="s2">&quot;F5DEB3,006400&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">changeDurationPalette</span> <span class="o">=</span> <span class="s2">&quot;BD1600,E2F400,0C2780&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>


<span class="c1">######################################################################</span>
<span class="c1"># Helper to multiply image</span>
<span class="k">def</span> <span class="nf">multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">distDir</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">distDir</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">by</span><span class="p">))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1">######################################################################</span>
<span class="c1"># Default run params for LandTrendr</span>
<span class="n">default_lt_run_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;maxSegments&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;spikeThreshold&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="s2">&quot;vertexCountOvershoot&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;preventOneYearRecovery&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;recoveryThreshold&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="s2">&quot;pvalThreshold&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="s2">&quot;bestModelProportion&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="s2">&quot;minObservationsNeeded&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1">######################################################################</span>
<span class="c1"># Helper to multiply new baselearner format values (LandTrendr &amp; Verdet) by the appropriate amount when importing</span>
<span class="c1"># Duration is the only band that does not get multiplied by 0.0001 upon import.</span>
<span class="k">def</span> <span class="nf">LT_VT_multBands</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_fitted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_slope&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_diff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_mag&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_dur&quot;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">dur</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">addToImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">howMuch</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">howMuch</span><span class="p">))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Used when masking out pixels that don&#39;t have sufficient data for Landtrendr and Verdet</span>
<span class="k">def</span> <span class="nf">nullFinder</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">countMask</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span>
    <span class="c1"># Allow areas with insufficient data to be included, but then set to a dummy value for later masking</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">countMask</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">countMask</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>


<span class="c1"># Function to convert an image array object to collection</span>
<span class="k">def</span> <span class="nf">arrayToTimeSeries</span><span class="p">(</span><span class="n">tsArray</span><span class="p">,</span> <span class="n">yearsArray</span><span class="p">,</span> <span class="n">possibleYears</span><span class="p">,</span> <span class="n">bandName</span><span class="p">):</span>
    <span class="c1"># Set up dummy image for handling null values</span>
    <span class="n">noDateValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span>
    <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">noDateValue</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>

    <span class="c1"># Iterate across years</span>
    <span class="k">def</span> <span class="nf">applyMasks</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>

        <span class="c1"># Pull out given year</span>
        <span class="n">yrMask</span> <span class="o">=</span> <span class="n">yearsArray</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>

        <span class="c1"># Mask array for that given year</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="n">tsArray</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">yrMask</span><span class="p">)</span>

        <span class="c1"># Find null pixels</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">masked</span><span class="o">.</span><span class="n">arrayLength</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Fill null values and convert to regular image</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="n">masked</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dummyImage</span><span class="p">)</span><span class="o">.</span><span class="n">arrayGet</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Remask nulls</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="n">masked</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">masked</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">noDateValue</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="n">bandName</span><span class="p">])</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">masked</span>

    <span class="n">tsC</span> <span class="o">=</span> <span class="n">possibleYears</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">applyMasks</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">tsC</span><span class="p">)</span>


<span class="c1">#########################################################################################################</span>
<span class="c1">###### GREATEST DISTURBANCE EXTRACTION FUNCTIONS #####</span>
<span class="c1">#########################################################################################################</span>


<span class="c1"># ----- function to extract greatest disturbance based on spectral delta between vertices</span>
<span class="k">def</span> <span class="nf">extractDisturbance</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">distDir</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mmu</span><span class="p">):</span>
    <span class="c1"># select only the vertices that represents a change</span>
    <span class="n">vertexMask</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># get the vertex - yes(1)/no(0) dimension</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">vertexMask</span><span class="p">)</span>  <span class="c1"># convert the 0&#39;s to masked</span>

    <span class="c1"># numberOfVertices = vertexMask.arrayReduce(ee.Reducer.sum(),[1]).arrayProject([1]).arrayFlatten([[&#39;vertexCount&#39;]])</span>
    <span class="c1"># secondMask = numberOfVertices.gte(3)</span>
    <span class="c1"># thirdMask = numberOfVertices.gte(4)</span>
    <span class="c1"># Map.addLayer(numberOfVertices,{min:2,max:4},&#39;number of vertices&#39;,false)</span>
    <span class="c1"># construct segment start and end point years and index values</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># slice out the vertices as the start of segments</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># slice out the vertices as the end of segments</span>
    <span class="n">startYear</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># get year dimension of LT data from the segment start vertices</span>
    <span class="n">startVal</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># get spectral index dimension of LT data from the segment start vertices</span>
    <span class="n">endYear</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># get year dimension of LT data from the segment end vertices</span>
    <span class="n">endVal</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># get spectral index dimension of LT data from the segment end vertices</span>

    <span class="n">dur</span> <span class="o">=</span> <span class="n">endYear</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span>  <span class="c1"># subtract the segment start year from the segment end year to calculate the duration of segments</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">endVal</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">startVal</span><span class="p">)</span>  <span class="c1"># substract the segment start index value from the segment end index value to calculate the delta of segments</span>

    <span class="c1"># concatenate segment start year, delta, duration, and starting spectral index value to an array</span>
    <span class="n">distImg</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">startYear</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mag</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">startVal</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span>
        <span class="mi">0</span>
    <span class="p">)</span>  <span class="c1"># make an image of segment attributes - multiply by the distDir parameter to re-orient the spectral index if it was flipped for segmentation - do it here so that the subtraction to calculate segment delta in the above line is consistent - add 1 to the detection year, because the vertex year is not the first year that change is detected, it is the following year</span>

    <span class="c1"># sort the segments in the disturbance attribute image delta by spectral index change delta</span>
    <span class="n">distImgSorted</span> <span class="o">=</span> <span class="n">distImg</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">mag</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># slice out the first (greatest) delta</span>
    <span class="n">tempDistImg1</span> <span class="o">=</span> <span class="n">distImgSorted</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])))</span>
    <span class="n">tempDistImg2</span> <span class="o">=</span> <span class="n">distImgSorted</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])))</span>
    <span class="n">tempDistImg3</span> <span class="o">=</span> <span class="n">distImgSorted</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])))</span>

    <span class="c1"># make an image from the array of attributes for the greatest disturbance</span>
    <span class="n">finalDistImg1</span> <span class="o">=</span> <span class="n">tempDistImg1</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;yod&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="s2">&quot;preval&quot;</span><span class="p">]])</span>
    <span class="n">finalDistImg2</span> <span class="o">=</span> <span class="n">tempDistImg2</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;yod&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="s2">&quot;preval&quot;</span><span class="p">]])</span>
    <span class="n">finalDistImg3</span> <span class="o">=</span> <span class="n">tempDistImg3</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;yod&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="s2">&quot;preval&quot;</span><span class="p">]])</span>

    <span class="c1"># filter out disturbances based on user settings</span>
    <span class="k">def</span> <span class="nf">filterDisturbances</span><span class="p">(</span><span class="n">finalDistImg</span><span class="p">):</span>
        <span class="c1"># threshold = ee.Image(finalDistImg.select([&#39;dur&#39;]))                        # get the disturbance band out to apply duration dynamic disturbance magnitude threshold</span>
        <span class="c1">#       .multiply((params.tree_loss20 - params.tree_loss1) / 19.0)  # ...</span>
        <span class="c1">#       .add(params.tree_loss1)                                     #    ...interpolate the magnitude threshold over years between a 1-year mag thresh and a 20-year mag thresh</span>
        <span class="c1">#       .lte(finalDistImg.select([&#39;mag&#39;]))                          # ...is disturbance less then equal to the interpolated, duration dynamic disturbance magnitude threshold</span>
        <span class="c1">#       .and(finalDistImg.select([&#39;mag&#39;]).gt(0))                    # and is greater than 0</span>
        <span class="c1">#       .and(finalDistImg.select([&#39;preval&#39;]).gt(params.pre_val))</span>
        <span class="n">longTermDisturbance</span> <span class="o">=</span> <span class="n">finalDistImg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;dur&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">longTermThreshold</span> <span class="o">=</span> <span class="n">finalDistImg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;mag&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;tree_loss20&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">longTermDisturbance</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">finalDistImg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;mag&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;tree_loss1&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">finalDistImg</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">threshold</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">longTermThreshold</span><span class="p">))</span>

    <span class="n">finalDistImg1</span> <span class="o">=</span> <span class="n">filterDisturbances</span><span class="p">(</span><span class="n">finalDistImg1</span><span class="p">)</span>
    <span class="n">finalDistImg2</span> <span class="o">=</span> <span class="n">filterDisturbances</span><span class="p">(</span><span class="n">finalDistImg2</span><span class="p">)</span>
    <span class="n">finalDistImg3</span> <span class="o">=</span> <span class="n">filterDisturbances</span><span class="p">(</span><span class="n">finalDistImg3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">applyMMU</span><span class="p">(</span><span class="n">finalDistImg</span><span class="p">):</span>
        <span class="c1"># patchify based on disturbances having the same year of detection</span>
        <span class="c1"># count the number of pixel in a candidate patch</span>
        <span class="n">mmuPatches</span> <span class="o">=</span> <span class="n">finalDistImg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;yod.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">connectedPixelCount</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">mmu</span><span class="p">)</span>  <span class="c1"># are the the number of pixels per candidate patch greater than user-defined minimum mapping unit?</span>
        <span class="k">return</span> <span class="n">finalDistImg</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mmuPatches</span><span class="p">)</span>  <span class="c1"># mask the pixels/patches that are less than minimum mapping unit</span>

    <span class="c1"># patchify the remaining disturbance pixels using a minimum mapping unit</span>
    <span class="k">if</span> <span class="n">mmu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying mmu:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mmu</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to LANDTRENDR heuristic outputs&quot;</span><span class="p">)</span>

        <span class="n">finalDistImg1</span> <span class="o">=</span> <span class="n">applyMMU</span><span class="p">(</span><span class="n">finalDistImg1</span><span class="p">)</span>
        <span class="n">finalDistImg2</span> <span class="o">=</span> <span class="n">applyMMU</span><span class="p">(</span><span class="n">finalDistImg2</span><span class="p">)</span>
        <span class="n">finalDistImg3</span> <span class="o">=</span> <span class="n">applyMMU</span><span class="p">(</span><span class="n">finalDistImg3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">finalDistImg1</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">finalDistImg2</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">finalDistImg3</span><span class="p">)</span>  <span class="c1"># return the filtered greatest disturbance attribute image</span>


<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1">#             LandTrendr Code</span>
<span class="c1"># ------------------------------------------------------------------------</span>
<span class="c1"># Landtrendr code taken from users/emaprlab/public</span>
<span class="c1">###### UNPACKING LT-GEE OUTPUT STRUCTURE FUNCTIONS #####</span>


<span class="c1"># ----- FUNCTION TO EXTRACT VERTICES FROM LT RESULTS AND STACK BANDS -----</span>
<span class="k">def</span> <span class="nf">getLTvertStack</span><span class="p">(</span><span class="n">LTresult</span><span class="p">,</span> <span class="n">run_params</span><span class="p">):</span>
    <span class="n">emptyArray</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># make empty array to hold another array whose length will vary depending on maxSegments parameter</span>
    <span class="n">vertLabels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># make empty array to hold band names whose length will vary depending on maxSegments parameter</span>
    <span class="c1"># iString                                      # initialize variable to hold vertex number</span>
    <span class="c1"># loop through the maximum number of vertices in segmentation and fill empty arrays:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;maxSegments&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">vertLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;vert_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  <span class="c1"># define vertex number as string, make a band name for given vertex</span>
        <span class="n">emptyArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fill in emptyArray</span>

    <span class="n">zeros</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">emptyArray</span><span class="p">,</span>  <span class="c1"># make an image to fill holes in result &#39;LandTrendr&#39; array where vertices found is not equal to maxSegments parameter plus 1</span>
                <span class="n">emptyArray</span><span class="p">,</span>
                <span class="n">emptyArray</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;yrs_&quot;</span><span class="p">,</span> <span class="s2">&quot;src_&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_&quot;</span><span class="p">],</span>
        <span class="n">vertLabels</span><span class="p">,</span>
    <span class="p">]</span>  <span class="c1"># labels for 2 dimensions of the array that will be cast to each other in the final step of creating the vertice output</span>

    <span class="n">vmask</span> <span class="o">=</span> <span class="n">LTresult</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
    <span class="p">)</span>  <span class="c1"># slices out the 4th row of a 4 row x N col (N = number of years in annual stack) matrix, which identifies vertices - contains only 0s and 1s, where 1 is a vertex (referring to spectral-temporal segmentation) year and 0 is not</span>

    <span class="c1"># Line by line comments taken from call below</span>
    <span class="c1"># .arrayMask uses the sliced out isVert row as a mask to only include vertice in this data - after this a pixel will only contain as many &quot;bands&quot; are there are vertices for that pixel - min of 2 to max of 7.</span>
    <span class="c1"># .arraySlice()...from the vertOnly data subset slice out the vert year row, raw spectral row, and fitted spectral row</span>
    <span class="c1"># .addBands() # ...adds the 3 row x 7 col &#39;zeros&#39; matrix as a band to the vertOnly array - this is an intermediate step to the goal of filling in the vertOnly data so that there are 7 vertice slots represented in the data - right now there is a mix of lengths from 2 to 7</span>
    <span class="c1"># .toArray() # ...concatenates the 3 row x 7 col &#39;zeros&#39; matrix band to the vertOnly data so that there are at least 7 vertice slots represented - in most cases there are now &gt; 7 slots filled but those will be truncated in the next step</span>
    <span class="c1"># .arraySlice()...before this line runs the array has 3 rows and between 9 and 14 cols depending on how many vertices were found during segmentation for a given pixel. this step truncates the cols at 7 (the max verts allowed) so we are left with a 3 row X 7 col array</span>
    <span class="c1"># .arrayFlatten()...this takes the 2-d array and makes it 1-d by stacking the unique sets of rows and cols into bands. there will be 7 bands (vertices) for vertYear, followed by 7 bands (vertices) for rawVert, followed by 7 bands (vertices) for fittedVert, according to the &#39;lbls&#39; list</span>
    <span class="n">ltVertStack</span> <span class="o">=</span> <span class="n">LTresult</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">vmask</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;maxSegments&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">(</span><span class="n">lbls</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ltVertStack</span>  <span class="c1"># return the stack</span>


<span class="c1"># Adapted version for converting sorted array to image</span>
<span class="k">def</span> <span class="nf">getLTStack</span><span class="p">(</span><span class="n">LTresult</span><span class="p">,</span> <span class="n">maxVertices</span><span class="p">,</span> <span class="n">bandNames</span><span class="p">):</span>

    <span class="n">nBands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span>
    <span class="n">emptyArray</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># make empty array to hold another array whose length will vary depending on maxSegments parameter</span>
    <span class="n">vertLabels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># make empty array to hold band names whose length will vary depending on maxSegments parameter</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxVertices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># loop through the maximum number of vertices in segmentation and fill empty arrays</span>
        <span class="n">vertLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  <span class="c1"># make a band name for given vertex</span>
        <span class="n">emptyArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">)</span>  <span class="c1"># fill in emptyArray</span>

    <span class="c1"># Set up empty array list</span>
    <span class="n">emptyArrayList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nBands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">emptyArrayList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emptyArray</span><span class="p">)</span>

    <span class="n">zeros</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">emptyArrayList</span><span class="p">))</span>  <span class="c1"># make an image to fill holes in result &#39;LandTrendr&#39; array where vertices found is not equal to maxSegments parameter plus 1</span>

    <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">bandNames</span><span class="p">,</span>
        <span class="n">vertLabels</span><span class="p">,</span>
    <span class="p">]</span>  <span class="c1"># labels for 2 dimensions of the array that will be cast to each other in the final step of creating the vertice output</span>

    <span class="c1"># slices out the 4th row of a 4 row x N col (N = number of years in annual stack) matrix, which identifies vertices - contains only 0s and 1s, where 1 is a vertex (referring to spectral-temporal segmentation) year and 0 is not</span>

    <span class="n">ltVertStack</span> <span class="o">=</span> <span class="n">LTresult</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxVertices</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">(</span><span class="n">lbls</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># Line by line comments taken from call above</span>
    <span class="c1"># LTresult:                       # uses the sliced out isVert row as a mask to only include vertice in this data - after this a pixel will only contain as many &quot;bands&quot; are there are vertices for that pixel - min of 2 to max of 7.</span>
    <span class="c1"># .addBands(zeros):               # ...adds the 3 row x 7 col &#39;zeros&#39; matrix as a band to the vertOnly array - this is an intermediate step to the goal of filling in the vertOnly data so that there are 7 vertice slots represented in the data - right now there is a mix of lengths from 2 to 7</span>
    <span class="c1"># .toArray(1):                    # ...concatenates the 3 row x 7 col &#39;zeros&#39; matrix band to the vertOnly data so that there are at least 7 vertice slots represented - in most cases there are now &gt; 7 slots filled but those will be truncated in the next step</span>
    <span class="c1"># .arraySlice(1, 0, maxVertices): # ...before this line runs the array has 3 rows and between 9 and 14 cols depending on how many vertices were found during segmentation for a given pixel. this step truncates the cols at 7 (the max verts allowed) so we are left with a 3 row X 7 col array</span>
    <span class="c1"># .arrayFlatten(lbls, &#39;&#39;):        # ...this takes the 2-d array and makes it 1-d by stacking the unique sets of rows and cols into bands. there will be 7 bands (vertices) for vertYear, followed by 7 bands (vertices) for rawVert, followed by 7 bands (vertices) for fittedVert, according to the &#39;lbls&#39; list</span>
    <span class="k">return</span> <span class="n">ltVertStack</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ltVertStack</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">))</span>


<span class="c1">############################################################################################################</span>
<span class="c1"># Function to remove non vertex info from raw image array format from LandTrendr.</span>
<span class="c1"># E.g. if an output is [1985,1990,2020],[500,450,320],[500,510,320],[1,0,1], the output will be [1985,2020],[500,320]</span>
<span class="c1"># This is the equivalent to the vert stack functions by keeps outputs in image array format</span>
<span class="k">def</span> <span class="nf">rawLTToVertices</span><span class="p">(</span><span class="n">rawLT</span><span class="p">,</span> <span class="n">indexName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multBy</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">vertexNoData</span><span class="o">=-</span><span class="mi">32768</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">indexName</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">distDir</span> <span class="o">=</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">distDir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">distDir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;LandTrendr&quot;</span><span class="p">])</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;rmse&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
    <span class="n">minObservationsNeededMask</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">vertexNoData</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;test&quot;</span><span class="p">]])</span>

    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])))</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arrayLength</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">multImg</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">distDir</span> <span class="o">*</span> <span class="n">multBy</span><span class="p">]]))</span><span class="o">.</span><span class="n">arrayRepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multImg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">minObservationsNeededMask</span><span class="p">)</span>


<span class="c1">############################################################################################################</span>
<span class="c1"># Function to wrap landtrendr processing</span>
<span class="k">def</span> <span class="nf">landtrendrWrapper</span><span class="p">(</span>
    <span class="n">processedComposites</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">indexName</span><span class="p">,</span>
    <span class="n">distDir</span><span class="p">,</span>
    <span class="n">run_params</span><span class="p">,</span>
    <span class="n">distParams</span><span class="p">,</span>
    <span class="n">mmu</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># startYear = 1984#ee.Date(ee.Image(processedComposites.first()).get(&#39;system:time_start&#39;)).get(&#39;year&#39;).getInfo()</span>
    <span class="c1"># endYear = 2017#ee.Date(ee.Image(processedComposites.sort(&#39;system:time_start&#39;,false).first()).get(&#39;system:time_start&#39;)).get(&#39;year&#39;).getInfo()</span>
    <span class="n">noDataValue</span> <span class="o">=</span> <span class="mi">32768</span>
    <span class="k">if</span> <span class="n">distDir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">noDataValue</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">noDataValue</span>

    <span class="c1"># ----- RUN LANDTRENDR -----</span>
    <span class="n">ltCollection</span> <span class="o">=</span> <span class="n">processedComposites</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">distDir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>  <span class="c1"># .unmask(noDataValue)</span>

    <span class="c1"># Map.addLayer(ltCollection,{},&#39;ltCollection&#39;,false)</span>
    <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltCollection</span>  <span class="c1"># add LT collection to the segmentation run parameter object</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">TemporalSegmentation</span><span class="o">.</span><span class="n">LandTrendr</span><span class="p">(</span><span class="o">**</span><span class="n">run_params</span><span class="p">)</span>  <span class="c1"># run LandTrendr spectral temporal segmentation algorithm</span>

    <span class="c1">#########################################################################################################</span>
    <span class="c1">###### RUN THE GREATEST DISTURBANCE EXTRACT FUNCTION #####</span>
    <span class="c1">#########################################################################################################</span>

    <span class="c1"># run the dist extract function</span>
    <span class="n">distImg</span> <span class="o">=</span> <span class="n">extractDisturbance</span><span class="p">(</span><span class="n">lt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;LandTrendr&quot;</span><span class="p">),</span> <span class="n">distDir</span><span class="p">,</span> <span class="n">distParams</span><span class="p">,</span> <span class="n">mmu</span><span class="p">)</span>
    <span class="n">distImgBandNames</span> <span class="o">=</span> <span class="n">distImg</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">distImgBandNames</span> <span class="o">=</span> <span class="n">distImgBandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">bn</span><span class="p">))</span>
    <span class="n">distImg</span> <span class="o">=</span> <span class="n">distImg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">distImgBandNames</span><span class="p">)</span>

    <span class="c1"># Convert to collection</span>
    <span class="n">rawLT</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ltYear</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ltFitted</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">distDir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">ltFitted</span> <span class="o">=</span> <span class="n">ltFitted</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">fittedCollection</span> <span class="o">=</span> <span class="n">arrayToTimeSeries</span><span class="p">(</span><span class="n">ltFitted</span><span class="p">,</span> <span class="n">ltYear</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">),</span> <span class="s2">&quot;LT_Fitted_&quot;</span> <span class="o">+</span> <span class="n">indexName</span><span class="p">)</span>

    <span class="c1"># Convert to single image</span>
    <span class="n">vertStack</span> <span class="o">=</span> <span class="n">getLTvertStack</span><span class="p">(</span><span class="n">rawLT</span><span class="p">,</span> <span class="n">run_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lt</span><span class="p">,</span> <span class="n">distImg</span><span class="p">,</span> <span class="n">fittedCollection</span><span class="p">,</span> <span class="n">vertStack</span><span class="p">]</span>


<span class="c1">#########################################################################################################</span>
<span class="c1">#########################################################################################################</span>
<span class="c1"># Function to join raw time series with fitted time series from LANDTRENDR</span>
<span class="c1"># Takes the rawTs as an imageCollection, lt is the first band of the output from LANDTRENDR, and the distDir</span>
<span class="c1"># is the direction of change for a loss in vegeation for the chosen band/index</span>
<span class="k">def</span> <span class="nf">getRawAndFittedLT</span><span class="p">(</span><span class="n">rawTs</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">indexName</span><span class="o">=</span><span class="s2">&quot;Band&quot;</span><span class="p">,</span> <span class="n">distDir</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>

    <span class="c1"># Pop off years and fitted values</span>
    <span class="n">ltYear</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ltFitted</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Flip fitted values if needed</span>
    <span class="k">if</span> <span class="n">distDir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">ltFitted</span> <span class="o">=</span> <span class="n">ltFitted</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Convert array to an imageCollection</span>
    <span class="n">fittedCollection</span> <span class="o">=</span> <span class="n">arrayToTimeSeries</span><span class="p">(</span><span class="n">ltFitted</span><span class="p">,</span> <span class="n">ltYear</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">),</span> <span class="s2">&quot;LT_Fitted_&quot;</span> <span class="o">+</span> <span class="n">indexName</span><span class="p">)</span>

    <span class="c1"># Join raw time series with fitted</span>
    <span class="n">joinedTS</span> <span class="o">=</span> <span class="n">joinCollections</span><span class="p">(</span><span class="n">rawTs</span><span class="p">,</span> <span class="n">fittedCollection</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">joinedTS</span>


<span class="c1">#########################################################################################################</span>
<span class="c1"># 2023 rework to run LT in its most simple form</span>
<span class="c1"># Gets rid of handling :</span>
<span class="c1">#   Insufficient obs counts, no data handling,</span>
<span class="c1">#   Exporting of band stack format (assumes image array format for output)</span>


<span class="c1"># Function to mask out the non vertex and original values</span>
<span class="c1"># Simplified version of rawLTToVertices</span>
<span class="k">def</span> <span class="nf">simpleRawLTToVertices</span><span class="p">(</span><span class="n">rawLT</span><span class="p">):</span>
    <span class="c1"># Pull off rmse</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;rmse&quot;</span><span class="p">])</span>
    <span class="c1"># Mask out non vertex values to use less storage space</span>
    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;LandTrendr&quot;</span><span class="p">])</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>

    <span class="c1"># Mask out all but the year and vertex fited values (get rid of the raw and vertex rows)</span>
    <span class="k">return</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>


<span class="c1">###########################################################</span>
<span class="c1"># Function to multiply the LandTrendr RMSE and vertex array</span>
<span class="c1"># Assumes LTMaskNonVertices has already been run</span>
<span class="k">def</span> <span class="nf">multLT</span><span class="p">(</span><span class="n">rawLT</span><span class="p">,</span> <span class="n">multBy</span><span class="p">):</span>
    <span class="c1"># Pull off rmse</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;rmse&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="c1"># Ensure only the LandTrendr array output</span>
    <span class="n">ltArray</span> <span class="o">=</span> <span class="n">rawLT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;LandTrendr&quot;</span><span class="p">])</span>
    <span class="c1"># Form an image to multiply by</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">arrayLength</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">multImg</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">multBy</span><span class="p">]]))</span><span class="o">.</span><span class="n">arrayRepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ltArray</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multImg</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>


<span class="c1">###########################################################</span>
<span class="c1"># Function to simplify LandTrendr output for exporting</span>
<span class="k">def</span> <span class="nf">LTExportPrep</span><span class="p">(</span><span class="n">rawLT</span><span class="p">,</span> <span class="n">multBy</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">rawLT</span> <span class="o">=</span> <span class="n">simpleRawLTToVertices</span><span class="p">(</span><span class="n">rawLT</span><span class="p">)</span>
    <span class="n">rawLT</span> <span class="o">=</span> <span class="n">multLT</span><span class="p">(</span><span class="n">rawLT</span><span class="p">,</span> <span class="n">multBy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rawLT</span>


<span class="c1">###########################################################</span>
<span class="c1"># New function 11/23 to simplify running of LandTrendr</span>
<span class="c1"># and prepping outputs for export</span>
<span class="k">def</span> <span class="nf">runLANDTRENDR</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">bandName</span><span class="p">,</span> <span class="n">run_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Get single band time series and set its direction so that a loss in veg/moisture is going up</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bandName</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">distDir</span> <span class="o">=</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">bandName</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">distDir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">distDir</span><span class="p">))</span>

    <span class="c1"># Set up run params</span>
    <span class="k">if</span> <span class="n">run_params</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_params</span> <span class="o">=</span> <span class="n">default_lt_run_params</span>
    <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>

    <span class="c1"># Run LANDTRENDR</span>
    <span class="n">rawLT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">TemporalSegmentation</span><span class="o">.</span><span class="n">LandTrendr</span><span class="p">(</span><span class="o">**</span><span class="n">run_params</span><span class="p">)</span>

    <span class="c1"># Get vertex-only fitted values and multiply the fitted values</span>
    <span class="k">return</span> <span class="n">LTExportPrep</span><span class="p">(</span><span class="n">rawLT</span><span class="p">,</span> <span class="n">distDir</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">bandName</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;run_params&quot;</span><span class="p">,</span> <span class="n">run_params</span><span class="p">)</span>


<span class="c1">###########################################################</span>
<span class="c1"># Pulled from simpleLANDTRENDR below to take the lossGain dictionary and prep it for export</span>
<span class="k">def</span> <span class="nf">LTLossGainExportPrep</span><span class="p">(</span><span class="n">lossGainDict</span><span class="p">,</span> <span class="n">indexName</span><span class="o">=</span><span class="s2">&quot;Bn&quot;</span><span class="p">,</span> <span class="n">multBy</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">lossStack</span> <span class="o">=</span> <span class="n">lossGainDict</span><span class="p">[</span><span class="s2">&quot;lossStack&quot;</span><span class="p">]</span>
    <span class="n">gainStack</span> <span class="o">=</span> <span class="n">lossGainDict</span><span class="p">[</span><span class="s2">&quot;gainStack&quot;</span><span class="p">]</span>

    <span class="c1"># Convert to byte/int16 if possible to save space</span>
    <span class="n">lossThematic</span> <span class="o">=</span> <span class="n">lossStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_yr_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">lossStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_dur_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">byte</span><span class="p">())</span>
    <span class="n">lossContinuous</span> <span class="o">=</span> <span class="n">lossStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_mag_.*&quot;</span><span class="p">,</span> <span class="s2">&quot;.*_slope_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">lossContinuous</span> <span class="o">=</span> <span class="n">lossContinuous</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

    <span class="n">lossStack</span> <span class="o">=</span> <span class="n">lossThematic</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">lossContinuous</span><span class="p">)</span>

    <span class="n">gainThematic</span> <span class="o">=</span> <span class="n">gainStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_yr_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">gainStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_dur_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">byte</span><span class="p">())</span>
    <span class="n">gainContinuous</span> <span class="o">=</span> <span class="n">gainStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_mag_.*&quot;</span><span class="p">,</span> <span class="s2">&quot;.*_slope_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">gainContinuous</span> <span class="o">=</span> <span class="n">gainContinuous</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

    <span class="n">gainStack</span> <span class="o">=</span> <span class="n">gainThematic</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">gainContinuous</span><span class="p">)</span>
    <span class="n">outStack</span> <span class="o">=</span> <span class="n">lossStack</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">gainStack</span><span class="p">)</span>

    <span class="c1"># Add indexName to bandnames</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">outStack</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">outBns</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_LT_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">bn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">outStack</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outBns</span><span class="p">)</span>


<span class="c1">###########################################################</span>
<span class="c1"># Pulled from simpleLANDTRENDR below to take prepped (must run LTLossGainExportPrep first) lossGain stack and view it</span>
<span class="k">def</span> <span class="nf">addLossGainToMap</span><span class="p">(</span>
    <span class="n">lossGainStack</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">lossMagMin</span><span class="o">=-</span><span class="mi">8000</span><span class="p">,</span>
    <span class="n">lossMagMax</span><span class="o">=-</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">gainMagMin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">gainMagMax</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
    <span class="n">indexName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">howManyToPull</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">indexName</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">howManyToPull</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bns</span> <span class="o">=</span> <span class="n">lossGainStack</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
        <span class="n">indexName</span> <span class="o">=</span> <span class="n">bns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">howManyToPull</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">bns</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">howManyToPull</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">howManyToPull</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Set up viz params</span>
    <span class="n">vizParamsLossYear</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">startYear</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">lossYearPalette</span><span class="p">}</span>
    <span class="n">vizParamsLossMag</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">lossMagMin</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">lossMagMax</span><span class="p">,</span> <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">lossMagPalette</span><span class="p">}</span>

    <span class="n">vizParamsGainYear</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">startYear</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">gainYearPalette</span><span class="p">}</span>
    <span class="n">vizParamsGainMag</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">gainMagMin</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">gainMagMax</span><span class="p">,</span> <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">gainMagPalette</span><span class="p">}</span>

    <span class="n">vizParamsDuration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;legendLabelLeftAfter&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span>
        <span class="s2">&quot;legendLabelRightAfter&quot;</span><span class="p">:</span> <span class="s2">&quot;years&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">changeDurationPalette</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">howManyToPull</span><span class="p">:</span>

        <span class="n">lossStackI</span> <span class="o">=</span> <span class="n">lossGainStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_loss_.*_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
        <span class="n">lossStackYrMaskI</span> <span class="o">=</span> <span class="n">lossStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_loss_yr.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">lossStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_loss_yr.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">endYear</span><span class="p">))</span>
        <span class="n">lossStackI</span> <span class="o">=</span> <span class="n">lossStackI</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">lossStackYrMaskI</span><span class="p">)</span>

        <span class="n">gainStackI</span> <span class="o">=</span> <span class="n">lossGainStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_gain_.*_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
        <span class="n">gainStackYrMaskI</span> <span class="o">=</span> <span class="n">gainStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_gain_yr.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">gainStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_gain_yr.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">endYear</span><span class="p">))</span>
        <span class="n">gainStackI</span> <span class="o">=</span> <span class="n">gainStackI</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">gainStackYrMaskI</span><span class="p">)</span>

        <span class="n">showLossYear</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">showLossYear</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">iString</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="n">howManyToPull</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">iString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">lossStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_loss_yr.*&quot;</span><span class="p">]),</span>
            <span class="n">vizParamsLossYear</span><span class="p">,</span>
            <span class="s2">&quot;LandTrendr &quot;</span> <span class="o">+</span> <span class="n">iString</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot; Loss Year&quot;</span><span class="p">,</span>
            <span class="n">showLossYear</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">lossStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_loss_mag.*&quot;</span><span class="p">]),</span>
            <span class="n">vizParamsLossMag</span><span class="p">,</span>
            <span class="s2">&quot;LandTrendr &quot;</span> <span class="o">+</span> <span class="n">iString</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot; Loss Magnitude&quot;</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">lossStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_loss_dur.*&quot;</span><span class="p">]),</span>
            <span class="n">vizParamsDuration</span><span class="p">,</span>
            <span class="s2">&quot;LandTrendr &quot;</span> <span class="o">+</span> <span class="n">iString</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot; Loss Duration&quot;</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">gainStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_gain_yr.*&quot;</span><span class="p">]),</span>
            <span class="n">vizParamsGainYear</span><span class="p">,</span>
            <span class="s2">&quot;LandTrendr &quot;</span> <span class="o">+</span> <span class="n">iString</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot; Gain Year&quot;</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">gainStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_gain_mag.*&quot;</span><span class="p">]),</span>
            <span class="n">vizParamsGainMag</span><span class="p">,</span>
            <span class="s2">&quot;LandTrendr &quot;</span> <span class="o">+</span> <span class="n">iString</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot; Gain Magnitude&quot;</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">gainStackI</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_gain_dur.*&quot;</span><span class="p">]),</span>
            <span class="n">vizParamsDuration</span><span class="p">,</span>
            <span class="s2">&quot;LandTrendr &quot;</span> <span class="o">+</span> <span class="n">iString</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot; Gain Duration&quot;</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>


<span class="c1">#########################################################################################################</span>
<span class="c1"># Function for running LT, thresholding the segments for both loss and gain, sort them, and convert them to an image stack</span>
<span class="c1"># July 2019 LSC: replaced some parts of workflow with functions in changeDetectionLib</span>
<div class="viewcode-block" id="simpleLANDTRENDR">
<a class="viewcode-back" href="../../modules.html#geeViz.changeDetectionLib.simpleLANDTRENDR">[docs]</a>
<span class="k">def</span> <span class="nf">simpleLANDTRENDR</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">indexName</span><span class="o">=</span><span class="s2">&quot;NBR&quot;</span><span class="p">,</span>
    <span class="n">run_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lossMagThresh</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">lossSlopeThresh</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">gainMagThresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">gainSlopeThresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">slowLossDurationThresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">chooseWhichLoss</span><span class="o">=</span><span class="s2">&quot;largest&quot;</span><span class="p">,</span>
    <span class="n">chooseWhichGain</span><span class="o">=</span><span class="s2">&quot;largest&quot;</span><span class="p">,</span>
    <span class="n">addToMap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">howManyToPull</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">multBy</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes annual time series input data, properly sets it up for LandTrendr, runs LandTrendr, and provides both a compressed vertex-only format output as well as a basic change detection output.</span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">run_params</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_params</span> <span class="o">=</span> <span class="n">default_lt_run_params</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="n">runLANDTRENDR</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">distDir</span> <span class="o">=</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">distDir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">ltTS</span> <span class="o">=</span> <span class="n">simpleLTFit</span><span class="p">(</span>
        <span class="n">lt</span><span class="p">,</span>
        <span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="p">,</span>
        <span class="n">indexName</span><span class="o">=</span><span class="n">indexName</span><span class="p">,</span>
        <span class="n">arrayMode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">maxSegs</span><span class="o">=</span><span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;maxSegments&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">joinedTS</span> <span class="o">=</span> <span class="n">joinCollections</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ltTS</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_LT_fitted&quot;</span><span class="p">]))</span>

    <span class="c1"># Flip the output back around if needed to do change detection</span>
    <span class="n">ltRawPositiveForChange</span> <span class="o">=</span> <span class="n">multLT</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">distDir</span><span class="p">)</span>

    <span class="c1"># Take the LT output and detect change</span>
    <span class="n">lossGainDict</span> <span class="o">=</span> <span class="n">convertToLossGain</span><span class="p">(</span>
        <span class="n">ltRawPositiveForChange</span><span class="p">,</span>
        <span class="s2">&quot;arrayLandTrendr&quot;</span><span class="p">,</span>
        <span class="n">lossMagThresh</span><span class="p">,</span>
        <span class="n">lossSlopeThresh</span><span class="p">,</span>
        <span class="n">gainMagThresh</span><span class="p">,</span>
        <span class="n">gainSlopeThresh</span><span class="p">,</span>
        <span class="n">slowLossDurationThresh</span><span class="p">,</span>
        <span class="n">chooseWhichLoss</span><span class="p">,</span>
        <span class="n">chooseWhichGain</span><span class="p">,</span>
        <span class="n">howManyToPull</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Prep loss gain dictionary into multi-band image ready for exporting</span>
    <span class="n">lossGainStack</span> <span class="o">=</span> <span class="n">LTLossGainExportPrep</span><span class="p">(</span><span class="n">lossGainDict</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">multBy</span><span class="p">)</span>

    <span class="c1"># Add the change outputs to the map if specified to do so</span>
    <span class="k">if</span> <span class="n">addToMap</span><span class="p">:</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span><span class="n">joinedTS</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s2">&quot;Raw and Fitted Time Series&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">addLossGainToMap</span><span class="p">(</span>
            <span class="n">lossGainStack</span><span class="p">,</span>
            <span class="n">startYear</span><span class="p">,</span>
            <span class="n">endYear</span><span class="p">,</span>
            <span class="p">(</span><span class="n">lossMagThresh</span> <span class="o">-</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">*</span> <span class="n">multBy</span><span class="p">,</span>
            <span class="n">lossMagThresh</span> <span class="o">*</span> <span class="n">multBy</span><span class="p">,</span>
            <span class="n">gainMagThresh</span> <span class="o">*</span> <span class="n">multBy</span><span class="p">,</span>
            <span class="p">(</span><span class="n">gainMagThresh</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">*</span> <span class="n">multBy</span><span class="p">,</span>
            <span class="n">indexName</span><span class="p">,</span>
            <span class="n">howManyToPull</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">multLT</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">multBy</span><span class="p">),</span> <span class="n">lossGainStack</span><span class="p">]</span></div>



<span class="c1">#########################################################################################################</span>
<span class="c1">#########################################################################################################</span>
<span class="c1"># Function to prep data following our workflows. Will have to run Landtrendr and convert to stack after.</span>
<span class="k">def</span> <span class="nf">prepTimeSeriesForLandTrendr</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">):</span>
    <span class="n">maxSegments</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;maxSegments&quot;</span><span class="p">])</span>

    <span class="c1"># Get single band time series and set its direction so that a loss in veg is going up</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">indexName</span><span class="p">])</span>
    <span class="n">distDir</span> <span class="o">=</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span>
    <span class="n">tsT</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">distDir</span><span class="p">))</span>

    <span class="c1"># Find areas with insufficient data to run LANDTRENDR</span>
    <span class="n">countMask</span> <span class="o">=</span> <span class="n">tsT</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">unmask</span><span class="p">()</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;minObservationsNeeded&quot;</span><span class="p">])</span>

    <span class="c1"># Mask areas identified by countMask</span>
    <span class="n">tsT</span> <span class="o">=</span> <span class="n">tsT</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">nullFinder</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">countMask</span><span class="p">))</span>

    <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsT</span>
    <span class="n">countMask</span> <span class="o">=</span> <span class="n">countMask</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;insufficientDataMask&quot;</span><span class="p">)</span>
    <span class="n">prepDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;run_params&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">,</span> <span class="s2">&quot;countMask&quot;</span><span class="p">:</span> <span class="n">countMask</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">prepDict</span>


<span class="c1"># This function outputs Landtrendr as a vertical stack and adds properties about the run.</span>
<span class="k">def</span> <span class="nf">LANDTRENDRVertStack</span><span class="p">(</span><span class="n">composites</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">):</span>
    <span class="n">creationDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">composites</span> <span class="o">=</span> <span class="n">composites</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>

    <span class="c1"># Prep Time Series and put into run parameters</span>
    <span class="n">prepDict</span> <span class="o">=</span> <span class="n">prepTimeSeriesForLandTrendr</span><span class="p">(</span><span class="n">composites</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">)</span>
    <span class="n">run_params</span> <span class="o">=</span> <span class="n">prepDict</span><span class="p">[</span><span class="s2">&quot;run_params&quot;</span><span class="p">]</span>
    <span class="n">countMask</span> <span class="o">=</span> <span class="n">prepDict</span><span class="p">[</span><span class="s2">&quot;countMask&quot;</span><span class="p">]</span>

    <span class="c1"># Run LANDTRENDR</span>
    <span class="n">rawLt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">TemporalSegmentation</span><span class="o">.</span><span class="n">LandTrendr</span><span class="p">(</span><span class="o">**</span><span class="n">run_params</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(rawLt,{},&#39;raw lt {}-{}&#39;.format(startYear,endYear))</span>
    <span class="c1"># Convert to image stack</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="n">rawLt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">getLTvertStack</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">run_params</span><span class="p">))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">countMask</span><span class="p">)</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;yrs.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;fit.*&quot;</span><span class="p">))</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">rawLt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">)</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>

    <span class="c1"># Undo distdir change done in prepTimeSeriesForLandtrendr()</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">applyDistDir_vertStack</span><span class="p">(</span><span class="n">ltStack</span><span class="p">,</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">indexName</span><span class="p">],</span> <span class="s2">&quot;landtrendr&quot;</span><span class="p">)</span>

    <span class="c1"># Set Properties</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;startYear&quot;</span><span class="p">:</span> <span class="n">startYear</span><span class="p">,</span>
            <span class="s2">&quot;endYear&quot;</span><span class="p">:</span> <span class="n">endYear</span><span class="p">,</span>
            <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">indexName</span><span class="p">,</span>
            <span class="s2">&quot;creationDate&quot;</span><span class="p">:</span> <span class="n">creationDate</span><span class="p">,</span>
            <span class="s2">&quot;maxSegments&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;maxSegments&quot;</span><span class="p">],</span>
            <span class="s2">&quot;spikeThreshold&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;spikeThreshold&quot;</span><span class="p">],</span>
            <span class="s2">&quot;vertexCountOvershoot&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;vertexCountOvershoot&quot;</span><span class="p">],</span>
            <span class="s2">&quot;recoveryThreshold&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;recoveryThreshold&quot;</span><span class="p">],</span>
            <span class="s2">&quot;pvalThreshold&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;pvalThreshold&quot;</span><span class="p">],</span>
            <span class="s2">&quot;bestModelProportion&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;bestModelProportion&quot;</span><span class="p">],</span>
            <span class="s2">&quot;minObservationsNeeded&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;minObservationsNeeded&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ltStack</span><span class="p">)</span>


<span class="c1">#############################################/</span>
<span class="c1"># Function for running LANDTRENDR and converting output to annual image collection</span>
<span class="c1"># with the fitted value, duration, magnitude, slope, and diff for the segment for each given year</span>
<span class="k">def</span> <span class="nf">LANDTRENDRFitMagSlopeDiffCollection</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">):</span>

    <span class="n">startYear</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="n">endYear</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>

    <span class="c1"># Run LandTrendr and convert to VertStack format</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">LANDTRENDRVertStack</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">))</span>
    <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">LT_VT_vertStack_multBands</span><span class="p">(</span><span class="n">ltStack</span><span class="p">,</span> <span class="s2">&quot;landtrendr&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>

    <span class="c1"># Convert to durFitMagSlope format</span>
    <span class="n">durFitMagSlope</span> <span class="o">=</span> <span class="n">convertStack_To_DurFitMagSlope</span><span class="p">(</span><span class="n">ltStack</span><span class="p">,</span> <span class="s2">&quot;LT&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">durFitMagSlope</span>


<span class="c1"># ----------------------------------------------------------------------------------------------------</span>
<span class="c1">#        Functions for both Verdet and Landtrendr</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------</span>
<span class="c1"># Helper to multiply new baselearner format values (LandTrendr &amp; Verdet) by the appropriate amount when importing</span>
<span class="c1"># Duration is the only band that does not get multiplied by 0.0001 upon import.</span>
<span class="c1"># img = landtrendr or verdet image in fitMagDurSlope format</span>
<span class="c1"># multBy = 10000 (to prep for export) or 0.0001 (after import)</span>
<span class="k">def</span> <span class="nf">LT_VT_multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">multBy</span><span class="p">):</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_fitted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_slope&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_diff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_mag&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_dur&quot;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">dur</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Function to apply the Direction of  a decrease in photosynthetic vegetation to Landtrendr or Verdet vertStack format</span>
<span class="c1"># img = vertStack image for one band, e.g. &quot;NBR&quot;</span>
<span class="c1"># verdet_or_landtrendr = &#39;verdet&#39; or &#39;landtrendr&#39;</span>
<span class="c1"># distDir = from getImagesLib.changeDirDict</span>
<span class="k">def</span> <span class="nf">applyDistDir_vertStack</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">distDir</span><span class="p">,</span> <span class="n">verdet_or_landtrendr</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;yrs.*&quot;</span><span class="p">)</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;fit.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">distDir</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">years</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verdet_or_landtrendr</span> <span class="o">==</span> <span class="s2">&quot;landtrendr&quot;</span><span class="p">:</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Helper to multiply vertStack bands by the appropriate amount before exporting (multBy = 10000)</span>
<span class="c1"># or after importing (multBy = 0.0001)</span>
<span class="c1"># img = vertStack image for one band, e.g. &quot;NBR&quot;</span>
<span class="c1"># verdet_or_landtrendr = &#39;verdet&#39; or &#39;landtrendr&#39;</span>
<span class="c1"># multBy = 10000 or 0.0001</span>
<span class="k">def</span> <span class="nf">LT_VT_vertStack_multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">verdet_or_landtrendr</span><span class="p">,</span> <span class="n">multBy</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;yrs.*&quot;</span><span class="p">)</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;fit.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">years</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verdet_or_landtrendr</span> <span class="o">==</span> <span class="s2">&quot;landtrendr&quot;</span><span class="p">:</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Simplified method to convert LANDTRENDR stack to annual collection of</span>
<span class="c1"># Duration, fitted, magnitude, slope, and diff</span>
<span class="c1"># Improved handling of start year delay found in older method</span>
<span class="k">def</span> <span class="nf">simpleLTFit</span><span class="p">(</span><span class="n">ltStack</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">indexName</span><span class="o">=</span><span class="s2">&quot;bn&quot;</span><span class="p">,</span> <span class="n">arrayMode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxSegs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">multBy</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">indexName</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span>

    <span class="c1"># Set up output band names</span>
    <span class="n">outBns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">indexName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_LT_dur&quot;</span><span class="p">),</span>
        <span class="n">indexName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_LT_fitted&quot;</span><span class="p">),</span>
        <span class="n">indexName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_LT_mag&quot;</span><span class="p">),</span>
        <span class="n">indexName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_LT_slope&quot;</span><span class="p">),</span>
        <span class="n">indexName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_LT_diff&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># Separate years and fitted values of vertices</span>
    <span class="k">if</span> <span class="n">arrayMode</span><span class="p">:</span>
        <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxSegs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">yrBns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;yrs_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxSegs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">fitBns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fit_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxSegs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">yrs</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxSegs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([</span><span class="n">yrBns</span><span class="p">])</span><span class="o">.</span><span class="n">selfMask</span><span class="p">()</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxSegs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([</span><span class="n">fitBns</span><span class="p">])</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrs</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">yrs</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;yrs_.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">selfMask</span><span class="p">()</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;fit_.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrs</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span>

    <span class="n">fit</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multBy</span><span class="p">)</span>
    <span class="c1"># Find the first and last vertex years</span>
    <span class="n">isStartYear</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">firstNonNull</span><span class="p">())</span>
    <span class="n">isEndYear</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">lastNonNull</span><span class="p">())</span>
    <span class="n">blankMask</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>

    <span class="c1"># Iterate across each year to find the values for that year</span>
    <span class="k">def</span> <span class="nf">getYearValues</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>

        <span class="c1"># Find the segment the year belongs to</span>
        <span class="c1"># Handle whether the year is the same as the first vertex year</span>
        <span class="n">startYrMask</span> <span class="o">=</span> <span class="n">blankMask</span>
        <span class="n">startYrMask</span> <span class="o">=</span> <span class="n">startYrMask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isStartYear</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">yr</span><span class="p">),</span> <span class="n">yrs</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>
        <span class="n">startYrMask</span> <span class="o">=</span> <span class="n">startYrMask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isStartYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">yr</span><span class="p">),</span> <span class="n">yrs</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>

        <span class="c1"># Handle whether the year is the same as the last vertex year</span>
        <span class="n">endYrMask</span> <span class="o">=</span> <span class="n">blankMask</span>
        <span class="n">endYrMask</span> <span class="o">=</span> <span class="n">endYrMask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isStartYear</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">yr</span><span class="p">),</span> <span class="n">yrs</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>
        <span class="n">endYrMask</span> <span class="o">=</span> <span class="n">endYrMask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isStartYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">yr</span><span class="p">),</span> <span class="n">yrs</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>

        <span class="c1"># Get fitted values for the vertices segment the year is within</span>
        <span class="n">fitStart</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">startYrMask</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">lastNonNull</span><span class="p">())</span>
        <span class="n">fitEnd</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">endYrMask</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">firstNonNull</span><span class="p">())</span>

        <span class="c1"># Get start and end year for the vertices segment the year is within</span>
        <span class="n">yearStart</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">startYrMask</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">lastNonNull</span><span class="p">())</span>
        <span class="n">yearEnd</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">endYrMask</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">firstNonNull</span><span class="p">())</span>

        <span class="c1"># Get the difference and duration of the segment</span>
        <span class="n">segDiff</span> <span class="o">=</span> <span class="n">fitEnd</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">fitStart</span><span class="p">)</span>
        <span class="n">segDur</span> <span class="o">=</span> <span class="n">yearEnd</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">yearStart</span><span class="p">)</span>

        <span class="c1"># Get the varius annual derivatives</span>
        <span class="n">tDiff</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">yearStart</span><span class="p">)</span>
        <span class="n">segSlope</span> <span class="o">=</span> <span class="n">segDiff</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">segDur</span><span class="p">)</span>
        <span class="n">fitDiff</span> <span class="o">=</span> <span class="n">segSlope</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tDiff</span><span class="p">)</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">fitStart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fitDiff</span><span class="p">)</span>

        <span class="n">formatted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">segDur</span><span class="p">,</span> <span class="n">fitted</span><span class="p">,</span> <span class="n">segDiff</span><span class="p">,</span> <span class="n">segSlope</span><span class="p">,</span> <span class="n">fitDiff</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outBns</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">formatted</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">getYearValues</span><span class="p">(</span><span class="n">yr</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Wrapper function to iterate across multiple LT band/index values</span>
<span class="k">def</span> <span class="nf">batchSimpleLTFit</span><span class="p">(</span>
    <span class="n">ltStacks</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">indexNames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bandPropertyName</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span>
    <span class="n">arrayMode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">maxSegs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">multBy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mosaicReducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">lastNonNull</span><span class="p">(),</span>
<span class="p">):</span>
    <span class="c1"># Get band/index names if not provided</span>
    <span class="k">if</span> <span class="n">indexNames</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indexNames</span> <span class="o">=</span> <span class="n">ltStacks</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="n">bandPropertyName</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

    <span class="c1"># Iterate across each band/index and get the fitted, mag, slope, etc</span>
    <span class="n">lt_fit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">indexNames</span><span class="p">:</span>
        <span class="n">ltt</span> <span class="o">=</span> <span class="n">ltStacks</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">bandPropertyName</span><span class="p">,</span> <span class="n">bn</span><span class="p">))</span>
        <span class="n">bns</span> <span class="o">=</span> <span class="n">ltt</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
        <span class="n">ltt</span> <span class="o">=</span> <span class="n">ltt</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">mosaicReducer</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lt_fit</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lt_fit</span> <span class="o">=</span> <span class="n">simpleLTFit</span><span class="p">(</span><span class="n">ltt</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">arrayMode</span><span class="p">,</span> <span class="n">maxSegs</span><span class="p">,</span> <span class="n">multBy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lt_fit</span> <span class="o">=</span> <span class="n">joinCollections</span><span class="p">(</span>
                <span class="n">lt_fit</span><span class="p">,</span>
                <span class="n">simpleLTFit</span><span class="p">(</span><span class="n">ltt</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">arrayMode</span><span class="p">,</span> <span class="n">maxSegs</span><span class="p">,</span> <span class="n">multBy</span><span class="p">),</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">lt_fit</span>


<span class="c1"># Function to parse stack from LANDTRENDR or VERDET into image collection</span>
<span class="c1"># July 2019 LSC: multiply(distDir) and multiply(10000) now take place outside of this function,</span>
<span class="c1"># but must be done BEFORE stack is passed to this function</span>
<span class="k">def</span> <span class="nf">fitStackToCollection</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">maxSegments</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">):</span>
    <span class="c1"># Parse into annual fitted, duration, magnitude, and slope images</span>
    <span class="c1"># Iterate across each possible segment and find its fitted end value, duration, magnitude, and slope</span>
    <span class="k">def</span> <span class="nf">segmentLooper</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Set up slector for left and right side of segments</span>
        <span class="n">stringSelectLeft</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;.*_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
        <span class="n">stringSelectRight</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;.*_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">i</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>

        <span class="c1"># Get the left and right bands into separate images</span>
        <span class="n">stackLeft</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">stringSelectLeft</span><span class="p">])</span>
        <span class="n">stackRight</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">stringSelectRight</span><span class="p">])</span>

        <span class="c1"># Select off the year bands</span>
        <span class="n">segYearsLeft</span> <span class="o">=</span> <span class="n">stackLeft</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;yrs_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year_left&quot;</span><span class="p">])</span>
        <span class="n">segYearsRight</span> <span class="o">=</span> <span class="n">stackRight</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;yrs_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year_right&quot;</span><span class="p">])</span>

        <span class="c1"># Select off the fitted bands and flip them if they were flipped for use in LT</span>
        <span class="n">segFitLeft</span> <span class="o">=</span> <span class="n">stackLeft</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;fit_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;fitted&quot;</span><span class="p">])</span>
        <span class="n">segFitRight</span> <span class="o">=</span> <span class="n">stackRight</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;fit_.*&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;fitted&quot;</span><span class="p">])</span>

        <span class="c1"># Comput duration, magnitude, and then slope</span>
        <span class="n">segDur</span> <span class="o">=</span> <span class="n">segYearsRight</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">segYearsLeft</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;dur&quot;</span><span class="p">])</span>
        <span class="n">segMag</span> <span class="o">=</span> <span class="n">segFitRight</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">segFitLeft</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;mag&quot;</span><span class="p">])</span>
        <span class="n">segSlope</span> <span class="o">=</span> <span class="n">segMag</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">segDur</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;slope&quot;</span><span class="p">])</span>

        <span class="c1"># Iterate across each year to see if the year is within a given segment</span>
        <span class="c1"># All annualizing is done from the right vertex backward</span>
        <span class="c1"># The first year of the time series is inserted manually with an if statement</span>
        <span class="c1"># Ex: If the first segment goes from 1984-1990 and the second from 1990-1997, the duration, magnitude,and slope</span>
        <span class="c1"># values from the first segment will be given to 1984-1990, while the second segment (and any subsequent segment)</span>
        <span class="c1"># the duration, magnitude, and slope values will be given from 1991-1997</span>
        <span class="k">def</span> <span class="nf">annualizer</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
            <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>
            <span class="n">yrImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>

            <span class="c1"># Find if the year is the first and include the left year if it is</span>
            <span class="c1"># Otherwise, do not include the left year</span>
            <span class="n">yrImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
                <span class="n">yr</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">startYear</span><span class="p">),</span>
                <span class="n">yrImage</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">segYearsLeft</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">segYearsRight</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">yr</span><span class="p">))),</span>
                <span class="n">yrImage</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">segYearsLeft</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">segYearsRight</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">yr</span><span class="p">))),</span>
            <span class="p">)</span>

            <span class="n">yrImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">yrImage</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;yr&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

            <span class="c1"># Mask out the duration, magnitude, slope, and fit raster for the given year mask</span>
            <span class="n">yrDur</span> <span class="o">=</span> <span class="n">segDur</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrImage</span><span class="p">)</span>
            <span class="n">yrMag</span> <span class="o">=</span> <span class="n">segMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrImage</span><span class="p">)</span>
            <span class="n">yrSlope</span> <span class="o">=</span> <span class="n">segSlope</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrImage</span><span class="p">)</span>
            <span class="n">yrFit</span> <span class="o">=</span> <span class="n">segFitRight</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">yrSlope</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">segYearsRight</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">yr</span><span class="p">)))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrImage</span><span class="p">)</span>

            <span class="c1"># Get the difference from the</span>
            <span class="n">diffFromLeft</span> <span class="o">=</span> <span class="n">yrFit</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">segFitLeft</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yrImage</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;diff&quot;</span><span class="p">])</span>
            <span class="c1"># relativeDiffFromLeft = diffFromLeft.divide(segMag.abs()).updateMask(yrImage).rename([&#39;rel_yr_diff_left&#39;]).multiply(10000)</span>

            <span class="c1"># diffFromRight =yrFit.subtract(segFitRight).updateMask(yrImage).rename([&#39;yr_diff_right&#39;])</span>
            <span class="c1"># relativeDiffFromRight = diffFromRight.divide(segMag.abs()).updateMask(yrImage).rename([&#39;rel_yr_diff_right&#39;]).multiply(10000)</span>
            <span class="c1"># Stack it up</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">yrDur</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">yrFit</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">yrMag</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">yrSlope</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">diffFromLeft</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">annualCollection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">annualizer</span><span class="p">(</span><span class="n">yr</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">annualCollection</span>

    <span class="n">yrDurMagSlope</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxSegments</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">segmentLooper</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>

    <span class="c1"># Convert to an image collection</span>
    <span class="n">yrDurMagSlope</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">yrDurMagSlope</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="c1"># Collapse each given year to the single segment with data</span>
    <span class="k">def</span> <span class="nf">cleaner</span><span class="p">(</span><span class="n">yrDurMagSlope</span><span class="p">,</span> <span class="n">yr</span><span class="p">):</span>
        <span class="n">yrDurMagSlopeT</span> <span class="o">=</span> <span class="n">yrDurMagSlope</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">mosaic</span><span class="p">()</span>
        <span class="n">yrDurMagSlopeT</span> <span class="o">=</span> <span class="n">yrDurMagSlopeT</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">yrDurMagSlopeT</span>

    <span class="n">yrDurMagSlopeCleaned</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">cleaner</span><span class="p">(</span><span class="n">yrDurMagSlope</span><span class="p">,</span> <span class="n">yr</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">yrDurMagSlopeCleaned</span>


<span class="c1"># Convert image collection created using LANDTRENDRVertStack() to the same format as that created by</span>
<span class="c1"># LANDTRENDRFitMagSlopeDiffCollection(). Also works for Verdet Stack.</span>
<span class="c1"># VTorLT is the string that is put in the band names, &#39;LT&#39; or &#39;VT&#39;</span>
<span class="k">def</span> <span class="nf">convertStack_To_DurFitMagSlope</span><span class="p">(</span><span class="n">stackCollection</span><span class="p">,</span> <span class="n">VTorLT</span><span class="p">):</span>
    <span class="n">stackList</span> <span class="o">=</span> <span class="n">stackCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;rmse&quot;</span> <span class="ow">in</span> <span class="n">stackList</span><span class="o">.</span><span class="n">getInfo</span><span class="p">():</span>
        <span class="n">stackList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">)</span>
        <span class="n">stackCollection</span> <span class="o">=</span> <span class="n">stackCollection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">stackList</span><span class="p">)</span>

    <span class="c1"># Prep parameters for fitStackToCollection</span>
    <span class="n">maxSegments</span> <span class="o">=</span> <span class="n">stackCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxSegments&quot;</span><span class="p">)</span>
    <span class="n">startYear</span> <span class="o">=</span> <span class="n">stackCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startYear&quot;</span><span class="p">)</span>
    <span class="n">endYear</span> <span class="o">=</span> <span class="n">stackCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;endYear&quot;</span><span class="p">)</span>
    <span class="n">indexList</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">stackCollection</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

    <span class="c1"># Set up output collection to populate</span>
    <span class="n">outputCollection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Iterate across indices</span>
    <span class="k">for</span> <span class="n">indexName</span> <span class="ow">in</span> <span class="n">indexList</span><span class="p">:</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">stackCollection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">indexName</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># Convert to image collection</span>
        <span class="n">yrDurMagSlopeCleaned</span> <span class="o">=</span> <span class="n">fitStackToCollection</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">maxSegments</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span>

        <span class="c1"># Rename</span>
        <span class="n">bns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">yrDurMagSlopeCleaned</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
        <span class="n">outBns</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">VTorLT</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">bn</span><span class="p">))</span>
        <span class="n">yrDurMagSlopeCleaned</span> <span class="o">=</span> <span class="n">yrDurMagSlopeCleaned</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">,</span> <span class="n">outBns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outputCollection</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">outputCollection</span> <span class="o">=</span> <span class="n">yrDurMagSlopeCleaned</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputCollection</span> <span class="o">=</span> <span class="n">joinCollections</span><span class="p">(</span><span class="n">outputCollection</span><span class="p">,</span> <span class="n">yrDurMagSlopeCleaned</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outputCollection</span>


<span class="c1">#########################################################################################################</span>
<span class="c1"># Function to convert from raw Landtrendr Output OR Landtrendr/VerdetVertStack output to Loss &amp; Gain Space</span>
<span class="c1"># format = &#39;rawLandtrendr&#39; (Landtrendr only) or &#39;vertStack&#39; (Verdet or Landtrendr)</span>
<span class="c1"># If using vertStack format, this will not work if there are masked values in the vertStack. Must use getImagesLib.setNoData prior to</span>
<span class="c1"># calling this function</span>
<span class="c1"># Have to apply LandTrendr changeDirection (loss in veg/moisture goes up) to both Verdet and Landtrendr before applying convertToLossGain()</span>
<span class="k">def</span> <span class="nf">convertToLossGain</span><span class="p">(</span>
    <span class="n">ltStack</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;rawLandTrendr&quot;</span><span class="p">,</span>
    <span class="n">lossMagThresh</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">lossSlopeThresh</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">gainMagThresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">gainSlopeThresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">slowLossDurationThresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">chooseWhichLoss</span><span class="o">=</span><span class="s2">&quot;largest&quot;</span><span class="p">,</span>
    <span class="n">chooseWhichGain</span><span class="o">=</span><span class="s2">&quot;largest&quot;</span><span class="p">,</span>
    <span class="n">howManyToPull</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;rawLandTrendr&quot;</span><span class="p">:</span>
        <span class="n">ltStack</span> <span class="o">=</span> <span class="n">simpleRawLTToVertices</span><span class="p">(</span><span class="n">ltStack</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;rawLandTrendr&quot;</span> <span class="ow">or</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;arrayLandTrendr&quot;</span><span class="p">:</span>
        <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting LandTrendr from array output to Gain &amp; Loss&quot;</span><span class="p">)</span>
        <span class="c1"># Get the pair-wise difference and slopes of the years</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fittedMag</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Set up array for sorting</span>
        <span class="n">forSorting</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">fittedMag</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">slopes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;vertStack&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting LandTrendr OR Verdet from vertStack format to Gain &amp; Loss&quot;</span><span class="p">)</span>

        <span class="n">baseMask</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span>  <span class="c1"># Will fail on completely masked pixels. Have to work around and then remask later.</span>
        <span class="n">ltStack</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="c1"># Set masked pixels to 255</span>

        <span class="n">yrs</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;yrs.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>
        <span class="n">yrMask</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">)</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">yrs</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">32767</span><span class="p">))</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">yrs</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span>
        <span class="n">yrs</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">yrMask</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">ltStack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;fit.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">yrMask</span><span class="p">)</span>
        <span class="n">both</span> <span class="o">=</span> <span class="n">yrs</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">matrixTranspose</span><span class="p">()</span>

        <span class="n">left</span> <span class="o">=</span> <span class="n">both</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">both</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="n">fittedMag</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="n">fittedMag</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">forSorting</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">fittedMag</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">slopes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">forSorting</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">baseMask</span><span class="p">)</span>

    <span class="c1"># Apply thresholds</span>
    <span class="n">magLossMask</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">lossMagThresh</span><span class="p">)</span>
    <span class="n">slopeLossMask</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">lossSlopeThresh</span><span class="p">)</span>
    <span class="n">lossMask</span> <span class="o">=</span> <span class="n">magLossMask</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">slopeLossMask</span><span class="p">)</span>
    <span class="n">magGainMask</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">gainMagThresh</span><span class="p">)</span>
    <span class="n">slopeGainMask</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">gainSlopeThresh</span><span class="p">)</span>
    <span class="n">gainMask</span> <span class="o">=</span> <span class="n">magGainMask</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">slopeGainMask</span><span class="p">)</span>

    <span class="c1"># Mask any segments that do not meet thresholds</span>
    <span class="n">forLossSorting</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">lossMask</span><span class="p">)</span>
    <span class="n">forGainSorting</span> <span class="o">=</span> <span class="n">forSorting</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">gainMask</span><span class="p">)</span>

    <span class="c1"># Dictionaries for choosing the column and direction to multiply the column for sorting</span>
    <span class="c1"># Loss and gain are handled differently for sorting magnitude and slope (largest/smallest and steepest/mostgradual)</span>
    <span class="n">lossColumnDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;newest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;oldest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;largest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;smallest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;steepest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;mostGradual&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;shortest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;longest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">gainColumnDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;newest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;oldest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;largest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;smallest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;steepest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;mostGradual&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;shortest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;longest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="c1"># Pull the respective column and direction</span>
    <span class="n">lossSortValue</span> <span class="o">=</span> <span class="n">lossColumnDict</span><span class="p">[</span><span class="n">chooseWhichLoss</span><span class="p">]</span>
    <span class="n">gainSortValue</span> <span class="o">=</span> <span class="n">gainColumnDict</span><span class="p">[</span><span class="n">chooseWhichGain</span><span class="p">]</span>

    <span class="c1"># Pull the sort column and multiply it</span>
    <span class="n">lossSortBy</span> <span class="o">=</span> <span class="n">forLossSorting</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lossSortValue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lossSortValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">lossSortValue</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">gainSortBy</span> <span class="o">=</span> <span class="n">forGainSorting</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gainSortValue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gainSortValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">gainSortValue</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Sort the loss and gain and slice off the first column</span>
    <span class="n">lossAfterForSorting</span> <span class="o">=</span> <span class="n">forLossSorting</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">lossSortBy</span><span class="p">)</span>
    <span class="n">gainAfterForSorting</span> <span class="o">=</span> <span class="n">forGainSorting</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">gainSortBy</span><span class="p">)</span>

    <span class="c1"># Convert array to image stck</span>
    <span class="n">lossStack</span> <span class="o">=</span> <span class="n">getLTStack</span><span class="p">(</span>
        <span class="n">lossAfterForSorting</span><span class="p">,</span>
        <span class="n">howManyToPull</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;loss_yr_&quot;</span><span class="p">,</span> <span class="s2">&quot;loss_dur_&quot;</span><span class="p">,</span> <span class="s2">&quot;loss_mag_&quot;</span><span class="p">,</span> <span class="s2">&quot;loss_slope_&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">gainStack</span> <span class="o">=</span> <span class="n">getLTStack</span><span class="p">(</span>
        <span class="n">gainAfterForSorting</span><span class="p">,</span>
        <span class="n">howManyToPull</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;gain_yr_&quot;</span><span class="p">,</span> <span class="s2">&quot;gain_dur_&quot;</span><span class="p">,</span> <span class="s2">&quot;gain_mag_&quot;</span><span class="p">,</span> <span class="s2">&quot;gain_slope_&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">lossGainDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lossStack&quot;</span><span class="p">:</span> <span class="n">lossStack</span><span class="p">,</span> <span class="s2">&quot;gainStack&quot;</span><span class="p">:</span> <span class="n">gainStack</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">lossGainDict</span>


<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1">#                 Linear Interpolation functions</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Adapted from: https:#code.earthengine.google.com/?accept_repo=users/kongdd/public</span>
<span class="c1"># To work with multi-band images</span>
<span class="k">def</span> <span class="nf">replace_mask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">newimg</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1"># con = img.mask()</span>
    <span class="c1"># res = img., NODATA</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;** </span>
<span class="sd">     * This solution lead to interpolation fails | 2018-07-12</span>
<span class="sd">     * Good vlaues can become NA.</span>
<span class="sd">     *&quot;&quot;&quot;</span>
    <span class="c1"># img = img.expression(&quot;img*mask + newimg*(!mask)&quot;, {</span>
    <span class="c1">#     img    : img.unmask(),  # default unmask value is zero</span>
    <span class="c1">#     newimg : newimg,</span>
    <span class="c1">#     mask   : mask</span>
    <span class="c1"># })</span>

    <span class="c1"># ** The only nsolution is unmask &amp; updatemask */</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">nodata</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="n">newimg</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># error 2018-07-13 : mask already in newimg, so it&#39;s unnecessary to updateMask again</span>
    <span class="c1"># either test or image is masked, values will not be changed. So, newimg</span>
    <span class="c1"># mask can transfer to img.</span>
    <span class="c1">#</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">nodata</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">img</span>


<span class="c1"># ** Interpolation not considering weights */</span>
<span class="k">def</span> <span class="nf">addMillisecondsTimeBand</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="c1"># ** make sure mask is consistent */</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">linearInterp</span><span class="p">(</span><span class="n">imgcol</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">imgcol</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="c1"># frame = 32</span>
    <span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;system:time_start&quot;</span>
    <span class="n">imgcol</span> <span class="o">=</span> <span class="n">imgcol</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">addMillisecondsTimeBand</span><span class="p">)</span>

    <span class="c1"># We&#39;ll look for all images up to 32 days away from the current image.</span>
    <span class="n">maxDiff</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">maxDifference</span><span class="p">(</span><span class="n">frame</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">),</span> <span class="n">time</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;leftField&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s2">&quot;rightField&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">}</span>

    <span class="c1"># Images after, sorted in descending order (so closest is last).</span>
    <span class="c1"># f1 = maxDiff.and(ee.Filter.lessThanOrEquals(time, null, time))</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">maxDiff</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lessThanOrEquals</span><span class="p">(</span><span class="o">**</span><span class="n">cond</span><span class="p">))</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">saveAll</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;matchesKey&quot;</span><span class="p">:</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="s2">&quot;ordering&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s2">&quot;ascending&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">imgcol</span><span class="p">,</span> <span class="n">imgcol</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span>

    <span class="c1"># Images before, sorted in ascending order (so closest is last).</span>
    <span class="c1"># f2 = maxDiff.and(ee.Filter.greaterThanOrEquals(time, null, time))</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">maxDiff</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">greaterThanOrEquals</span><span class="p">(</span><span class="o">**</span><span class="n">cond</span><span class="p">))</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">saveAll</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;matchesKey&quot;</span><span class="p">:</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="s2">&quot;ordering&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s2">&quot;ascending&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">imgcol</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>

    <span class="c1"># print(c2, &#39;c2&#39;)</span>
    <span class="c1"># img = ee.Image(c2.toList(1, 15).get(0))</span>
    <span class="c1"># mask   = img.select([0]).mask()</span>
    <span class="c1"># Map.addLayer(img , {}, &#39;img&#39;)</span>
    <span class="c1"># Map.addLayer(mask, {}, &#39;mask&#39;)</span>
    <span class="k">def</span> <span class="nf">interpolator</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">before</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;before&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">mosaic</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">mosaic</span><span class="p">()</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># constrain after or before no NA values, confirm linear Interp having result</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">replace_mask</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">nodata</span><span class="p">)</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">replace_mask</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">nodata</span><span class="p">)</span>

        <span class="c1"># Compute the ratio between the image times.</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>  <span class="c1"># this is zero anywhere x1 = x2</span>
        <span class="c1"># Compute the interpolated image.</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>  <span class="c1"># remove time band now</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>

        <span class="n">interp</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">before</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
        <span class="c1"># mask   = img.select([0]).mask()</span>

        <span class="n">qc</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span>  <span class="c1"># .rename(&#39;qc&#39;)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">replace_mask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="n">nodata</span><span class="p">)</span>
        <span class="c1"># Map.addLayer(interp, {}, &#39;interp&#39;)</span>
        <span class="k">return</span> <span class="n">interp</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">())</span>

    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">interpolated</span>


<span class="c1">############################################################</span>
<span class="c1"># Function to do a single-band linear interpolation across time</span>
<span class="c1"># Assumes the image has date properties stored under system:time_start</span>
<span class="c1"># Will return a linearally interpolated date value where they were missing</span>
<span class="c1"># Where there are only values on one side, it will cast out the mean date of year offset</span>
<span class="c1"># for all years prior to or after actual data being available</span>
<span class="k">def</span> <span class="nf">new_interp_date</span><span class="p">(</span><span class="n">dateYr</span><span class="p">,</span> <span class="n">dateCollection</span><span class="p">,</span> <span class="n">max_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dummyImage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="c1"># Find the year</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">dateYr</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>

    <span class="c1"># When looking at years where there are no images available</span>
    <span class="c1"># will need to fill empty collections</span>
    <span class="c1"># This needs a dummy image to fill in blank images with</span>
    <span class="k">if</span> <span class="n">dummyImage</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">dateCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="c1"># Find the years in the window plus and minus from the given year</span>
    <span class="n">window_years</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_window</span><span class="p">)</span>

    <span class="c1"># Get values on either side</span>
    <span class="k">def</span> <span class="nf">getWindow</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
        <span class="c1"># Get window of years</span>
        <span class="n">yrLeft</span> <span class="o">=</span> <span class="n">year</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="n">yrRight</span> <span class="o">=</span> <span class="n">year</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

        <span class="c1"># Pull any data available for that year and add a constant year band as an integer (to handle date wrapping)</span>
        <span class="n">dateYrLeft</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">fillEmptyCollections</span><span class="p">(</span>
                <span class="n">dateCollection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yrLeft</span><span class="p">,</span> <span class="n">yrLeft</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)),</span>
                <span class="n">dummyImage</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;left&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">yrLeft</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">yrLeft</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">dateYrLeft</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;left_year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="n">dateYrRight</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">fillEmptyCollections</span><span class="p">(</span>
                <span class="n">dateCollection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yrRight</span><span class="p">,</span> <span class="n">yrRight</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)),</span>
                <span class="n">dummyImage</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;right&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">yrRight</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">yrRight</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">dateYrRight</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;right_year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">dateYrLeft</span><span class="p">,</span> <span class="n">yrLeft</span><span class="p">,</span> <span class="n">dateYrRight</span><span class="p">,</span> <span class="n">yrRight</span><span class="p">])</span>

    <span class="n">window_stack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">window_years</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getWindow</span><span class="p">))</span>

    <span class="c1"># Get the first non null date</span>
    <span class="n">window_first</span> <span class="o">=</span> <span class="n">window_stack</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">firstNonNull</span><span class="p">())</span>

    <span class="c1"># Find the difference in date per year (will be close to 1)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">window_first</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;right_first&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">window_first</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;left_first&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">window_first</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;right_year_first&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">window_first</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;left_year_first&quot;</span><span class="p">])))</span>

    <span class="c1"># Compute the interpolated value</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">window_first</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;left_year_first&quot;</span><span class="p">]))</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">interpolated</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">interpolated</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">window_first</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;left_first&quot;</span><span class="p">]))</span>

    <span class="c1"># Burn in any non null interpolated values</span>
    <span class="n">dateYrOut</span> <span class="o">=</span> <span class="n">dateYr</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="c1"># Extrapolate using the mean date offset</span>
    <span class="k">if</span> <span class="n">extrapolate</span><span class="p">:</span>
        <span class="n">extrapolate_left</span> <span class="o">=</span> <span class="n">window_stack</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;right&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;right_year&quot;</span><span class="p">])))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="n">extrapolate_right</span> <span class="o">=</span> <span class="n">window_stack</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;left&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;left_year&quot;</span><span class="p">])))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="n">dateYrOut</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">dateYrOut</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">extrapolate_left</span><span class="p">)</span>
        <span class="n">dateYrOut</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">dateYrOut</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">extrapolate_right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dateYrOut</span>


<span class="c1"># Wrapper function to handle date interpolation for</span>
<span class="k">def</span> <span class="nf">new_interp_date_collection</span><span class="p">(</span><span class="n">dateCollection</span><span class="p">,</span> <span class="n">max_window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dummyImage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">dateCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">dateCollection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dateImg</span><span class="p">:</span> <span class="n">new_interp_date</span><span class="p">(</span><span class="n">dateImg</span><span class="p">,</span> <span class="n">dateCollection</span><span class="p">,</span> <span class="n">max_window</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">,</span> <span class="n">extrapolate</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">interpolated</span>


<span class="c1">############################################################</span>
<span class="c1"># Function to apply linear interpolation for Verdet</span>
<span class="k">def</span> <span class="nf">applyLinearInterp</span><span class="p">(</span><span class="n">composites</span><span class="p">,</span> <span class="n">nYearsInterpolate</span><span class="p">):</span>

    <span class="c1"># Start with just the basic bands</span>
    <span class="n">composites</span> <span class="o">=</span> <span class="n">composites</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span>

    <span class="c1"># Find pixels/years with no data</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">composites</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">()))</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYY&quot;</span><span class="p">)]))</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">toBands</span><span class="p">()</span>

    <span class="c1"># rename bands to better names</span>
    <span class="n">origNames</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="c1"># print(&#39;mask bandNames&#39;, origNames.getInfo())</span>
    <span class="n">newNames</span> <span class="o">=</span> <span class="n">origNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bandName</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bandName</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">))</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">origNames</span><span class="p">,</span> <span class="n">newNames</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;creationDate&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Perform linear interpolation</span>
    <span class="n">composites</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">composites</span><span class="p">,</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">nYearsInterpolate</span><span class="p">,</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddIndices</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getTasseledCap</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddTCAngles</span><span class="p">)</span>

    <span class="n">outDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;composites&quot;</span><span class="p">:</span> <span class="n">composites</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="n">masks</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">outDict</span>


<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1">#                 VERDET</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Functions to apply our scaling work arounds for Verdet</span>
<span class="c1"># Multiply by a predetermined factor beforehand and divide after</span>
<span class="c1"># Add 1 before and subtract 1 after</span>
<span class="k">def</span> <span class="nf">applyVerdetScaling</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">):</span>
    <span class="n">distDir</span> <span class="o">=</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span>
    <span class="c1"># tsT = ts.map(lambda img: multBands(img, 1, -distDir)) # Apply change in direction first</span>
    <span class="n">tsT</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">addToImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Then add 1 to image to get rid of any negatives</span>
    <span class="n">tsT</span> <span class="o">=</span> <span class="n">tsT</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">multBands</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">))</span>  <span class="c1"># Finally we can apply scaling.</span>
    <span class="k">return</span> <span class="n">tsT</span>


<span class="k">def</span> <span class="nf">undoVerdetScaling</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">):</span>
    <span class="n">distDir</span> <span class="o">=</span> <span class="n">changeDirDict</span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">multBands</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">correctionFactor</span><span class="p">))</span>  <span class="c1"># Undo scaling first</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">addToImage</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Undo getting rid of negatives</span>
    <span class="c1"># fitted = multBands(fitted, 1, -distDir) #Finally, undo change in direction # LSC 10/19, this is not working as intended. Decided to just comment it out as I believe it is an unnecessary step.</span>
    <span class="k">return</span> <span class="n">fitted</span>


<span class="c1"># Update Mask from LinearInterp step</span>
<span class="k">def</span> <span class="nf">updateVerdetMasks</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">linearInterpMasks</span><span class="p">):</span>
    <span class="n">thisYear</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYY&quot;</span><span class="p">)</span>
    <span class="c1"># thisYear_maskName = ee.String(&#39;mask_&#39;).cat(thisYear)</span>
    <span class="n">thisYear_maskName</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;.*_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">thisYear</span><span class="p">)</span>
    <span class="n">thisMask</span> <span class="o">=</span> <span class="n">linearInterpMasks</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">thisYear_maskName</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">thisMask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>


<span class="c1"># Function to prep data for Verdet. Will have to run Verdet and convert to stack after.</span>
<span class="c1"># This step applies the Verdet Scaling. The scaling is undone in VERDETVertStack().</span>
<span class="k">def</span> <span class="nf">prepTimeSeriesForVerdet</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">):</span>
    <span class="c1"># Get the start and end years</span>
    <span class="n">startYear</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="n">endYear</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>

    <span class="c1"># Get single band time series and set its direction so that a loss in veg is going up</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">indexName</span><span class="p">])</span>
    <span class="n">tsT</span> <span class="o">=</span> <span class="n">applyVerdetScaling</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">)</span>

    <span class="c1"># Find areas with insufficient data to run VERDET</span>
    <span class="c1"># VERDET currently requires all pixels have a value</span>
    <span class="n">countMask</span> <span class="o">=</span> <span class="n">tsT</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">unmask</span><span class="p">()</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">endYear</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Mask areas identified by countMask</span>
    <span class="n">tsT</span> <span class="o">=</span> <span class="n">tsT</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">nullFinder</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">countMask</span><span class="p">))</span>

    <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsT</span>

    <span class="n">countMask</span> <span class="o">=</span> <span class="n">countMask</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;insufficientDataMask&quot;</span><span class="p">)</span>
    <span class="n">prepDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_params&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">,</span>
        <span class="s2">&quot;countMask&quot;</span><span class="p">:</span> <span class="n">countMask</span><span class="p">,</span>
        <span class="s2">&quot;startYear&quot;</span><span class="p">:</span> <span class="n">startYear</span><span class="p">,</span>
        <span class="s2">&quot;endYear&quot;</span><span class="p">:</span> <span class="n">endYear</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">prepDict</span>


<span class="c1"># Function to run Verdet and reformat as vertex stack in the same format as landtrendr</span>
<span class="k">def</span> <span class="nf">VERDETVertStack</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">,</span>
    <span class="n">indexName</span><span class="p">,</span>
    <span class="n">run_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tolerance&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">maxSegments</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">correctionFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">doLinearInterp</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># linearInterp is applied outside this function. This parameter is just to set the properties (true/false)</span>

    <span class="c1"># Get today&#39;s date for properties</span>
    <span class="n">creationDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract composite time series and apply relevant masking &amp; scaling</span>
    <span class="n">prepDict</span> <span class="o">=</span> <span class="n">prepTimeSeriesForVerdet</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">)</span>
    <span class="n">run_params</span> <span class="o">=</span> <span class="n">prepDict</span><span class="p">[</span><span class="s2">&quot;run_params&quot;</span><span class="p">]</span>
    <span class="n">countMask</span> <span class="o">=</span> <span class="n">prepDict</span><span class="p">[</span><span class="s2">&quot;countMask&quot;</span><span class="p">]</span>
    <span class="n">startYear</span> <span class="o">=</span> <span class="n">prepDict</span><span class="p">[</span><span class="s2">&quot;startYear&quot;</span><span class="p">]</span>
    <span class="n">endYear</span> <span class="o">=</span> <span class="n">prepDict</span><span class="p">[</span><span class="s2">&quot;endYear&quot;</span><span class="p">]</span>

    <span class="c1"># Run VERDET</span>
    <span class="n">verdet</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">TemporalSegmentation</span><span class="o">.</span><span class="n">Verdet</span><span class="p">(</span><span class="o">**</span><span class="n">run_params</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Get all possible years</span>
    <span class="n">tsYearRight</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([</span><span class="n">startYear</span><span class="p">]),</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">endYear</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Slice off right and left slopes</span>
    <span class="n">vLeft</span> <span class="o">=</span> <span class="n">verdet</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vRight</span> <span class="o">=</span> <span class="n">verdet</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Find whether its a vertex (abs of curvature !== 0)</span>
    <span class="n">vCurvature</span> <span class="o">=</span> <span class="n">vLeft</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">vRight</span><span class="p">)</span>
    <span class="n">vVertices</span> <span class="o">=</span> <span class="n">vCurvature</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">)</span>

    <span class="c1"># Append vertices to the start and end of the time series al la LANDTRENDR</span>
    <span class="n">vVertices</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">vVertices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([</span><span class="mi">1</span><span class="p">])),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Mask out vertex years</span>
    <span class="n">tsYearRight</span> <span class="o">=</span> <span class="n">tsYearRight</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">vVertices</span><span class="p">)</span>
    <span class="c1"># Find the duration of each segment</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">tsYearRight</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">tsYearRight</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">dur</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Mask out vertex slopes</span>
    <span class="n">verdet</span> <span class="o">=</span> <span class="n">verdet</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">vVertices</span><span class="p">)</span>

    <span class="c1"># Get the magnitude of change for each segment</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">verdet</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>

    <span class="c1"># Get the fitted values</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">arrayAccum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Undo scaling of fitted values</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">undoVerdetScaling</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">)</span>

    <span class="c1"># Get the bands needed to convert to image stack</span>
    <span class="n">forStack</span> <span class="o">=</span> <span class="n">tsYearRight</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Convert to stack and mask out any pixels that didn&#39;t have an observation in every image</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">getLTStack</span><span class="p">(</span><span class="n">forStack</span><span class="o">.</span><span class="n">arrayTranspose</span><span class="p">(),</span> <span class="n">maxSegments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;yrs_&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">countMask</span><span class="p">)</span>

    <span class="c1"># Set Properties</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;startYear&quot;</span><span class="p">:</span> <span class="n">startYear</span><span class="p">,</span>
            <span class="s2">&quot;endYear&quot;</span><span class="p">:</span> <span class="n">endYear</span><span class="p">,</span>
            <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">indexName</span><span class="p">,</span>
            <span class="s2">&quot;creationDate&quot;</span><span class="p">:</span> <span class="n">creationDate</span><span class="p">,</span>
            <span class="s2">&quot;maxSegments&quot;</span><span class="p">:</span> <span class="n">maxSegments</span><span class="p">,</span>
            <span class="s2">&quot;correctionFactor&quot;</span><span class="p">:</span> <span class="n">correctionFactor</span><span class="p">,</span>
            <span class="s2">&quot;tolerance&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">],</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">run_params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
            <span class="s2">&quot;linearInterpApplied&quot;</span><span class="p">:</span> <span class="n">doLinearInterp</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>


<span class="c1"># Function for running VERDET and converting output to annual image collection</span>
<span class="c1"># with the fitted value, duration, magnitude, slope, and diff for the segment for each given year</span>
<span class="c1"># Linear Interpolation has to be done beforehand, and the masks collection passed in to this function</span>
<span class="k">def</span> <span class="nf">VERDETFitMagSlopeDiffCollection</span><span class="p">(</span>
    <span class="n">composites</span><span class="p">,</span>
    <span class="n">indexName</span><span class="p">,</span>
    <span class="n">run_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tolerance&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">maxSegments</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">correctionFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">doLinearInterp</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
    <span class="n">masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># Run Verdet and convert to vertStack format</span>
    <span class="n">vtStack</span> <span class="o">=</span> <span class="n">VERDETVertStack</span><span class="p">(</span><span class="n">composites</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">run_params</span><span class="p">,</span> <span class="n">maxSegments</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">,</span> <span class="n">doLinearInterp</span><span class="p">)</span>
    <span class="n">vtStack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">LT_VT_vertStack_multBands</span><span class="p">(</span><span class="n">vtStack</span><span class="p">,</span> <span class="s2">&quot;verdet&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>  <span class="c1"># This needs to happen before the fitStackToCollection() step</span>

    <span class="c1"># Convert to durFitMagSlope format</span>
    <span class="n">durFitMagSlope</span> <span class="o">=</span> <span class="n">convertStack_To_DurFitMagSlope</span><span class="p">(</span><span class="n">vtStack</span><span class="p">,</span> <span class="s2">&quot;VT&quot;</span><span class="p">)</span>

    <span class="c1"># Prep data types for export</span>
    <span class="n">durFitMagSlope</span> <span class="o">=</span> <span class="n">durFitMagSlope</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">int16</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">doLinearInterp</span><span class="p">:</span>
        <span class="n">durFitMagSlope</span> <span class="o">=</span> <span class="n">durFitMagSlope</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">updateVerdetMasks</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">durFitMagSlope</span>


<span class="c1"># Wrapper for applying VERDET slightly more simply</span>
<span class="c1"># Returns annual collection of verdet slope</span>
<span class="k">def</span> <span class="nf">verdetAnnualSlope</span><span class="p">(</span><span class="n">tsIndex</span><span class="p">,</span> <span class="n">indexName</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>  <span class="c1"># ,alpha = 1/3.0):</span>
    <span class="c1"># Apply VERDET</span>
    <span class="n">run_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;timeSeries&quot;</span><span class="p">:</span> <span class="n">tsIndex</span><span class="p">,</span>
        <span class="s2">&quot;tolerance&quot;</span><span class="p">:</span> <span class="n">tolerance</span><span class="p">,</span>  <span class="c1"># default = 0.0001</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
    <span class="p">}</span>  <span class="c1"># default = 1/3.0</span>
    <span class="n">verdet</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">TemporalSegmentation</span><span class="o">.</span><span class="n">Verdet</span><span class="p">(</span><span class="o">**</span><span class="n">run_params</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;indexName: &quot;</span> <span class="o">+</span> <span class="n">indexName</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(verdet,{},&#39;verdet &#39;+indexName)</span>
    <span class="n">tsYear</span> <span class="o">=</span> <span class="n">tsIndex</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">addYearBand</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Find possible years to convert back to collection with</span>
    <span class="c1"># possibleYears = ee.List.sequence(startYear+1,endYear)</span>
    <span class="n">possibleYears</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span>
    <span class="n">verdetC</span> <span class="o">=</span> <span class="n">arrayToTimeSeries</span><span class="p">(</span><span class="n">verdet</span><span class="p">,</span> <span class="n">tsYear</span><span class="p">,</span> <span class="n">possibleYears</span><span class="p">,</span> <span class="s2">&quot;VERDET_fitted_&quot;</span> <span class="o">+</span> <span class="n">indexName</span> <span class="o">+</span> <span class="s2">&quot;_slope&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">verdetC</span>


<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1">#                 CCDC FUNCTIONS</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Function for getting CCDC coefficients for a given date raster</span>
<span class="c1"># Date raster is expected to be decimal year (e.g. 2000.5  or 1999.25...etc)</span>
<span class="k">def</span> <span class="nf">getSegmentParamsForYear</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">yearImg</span><span class="p">):</span>

    <span class="c1"># Get the start and end and convert to decimal years</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*tStart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">365.25</span><span class="p">)</span><span class="o">.</span><span class="n">selfMask</span><span class="p">()</span>  <span class="c1"># segment start data</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*tEnd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">365.25</span><span class="p">)</span><span class="o">.</span><span class="n">selfMask</span><span class="p">()</span>  <span class="c1"># segment end date</span>

    <span class="c1"># Get the band names and set up a blank raster with the indices of the segments</span>
    <span class="n">bandNames</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">segIndices</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
    <span class="n">blankRaster</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">segIndices</span><span class="p">)</span>
    <span class="n">firstBandName</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bandNames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">outBandNames</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">firstBandName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;.*coef.*&quot;</span><span class="p">),</span> <span class="n">firstBandName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;.*RMSE&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;S1_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Find areas where the date is less than the end of the segment</span>
    <span class="n">yearMask</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">yearImg</span><span class="p">)</span>  <span class="c1"># start.lte(yearImg).and(end.gte(yearImg));</span>

    <span class="c1"># Handle no segments at target date</span>
    <span class="c1"># If date is after latest segment, force to use last segment coeffs</span>
    <span class="n">validPixels</span> <span class="o">=</span> <span class="n">yearMask</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">yearMask</span> <span class="o">=</span> <span class="n">yearMask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">validPixels</span><span class="o">.</span><span class="n">Not</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Apply mask to blank raster and then pull the first valid value (earliest segment that ends after target date)</span>
    <span class="n">blankRaster</span> <span class="o">=</span> <span class="n">blankRaster</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yearMask</span><span class="p">)</span>
    <span class="n">firstValid</span> <span class="o">=</span> <span class="n">blankRaster</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">blankRaster</span> <span class="o">=</span> <span class="n">blankRaster</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">blankRaster</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">firstValid</span><span class="p">))</span>
    <span class="n">yearMask</span> <span class="o">=</span> <span class="n">yearMask</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">blankRaster</span><span class="p">)</span>

    <span class="c1"># Set up blank raster</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">outBandNames</span><span class="o">.</span><span class="n">length</span><span class="p">()))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outBandNames</span><span class="p">)</span>

    <span class="c1"># Iterate across each segment and unmask coefficients if they&#39;re the valid segment</span>
    <span class="k">def</span> <span class="nf">unmaskValidCoefficients</span><span class="p">(</span><span class="n">bn</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">bn</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span>

        <span class="c1"># Include both the coefficients and RMSE</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;.*coef.*&quot;</span><span class="p">),</span> <span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;.*RMSE&quot;</span><span class="p">)])</span>

        <span class="c1"># Select the year mask corresponding to the relevant segment</span>
        <span class="n">yearMaskT</span> <span class="o">=</span> <span class="n">yearMask</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">))</span>

        <span class="c1"># Apply mask</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">yearMaskT</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">mask</span><span class="p">(),</span> <span class="n">coeffs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">bandNames</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">,</span> <span class="n">out</span><span class="p">:</span> <span class="n">unmaskValidCoefficients</span><span class="p">(</span><span class="n">bn</span><span class="p">,</span> <span class="n">out</span><span class="p">),</span> <span class="n">out</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1">#          UNCONVERTED JAVASCRIPT FUNCTIONS BELOW HERE</span>
<span class="c1"># --------------------------------------------------------------------------</span>


<span class="c1">#######################/</span>
<span class="k">def</span> <span class="nf">thresholdChange</span><span class="p">(</span><span class="n">changeCollection</span><span class="p">,</span> <span class="n">changeThresh</span><span class="p">,</span> <span class="n">changeDir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">changeDir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">changeDir</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">bandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">changeCollection</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">bandNames</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_change&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">thresholder</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="n">changeYr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">changeDir</span><span class="p">)</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">changeThresh</span><span class="p">)</span>
        <span class="n">yrImage</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">(),</span> <span class="n">yr</span><span class="p">)</span>
        <span class="n">changeYr</span> <span class="o">=</span> <span class="n">yrImage</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">changeYr</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">changeYr</span><span class="p">)</span>

    <span class="n">change</span> <span class="o">=</span> <span class="n">changeCollection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">thresholder</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">change</span>


<span class="c1"># function thresholdSubtleChange(changeCollection,changeThreshLow,changeThreshHigh,changeDir){</span>
<span class="c1">#   if(changeDir === undefined || changeDir === null){changeDir = 1}</span>
<span class="c1">#   bandNames = ee.Image(changeCollection.first()).bandNames()</span>
<span class="c1">#   bandNames = bandNames.map(function(bn){return ee.String(bn).cat(&#39;_change&#39;)})</span>
<span class="c1">#   change = changeCollection.map(function(img){</span>
<span class="c1">#     yr = ee.Date(img.get(&#39;system:time_start&#39;)).get(&#39;year&#39;)</span>
<span class="c1">#     changeYr = img.multiply(changeDir).gt(changeThreshLow).and(img.multiply(changeDir).lt(changeThreshHigh))</span>
<span class="c1">#     yrImage = img.where(img.mask(),yr)</span>
<span class="c1">#     changeYr = yrImage.updateMask(changeYr).rename(bandNames).int16()</span>
<span class="c1">#     return img.mask(ee.Image(1)).addBands(changeYr)</span>
<span class="c1">#   })</span>
<span class="c1">#   return change</span>
<span class="c1"># }</span>

<span class="c1"># function getExistingChangeData(changeThresh,showLayers){</span>
<span class="c1">#   if(showLayers === undefined || showLayers === null){</span>
<span class="c1">#     showLayers = true</span>
<span class="c1">#   }</span>
<span class="c1">#   if(changeThresh === undefined || changeThresh === null){</span>
<span class="c1">#     changeThresh = 50</span>
<span class="c1">#   }</span>
<span class="c1">#   startYear = 1985</span>
<span class="c1">#   endYear = 2016</span>


<span class="c1">#   # glriEnsemble = ee.Image(&#39;projects/glri-phase3/changeMaps/ensembleOutputs/NBR_NDVI_TCBGAngle_swir1_swir2_median_LT_Ensemble&#39;)</span>


<span class="c1">#   # if(showLayers){</span>
<span class="c1">#   # Map.addLayer(conusChange.select([&#39;change&#39;]).max(),{&#39;min&#39;:startYear,&#39;max&#39;:endYear,&#39;palette&#39;:&#39;FF0,F00&#39;},&#39;CONUS LCMS Most Recent Year of Change&#39;,false)</span>
<span class="c1">#   # Map.addLayer(conusChange.select([&#39;probability&#39;]).max(),{&#39;min&#39;:0,&#39;max&#39;:50,&#39;palette&#39;:&#39;888,008&#39;},&#39;LCMSC&#39;,false)</span>
<span class="c1">#   # }</span>
<span class="c1">#   # glri_lcms = glriEnsemble.updateMask(glriEnsemble.select([0])).select([1])</span>
<span class="c1">#   # glri_lcms = glri_lcms.updateMask(glri_lcms.gte(startYear).and(glri_lcms.lte(endYear)))</span>
<span class="c1">#   # if(showLayers){</span>
<span class="c1">#   # Map.addLayer(glri_lcms,{&#39;min&#39;:startYear,&#39;max&#39;:endYear,&#39;palette&#39;:&#39;FF0,F00&#39;},&#39;GLRI LCMS&#39;,false)</span>
<span class="c1">#   # }</span>


<span class="c1">#   hansen = ee.Image(&#39;UMD/hansen/global_forest_change_2016_v1_4&#39;).select([&#39;lossyear&#39;]).add(2000).int16()</span>
<span class="c1">#   hansen = hansen.updateMask(hansen.neq(2000).and(hansen.gte(startYear)).and(hansen.lte(endYear)))</span>
<span class="c1">#   if(showLayers){</span>
<span class="c1">#   Map.addLayer(hansen,{&#39;min&#39;:startYear,&#39;max&#39;:endYear,&#39;palette&#39;:&#39;FF0,F00&#39;},&#39;Hansen Change Year&#39;,false)</span>
<span class="c1">#   }</span>
<span class="c1">#   # return conusChangeOut</span>
<span class="c1"># }</span>


<span class="c1"># #####################################</span>
<span class="c1"># #Wrapper for applying EWMACD slightly more simply</span>
<span class="c1"># function getEWMA(lsIndex,trainingStartYear,trainingEndYear, harmonicCount){</span>
<span class="c1">#   if(harmonicCount === null || harmonicCount === undefined){harmonicCount = 1}</span>


<span class="c1">#   #Run EWMACD</span>
<span class="c1">#   ewmacd = ee.Algorithms.TemporalSegmentation.Ewmacd({</span>
<span class="c1">#     timeSeries: lsIndex,</span>
<span class="c1">#     vegetationThreshold: -1,</span>
<span class="c1">#     trainingStartYear: trainingStartYear,</span>
<span class="c1">#     trainingEndYear: trainingEndYear,</span>
<span class="c1">#     harmonicCount: harmonicCount</span>
<span class="c1">#   })</span>

<span class="c1">#   #Extract the ewmac values</span>
<span class="c1">#   ewma = ewmacd.select([&#39;ewma&#39;])</span>
<span class="c1">#   return ewma</span>
<span class="c1"># }</span>

<span class="c1"># #Function for converting EWMA values to annual collection</span>
<span class="c1"># function annualizeEWMA(ewma,indexName,lsYear,startYear,endYear,annualReducer,remove2012){</span>
<span class="c1">#   #Fill null parameters</span>
<span class="c1">#   if(annualReducer === null || annualReducer === undefined){annualReducer = ee.Reducer.min()}</span>
<span class="c1">#   if(remove2012 === null || remove2012 === undefined){remove2012 = true}</span>

<span class="c1">#    #Find the years to annualize with</span>
<span class="c1">#   years = ee.List.sequence(startYear,endYear)</span>

<span class="c1">#   #Find if 2012 needs replaced</span>
<span class="c1">#   replace2012 = ee.Number(ee.List([years.indexOf(2011),years.indexOf(2012),years.indexOf(2013)]).reduce(ee.Reducer.min())).neq(-1).getInfo()</span>
<span class="c1">#   print(&#39;2012 needs replaced:&#39;,replace2012)</span>


<span class="c1">#   #Remove 2012 if in list and set to true</span>
<span class="c1">#   if(remove2012){years = years.removeAll([2012])}</span>


<span class="c1">#   #Annualize</span>
<span class="c1">#   #Set up dummy image for handling null values</span>
<span class="c1">#   noDateValue = -32768;</span>
<span class="c1">#   dummyImage = ee.Image(noDateValue).toArray();</span>


<span class="c1">#   annualEWMA = years.map(function(yr){</span>
<span class="c1">#     yr = ee.Number(yr);</span>
<span class="c1">#     yrMask = lsYear.int16().eq(yr);</span>
<span class="c1">#     ewmacdYr = ewma.arrayMask(yrMask);</span>
<span class="c1">#     ewmacdYearYr = lsYear.arrayMask(yrMask);</span>
<span class="c1">#     ewmacdYrSorted = ewmacdYr.arraySort(ewmacdYr);</span>
<span class="c1">#     ewmacdYearYrSorted= ewmacdYearYr.arraySort(ewmacdYr);</span>

<span class="c1">#     yrData = ewmacdYrSorted.arrayCat(ewmacdYearYrSorted,1);</span>
<span class="c1">#     yrReduced = ewmacdYrSorted.arrayReduce(annualReducer,[0]);</span>


<span class="c1">#     #Find null pixels</span>
<span class="c1">#     l = yrReduced.arrayLength(0);</span>

<span class="c1">#     #Fill null values and convert to regular image</span>
<span class="c1">#     yrReduced = yrReduced.where(l.eq(0),dummyImage).arrayGet([-1]);</span>

<span class="c1">#     #Remask nulls</span>
<span class="c1">#     yrReduced = yrReduced.updateMask(yrReduced.neq(noDateValue)).rename([&#39;EWMA_&#39;+indexName])</span>
<span class="c1">#       .set(&#39;system:time_start&#39;,ee.Date.fromYMD(yr,6,1).millis()).int16();</span>


<span class="c1">#     return yrReduced;</span>
<span class="c1">#   });</span>
<span class="c1">#   annualEWMA = ee.ImageCollection.fromImages(annualEWMA);</span>
<span class="c1">#   # print(remove2012,replace2012 ==1)</span>
<span class="c1">#   if(remove2012 &amp;&amp; replace2012 ==1){</span>
<span class="c1">#     print(&#39;Replacing EWMA 2012 with mean of 2011 and 2013&#39;);</span>
<span class="c1">#     value2011 = ee.Image(annualEWMA.filter(ee.Filter.calendarRange(2011,2011,&#39;year&#39;)).first());</span>
<span class="c1">#     value2013 = ee.Image(annualEWMA.filter(ee.Filter.calendarRange(2013,2013,&#39;year&#39;)).first());</span>
<span class="c1">#     value2012 = value2013.add(value2011);</span>
<span class="c1">#     value2012 = value2012.divide(2).rename([&#39;EWMA_&#39;+indexName])</span>
<span class="c1">#     .set(&#39;system:time_start&#39;,ee.Date.fromYMD(2012,6,1).millis()).int16();</span>

<span class="c1">#     annualEWMA = ee.ImageCollection(ee.FeatureCollection([annualEWMA,ee.ImageCollection([value2012])]).flatten()).sort(&#39;system:time_start&#39;);</span>
<span class="c1">#   }</span>
<span class="c1">#   return annualEWMA;</span>
<span class="c1"># }</span>
<span class="c1"># #</span>
<span class="c1"># function runEWMACD(lsIndex,indexName,startYear,endYear,trainingStartYear,trainingEndYear, harmonicCount,annualReducer,remove2012){</span>
<span class="c1">#   # bandName = ee.String(ee.Image(lsIndex.first()).bandNames().get(0));</span>

<span class="c1">#   ewma = getEWMA(lsIndex,trainingStartYear,trainingEndYear, harmonicCount);</span>

<span class="c1">#   #Get dates for later reference</span>
<span class="c1">#   lsYear = lsIndex.map(function(img){return getImageLib.addDateBand(img,true)}).select([&#39;year&#39;]).toArray().arrayProject([0]);</span>


<span class="c1">#   annualEWMA = annualizeEWMA(ewma,indexName,lsYear,startYear,endYear,annualReducer,remove2012);</span>

<span class="c1">#   return [ewma.arrayCat(lsYear,1),annualEWMA];</span>
<span class="c1"># }</span>
<span class="c1"># #####################################</span>
<span class="c1"># #Function to find the pairwise difference of a time series</span>
<span class="c1"># #Assumes one image per year</span>
<span class="c1"># function pairwiseSlope(c){</span>
<span class="c1">#     c = c.sort(&#39;system:time_start&#39;);</span>

<span class="c1">#     bandNames = ee.Image(c.first()).bandNames();</span>
<span class="c1">#     # bandNames = bandNames.map(function(bn){return ee.String(bn).cat(&#39;_slope&#39;)});</span>

<span class="c1">#     years = c.toList(10000).map(function(i){i = ee.Image(i);return ee.Date(i.get(&#39;system:time_start&#39;)).get(&#39;year&#39;)});</span>

<span class="c1">#     yearsLeft = years.slice(0,-1);</span>
<span class="c1">#     yearsRight = years.slice(1,null);</span>
<span class="c1">#     yearPairs = yearsLeft.zip(yearsRight);</span>

<span class="c1">#     slopeCollection = yearPairs.map(function(yp){</span>
<span class="c1">#       yp = ee.List(yp);</span>
<span class="c1">#       yl = ee.Number(yp.get(0));</span>
<span class="c1">#       yr = ee.Number(yp.get(1));</span>
<span class="c1">#       yd = yr.subtract(yl);</span>
<span class="c1">#       l = ee.Image(c.filter(ee.Filter.calendarRange(yl,yl,&#39;year&#39;)).first()).add(0.000001);</span>
<span class="c1">#       r = ee.Image(c.filter(ee.Filter.calendarRange(yr,yr,&#39;year&#39;)).first());</span>

<span class="c1">#       slope = (r.subtract(l)).rename(bandNames);</span>
<span class="c1">#       slope = slope.set(&#39;system:time_start&#39;,ee.Date.fromYMD(yr,6,1).millis());</span>
<span class="c1">#       return slope;</span>
<span class="c1">#     });</span>
<span class="c1">#     return ee.ImageCollection.fromImages(slopeCollection);</span>
<span class="c1">#   }</span>


<span class="c1">############################################Function for converting collection into annual median collection</span>
<span class="c1"># Does not support date wrapping across the new year (e.g. Nov- April window is a no go)</span>
<span class="k">def</span> <span class="nf">toAnnualMedian</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">):</span>
    <span class="n">dummyImmage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">getMedian</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
        <span class="n">imagesT</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>
        <span class="n">imagesT</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">imagesT</span><span class="p">,</span> <span class="n">dummyImmage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imagesT</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getMedian</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="c1">############################################Function for applying linear fit model</span>
<span class="c1"># Assumes the model has a intercept and slope band prefix to the bands in the model</span>
<span class="c1"># Assumes that the c (collection) has the raw bands in it</span>
<span class="k">def</span> <span class="nf">predictModel</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">bandNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># Parse model</span>
    <span class="n">intercepts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_intercept&quot;</span><span class="p">)</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_slope&quot;</span><span class="p">)</span>

    <span class="c1"># Find band names for raw data if not provided</span>
    <span class="k">if</span> <span class="n">bandNames</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bandNames</span> <span class="o">=</span> <span class="n">slopes</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Set up output band names</span>
    <span class="n">predictedBandNames</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_trend&quot;</span><span class="p">))</span>

    <span class="c1"># Predict model</span>
    <span class="k">def</span> <span class="nf">pModel</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">cActual</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;constant&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">intercepts</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">predictedBandNames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cActual</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span>

    <span class="n">predicted</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pModel</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predicted</span>


<span class="c1">###########################################</span>
<span class="c1"># Function for getting a linear fit of a time series and applying it</span>
<span class="k">def</span> <span class="nf">getLinearFit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">bandNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Find band names for raw data if not provided</span>
    <span class="k">if</span> <span class="n">bandNames</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span>

    <span class="c1"># Add date and constant independents</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">addDateBand</span><span class="p">)</span>
    <span class="n">selectOrder</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">bandNames</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Fit model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selectOrder</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">linearRegression</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">length</span><span class="p">()))</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Convert model to image</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">arrayTranspose</span><span class="p">()</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([</span><span class="n">bandNames</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="s2">&quot;slope&quot;</span><span class="p">]])</span>

    <span class="c1"># Apply model</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictModel</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">bandNames</span><span class="p">)</span>

    <span class="c1"># Return both the model and predicted</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="p">,</span> <span class="n">predicted</span><span class="p">]</span>


<span class="c1">#####################################</span>
<span class="c1"># #Iterate across each time window and do a z-score and trend analysis</span>
<span class="c1"># #This method does not currently support date wrapping</span>
<span class="k">def</span> <span class="nf">zAndTrendChangeDetection</span><span class="p">(</span>
    <span class="n">allScenes</span><span class="p">,</span>
    <span class="n">indexNames</span><span class="p">,</span>
    <span class="n">nDays</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">baselineLength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">baselineGap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">epochLength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">zReducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
    <span class="n">useAnnualMedianForTrend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">exportImages</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">exportPathRoot</span><span class="o">=</span><span class="s2">&quot;users/iwhousman/test/ChangeCollection&quot;</span><span class="p">,</span>
    <span class="n">studyArea</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">minBaselineObservationsNeeded</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># House-keeping</span>
    <span class="n">allScenes</span> <span class="o">=</span> <span class="n">allScenes</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">indexNames</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">allScenes</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">())</span>
    <span class="n">dummyScene</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">allScenes</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="n">outNames</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">bn</span> <span class="o">+</span> <span class="s2">&quot;_Z&quot;</span><span class="p">,</span> <span class="n">indexNames</span><span class="p">)</span>

    <span class="n">analysisStartYear</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">startYear</span> <span class="o">+</span> <span class="n">baselineLength</span> <span class="o">+</span> <span class="n">baselineGap</span><span class="p">,</span> <span class="n">startYear</span> <span class="o">+</span> <span class="n">epochLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">years</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">analysisStartYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
    <span class="n">julians</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span> <span class="o">-</span> <span class="n">nDays</span><span class="p">,</span> <span class="n">nDays</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

    <span class="c1"># Iterate across each year and perform analysis</span>

    <span class="k">def</span> <span class="nf">processYrJd</span><span class="p">(</span><span class="n">yjd</span><span class="p">):</span>
        <span class="n">yjd</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">yjd</span><span class="p">)</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yjd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">jd</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yjd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Set up the baseline years</span>
        <span class="n">blStartYear</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">baselineLength</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">baselineGap</span><span class="p">)</span>
        <span class="n">blEndYear</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">baselineGap</span><span class="p">)</span>

        <span class="c1"># Set up the trend years</span>
        <span class="n">trendStartYear</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">epochLength</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Set up the julian date range</span>
        <span class="n">jdStart</span> <span class="o">=</span> <span class="n">jd</span>
        <span class="n">jdEnd</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nDays</span><span class="p">)</span>

        <span class="c1"># Get the baseline images</span>
        <span class="n">blImages</span> <span class="o">=</span> <span class="n">allScenes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">blStartYear</span><span class="p">,</span> <span class="n">blEndYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">jdStart</span><span class="p">,</span> <span class="n">jdEnd</span><span class="p">))</span>
        <span class="n">blImages</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">blImages</span><span class="p">,</span> <span class="n">dummyScene</span><span class="p">)</span>

        <span class="c1"># Mask out where not enough observations</span>
        <span class="n">blCounts</span> <span class="o">=</span> <span class="n">blImages</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">blImages</span> <span class="o">=</span> <span class="n">blImages</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">blCounts</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">minBaselineObservationsNeeded</span><span class="p">)))</span>

        <span class="c1"># Get the z analysis images</span>
        <span class="n">analysisImages</span> <span class="o">=</span> <span class="n">allScenes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">jdStart</span><span class="p">,</span> <span class="n">jdEnd</span><span class="p">))</span>
        <span class="n">analysisImages</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">analysisImages</span><span class="p">,</span> <span class="n">dummyScene</span><span class="p">)</span>

        <span class="c1"># Get the images for the trend analysis</span>
        <span class="n">trendImages</span> <span class="o">=</span> <span class="n">allScenes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">trendStartYear</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">jdStart</span><span class="p">,</span> <span class="n">jdEnd</span><span class="p">))</span>
        <span class="n">trendImages</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">trendImages</span><span class="p">,</span> <span class="n">dummyScene</span><span class="p">)</span>

        <span class="c1"># Convert to annual stack if selected</span>
        <span class="k">if</span> <span class="n">useAnnualMedianForTrend</span><span class="p">:</span>
            <span class="n">trendImages</span> <span class="o">=</span> <span class="n">toAnnualMedian</span><span class="p">(</span><span class="n">trendImages</span><span class="p">,</span> <span class="n">trendStartYear</span><span class="p">,</span> <span class="n">yr</span><span class="p">)</span>

        <span class="c1"># Perform the linear trend analysis</span>
        <span class="n">linearTrend</span> <span class="o">=</span> <span class="n">getLinearFit</span><span class="p">(</span><span class="n">trendImages</span><span class="p">,</span> <span class="n">indexNames</span><span class="p">)</span>
        <span class="n">linearTrendModel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">linearTrend</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_slope&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

        <span class="c1"># Perform the z analysis</span>
        <span class="n">blMean</span> <span class="o">=</span> <span class="n">blImages</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">blStd</span> <span class="o">=</span> <span class="n">blImages</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">stdDev</span><span class="p">())</span>

        <span class="n">analysisImagesZ</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">analysisImages</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">blMean</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">blStd</span><span class="p">)))</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">zReducer</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outNames</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Set up the output</span>
        <span class="n">outName</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;Z_and_Trend_b&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">blStartYear</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">blEndYear</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_epoch&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">epochLength</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_y&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">yr</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_jd&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">jdStart</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">jdEnd</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">imageStartDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">jdStart</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysisImagesZ</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">linearTrendModel</span><span class="p">)</span>
            <span class="o">.</span><span class="n">int16</span><span class="p">()</span>
            <span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;system:time_start&quot;</span><span class="p">:</span> <span class="n">imageStartDate</span><span class="p">,</span>
                    <span class="s2">&quot;system:time_end&quot;</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">jdEnd</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span>
                    <span class="s2">&quot;baselineYrs&quot;</span><span class="p">:</span> <span class="n">baselineLength</span><span class="p">,</span>
                    <span class="s2">&quot;baselineStartYear&quot;</span><span class="p">:</span> <span class="n">blStartYear</span><span class="p">,</span>
                    <span class="s2">&quot;baselineEndYear&quot;</span><span class="p">:</span> <span class="n">blEndYear</span><span class="p">,</span>
                    <span class="s2">&quot;epochLength&quot;</span><span class="p">:</span> <span class="n">epochLength</span><span class="p">,</span>
                    <span class="s2">&quot;trendStartYear&quot;</span><span class="p">:</span> <span class="n">trendStartYear</span><span class="p">,</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">yr</span><span class="p">,</span>
                    <span class="s2">&quot;startJulian&quot;</span><span class="p">:</span> <span class="n">jdStart</span><span class="p">,</span>
                    <span class="s2">&quot;endJulian&quot;</span><span class="p">:</span> <span class="n">jdEnd</span><span class="p">,</span>
                    <span class="s2">&quot;system:index&quot;</span><span class="p">:</span> <span class="n">outName</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># if exportImages:</span>
        <span class="c1">#   outName = outName.getInfo()</span>
        <span class="c1">#   outPath = exportPathRoot + &#39;/&#39; + outName</span>
        <span class="c1">#   getImageLib.exportToAssetWrapper(out.clip(studyArea),outName,outPath,\</span>
        <span class="c1">#     &#39;mean&#39;,studyArea.bounds(),scale,crs,transform)</span>
        <span class="c1"># zAndTrendCollection.append(out)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">yjdList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="c1"># Iterate across the julian dates</span>
        <span class="k">for</span> <span class="n">jd</span> <span class="ow">in</span> <span class="n">julians</span><span class="p">:</span>
            <span class="n">yjdList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">yr</span><span class="p">,</span> <span class="n">jd</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">yjdList</span><span class="p">)</span>

    <span class="n">zAndTrendCollection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">([</span><span class="n">processYrJd</span><span class="p">(</span><span class="n">yjd</span><span class="p">)</span> <span class="k">for</span> <span class="n">yjd</span> <span class="ow">in</span> <span class="n">yjdList</span><span class="p">])</span>

    <span class="c1"># return zAndTrendCollection</span>


<span class="k">def</span> <span class="nf">thresholdZAndTrend</span><span class="p">(</span>
    <span class="n">zAndTrendCollection</span><span class="p">,</span>
    <span class="n">zThresh</span><span class="p">,</span>
    <span class="n">slopeThresh</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">negativeOrPositiveChange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">negativeOrPositiveChange</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">negativeOrPositiveChange</span> <span class="o">=</span> <span class="s2">&quot;negative&quot;</span>

    <span class="k">if</span> <span class="n">negativeOrPositiveChange</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">zCollection</span> <span class="o">=</span> <span class="n">zAndTrendCollection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_Z&quot;</span><span class="p">)</span>
    <span class="n">trendCollection</span> <span class="o">=</span> <span class="n">zAndTrendCollection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_slope&quot;</span><span class="p">)</span>

    <span class="n">zChange</span> <span class="o">=</span> <span class="n">thresholdChange</span><span class="p">(</span><span class="n">zCollection</span><span class="p">,</span> <span class="o">-</span><span class="n">zThresh</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_change&quot;</span><span class="p">)</span>
    <span class="n">trendChange</span> <span class="o">=</span> <span class="n">thresholdChange</span><span class="p">(</span><span class="n">trendCollection</span><span class="p">,</span> <span class="o">-</span><span class="n">slopeThresh</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_change&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">zChange</span><span class="p">,</span> <span class="n">trendChange</span><span class="p">]</span>


<span class="c1">###################################################################################</span>
<span class="c1"># ------------------- BEGIN CCDC Helper Functions -------------------#</span>
<span class="c1">###################################################################################</span>
<span class="c1"># Function to predict a CCDC harmonic model at a given time</span>
<span class="c1"># The whichHarmonics options are [1,2,3] - denoting which harmonics to include</span>
<span class="c1"># Which bands is a list of the names of the bands to predict across</span>
<span class="k">def</span> <span class="nf">simpleCCDCPrediction</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">timeBandName</span><span class="p">,</span> <span class="n">whichHarmonics</span><span class="p">,</span> <span class="n">whichBands</span><span class="p">):</span>
    <span class="c1"># Unit of each harmonic (1 cycle)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="c1"># Pull out the time band in the yyyy.ff format</span>
    <span class="n">tBand</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">timeBandName</span><span class="p">])</span>

    <span class="c1"># Pull out the intercepts and slopes</span>
    <span class="n">intercepts</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_INTP&quot;</span><span class="p">])</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_SLP&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tBand</span><span class="p">)</span>

    <span class="c1"># Set up the omega for each harmonic for the given time band</span>
    <span class="n">tOmega</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">whichHarmonics</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tBand</span><span class="p">)</span>
    <span class="n">cosHarm</span> <span class="o">=</span> <span class="n">tOmega</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">sinHarm</span> <span class="o">=</span> <span class="n">tOmega</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>

    <span class="c1"># Set up which harmonics to select</span>

    <span class="n">harmSelect</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">whichHarmonics</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">()))</span>

    <span class="c1"># Select the harmonics specified</span>
    <span class="n">sins</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_SIN.*&quot;</span><span class="p">])</span>
    <span class="n">sins</span> <span class="o">=</span> <span class="n">sins</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">harmSelect</span><span class="p">)</span>
    <span class="n">coss</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_COS.*&quot;</span><span class="p">])</span>
    <span class="n">coss</span> <span class="o">=</span> <span class="n">coss</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">harmSelect</span><span class="p">)</span>

    <span class="c1"># Set up final output band names</span>
    <span class="n">outBns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">whichBands</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_CCDC_fitted&quot;</span><span class="p">))</span>

    <span class="c1"># Iterate across each band and predict value</span>
    <span class="k">def</span> <span class="nf">predHelper</span><span class="p">(</span><span class="n">bn</span><span class="p">):</span>
        <span class="n">bn</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">intercepts</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">)),</span>
                <span class="n">slopes</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">)),</span>
                <span class="n">sins</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sinHarm</span><span class="p">),</span>
                <span class="n">coss</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">cosHarm</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">predicted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">predHelper</span><span class="p">,</span> <span class="n">whichBands</span><span class="p">)))</span><span class="o">.</span><span class="n">toBands</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outBns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>


<span class="c1">###################################################################################</span>
<span class="c1"># Wrapper to predict CCDC values from a collection containing a time image and ccdc coeffs</span>
<span class="c1"># It is also assumed that the time format is yyyy.ff where the .ff is the proportion of the year</span>
<span class="c1"># The whichHarmonics options are [1,2,3] - denoting which harmonics to include</span>
<span class="k">def</span> <span class="nf">simpleCCDCPredictionWrapper</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">timeBandName</span><span class="p">,</span> <span class="n">whichHarmonics</span><span class="p">):</span>
    <span class="n">whichBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_INTP&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">whichBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">whichBands</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">frequencyHistogram</span><span class="p">()))</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">simpleCCDCPrediction</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">timeBandName</span><span class="p">,</span> <span class="n">whichHarmonics</span><span class="p">,</span> <span class="n">whichBands</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1">###################################################################################</span>
<span class="c1">###################################################################################</span>
<span class="c1"># Function to get the coeffs corresponding to a given date on a pixel-wise basis</span>
<span class="c1"># The raw CCDC image is expected</span>
<span class="c1"># It is also assumed that the time format is yyyy.ff where the .ff is the proportion of the year</span>
<span class="k">def</span> <span class="nf">getCCDCSegCoeffs</span><span class="p">(</span><span class="n">timeImg</span><span class="p">,</span> <span class="n">ccdcImg</span><span class="p">,</span> <span class="n">fillGaps</span><span class="p">):</span>
    <span class="n">coeffKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.*_coefs&quot;</span><span class="p">]</span>
    <span class="n">tStartKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tStart&quot;</span><span class="p">]</span>
    <span class="n">tEndKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tEnd&quot;</span><span class="p">]</span>
    <span class="n">tBreakKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tBreak&quot;</span><span class="p">]</span>

    <span class="c1"># Get coeffs and find how many bands have coeffs</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coeffKeys</span><span class="p">)</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">nBns</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="n">harmonicTag</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s2">&quot;INTP&quot;</span><span class="p">,</span> <span class="s2">&quot;SLP&quot;</span><span class="p">,</span> <span class="s2">&quot;COS1&quot;</span><span class="p">,</span> <span class="s2">&quot;SIN1&quot;</span><span class="p">,</span> <span class="s2">&quot;COS2&quot;</span><span class="p">,</span> <span class="s2">&quot;SIN2&quot;</span><span class="p">,</span> <span class="s2">&quot;COS3&quot;</span><span class="p">,</span> <span class="s2">&quot;SIN3&quot;</span><span class="p">])</span>

    <span class="c1"># Get coeffs, start and end times</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tStarts</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tStartKeys</span><span class="p">)</span>
    <span class="n">tEnds</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tEndKeys</span><span class="p">)</span>
    <span class="n">tBreaks</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tBreakKeys</span><span class="p">)</span>

    <span class="c1"># If filling to the tBreak, use this</span>
    <span class="n">tStarts</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
            <span class="n">fillGaps</span><span class="p">,</span>
            <span class="n">tStarts</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">tBreaks</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">tStarts</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">tEnds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
            <span class="n">fillGaps</span><span class="p">,</span>
            <span class="n">tBreaks</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">tEnds</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">tEnds</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Set up a mask for segments that the time band intersects</span>
    <span class="n">tMask</span> <span class="o">=</span> <span class="n">tStarts</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">timeImg</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">tEnds</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">timeImg</span><span class="p">))</span><span class="o">.</span><span class="n">arrayRepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayRepeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">tMask</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arrayTranspose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([</span><span class="n">bns</span><span class="p">,</span> <span class="n">harmonicTag</span><span class="p">])</span>

    <span class="c1"># If time band doesn&#39;t intersect any segments, set it to null</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">timeImg</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>


<span class="c1">###################################################################################</span>
<span class="c1"># Functions to get yearly ccdc coefficients.</span>
<span class="c1">#</span>
<span class="c1"># Get CCDC coefficients for each year.</span>
<span class="c1"># yearStartMonth and yearStartDay are the date that you want the CCDC &quot;year&quot; to start at. This is mostly important for Annualized CCDC.</span>
<span class="c1"># For CONUS &amp; COASTAL AK LCMS, this is Sept. 1. So any change that occurs before Sept 1 in that year will be counted in that year, and Sept. 1 and after</span>
<span class="c1"># will be counted in the following year.</span>
<span class="c1"># 10/21 LSC Added Capability to use pixel-wise Composite Dates instead of set dates.</span>
<span class="c1"># If used, set annualizeWithCompositeDates to True and provide imported/prepped composite image collection with &#39;year&#39; and &#39;julianDay&#39; bands</span>
<span class="c1"># Optionally, if there are holes in the composite dates, they can be interpolated using linear interpolation across time</span>
<span class="k">def</span> <span class="nf">annualizeCCDC</span><span class="p">(</span>
    <span class="n">ccdcImg</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">tEndExtrapolationPeriod</span><span class="p">,</span>
    <span class="n">yearStartMonth</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
    <span class="n">yearStartDay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">annualizeWithCompositeDates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">compositeCollection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">interpolateCompositeDates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># Create image collection of images with the proper time stamp as well as a &#39;year&#39; band with the year fraction.</span>
    <span class="k">if</span> <span class="n">annualizeWithCompositeDates</span> <span class="ow">and</span> <span class="n">compositeCollection</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timeImgs</span> <span class="o">=</span> <span class="n">getTimeImageCollectionFromComposites</span><span class="p">(</span><span class="n">compositeCollection</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">interpolateCompositeDates</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timeImgs</span> <span class="o">=</span> <span class="n">getTimeImageCollection</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">yearStartMonth</span><span class="p">,</span> <span class="n">yearStartDay</span><span class="p">)</span>

    <span class="c1"># If selected, add a constant amount of time to last end segment to make sure the last year is annualized correctly.</span>
    <span class="c1"># tEndExtrapolationPeriod should be a fraction of a year.</span>
    <span class="n">finalTEnd</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;tEnd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;tEnd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">arrayGet</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tEndExtrapolationPeriod</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tEnds</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;tEnd&quot;</span><span class="p">)</span>
    <span class="n">tEnds</span> <span class="o">=</span> <span class="n">tEnds</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">finalTEnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;tEnd&quot;</span><span class="p">)</span>
    <span class="n">ccdcImg</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tEnds</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Loop through time image collection and grab the correct CCDC coefficients</span>
    <span class="n">annualSegCoeffs</span> <span class="o">=</span> <span class="n">timeImgs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">getCCDCSegCoeffs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ccdcImg</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">annualSegCoeffs</span>


<span class="c1"># Using annualized time series, get fitted values and slopes from fitted values.</span>
<span class="k">def</span> <span class="nf">getFitSlopeCCDC</span><span class="p">(</span><span class="n">annualSegCoeffs</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">):</span>
    <span class="c1"># Predict across each time image</span>
    <span class="n">whichBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">annualSegCoeffs</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_INTP&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">whichBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">whichBands</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">frequencyHistogram</span><span class="p">()))</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">annualSegCoeffs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">simpleCCDCPredictionAnnualized</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">whichBands</span><span class="p">))</span>

    <span class="c1"># Get back-casted slope using the fitted values</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rightYear</span><span class="p">:</span> <span class="n">yearlySlope</span><span class="p">(</span><span class="n">rightYear</span><span class="p">,</span> <span class="n">fitted</span><span class="p">)))</span>

    <span class="c1"># Rename bands</span>
    <span class="n">bandNames</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">newBandNames</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="s2">&quot;CCDC&quot;</span><span class="p">))</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandNames</span><span class="p">,</span> <span class="n">newBandNames</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">diff</span>


<span class="k">def</span> <span class="nf">yearlySlope</span><span class="p">(</span><span class="n">rightYear</span><span class="p">,</span> <span class="n">fitted</span><span class="p">):</span>
    <span class="n">leftYear</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">rightYear</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rightFitted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">fitted</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">rightYear</span><span class="p">,</span> <span class="n">rightYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="n">leftFitted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">fitted</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">leftYear</span><span class="p">,</span> <span class="n">leftYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="n">slopeNames</span> <span class="o">=</span> <span class="n">rightFitted</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_fitted&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_fitted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_fitSlope&quot;</span><span class="p">)))</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">rightFitted</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_fitted&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">leftFitted</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_fitted&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">slopeNames</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rightFitted</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>


<span class="c1"># This function is ALMOST the same as simpleCCDCPrediction(), except that you don&#39;t use the harmonic coefficients, just the slope and intercept.</span>
<span class="c1"># This is necessary if using a pixel-wise composite date method instead of one consistent date for annualization.</span>
<span class="k">def</span> <span class="nf">simpleCCDCPredictionAnnualized</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">timeBandName</span><span class="p">,</span> <span class="n">whichBands</span><span class="p">):</span>

    <span class="c1"># Pull out the time band in the yyyy.ff format</span>
    <span class="n">tBand</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">timeBandName</span><span class="p">])</span>

    <span class="c1"># Pull out the intercepts and slopes</span>
    <span class="n">intercepts</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_INTP&quot;</span><span class="p">])</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;.*_SLP&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tBand</span><span class="p">)</span>

    <span class="c1"># Set up final output band names</span>
    <span class="n">outBns</span> <span class="o">=</span> <span class="n">whichBands</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_CCDC_fitted&quot;</span><span class="p">))</span>

    <span class="c1"># Iterate across each band and predict value</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span>
            <span class="n">whichBands</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">intercepts</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">)),</span>
                        <span class="n">slopes</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">)),</span>
                    <span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">toBands</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outBns</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>


<span class="c1">###################################################################################</span>
<span class="c1"># Wrapper function for predicting CCDC across a set of time images</span>
<div class="viewcode-block" id="predictCCDC">
<a class="viewcode-back" href="../../modules.html#geeViz.changeDetectionLib.predictCCDC">[docs]</a>
<span class="k">def</span> <span class="nf">predictCCDC</span><span class="p">(</span>
    <span class="n">ccdcImg</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
    <span class="n">timeImgs</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span>
    <span class="n">fillGaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">whichHarmonics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="n">featherStartYr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2015</span><span class="p">,</span>
    <span class="n">featherEndYr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes one or two raw CCDC `ee.Image` array outputs, an `ee.ImageCollection` of time images, and returns a time-series `ee.ImageCollection` with harmonic coefficients and fitted values</span>

<span class="sd">    Args:</span>
<span class="sd">        ccdcImg (list[ee.Image, ee.Image] | ee.Image): A raw CCDC `ee.Image` array or list of two raw CCDC `ee.Image` arrays. If a list of 2 images is provided, feathering will automatically be performed. Note that any pixel that is null in either CCDC image will result in a null value in the predicted output.</span>
<span class="sd">        timeImgs (ee.ImageCollection): An `ee.ImageCollection` of time images usually from functions such as `simpleGetTimeImageCollection`.</span>
<span class="sd">        fillGaps (bool, optional): Whether to fill gaps between segments. If false, outputs can have blank values mid time-series. Defaults to True.</span>
<span class="sd">        whichHarmonics (list[int], optional): Which harmonics to include in fitted outputs forreturned time-series. Defaults to [1,2,3].</span>
<span class="sd">        featherStartYear (int, optional): If a list of 2 images is provided as `ccdcImg`, this is the first year of the window used for feathering the two time-series together. Defaults to 2015.</span>
<span class="sd">        featherEndYear (int, optional): If a list of 2 images is provided as `ccdcImg`, this is the last year (inclusive) of the window used for feathering the two time-series together. Defaults to 2021.</span>


<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of CCDC coefficients and fitted values.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.changeDetectionLib as cdl</span>
<span class="sd">    &gt;&gt;&gt; Map = cdl.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = cdl.ee</span>
<span class="sd">    &gt;&gt;&gt; ccdcBandNames = [&quot;tStart&quot;, &quot;tEnd&quot;, &quot;tBreak&quot;, &quot;changeProb&quot;, &quot;swir1.*&quot;, &quot;NDVI.*&quot;]</span>
<span class="sd">    &gt;&gt;&gt; timeImgs = cdl.simpleGetTimeImageCollection(startYear=1984, endYear=2024, startJulian=1, endJulian=365, step=0.1)</span>
<span class="sd">    &gt;&gt;&gt; ccdcImg1 = ee.ImageCollection(&quot;projects/lcms-292214/assets/CONUS-LCMS/Base-Learners/CCDC-Collection-1984-2022&quot;).select(ccdcBandNames).mosaic()</span>
<span class="sd">    &gt;&gt;&gt; ccdcImg2 = ee.ImageCollection(&quot;projects/lcms-292214/assets/CONUS-LCMS/Base-Learners/CCDC-Feathered-Collection&quot;).select(ccdcBandNames).mosaic()</span>
<span class="sd">    &gt;&gt;&gt; fittedFeathered = cdl.predictCCDC(ccdcImg=[ccdcImg1, ccdcImg2], timeImgs=timeImgs, fillGaps=True, whichHarmonics=[1, 2, 3], featherStartYr=2015, featherEndYr=2021)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(fittedFeathered.select([&quot;.*_CCDC_fitted&quot;]), {&quot;reducer&quot;: ee.Reducer.mean(), &quot;min&quot;: 0.3, &quot;max&quot;: 0.8}, &quot;Combined CCDC&quot;, True)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.setCenter(-88, 36, 12)</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timeBandName</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">timeImgs</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ccdcImg</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
        <span class="n">ccdcCoeffs1</span> <span class="o">=</span> <span class="n">timeImgs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">getCCDCSegCoeffs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ccdcImg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fillGaps</span><span class="p">))</span>
        <span class="n">ccdcCoeffs2</span> <span class="o">=</span> <span class="n">timeImgs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">getCCDCSegCoeffs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ccdcImg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fillGaps</span><span class="p">))</span>
        <span class="n">ccdcCoeffsCombined</span> <span class="o">=</span> <span class="n">batchFeatherCCDCImgs</span><span class="p">(</span><span class="n">ccdcCoeffs1</span><span class="p">,</span> <span class="n">ccdcCoeffs2</span><span class="p">,</span> <span class="n">featherStartYr</span><span class="p">,</span> <span class="n">featherEndYr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ccdcCoeffsCombined</span> <span class="o">=</span> <span class="n">timeImgs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">getCCDCSegCoeffs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ccdcImg</span><span class="p">,</span> <span class="n">fillGaps</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">simpleCCDCPredictionWrapper</span><span class="p">(</span><span class="n">ccdcCoeffsCombined</span><span class="p">,</span> <span class="n">timeBandName</span><span class="p">,</span> <span class="n">whichHarmonics</span><span class="p">)</span></div>



<span class="c1">###################################################################################</span>
<span class="c1"># Function for getting a set of time images</span>
<span class="c1"># This is generally used for methods such as CCDC</span>
<span class="c1"># yearStartMonth and yearStartDay are the date that you want the CCDC &quot;year&quot; to start at. This is mostly important for Annualized CCDC.</span>
<span class="c1"># For LCMS, this is Sept. 1. So any change that occurs before Sept 1 in that year will be counted in that year, and Sept. 1 and after</span>
<span class="c1"># will be counted in the following year.</span>
<span class="k">def</span> <span class="nf">getTimeImageCollection</span><span class="p">(</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span>
    <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">yearStartMonth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">yearStartDay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">getYrImage</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

    <span class="n">monthDayFraction</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">yearStartMonth</span><span class="p">,</span> <span class="n">yearStartDay</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;DDD&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>
    <span class="n">yearImages</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">monthDayFraction</span><span class="p">),</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">monthDayFraction</span><span class="p">),</span>
            <span class="n">step</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getYrImage</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">yearImages</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>


<span class="c1"># Rework of above function to be impler and less buggy for small steps</span>
<span class="c1"># This method ensures the startJulian is the start for each year, regardless of step interval</span>
<div class="viewcode-block" id="simpleGetTimeImageCollection">
<a class="viewcode-back" href="../../modules.html#geeViz.changeDetectionLib.simpleGetTimeImageCollection">[docs]</a>
<span class="k">def</span> <span class="nf">simpleGetTimeImageCollection</span><span class="p">(</span>
    <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">365</span><span class="p">,</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a time series of year and decimal days `ee.ImageCollection`. This is useful for CCDC predictions</span>

<span class="sd">    Args:</span>
<span class="sd">        startYear (int): The starting year for returned time-series.</span>
<span class="sd">        endYear (int): The ending year for the returned time-series.</span>
<span class="sd">        startJulian (int): The starting Julian day of year for returned time-series (1-365).</span>
<span class="sd">        endJulian (int): The ending Julian day of year for returned time-series (1-365).</span>
<span class="sd">        step (float, optional): Fraction of a year for each output in returned time-series (~0.01-1). Defaults to 0.1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of time images.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.changeDetectionLib as cdl</span>
<span class="sd">    &gt;&gt;&gt; Map = cdl.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = cdl.ee</span>
<span class="sd">    &gt;&gt;&gt; timeImgs = cdl.simpleGetTimeImageCollection(startYear = 1984, endYear = 2024, startJulian = 1, endJulian = 365, step = 0.1)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(timeImgs, {}, &quot;Time Images&quot;, True)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startDayFraction</span> <span class="o">=</span> <span class="n">startJulian</span> <span class="o">/</span> <span class="mi">365</span>
    <span class="n">endDayFraction</span> <span class="o">=</span> <span class="n">endJulian</span> <span class="o">/</span> <span class="mi">365</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">years</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">startDayFraction</span><span class="p">),</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">endDayFraction</span><span class="p">),</span> <span class="n">step</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getYrImage</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

    <span class="n">yearImages</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getYrImage</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">yearImages</span></div>



<span class="c1"># This creates an image collection in the same format as getTimeImageCollection(), but gets the pixel-wise dates from a composite collection</span>
<span class="c1"># Composite collection should be an imported and prepped image collection with &#39;julianDay&#39; and &#39;year&#39; bands</span>
<span class="c1"># def getTimeImageCollectionFromComposites(startJulian, endJulian, compositeCollection):</span>
<span class="c1">## Account for date wrapping. If julian day is less than startJulian, add one year.</span>
<span class="c1">## For PRUSVI CCDC, Year 2020 is day 152 2020 to day 151 2021</span>
<span class="c1">## For CONUS CCDC, Year 2020 is day 1 2020 to day 365 2020, so it will never be less.</span>
<span class="c1"># def getWrappedFraction(jDay):</span>
<span class="c1"># fraction = jDay.divide(365)</span>
<span class="c1"># nextYearMask = jDay.lte(ee.Image.constant(startJulian))</span>
<span class="c1"># thisYearMask = nextYearMask.Not()</span>
<span class="c1"># nextYearFraction = fraction.updateMask(nextYearMask).add(1)</span>
<span class="c1"># thisYearFraction = fraction.updateMask(thisYearMask)</span>
<span class="c1"># fraction = nextYearFraction.addBands(thisYearFraction).reduce(ee.Reducer.max())</span>
<span class="c1"># return fraction</span>
<span class="c1"># medianFraction = compositeCollection.select(&#39;julianDay&#39;)\</span>
<span class="c1"># .map(lambda jDay: getWrappedFraction(jDay))\</span>
<span class="c1"># .reduce(ee.Reducer.median())</span>

<span class="c1"># def getYearTimeImage(dateImg):</span>
<span class="c1">## Get Unmasked values</span>
<span class="c1"># newDateImg = ee.Image(dateImg.select(&#39;year&#39;).add(dateImg.select(&#39;julianDay&#39;).divide(365))).copyProperties(dateImg, [&#39;system:time_start&#39;])</span>

<span class="c1">## Create values for masked pixels</span>
<span class="c1"># imgYear = dateImg.date().get(&#39;year&#39;);</span>
<span class="c1"># medianValues = ee.Image.constant(imgYear).float().add(ee.Image(medianFraction)).rename(&#39;median_values&#39;);</span>

<span class="c1">## Fill masked Values with median fraction</span>
<span class="c1"># compositeMask = ee.Image(newDateImg).mask()</span>
<span class="c1"># out = ee.Image(newDateImg)\</span>
<span class="c1"># .addBands(medianValues.updateMask(compositeMask.Not()))\</span>
<span class="c1"># .reduce(ee.Reducer.max())\</span>
<span class="c1"># .rename(&#39;year&#39;)\</span>
<span class="c1"># .copyProperties(dateImg, [&#39;system:time_start&#39;]);</span>

<span class="c1"># return out</span>
<span class="c1"># yearImages = compositeCollection.map(lambda dateImg: getYearTimeImage(dateImg))</span>

<span class="c1"># return yearImages</span>


<span class="c1"># def getTimeImageCollectionFromComposites(startJulian, endJulian, compositeCollection):</span>
<span class="c1">#   dates = compositeCollection.map(lambda img:img.select([&#39;year&#39;]).add(img.select([&#39;julianDay&#39;]).divide(365)).float().copyProperties(img,[&#39;system:time_start&#39;]))</span>
<span class="c1">#   nYears = dates.size().getInfo()</span>
<span class="c1">#   interpolated = linearInterp(dates, 365*nYears, -32768)</span>
<span class="c1">#   return interpolated</span>
<span class="k">def</span> <span class="nf">getTimeImageCollectionFromComposites</span><span class="p">(</span>
    <span class="n">compositeCollection</span><span class="p">,</span>
    <span class="n">startYear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">endYear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">useNewInterpMethod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">compositeCollection</span> <span class="o">=</span> <span class="n">compositeCollection</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">startYear</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">startYear</span> <span class="o">=</span> <span class="n">compositeCollection</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found start year: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startYear</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">endYear</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">endYear</span> <span class="o">=</span> <span class="n">compositeCollection</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found end year: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">endYear</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()))</span>

    <span class="n">dates</span> <span class="o">=</span> <span class="n">compositeCollection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;julianDay&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">365</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">]))</span>
    <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">datesFilled</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)),</span> <span class="n">dummyImage</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())))</span>

    <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating composite time images&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">useNewInterpMethod</span><span class="p">:</span>
            <span class="n">nYears</span> <span class="o">=</span> <span class="n">datesFilled</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
            <span class="c1"># print(nYears,endYear.getInfo()-startYear.getInfo())</span>
            <span class="k">return</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">datesFilled</span><span class="p">,</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">nYears</span><span class="p">,</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_interp_date_collection</span><span class="p">(</span><span class="n">datesFilled</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datesFilled</span>


<span class="c1">###################################################################################</span>
<div class="viewcode-block" id="ccdcChangeDetection">
<a class="viewcode-back" href="../../modules.html#geeViz.changeDetectionLib.ccdcChangeDetection">[docs]</a>
<span class="k">def</span> <span class="nf">ccdcChangeDetection</span><span class="p">(</span><span class="n">ccdcImg</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">bandName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">startYear</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">endYear</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for getting change years and magnitudes for a specified band from CCDC outputs</span>
<span class="sd">    Only change from the breaks is extracted. As of now, if a segment has a high slope value, this method will not extract that.</span>
<span class="sd">    If combining two CCDC raw outputs provide them as a list of two images for the `ccdcImg` parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccdcImg (list[ee.Image, ee.Image] | ee.Image): A raw CCDC `ee.Image` array or list of two raw CCDC `ee.Image` arrays. If a list of 2 images is provided, they will automatically be combined.</span>
<span class="sd">        bandName (str): The band name to use for magnitude of change.</span>
<span class="sd">        startYear (None | int): The start of the time window. If left as None, all years in the input CCDC images will be included. Defaults to None.</span>
<span class="sd">        endYear (None | int): The end of the time window (inclusive). If left as None, all years in the input CCDC images will be included. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary of various CCDC change metrics.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.changeDetectionLib as cdl</span>
<span class="sd">    &gt;&gt;&gt; Map = cdl.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = cdl.ee</span>
<span class="sd">    &gt;&gt;&gt; changeDetectionBandName = &quot;NDVI&quot;</span>
<span class="sd">    &gt;&gt;&gt; ccdcChangeBandNames = [&quot;tBreak&quot;, &quot;changeProb&quot;, f&quot;{changeDetectionBandName}.*&quot;]</span>
<span class="sd">    &gt;&gt;&gt; sortingMethod = &quot;mostRecent&quot;</span>
<span class="sd">    &gt;&gt;&gt; ccdcImg1 = ee.ImageCollection(&quot;projects/lcms-292214/assets/CONUS-LCMS/Base-Learners/CCDC-Collection-1984-2022&quot;).select(ccdcChangeBandNames).mosaic()</span>
<span class="sd">    &gt;&gt;&gt; ccdcImg2 = ee.ImageCollection(&quot;projects/lcms-292214/assets/CONUS-LCMS/Base-Learners/CCDC-Feathered-Collection&quot;).select(ccdcChangeBandNames).mosaic()</span>
<span class="sd">    &gt;&gt;&gt; changeObjCombined = cdl.ccdcChangeDetection([ccdcImg1, ccdcImg2], changeDetectionBandName)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(changeObjCombined[sortingMethod][&quot;loss&quot;][&quot;year&quot;], {&quot;min&quot;: 1984, &quot;max&quot;: 2024, &quot;palette&quot;: cdl.lossYearPalette}, &quot;Loss Year&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(changeObjCombined[sortingMethod][&quot;loss&quot;][&quot;mag&quot;], {&quot;min&quot;: -0.5, &quot;max&quot;: -0.1, &quot;palette&quot;: cdl.lossMagPalette}, &quot;Loss Mag&quot;, False)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(changeObjCombined[sortingMethod][&quot;gain&quot;][&quot;year&quot;], {&quot;min&quot;: 1984, &quot;max&quot;: 2024, &quot;palette&quot;: cdl.gainYearPalette}, &quot;Gain Year&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(changeObjCombined[sortingMethod][&quot;gain&quot;][&quot;mag&quot;], {&quot;min&quot;: 0.05, &quot;max&quot;: 0.2, &quot;palette&quot;: cdl.gainMagPalette}, &quot;Gain Mag&quot;, False)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.setCenter(-88, 36, 12)</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">magKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.*_magnitude&quot;</span><span class="p">]</span>
    <span class="n">tBreakKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tBreak&quot;</span><span class="p">]</span>
    <span class="n">changeProbKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;changeProb&quot;</span><span class="p">]</span>
    <span class="n">changeProbThresh</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">changeBands</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bandName</span><span class="si">}</span><span class="s2">_magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;tBreak&quot;</span><span class="p">,</span> <span class="s2">&quot;changeProb&quot;</span><span class="p">]</span>

    <span class="c1"># Combine ccdc images if two are provided</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ccdcImg</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
        <span class="n">ccdcImg</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">changeBands</span><span class="p">)</span><span class="o">.</span><span class="n">arrayCat</span><span class="p">(</span><span class="n">ccdcImg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">changeBands</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Pull out pieces from CCDC output</span>
    <span class="n">magnitudes</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">magKeys</span><span class="p">)</span>
    <span class="n">breaks</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tBreakKeys</span><span class="p">)</span>

    <span class="c1"># Map.addLayer(breaks.arrayLength(0),{&#39;min&#39;:1,&#39;max&#39;:10});</span>
    <span class="n">changeProbs</span> <span class="o">=</span> <span class="n">ccdcImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">changeProbKeys</span><span class="p">)</span>
    <span class="n">changeMask</span> <span class="o">=</span> <span class="n">changeProbs</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">changeProbThresh</span><span class="p">)</span>
    <span class="n">magnitudes</span> <span class="o">=</span> <span class="n">magnitudes</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandName</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>

    <span class="c1"># Sort by magnitude and years</span>
    <span class="n">breaksSortedByMag</span> <span class="o">=</span> <span class="n">breaks</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span>
    <span class="n">magnitudesSortedByMag</span> <span class="o">=</span> <span class="n">magnitudes</span><span class="o">.</span><span class="n">arraySort</span><span class="p">()</span>
    <span class="n">changeMaskSortedByMag</span> <span class="o">=</span> <span class="n">changeMask</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span>

    <span class="n">breaksSortedByYear</span> <span class="o">=</span> <span class="n">breaks</span><span class="o">.</span><span class="n">arraySort</span><span class="p">()</span>
    <span class="n">magnitudesSortedByYear</span> <span class="o">=</span> <span class="n">magnitudes</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span>
    <span class="n">changeMaskSortedByYear</span> <span class="o">=</span> <span class="n">changeMask</span><span class="o">.</span><span class="n">arraySort</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span>

    <span class="c1"># Get the loss and gain years and magnitudes for each sorting method</span>
    <span class="n">highestMagLossYear</span> <span class="o">=</span> <span class="n">breaksSortedByMag</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;loss_year&quot;</span><span class="p">]])</span>
    <span class="n">highestMagLossMag</span> <span class="o">=</span> <span class="n">magnitudesSortedByMag</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;loss_mag&quot;</span><span class="p">]])</span>
    <span class="n">highestMagLossMask</span> <span class="o">=</span> <span class="n">changeMaskSortedByMag</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;loss_mask&quot;</span><span class="p">]])</span>

    <span class="n">highestMagLossYear</span> <span class="o">=</span> <span class="n">highestMagLossYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagLossMag</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">highestMagLossMask</span><span class="p">))</span>
    <span class="n">highestMagLossMag</span> <span class="o">=</span> <span class="n">highestMagLossMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagLossMag</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">highestMagLossMask</span><span class="p">))</span>

    <span class="n">highestMagGainYear</span> <span class="o">=</span> <span class="n">breaksSortedByMag</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;gain_year&quot;</span><span class="p">]])</span>
    <span class="n">highestMagGainMag</span> <span class="o">=</span> <span class="n">magnitudesSortedByMag</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;gain_mag&quot;</span><span class="p">]])</span>
    <span class="n">highestMagGainMask</span> <span class="o">=</span> <span class="n">changeMaskSortedByMag</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;gain_mask&quot;</span><span class="p">]])</span>

    <span class="n">highestMagGainYear</span> <span class="o">=</span> <span class="n">highestMagGainYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagGainMag</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">highestMagGainMask</span><span class="p">))</span>
    <span class="n">highestMagGainMag</span> <span class="o">=</span> <span class="n">highestMagGainMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagGainMag</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">highestMagGainMask</span><span class="p">))</span>

    <span class="n">mostRecentLossYear</span> <span class="o">=</span> <span class="n">breaksSortedByYear</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">arrayPad</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;loss_year&quot;</span><span class="p">]])</span>
    <span class="n">mostRecentLossMag</span> <span class="o">=</span> <span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">arrayPad</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;loss_mag&quot;</span><span class="p">]])</span>
    <span class="n">mostRecentLossMask</span> <span class="o">=</span> <span class="n">changeMaskSortedByYear</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">arrayPad</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;loss_mask&quot;</span><span class="p">]])</span>

    <span class="n">mostRecentLossYear</span> <span class="o">=</span> <span class="n">mostRecentLossYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentLossMag</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">mostRecentLossMask</span><span class="p">))</span>
    <span class="n">mostRecentLossMag</span> <span class="o">=</span> <span class="n">mostRecentLossMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentLossMag</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">mostRecentLossMask</span><span class="p">))</span>

    <span class="n">mostRecentGainYear</span> <span class="o">=</span> <span class="n">breaksSortedByYear</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">arrayPad</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;gain_year&quot;</span><span class="p">]])</span>
    <span class="n">mostRecentGainMag</span> <span class="o">=</span> <span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">arrayPad</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;gain_mag&quot;</span><span class="p">]])</span>
    <span class="n">mostRecentGainMask</span> <span class="o">=</span> <span class="n">changeMaskSortedByYear</span><span class="o">.</span><span class="n">arrayMask</span><span class="p">(</span><span class="n">magnitudesSortedByYear</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">arrayPad</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;gain_mask&quot;</span><span class="p">]])</span>

    <span class="n">mostRecentGainYear</span> <span class="o">=</span> <span class="n">mostRecentGainYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentGainMag</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">mostRecentGainMask</span><span class="p">))</span>
    <span class="n">mostRecentGainMag</span> <span class="o">=</span> <span class="n">mostRecentGainMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentGainMag</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">mostRecentGainMask</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">startYear</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">endYear</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mostRecentLossYearMask</span> <span class="o">=</span> <span class="n">mostRecentLossYear</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">mostRecentLossYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">endYear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">mostRecentGainYearMask</span> <span class="o">=</span> <span class="n">mostRecentGainYear</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">mostRecentGainYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">endYear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">highestMagLossYearMask</span> <span class="o">=</span> <span class="n">highestMagLossYear</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">highestMagLossYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">endYear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">highestMagGainYearMask</span> <span class="o">=</span> <span class="n">highestMagGainYear</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">startYear</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">highestMagGainYear</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">endYear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">mostRecentLossYear</span> <span class="o">=</span> <span class="n">mostRecentLossYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentLossYearMask</span><span class="p">)</span>
        <span class="n">mostRecentGainYear</span> <span class="o">=</span> <span class="n">mostRecentGainYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentGainYearMask</span><span class="p">)</span>
        <span class="n">highestMagLossYear</span> <span class="o">=</span> <span class="n">highestMagLossYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagLossYearMask</span><span class="p">)</span>
        <span class="n">highestMagGainYear</span> <span class="o">=</span> <span class="n">highestMagGainYear</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagGainYearMask</span><span class="p">)</span>

        <span class="n">mostRecentLossMag</span> <span class="o">=</span> <span class="n">mostRecentLossMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentLossYearMask</span><span class="p">)</span>
        <span class="n">mostRecentGainMag</span> <span class="o">=</span> <span class="n">mostRecentGainMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mostRecentGainYearMask</span><span class="p">)</span>
        <span class="n">highestMagLossMag</span> <span class="o">=</span> <span class="n">highestMagLossMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagLossYearMask</span><span class="p">)</span>
        <span class="n">highestMagGainMag</span> <span class="o">=</span> <span class="n">highestMagGainMag</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">highestMagGainYearMask</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mostRecent&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">mostRecentLossYear</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">:</span> <span class="n">mostRecentLossMag</span><span class="p">},</span>
            <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">mostRecentGainYear</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">:</span> <span class="n">mostRecentGainMag</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;highestMag&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">highestMagLossYear</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">:</span> <span class="n">highestMagLossMag</span><span class="p">},</span>
            <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">highestMagGainYear</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">:</span> <span class="n">highestMagGainMag</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span></div>



<span class="c1">###################################################################################</span>
<div class="viewcode-block" id="featherCCDCImgs">
<a class="viewcode-back" href="../../modules.html#geeViz.changeDetectionLib.featherCCDCImgs">[docs]</a>
<span class="k">def</span> <span class="nf">featherCCDCImgs</span><span class="p">(</span><span class="n">joinedCCDCImg</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">ccdcBnds</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">coeffs1_bns</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">coeffs2_bns</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">featherStartYr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">featherEndYr</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to feather two CCDC collections together based on overlapping data time periods and weights</span>
<span class="sd">    The feather years are the overlapping years between the two CCDC collections that are used in weighting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">joinedCCDCImg</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYY.DDD&quot;</span><span class="p">))</span>

    <span class="c1"># Find difference between end and start feather years for weighting in feathering</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">featherEndYr</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">featherStartYr</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="c1"># Weights that are used to feather ccdc collections together</span>
    <span class="c1"># The clamp ensures weights are constrained to range of feather years</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">featherStartYr</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">joinedCCDCImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coeffs1_bns</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">joinedCCDCImg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coeffs2_bns</span><span class="p">)</span>

    <span class="n">m1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span>

    <span class="n">w1</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

    <span class="n">w2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">w1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w2</span><span class="p">))</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ccdcBnds</span><span class="p">)</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">joinedCCDCImg</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span></div>



<span class="c1">###################################################################################</span>
<div class="viewcode-block" id="batchFeatherCCDCImgs">
<a class="viewcode-back" href="../../modules.html#geeViz.changeDetectionLib.batchFeatherCCDCImgs">[docs]</a>
<span class="k">def</span> <span class="nf">batchFeatherCCDCImgs</span><span class="p">(</span><span class="n">ccdcAnnualizedCol1</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">ccdcAnnualizedCol2</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">featherStartYr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">featherEndYr</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function to join annualized CCDC images from two different CCDC collections, and iterate across images and apply featherCCDCImgs function</span>
<span class="sd">    The feather years are the overlapping years between the two CCDC collections that are used in weighting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get coeffs band info and rename bands for joined Collection</span>
    <span class="n">coeffs1</span> <span class="o">=</span> <span class="n">ccdcAnnualizedCol1</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;.*_coefs_.*&quot;</span><span class="p">])</span>
    <span class="n">coeffs2</span> <span class="o">=</span> <span class="n">ccdcAnnualizedCol2</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;.*_coefs_.*&quot;</span><span class="p">])</span>

    <span class="n">bns</span> <span class="o">=</span> <span class="n">coeffs1</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">coeffs1_bns</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_1&quot;</span><span class="p">))</span>
    <span class="n">coeffs2_bns</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_2&quot;</span><span class="p">))</span>

    <span class="n">coeffs1</span> <span class="o">=</span> <span class="n">coeffs1</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">,</span> <span class="n">coeffs1_bns</span><span class="p">)</span>
    <span class="n">coeffs2</span> <span class="o">=</span> <span class="n">coeffs2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">,</span> <span class="n">coeffs2_bns</span><span class="p">)</span>

    <span class="c1"># Join CCDC images together for feathering</span>
    <span class="c1"># coeffs_joined = joinCollections(coeffs1, coeffs2)</span>
    <span class="n">coeffs_joined</span> <span class="o">=</span> <span class="n">coeffs1</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">coeffs2</span><span class="p">,</span> <span class="n">coeffs2_bns</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span>

    <span class="c1"># Apply featherCCDCImgs across images</span>
    <span class="n">ccdcCol_coeffs_avg</span> <span class="o">=</span> <span class="n">coeffs_joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">featherCCDCImgs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bns</span><span class="p">,</span> <span class="n">coeffs1_bns</span><span class="p">,</span> <span class="n">coeffs2_bns</span><span class="p">,</span> <span class="n">featherStartYr</span><span class="p">,</span> <span class="n">featherEndYr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ccdcCol_coeffs_avg</span></div>



<span class="c1">###################################################################################</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Ian Housman, Josh Heyer
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://www.redcastleresources.com/" aria-label="RedCastle Resources Inc"><img src='https://apps.fs.usda.gov/lcms-viewer/src/assets/images/RCR-logo.jpg'  alt='RedCastle Inc. Logo' href='#' title='Click to learn more about RedCastle Resources Inc.'></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=8e9e9f52"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>