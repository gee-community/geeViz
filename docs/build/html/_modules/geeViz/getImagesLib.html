<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>geeViz.getImagesLib - geeViz &#34;2024.11.3&#34; docs</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/style/custom.css?v=ebb50e13" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #00897b;
  --color-brand-content: #00897b;
  --font-stack: Roboto, sans-serif;
  --font-stack--monospace: Courier, monospace;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  --color-brand-primary: #00bfa5;
  --color-brand-content: #00bfa5;
  --font-stack: Roboto, sans-serif;
  --font-stack--monospace: Courier, monospace;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  --color-brand-primary: #00bfa5;
  --color-brand-content: #00bfa5;
  --font-stack: Roboto, sans-serif;
  --font-stack--monospace: Courier, monospace;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     <i>geeViz</i> docs are still in development 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">geeViz "2024.11.3" docs</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/RCR-logo.jpg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">geeViz "2024.11.3" docs</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../overview.html">Overview</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Overview</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.geeView.html">geeViz.geeView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.getImagesLib.html">geeViz.getImagesLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.changeDetectionLib.html">geeViz.changeDetectionLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.taskManagerLib.html">geeViz.taskManagerLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.assetManagerLib.html">geeViz.assetManagerLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.cloudStorageManagerLib.html">geeViz.cloudStorageManagerLib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.gee2Pandas.html">geeViz.gee2Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.foliumView.html">geeViz.foliumView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../info/geeViz.phEEnoViz.html">geeViz.phEEnoViz</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Details</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/geeViewExampleNotebook.html">Starter geeViz geeView Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/lcmsViewerExampleNotebook.html">LCMS Viewer Intro Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/Annual_NLCD_Viewer_Notebook.html">Annual NLCD <code class="docutils literal notranslate"><span class="pre">geeViz</span></code> Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/mapBiomasViewerExampleNotebook.html">Visualizing MapBiomas Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/dynamicWorldExampleNotebook.html">Visualizing Dynamic World</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/global_land_cover_example_notebook.html">Visualizing Global Land Cover</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/LCMAP_and_LCMS_Viewer_Notebook.html">LCMAP and LCMS Outputs Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/getLandsatWrapperNotebook.html">Create High Quality Landsat Composites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/areaChart_examples.html">Visualizing Area Summaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/geeViz_geeMap_comparison_tutorial.html">A comparison between geeViz and geeMap’s map visualization capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/LANDTRENDRWrapperNotebook.html">Run LandTrendr and Visualize Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/LCMAP_and_LCMS_Viewer_Notebook.html">LCMAP and LCMS Outputs Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/CCDCVizNotebook.html">CCDC Visualization Notebook</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for geeViz.getImagesLib</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Get images and organize them so they are easier to work with</span>

<span class="sd">geeViz.getImagesLib is the core module for setting up various imageCollections from GEE. Notably, it facilitates Landsat, Sentinel-2, and MODIS data organization. This module helps avoid many common mistakes in GEE. Most functions ease matching band names, ensuring resampling methods are properly set, date wrapping, and helping with cloud and cloud shadow masking. </span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Copyright 2024 Ian Housman</span>

<span class="sd">   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">   you may not use this file except in compliance with the License.</span>
<span class="sd">   You may obtain a copy of the License at</span>

<span class="sd">       http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">   Unless required by applicable law or agreed to in writing, software</span>
<span class="sd">   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="sd">   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="sd">   See the License for the specific language governing permissions and</span>
<span class="sd">   limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># %%</span>
<span class="c1"># Script to help with data prep, analysis, and delivery from GEE</span>
<span class="c1"># Intended to work within the geeViz package</span>
<span class="c1">######################################################################</span>
<span class="kn">from</span> <span class="nn">geeViz.geeView</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">geeViz.cloudStorageManagerLib</span> <span class="k">as</span> <span class="nn">cml</span>
<span class="kn">import</span> <span class="nn">geeViz.assetManagerLib</span> <span class="k">as</span> <span class="nn">aml</span>
<span class="kn">import</span> <span class="nn">geeViz.taskManagerLib</span> <span class="k">as</span> <span class="nn">tml</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">ee</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">pdb</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="c1"># %%</span>
<span class="c1">######################################################################</span>
<span class="c1"># Module for getting Landsat, Sentinel 2 and MODIS images/composites</span>
<span class="c1"># Define visualization parameters</span>
<span class="n">vizParamsFalse</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
    <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="s2">&quot;swir1,nir,red&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mf">1.6</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">vizParamsFalse10k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">],</span>
    <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="s2">&quot;swir1,nir,red&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mf">1.6</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">vizParamsTrue</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="s2">&quot;red,green,blue&quot;</span><span class="p">}</span>
<span class="n">vizParamsTrue10k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">],</span>
    <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="s2">&quot;red,green,blue&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">common_projections</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">common_projections</span><span class="p">[</span><span class="s2">&quot;NLCD_CONUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="s1">&#39;PROJCS[&quot;Albers_Conical_Equal_Area&quot;,GEOGCS[&quot;WGS 84&quot;,DATUM[&quot;WGS_1984&quot;,SPHEROID[&quot;WGS 84&quot;,6378137,298.257223563,AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],TOWGS84[0,0,0,0,0,0,0],AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]],PRIMEM[&quot;Greenwich&quot;,0,AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]],PROJECTION[&quot;Albers_Conic_Equal_Area&quot;],PARAMETER[&quot;latitude_of_center&quot;,23],PARAMETER[&quot;longitude_of_center&quot;,-96],PARAMETER[&quot;standard_parallel_1&quot;,29.5],PARAMETER[&quot;standard_parallel_2&quot;,45.5],PARAMETER[&quot;false_easting&quot;,0],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;meters&quot;,1],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH]]&#39;</span><span class="p">,</span>
    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2361915.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mf">3177735.0</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">common_projections</span><span class="p">[</span><span class="s2">&quot;NLCD_AK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="s1">&#39;PROJCS[&quot;Albers_Conical_Equal_Area&quot;,GEOGCS[&quot;WGS 84&quot;,DATUM[&quot;WGS_1984&quot;,SPHEROID[&quot;WGS 84&quot;,6378137,298.257223563,AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],TOWGS84[0,0,0,0,0,0,0],AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]],PRIMEM[&quot;Greenwich&quot;,0,AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9108&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]],PROJECTION[&quot;Albers_Conic_Equal_Area&quot;],PARAMETER[&quot;standard_parallel_1&quot;,55],PARAMETER[&quot;standard_parallel_2&quot;,65],PARAMETER[&quot;latitude_of_center&quot;,50],PARAMETER[&quot;longitude_of_center&quot;,-154],PARAMETER[&quot;false_easting&quot;,0],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;meters&quot;,1]]&#39;</span><span class="p">,</span>
    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">48915.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mf">1319415.0</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">common_projections</span><span class="p">[</span><span class="s2">&quot;NLCD_HI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="s1">&#39;PROJCS[&quot;Albers_Conical_Equal_Area&quot;,GEOGCS[&quot;WGS 84&quot;,DATUM[&quot;WGS_1984&quot;, SPHEROID[&quot;WGS 84&quot;, 6378137.0, 298.257223563, AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]], AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]], PRIMEM[&quot;Greenwich&quot;, 0.0], UNIT[&quot;degree&quot;, 0.017453292519943295], AXIS[&quot;Longitude&quot;, EAST], AXIS[&quot;Latitude&quot;, NORTH], AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]], PROJECTION[&quot;Albers_Conic_Equal_Area&quot;], PARAMETER[&quot;central_meridian&quot;, -157.0],PARAMETER[&quot;latitude_of_origin&quot;, 3.0],PARAMETER[&quot;standard_parallel_1&quot;, 8.0],PARAMETER[&quot;false_easting&quot;, 0.0],PARAMETER[&quot;false_northing&quot;, 0.0],PARAMETER[&quot;standard_parallel_2&quot;, 18.0],UNIT[&quot;m&quot;, 1.0],AXIS[&quot;x&quot;, EAST],AXIS[&quot;y&quot;, NORTH]]&#39;</span><span class="p">,</span>
    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">342585</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">2127135</span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Direction of  a decrease in photosynthetic vegetation- add any that are missing</span>
<span class="n">changeDirDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;blue&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;nir&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;swir1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;swir2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;temp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NDVI&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NBR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NDMI&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NDSI&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;brightness&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;greenness&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;wetness&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;fourth&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;fifth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;sixth&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_blue_green&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_blue_red&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_blue_nir&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_blue_swir1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_blue_swir2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_green_red&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_green_nir&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_green_swir1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_green_swir2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_red_swir1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_red_swir2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_nir_red&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_nir_swir1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_nir_swir2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ND_swir1_swir2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;R_swir1_nir&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;R_red_swir1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;EVI&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;SAVI&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;IBI&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;tcAngleBG&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;tcAngleGW&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;tcAngleBW&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;tcDistBG&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;tcDistGW&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;tcDistBW&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NIRv&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NDCI&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;NDGI&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># Precomputed cloudscore offsets and TDOM stats</span>
<span class="c1"># These have been pre-computed for all CONUS for Landsat and Setinel 2 (separately)</span>
<span class="c1"># and are appropriate to use for any time period within the growing season</span>
<span class="c1"># The cloudScore offset is generally some lower percentile of cloudScores on a pixel-wise basis</span>
<span class="c1"># The TDOM stats are the mean and standard deviations of the two bands used in TDOM</span>
<span class="c1"># By default, TDOM uses the nir and swir1 bands</span>
<span class="n">preComputedCloudScoreOffset</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;projects/lcms-tcc-shared/assets/CS-TDOM-Stats/cloudScore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mosaic</span><span class="p">()</span>
<span class="n">preComputedTDOMStats</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;projects/lcms-tcc-shared/assets/CS-TDOM-Stats/TDOM&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;endYear&quot;</span><span class="p">,</span> <span class="mi">2019</span><span class="p">))</span><span class="o">.</span><span class="n">mosaic</span><span class="p">()</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">getPrecomputedCloudScoreOffsets</span><span class="p">(</span><span class="n">cloudScorePctl</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;landsat&quot;</span><span class="p">:</span> <span class="n">preComputedCloudScoreOffset</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Landsat_CloudScore_p</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cloudScorePctl</span><span class="p">)]),</span>
        <span class="s2">&quot;sentinel2&quot;</span><span class="p">:</span> <span class="n">preComputedCloudScoreOffset</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Sentinel2_CloudScore_p</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cloudScorePctl</span><span class="p">)]),</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">getPrecomputedTDOMStats</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;landsat&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">preComputedTDOMStats</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Landsat_nir_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Landsat_swir1_mean&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;stdDev&quot;</span><span class="p">:</span> <span class="n">preComputedTDOMStats</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Landsat_nir_stdDev&quot;</span><span class="p">,</span> <span class="s2">&quot;Landsat_swir1_stdDev&quot;</span><span class="p">]),</span>
        <span class="p">},</span>
        <span class="s2">&quot;sentinel2&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">preComputedTDOMStats</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Sentinel2_nir_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Sentinel2_swir1_mean&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;stdDev&quot;</span><span class="p">:</span> <span class="n">preComputedTDOMStats</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Sentinel2_nir_stdDev&quot;</span><span class="p">,</span> <span class="s2">&quot;Sentinel2_swir1_stdDev&quot;</span><span class="p">]),</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="c1">######################################################################</span>
<span class="c1"># FUNCTIONS</span>
<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>
<span class="c1"># Function to asynchronously print ee objects</span>
<span class="k">def</span> <span class="nf">printEE</span><span class="p">(</span><span class="n">eeObject</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">printIt</span><span class="p">(</span><span class="n">eeObject</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">eeObject</span><span class="o">.</span><span class="n">getInfo</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">printIt</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">eeObject</span><span class="p">,))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>
<span class="c1"># Function to set null value for export or conversion to arrays</span>
<div class="viewcode-block" id="setNoData">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.setNoData">[docs]</a>
<span class="k">def</span> <span class="nf">setNoData</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">noDataValue</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets null values for an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image.</span>
<span class="sd">        noDataValue: The value to assign to null pixels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine image with null pixels set to the specified noDataValue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">noDataValue</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># .set(&#39;noDataValue&#39;, noDataValue)</span>
    <span class="k">return</span> <span class="n">image</span>  <span class="c1"># .set(args)</span></div>



<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>
<span class="c1"># Formats arguments as strings so can be easily set as properties</span>
<div class="viewcode-block" id="formatArgs">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.formatArgs">[docs]</a>
<span class="k">def</span> <span class="nf">formatArgs</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Formats arguments as strings for setting as image properties.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: A dictionary of arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary of formatted arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formattedArgs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)]:</span>
            <span class="n">formattedArgs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
            <span class="n">formattedArgs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">formattedArgs</span></div>



<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>
<span class="c1"># Functions to perform basic clump and elim</span>
<div class="viewcode-block" id="sieve">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.sieve">[docs]</a>
<span class="k">def</span> <span class="nf">sieve</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">mmu</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs clumping and elimination on an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image.</span>
<span class="sd">        mmu: The minimum mapping unit.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine image with clumping and elimination applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">connectedPixelCount</span><span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(connected,{&#39;min&#39;:1,&#39;max&#39;:mmu},&#39;connected&#39;)</span>
    <span class="n">elim</span> <span class="o">=</span> <span class="n">connected</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">mmu</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">focal_mode</span><span class="p">(</span><span class="n">mmu</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;circle&quot;</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span>
    <span class="n">filled</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elim</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filled</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;mmu&quot;</span><span class="p">,</span> <span class="n">mmu</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<span class="c1"># Written by Yang Z.</span>
<span class="c1"># ------ L8 to L7 HARMONIZATION FUNCTION -----</span>
<span class="c1"># slope and intercept citation: Roy, D.P., Kovalskyy, V., Zhang, H.K., Vermote, E.F., Yan, L., Kumar, S.S, Egorov, A., 2016, Characterization of Landsat-7 to Landsat-8 reflective wavelength and normalized difference vegetation index continuity, Remote Sensing of Environment, 185, 57-70.(http://dx.doi.org/10.1016/j.rse.2015.12.024); Table 2 - reduced major axis (RMA) regression coefficients</span>
<div class="viewcode-block" id="harmonizationRoy">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.harmonizationRoy">[docs]</a>
<span class="k">def</span> <span class="nf">harmonizationRoy</span><span class="p">(</span><span class="n">oli</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Harmonizes Landsat 8 OLI to Landsat 7 ETM+ using Roy et al. (2016) coefficients.</span>

<span class="sd">    Args:</span>
<span class="sd">        oli: A Landsat 8 OLI image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A harmonized Landsat 8 OLI image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">0.9785</span><span class="p">,</span> <span class="mf">0.9542</span><span class="p">,</span> <span class="mf">0.9825</span><span class="p">,</span> <span class="mf">1.0073</span><span class="p">,</span> <span class="mf">1.0171</span><span class="p">,</span> <span class="mf">0.9949</span><span class="p">])</span>  <span class="c1"># create an image of slopes per band for L8 TO L7 regression line - David Roy</span>
    <span class="n">itcp</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="o">-</span><span class="mf">0.0095</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0022</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0021</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0030</span><span class="p">,</span> <span class="mf">0.0029</span><span class="p">])</span>  <span class="c1"># create an image of y-intercepts per band for L8 TO L7 regression line - David Roy</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">oli</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">includeBns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">]</span>
    <span class="n">otherBns</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">includeBns</span><span class="p">)</span>

    <span class="c1"># create an image of y-intercepts per band for L8 TO L7 regression line - David Roy</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">oli</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">includeBns</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">itcp</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">oli</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">oli</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">otherBns</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></div>



<span class="c1">####################################################################</span>
<span class="c1"># Code to implement OLI/ETM/MSI regression</span>
<span class="c1"># Chastain et al 2018 coefficients</span>
<span class="c1"># Empirical cross sensor comparison of Sentinel-2A and 2B MSI, Landsat-8 OLI, and Landsat-7 ETM+ top of atmosphere spectral characteristics over the conterminous United States</span>
<span class="c1"># https://www.sciencedirect.com/science/article/pii/S0034425718305212#t0020</span>
<span class="c1"># Left out 8a coefficients since all sensors need to be cross- corrected with bands common to all sensors</span>
<span class="c1"># Dependent and Independent variables can be switched since Major Axis (Model 2) linear regression was used</span>
<span class="n">chastainBandNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">]</span>

<span class="c1"># From Table 4</span>
<span class="c1"># msi = oli*slope+intercept</span>
<span class="c1"># oli = (msi-intercept)/slope</span>
<span class="n">msiOLISlopes</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0946</span><span class="p">,</span> <span class="mf">1.0043</span><span class="p">,</span> <span class="mf">1.0524</span><span class="p">,</span> <span class="mf">0.8954</span><span class="p">,</span> <span class="mf">1.0049</span><span class="p">,</span> <span class="mf">1.0002</span><span class="p">]</span>
<span class="n">msiOLIIntercepts</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.0107</span><span class="p">,</span> <span class="mf">0.0026</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0015</span><span class="p">,</span> <span class="mf">0.0033</span><span class="p">,</span> <span class="mf">0.0065</span><span class="p">,</span> <span class="mf">0.0046</span><span class="p">]</span>

<span class="c1"># From Table 5</span>
<span class="c1"># msi = etm*slope+intercept</span>
<span class="c1"># etm = (msi-intercept)/slope</span>
<span class="n">msiETMSlopes</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.10601</span><span class="p">,</span> <span class="mf">0.99091</span><span class="p">,</span> <span class="mf">1.05681</span><span class="p">,</span> <span class="mf">1.0045</span><span class="p">,</span> <span class="mf">1.03611</span><span class="p">,</span> <span class="mf">1.04011</span><span class="p">]</span>
<span class="n">msiETMIntercepts</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.0139</span><span class="p">,</span> <span class="mf">0.00411</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0024</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0076</span><span class="p">,</span> <span class="mf">0.00411</span><span class="p">,</span> <span class="mf">0.00861</span><span class="p">]</span>

<span class="c1"># From Table 6</span>
<span class="c1"># oli = etm*slope+intercept</span>
<span class="c1"># etm = (oli-intercept)/slope</span>
<span class="n">oliETMSlopes</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.03501</span><span class="p">,</span> <span class="mf">1.00921</span><span class="p">,</span> <span class="mf">1.01991</span><span class="p">,</span> <span class="mf">1.14061</span><span class="p">,</span> <span class="mf">1.04351</span><span class="p">,</span> <span class="mf">1.05271</span><span class="p">]</span>
<span class="n">oliETMIntercepts</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.0055</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0008</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0021</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0163</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0045</span><span class="p">,</span> <span class="mf">0.00261</span><span class="p">]</span>

<span class="c1"># Construct dictionary to handle all pairwise combos</span>
<span class="n">chastainCoeffDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;MSI_OLI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msiOLISlopes</span><span class="p">,</span> <span class="n">msiOLIIntercepts</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;MSI_ETM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msiETMSlopes</span><span class="p">,</span> <span class="n">msiETMIntercepts</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;OLI_ETM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">oliETMSlopes</span><span class="p">,</span> <span class="n">oliETMIntercepts</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;OLI_MSI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msiOLISlopes</span><span class="p">,</span> <span class="n">msiOLIIntercepts</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s2">&quot;ETM_MSI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msiETMSlopes</span><span class="p">,</span> <span class="n">msiETMIntercepts</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s2">&quot;ETM_OLI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">oliETMSlopes</span><span class="p">,</span> <span class="n">oliETMIntercepts</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">}</span>


<span class="c1"># Function to apply model in one direction</span>
<span class="k">def</span> <span class="nf">dir0Regression</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">intercepts</span><span class="p">):</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">nonCorrectBands</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">chastainBandNames</span><span class="p">)</span>
    <span class="n">nonCorrectedBands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nonCorrectBands</span><span class="p">)</span>
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">chastainBandNames</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">intercepts</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">nonCorrectedBands</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Applying the model in the opposite direction</span>
<span class="k">def</span> <span class="nf">dir1Regression</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">intercepts</span><span class="p">):</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">nonCorrectBands</span> <span class="o">=</span> <span class="n">bns</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">chastainBandNames</span><span class="p">)</span>
    <span class="n">nonCorrectedBands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nonCorrectBands</span><span class="p">)</span>
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">chastainBandNames</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">intercepts</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">nonCorrectedBands</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Function to correct one sensor to another</span>
<div class="viewcode-block" id="harmonizationChastain">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.harmonizationChastain">[docs]</a>
<span class="k">def</span> <span class="nf">harmonizationChastain</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">fromSensor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">toSensor</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Harmonizes Landsat images using Chastain et al. (2018) coefficients.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Landsat image.</span>
<span class="sd">        fromSensor: The sensor of the input image (e.g., &#39;OLI&#39;, &#39;ETM+&#39;).</span>
<span class="sd">        toSensor: The target sensor for harmonization (e.g., &#39;OLI&#39;, &#39;ETM+&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A harmonized Landsat image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="c1"># Get the model for the given from and to sensor</span>
    <span class="n">comboKey</span> <span class="o">=</span> <span class="n">fromSensor</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">toSensor</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">coeffList</span> <span class="o">=</span> <span class="n">chastainCoeffDict</span><span class="p">[</span><span class="n">comboKey</span><span class="p">]</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">coeffList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">intercepts</span> <span class="o">=</span> <span class="n">coeffList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">coeffList</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Apply the model in the respective direction</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
        <span class="n">direction</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">dir0Regression</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">intercepts</span><span class="p">),</span>
        <span class="n">dir1Regression</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">intercepts</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;fromSensor&quot;</span><span class="p">:</span> <span class="n">fromSensor</span><span class="p">,</span> <span class="s2">&quot;toSensor&quot;</span><span class="p">:</span> <span class="n">toSensor</span><span class="p">})</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>



<span class="c1">####################################################################</span>
<span class="c1"># Function to create a multiband image from a collection</span>
<div class="viewcode-block" id="collectionToImage">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.collectionToImage">[docs]</a>
<span class="k">def</span> <span class="nf">collectionToImage</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deprecated - use `.toBands()`. Converts an image collection to a multiband image.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection: The input Earth Engine image collection.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A multiband Earth Engine image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">cIterator</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">prev</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">cIterator</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">stack</span></div>



<span class="c1">####################################################################</span>
<span class="c1">####################################################################</span>
<span class="c1"># Function to find the date for a given composite computed from a given set of images</span>
<span class="c1"># Will work on composites computed with methods that include different dates across different bands</span>
<span class="c1"># such as the median.  For something like a medoid, only a single bands needs passed through</span>
<span class="c1"># A known bug is that if the same value occurs twice, it will choose only a single date</span>
<div class="viewcode-block" id="compositeDates">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.compositeDates">[docs]</a>
<span class="k">def</span> <span class="nf">compositeDates</span><span class="p">(</span><span class="n">images</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">composite</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">bandNames</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds the dates corresponding to bands in a composite image.</span>

<span class="sd">    Args:</span>
<span class="sd">        images: The original image collection.</span>
<span class="sd">        composite: The composite image.</span>
<span class="sd">        bandNames: Optional list of band names to consider.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine image with date information for each band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bandNames</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandNames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bnCat</span><span class="p">(</span><span class="n">bn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_diff&quot;</span><span class="p">)</span>

    <span class="n">bns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">bnCat</span><span class="p">)</span>

    <span class="c1"># Function to get the abs diff from a given composite *-1</span>
    <span class="k">def</span> <span class="nf">getDiff</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">composite</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">bns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># Find the diff and add a date band</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getDiff</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">addDateBand</span><span class="p">)</span>

    <span class="c1"># Iterate across each band and find the corresponding date to the composite</span>
    <span class="k">def</span> <span class="nf">bnCat2</span><span class="p">(</span><span class="n">bn</span><span class="p">):</span>
        <span class="n">bn</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bn</span><span class="p">,</span> <span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_diff&quot;</span><span class="p">),</span> <span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">qualityMosaic</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_diff&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;YYYYDD&quot;</span><span class="p">])</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">bnCat2</span><span class="p">)</span>

    <span class="c1"># Convert to an image and rename</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">collectionToImage</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
    <span class="c1"># var outBns = bandNames.map(function(bn){return ee.String(bn).cat(&#39;YYYYDD&#39;)});</span>
    <span class="c1"># out = out.rename(outBns);</span>

    <span class="k">return</span> <span class="n">out</span></div>



<span class="c1">############################################################################</span>
<span class="c1"># Function to handle empty collections that will cause subsequent processes to fail</span>
<span class="c1"># If the collection is empty, will fill it with an empty image</span>
<div class="viewcode-block" id="fillEmptyCollections">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.fillEmptyCollections">[docs]</a>
<span class="k">def</span> <span class="nf">fillEmptyCollections</span><span class="p">(</span><span class="n">inCollection</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fills empty image collections with a dummy image. This handles empty collections that will cause subsequent processes to fail.</span>

<span class="sd">    Args:</span>
<span class="sd">        inCollection: The input Earth Engine image collection.</span>
<span class="sd">        dummyImage: A dummy Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image collection or a collection containing the dummy image if empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dummyCollection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">([</span><span class="n">dummyImage</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">0</span><span class="p">))])</span>
    <span class="n">imageCount</span> <span class="o">=</span> <span class="n">inCollection</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">imageCount</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">inCollection</span><span class="p">,</span> <span class="n">dummyCollection</span><span class="p">))</span></div>



<span class="c1">############################################################################</span>
<span class="c1"># Add band tracking which satellite the pixel came from</span>
<div class="viewcode-block" id="addSensorBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addSensorBand">[docs]</a>
<span class="k">def</span> <span class="nf">addSensorBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">whichProgram</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a sensor band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>
<span class="sd">        whichProgram: The program (e.g., &#39;C1_landsat&#39;, &quot;C2_landsat&quot;, &#39;sentinel2&#39;).</span>
<span class="sd">        toaOrSR: Whether the image is TOA or SR.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added sensor band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sensorDict</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;LANDSAT_4&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;LANDSAT_5&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;LANDSAT_7&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s2">&quot;LANDSAT_8&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s2">&quot;LANDSAT_9&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
            <span class="s2">&quot;Sentinel-2A&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
            <span class="s2">&quot;Sentinel-2B&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
            <span class="s2">&quot;Sentinel-2C&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">sensorPropDict</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;C1_landsat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;SPACECRAFT_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="s2">&quot;SATELLITE&quot;</span><span class="p">},</span>
            <span class="s2">&quot;C2_landsat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;SPACECRAFT_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="s2">&quot;SPACECRAFT_ID&quot;</span><span class="p">},</span>
            <span class="s2">&quot;sentinel2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;SPACECRAFT_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="s2">&quot;SPACECRAFT_NAME&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">sensorProp</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">sensorPropDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">whichProgram</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">toaOrSR</span><span class="p">)</span>
    <span class="n">sensorName</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sensorProp</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">sensorDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sensorName</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;sensor&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">byte</span><span class="p">())</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sensor&quot;</span><span class="p">,</span> <span class="n">sensorName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span></div>



<span class="c1">############################################################################</span>
<span class="c1">############################################################################</span>
<span class="c1"># Adds the float year with julian proportion to image</span>
<div class="viewcode-block" id="addDateBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addDateBand">[docs]</a>
<span class="k">def</span> <span class="nf">addDateBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">maskTime</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a date band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>
<span class="sd">        maskTime: Whether to mask the date band based on the image mask.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added date band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getFraction</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">))</span>
    <span class="c1"># d=d.getFraction(&#39;year&#39;)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">maskTime</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div>



<div class="viewcode-block" id="addYearFractionBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addYearFractionBand">[docs]</a>
<span class="k">def</span> <span class="nf">addYearFractionBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a year fraction band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added year fraction band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="c1"># d = y.add(d.getFraction(&#39;year&#39;));</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">getFraction</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">db</span>  <span class="c1"># .updateMask(img.select([0]).mask())</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div>



<div class="viewcode-block" id="addYearYearFractionBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addYearYearFractionBand">[docs]</a>
<span class="k">def</span> <span class="nf">addYearYearFractionBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a year and year fraction band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added year and year fraction band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="c1"># d = y.add(d.getFraction(&#39;year&#39;));</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">getFraction</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">db</span>  <span class="c1"># .updateMask(img.select([0]).mask())</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div>



<div class="viewcode-block" id="addYearBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addYearBand">[docs]</a>
<span class="k">def</span> <span class="nf">addYearBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a year band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added year band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">db</span>  <span class="c1"># .updateMask(img.select([0]).mask())</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div>



<div class="viewcode-block" id="addJulianDayBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addJulianDayBand">[docs]</a>
<span class="k">def</span> <span class="nf">addJulianDayBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a Julian day band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added Julian day band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">julian</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;DD&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;julianDay&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">julian</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></div>



<div class="viewcode-block" id="addYearJulianDayBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addYearJulianDayBand">[docs]</a>
<span class="k">def</span> <span class="nf">addYearJulianDayBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a year and Julian day band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added year and Julian day band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">yj</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYDD&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;yearJulian&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">yj</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></div>



<div class="viewcode-block" id="addFullYearJulianDayBand">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addFullYearJulianDayBand">[docs]</a>
<span class="k">def</span> <span class="nf">addFullYearJulianDayBand</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a full year Julian day band to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input image with an added full year Julian day band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">yj</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYYDD&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;yearJulian&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">int64</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">yj</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></div>



<div class="viewcode-block" id="offsetImageDate">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.offsetImageDate">[docs]</a>
<span class="k">def</span> <span class="nf">offsetImageDate</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Offsets the date of an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>
<span class="sd">        n: The number of units to offset.</span>
<span class="sd">        unit: The unit of the offset (e.g., &#39;year&#39;, &#39;month&#39;, &#39;day&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with an offset date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="c1"># date = ee.Date.fromYMD(100,date.get(&#39;month&#39;),date.get(&#39;day&#39;))</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span></div>



<span class="c1">################################################################</span>
<span class="c1">################################################################</span>
<span class="n">fringeCountThreshold</span> <span class="o">=</span> <span class="mi">279</span>  <span class="c1"># Define number of non null observations for pixel to not be classified as a fringe</span>
<span class="c1">################################################################</span>
<span class="c1"># Kernel used for defringing</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span>
    <span class="mi">41</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">)</span>


<span class="c1">################################################################</span>
<span class="c1"># Algorithm to defringe Landsat scenes</span>
<div class="viewcode-block" id="defringeLandsat">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.defringeLandsat">[docs]</a>
<span class="k">def</span> <span class="nf">defringeLandsat</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Defringes a Landsat 7 image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Landsat 7 image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The defringed Landsat 7 image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find any pixel without sufficient non null pixels (fringes)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="c1"># Apply kernel</span>
    <span class="n">kernelSum</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(img,vizParams,&#39;with fringes&#39;)</span>
    <span class="c1"># Map.addLayer(sum,{&#39;min&#39;:20,&#39;max&#39;:241},&#39;sum41&#39;,false)</span>

    <span class="c1"># Mask pixels w/o sufficient obs</span>
    <span class="n">kernelSum</span> <span class="o">=</span> <span class="n">kernelSum</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">fringeCountThreshold</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">kernelSum</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(img,vizParams,&#39;defringed&#39;)</span>
    <span class="k">return</span> <span class="n">img</span></div>



<span class="c1">################################################################</span>
<span class="c1"># Function to find unique values of a field in a collection</span>
<div class="viewcode-block" id="uniqueValues">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.uniqueValues">[docs]</a>
<span class="k">def</span> <span class="nf">uniqueValues</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds unique values of a field in an image collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection: The input Earth Engine image collection.</span>
<span class="sd">        field: The field to extract unique values from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of unique values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">reduceColumns</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">frequencyHistogram</span><span class="p">(),</span> <span class="p">[</span><span class="n">field</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;histogram&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">values</span></div>



<span class="c1">###############################################################</span>
<span class="c1"># Function to simplify data into daily mosaics</span>
<span class="c1"># This procedure must be used for proper processing of S2 imagery</span>
<div class="viewcode-block" id="dailyMosaics">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.dailyMosaics">[docs]</a>
<span class="k">def</span> <span class="nf">dailyMosaics</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates daily mosaics from an image collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        imgs: The input Earth Engine image collection.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine image collection containing daily mosaics.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Simplify date to exclude time of day</span>
    <span class="k">def</span> <span class="nf">propWrapper</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYY-MM-dd&quot;</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SENSING_ORBIT_NUMBER&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;date-orbit&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">orbit</span><span class="p">),</span> <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">propWrapper</span><span class="p">)</span>

    <span class="c1"># Find the unique day orbits</span>
    <span class="n">dayOrbits</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="s2">&quot;date-orbit&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dayWrapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;SENSING_ORBIT_NUMBER&quot;</span><span class="p">,</span> <span class="n">orbit</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mosaic</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="n">dayOrbits</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dayWrapper</span><span class="p">)</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">imgs</span></div>



<span class="c1">################################################################</span>
<span class="c1"># Sentinel 1 processing</span>
<span class="c1"># Adapted from: https://code.earthengine.google.com/39a3ad5ac59cd8af14e3dbd78436d2b5</span>
<span class="c1"># Author: Warren Scott</span>

<span class="c1"># --------------------------------------- DEFINE SPECKLEFUNCTION---------------------------------------------------*/</span>


<span class="c1"># Sigma Lee filter</span>
<div class="viewcode-block" id="toNatural">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.toNatural">[docs]</a>
<span class="k">def</span> <span class="nf">toNatural</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a Sentinel-1 image from dB to natural units.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Sentinel-1 image in dB.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The converted image in natural units.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span></div>



<div class="viewcode-block" id="toDB">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.toDB">[docs]</a>
<span class="k">def</span> <span class="nf">toDB</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a Sentinel-1 image from natural units to dB.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Sentinel-1 image in natural units.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The converted image in dB.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">log10</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span></div>



<span class="c1"># The RL speckle filter from https://code.earthengine.google.com/2ef38463ebaf5ae133a478f173fd0ab5 by Guido Lemoine</span>
<span class="c1"># As coded in the SNAP 3.0 S1TBX:</span>
<div class="viewcode-block" id="RefinedLee">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.RefinedLee">[docs]</a>
<span class="k">def</span> <span class="nf">RefinedLee</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the Refined Lee speckle filter to a Sentinel-1 image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Sentinel-1 image in natural units.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The speckle filtered image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># img must be in natural units, i.e. not in dB!</span>
    <span class="c1"># Set up 3x3 kernels</span>
    <span class="n">weights3</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">kernel3</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">weights3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">mean3</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">kernel3</span><span class="p">)</span>
    <span class="n">variance3</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">kernel3</span><span class="p">)</span>

    <span class="c1"># Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span>
    <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">sample_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Calculate mean and variance for the sampled windows and store as 9 bands</span>
    <span class="n">sample_mean</span> <span class="o">=</span> <span class="n">mean3</span><span class="o">.</span><span class="n">neighborhoodToBands</span><span class="p">(</span><span class="n">sample_kernel</span><span class="p">)</span>
    <span class="n">sample_var</span> <span class="o">=</span> <span class="n">variance3</span><span class="o">.</span><span class="n">neighborhoodToBands</span><span class="p">(</span><span class="n">sample_kernel</span><span class="p">)</span>

    <span class="c1"># Determine the 4 gradients for the sampled windows</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>

    <span class="c1"># And find the maximum gradient amongst gradient bands</span>
    <span class="n">max_gradient</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Create a mask for band pixels that are the maximum gradient</span>
    <span class="n">gradmask</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">max_gradient</span><span class="p">)</span>

    <span class="c1"># duplicate gradmask bands: each gradient represents 2 directions</span>
    <span class="n">gradmask</span> <span class="o">=</span> <span class="n">gradmask</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">gradmask</span><span class="p">)</span>

    <span class="c1"># Determine the 8 directions</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

    <span class="c1"># The next 4 are the not() of the previous 4</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Mask all values that are not 1-8</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">gradmask</span><span class="p">)</span>

    <span class="c1"># &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span>
    <span class="c1"># Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span>

    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">sample_var</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sample_mean</span><span class="p">))</span>

    <span class="c1"># Calculate localNoiseVariance</span>
    <span class="n">sigmaV</span> <span class="o">=</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span><span class="o">.</span><span class="n">arraySort</span><span class="p">()</span><span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">arrayReduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Set up the 7*7 kernels for directional statistics</span>
    <span class="n">rect_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">diag_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">rect_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rect_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">diag_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">diag_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span>
    <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dir_var</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

    <span class="c1"># and add the bands for rotated kernels</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>

    <span class="c1"># &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span>
    <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># A finally generate the filtered value</span>
    <span class="n">varX</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">dir_mean</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dir_mean</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigmaV</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sigmaV</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">varX</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dir_var</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">dir_mean</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;sum&quot;</span><span class="p">]])</span></div>



<span class="c1">################################################################</span>


<span class="c1"># Load and filter Sentinel-1 GRD data by predefined parameters</span>
<div class="viewcode-block" id="getS1">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getS1">[docs]</a>
<span class="k">def</span> <span class="nf">getS1</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">polarization</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VV&quot;</span><span class="p">,</span>
    <span class="n">pass_direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ASCENDING&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads Sentinel-1 GRD data for a given area and time period.</span>

<span class="sd">    Args:</span>
<span class="sd">        studyArea: The geographic area of interest.</span>
<span class="sd">        startYear: The start year of the desired data.</span>
<span class="sd">        endYear: The end year of the desired data.</span>
<span class="sd">        startJulian: The start Julian day of the desired data.</span>
<span class="sd">        endJulian: The end Julian day of the desired data.</span>
<span class="sd">        polarization: The desired polarization (default: &quot;VV&quot;).</span>
<span class="sd">        pass_direction: The desired pass direction (default: &quot;ASCENDING&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine ImageCollection containing the loaded Sentinel-1 data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;COPERNICUS/S1_GRD&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;instrumentMode&quot;</span><span class="p">,</span> <span class="s2">&quot;IW&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">listContains</span><span class="p">(</span><span class="s2">&quot;transmitterReceiverPolarisation&quot;</span><span class="p">,</span> <span class="n">polarization</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;orbitProperties_pass&quot;</span><span class="p">,</span> <span class="n">pass_direction</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;resolution_meters&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">polarization</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">collection</span></div>



<span class="c1">################################################################</span>
<span class="c1"># Sentinel-2 collections and bands to use</span>
<span class="c1"># 3/22 - Changed to using the _HARMONIZED collections following the introduction of a 1000 value offset from Jan 25 2022 onward</span>
<span class="c1"># These collections account for these differences</span>
<span class="n">s2CollectionDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;COPERNICUS/S2_HARMONIZED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="s2">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">sensorBandDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;B1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B8A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B12&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;B1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B8A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B10&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B12&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="n">sensorBandNameDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;cb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nir2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;waterVapor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;cb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nir2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;waterVapor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cirrus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>


<span class="c1"># Function to get Sentinel 2 A and B data into a single collection with meaningful band names for a specified area and date range</span>
<span class="c1"># Will also join the S2 cloudless cloud probability collection if specified</span>
<div class="viewcode-block" id="getS2">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getS2">[docs]</a>
<span class="k">def</span> <span class="nf">getS2</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">,</span>
    <span class="n">startDate</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">endDate</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">365</span><span class="p">,</span>
    <span class="n">resampleMethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TOA&quot;</span><span class="p">,</span>
    <span class="n">convertToDailyMosaics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">addCloudProbability</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">addCloudScorePlus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePlusScore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cs&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads Sentinel-2 data for a given area and time period and joins cloud score information. Partially deprecated in favor of the simpler superSimpleGetS2.</span>

<span class="sd">    Args:</span>
<span class="sd">        studyArea: The geographic area of interest.</span>
<span class="sd">        startDate: The start date of the desired data. Can be an ee.Date object, datetime object, or date string.</span>
<span class="sd">        endDate: The end date of the desired data. Can be an ee.Date object, datetime object, or date string.</span>
<span class="sd">        startJulian: The start Julian day of the desired data.</span>
<span class="sd">        endJulian: The end Julian day of the desired data.</span>
<span class="sd">        resampleMethod: The resampling method (default: &quot;nearest&quot;).</span>
<span class="sd">        toaOrSR: Whether to load TOA or SR data (default: &quot;TOA&quot;).</span>
<span class="sd">        convertToDailyMosaics: Whether to convert the data to daily mosaics (default: True).</span>
<span class="sd">        addCloudProbability: Whether to add cloud probability data (default: False).</span>
<span class="sd">        addCloudScorePlus: Whether to add cloud score plus data (default: True).</span>
<span class="sd">        cloudScorePlusScore: The band name for cloud score plus (default: &quot;cs&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of Sentinel-2 satellite images filtered by the specified criteria.</span>


<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CA&quot;]</span>
<span class="sd">    &gt;&gt;&gt; composite = gil.getS2(studyArea, &quot;2024-01-01&quot;, &quot;2024-12-31&quot;, 190, 250).median()</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(composite, gil.vizParamsFalse, &quot;Sentinel-2 Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;canQuery&quot;: False}, &quot;Study Area&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">startDate</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">endDate</span><span class="p">)</span>

    <span class="c1"># Specify S2 continuous bands if resampling is set to something other than near</span>
    <span class="n">s2_continuous_bands</span> <span class="o">=</span> <span class="n">sensorBandNameDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">multS2</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sensorBandDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="c1"># t = t.addBands(img.select([&#39;QA60&#39;]))</span>
        <span class="c1"># out = t.copyProperties(img).copyProperties(img,[&#39;system:time_start&#39;])</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get some s2 data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using S2 Collection:&quot;</span><span class="p">,</span> <span class="n">s2CollectionDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">s2CollectionDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span>
        <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">multS2</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;QA60&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sensorBandDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;QA60&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sensorBandNameDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">addCloudProbability</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Joining pre-computed cloud probabilities from: COPERNICUS/S2_CLOUD_PROBABILITY&quot;</span><span class="p">)</span>
        <span class="n">cloudProbabilities</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;COPERNICUS/S2_CLOUD_PROBABILITY&quot;</span><span class="p">)</span>
            <span class="c1"># .filterDate(startDate, endDate.advance(1, &quot;day&quot;))</span>
            <span class="c1"># .filter(ee.Filter.calendarRange(startJulian, endJulian))</span>
            <span class="c1"># .filterBounds(studyArea)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;probability&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;cloud_probability&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">cloudProbabilitiesIds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">cloudProbabilities</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">s2sIds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">s2s</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">s2sIds</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">cloudProbabilitiesIds</span><span class="p">)</span>
        <span class="c1"># print(&#39;Missing cloud probability ids:&#39;, missing.getInfo())</span>
        <span class="c1"># print(&#39;N s2 images before joining with cloud prob:&#39;, s2s.size().getInfo())</span>
        <span class="c1"># s2s = joinCollections(s2s, cloudProbabilities, False, &quot;system:index&quot;)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">cloudProbabilities</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cloud_probability&quot;</span><span class="p">])</span>
        <span class="c1"># print(&#39;N s2 images after joining with cloud prob:&#39;, s2s.size().getInfo())</span>

    <span class="k">if</span> <span class="n">addCloudScorePlus</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Joining pre-computed cloudScore+ from: GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&quot;</span><span class="p">)</span>
        <span class="n">cloudScorePlus</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&quot;</span><span class="p">)</span>
            <span class="c1"># .filterDate(startDate, endDate.advance(1, &quot;day&quot;))</span>
            <span class="c1"># .filter(ee.Filter.calendarRange(startJulian, endJulian))</span>
            <span class="c1"># .filterBounds(studyArea)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">cloudScorePlusScore</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;cloudScorePlus&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">cloudScorePlusIds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">cloudScorePlus</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">s2sIds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">s2s</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">s2sIds</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">cloudScorePlus</span><span class="p">)</span>
        <span class="c1"># print(&#39;Missing cloud probability ids:&#39;, missing.getInfo())</span>
        <span class="c1"># print(&#39;N s2 images before joining with cloudScore+:&#39;, s2s.size().getInfo())</span>
        <span class="c1"># s2s = joinCollections(s2s, cloudScorePlus, False, &quot;system:index&quot;)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">cloudScorePlus</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cloudScorePlus&quot;</span><span class="p">])</span>
        <span class="c1"># print(&#39;N s2 images after joining with cloud prob:&#39;, s2s.size().getInfo())</span>

    <span class="c1"># Set resampling method - only sets to non nearest-neighbor for continuous bands</span>
    <span class="k">if</span> <span class="n">resampleMethod</span> <span class="o">==</span> <span class="s2">&quot;bilinear&quot;</span> <span class="ow">or</span> <span class="n">resampleMethod</span> <span class="o">==</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting resample method to &quot;</span><span class="p">,</span> <span class="n">resampleMethod</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s2_continuous_bands</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resampleMethod</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">resampleMethod</span> <span class="o">==</span> <span class="s2">&quot;aggregate&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting to aggregate instead of resample &quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s2_continuous_bands</span><span class="p">)</span><span class="o">.</span><span class="n">reduceResolution</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Convert to daily mosaics to avoid redundant observations in MGRS overlap areas and edge artifacts for shadow masking</span>
    <span class="k">if</span> <span class="n">convertToDailyMosaics</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting S2 data to daily mosaics&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">dailyMosaics</span><span class="p">(</span><span class="n">s2s</span><span class="p">)</span>

    <span class="c1"># This needs to occur AFTER the mosaicking to remove remaining edge artifacts.</span>
    <span class="c1"># Update on 15 May 2024 to only include spectral bands since qa bands are null after ~Feb 2024</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sensorBandNameDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())))</span>

    <span class="k">return</span> <span class="n">s2s</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<span class="n">getSentinel2</span> <span class="o">=</span> <span class="n">getS2</span>
<span class="c1">##################################################################</span>
<span class="c1"># Set up dictionaries to manage various Landsat collections, rescale factors, band names, etc</span>
<span class="n">landsat_C2_L2_rescale_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;refl_mult&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s2">&quot;refl_add&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;temp_mult&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;temp_add&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="s2">&quot;C2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;refl_mult&quot;</span><span class="p">:</span> <span class="mf">0.0000275</span><span class="p">,</span>
        <span class="s2">&quot;refl_add&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="s2">&quot;temp_mult&quot;</span><span class="p">:</span> <span class="mf">0.00341802</span><span class="p">,</span>
        <span class="s2">&quot;temp_add&quot;</span><span class="p">:</span> <span class="mf">149.0</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="c1"># Specify Landsat continuous bands if resampling is set to something other than near</span>
<span class="n">landsat_continuous_bands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">]</span>
<span class="c1"># Set up bands and corresponding band names</span>
<span class="n">landsatSensorBandDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C1_L4_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;BQA&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L4_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C1_L5_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;BQA&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L5_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C1_L7_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6_VCID_1&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;BQA&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L7_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6_VCID_1&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C1_L8_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B10&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;BQA&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L8_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B10&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L9_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B10&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C1_L4_SR&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel_qa&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L4_SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;SR_B1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST_B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;C1_L5_SR&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel_qa&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L5_SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;SR_B1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST_B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;C1_L7_SR&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel_qa&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L7_SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;SR_B1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST_B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;C1_L8_SR&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;B5&quot;</span><span class="p">,</span> <span class="s2">&quot;B6&quot;</span><span class="p">,</span> <span class="s2">&quot;B10&quot;</span><span class="p">,</span> <span class="s2">&quot;B7&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel_qa&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_L8_SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;SR_B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST_B10&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;C2_L9_SR&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;SR_B2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST_B10&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SR_B7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Provide common band names</span>
<span class="n">landsatSensorBandNameDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C1_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;BQA&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C1_SR&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel_qa&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C1_SRFMASK&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pixel_qa&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_TOA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
    <span class="s2">&quot;C2_SR&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Set up collections</span>
<span class="n">landsatCollectionDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C1_L8_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LC08/C01/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L7_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LE07/C01/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L5_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT05/C01/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L4_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT04/C01/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L8_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L7_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LE07/C01/T1_SR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L5_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT05/C01/T1_SR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_L4_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT04/C01/T1_SR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L9_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LC09/C02/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L8_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LC08/C02/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L7_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LE07/C02/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L5_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT05/C02/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L4_TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT04/C02/T1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L9_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LC09/C02/T1_L2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L8_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LC08/C02/T1_L2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L7_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LE07/C02/T1_L2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L5_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT05/C02/T1_L2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_L4_SR&quot;</span><span class="p">:</span> <span class="s2">&quot;LANDSAT/LT04/C02/T1_L2&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Name of cFmask qa bits band for Collections 1 and 2</span>
<span class="n">landsatFmaskBandNameDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C1&quot;</span><span class="p">:</span> <span class="s2">&quot;pixel_qa&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">:</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">}</span>


<span class="c1">##################################################################</span>
<span class="c1"># Method for rescaling reflectance and surface temperature data to 0-1 and Kelvin respectively</span>
<span class="c1"># This was adapted from the method provided by Google for rescaling Collection 2:</span>
<span class="c1"># https://code.earthengine.google.com/?scriptPath=Examples%3ADatasets%2FLANDSAT_LC08_C02_T1_L2</span>
<span class="k">def</span> <span class="nf">applyScaleFactors</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span><span class="p">):</span>
    <span class="n">factor_dict</span> <span class="o">=</span> <span class="n">landsat_C2_L2_rescale_dict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">]</span>
    <span class="n">opticalBands</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">factor_dict</span><span class="p">[</span><span class="s2">&quot;refl_mult&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">factor_dict</span><span class="p">[</span><span class="s2">&quot;refl_add&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">thermalBands</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">factor_dict</span><span class="p">[</span><span class="s2">&quot;temp_mult&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">factor_dict</span><span class="p">[</span><span class="s2">&quot;temp_add&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">opticalBands</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">thermalBands</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="c1">##################################################################</span>
<span class="c1"># Function for acquiring Landsat image collections</span>
<div class="viewcode-block" id="getLandsat">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getLandsat">[docs]</a>
<span class="k">def</span> <span class="nf">getLandsat</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">,</span>
    <span class="n">startDate</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">endDate</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">365</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SR&quot;</span><span class="p">,</span>
    <span class="n">includeSLCOffL7</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">defringeL5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">addPixelQA</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">resampleMethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;near&quot;</span><span class="p">,</span>
    <span class="n">landsatCollectionVersion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves Landsat imagery for a specified study area and date range.</span>

<span class="sd">    Args:</span>
<span class="sd">        studyArea (ee.Geometry, ee.Feature, or ee.FeatureCollection): The geographic area of interest.</span>
<span class="sd">        startDate (ee.Date, datetime.datetime, or str): The start date of the desired image range.</span>
<span class="sd">        endDate (ee.Date, datetime.datetime, or str): The end date of the desired image range.</span>
<span class="sd">        startJulian (int, optional): The start Julian day of the desired image range. Defaults to 1.</span>
<span class="sd">        endJulian (int, optional): The end Julian day of the desired image range. Defaults to 365.</span>
<span class="sd">        toaOrSR (str, optional): Whether to retrieve TOA or SR data. Defaults to &quot;SR&quot;.</span>
<span class="sd">        includeSLCOffL7 (bool, optional): Whether to include SLC-off L7 data. Defaults to False.</span>
<span class="sd">        defringeL5 (bool, optional): Whether to defringe L5 data. Defaults to False.</span>
<span class="sd">        addPixelQA (bool, optional): Whether to add pixel QA band. Defaults to False.</span>
<span class="sd">        resampleMethod (str, optional): Resampling method. Options are &quot;near&quot;, &quot;bilinear&quot;, or &quot;bicubic&quot;. Defaults to &quot;near&quot;.</span>
<span class="sd">        landsatCollectionVersion (str, optional): Landsat collection version. Options are &quot;C1&quot; or &quot;C2&quot;. Defaults to &quot;C2&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of Landsat images meeting the specified criteria.</span>


<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CA&quot;]</span>
<span class="sd">    &gt;&gt;&gt; composite = gil.getLandsat(studyArea, &quot;2024-01-01&quot;, &quot;2024-12-31&quot;, 190, 250).median()</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(composite, gil.vizParamsFalse, &quot;Landsat Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;canQuery&quot;: False}, &quot;Study Area&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">startDate</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">endDate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="n">whichC</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">landsatCollectionDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">whichC</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">toaOrSR</span><span class="p">])</span>
            <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="s2">&quot;WRS_ROW&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;toa&quot;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">Landsat</span><span class="o">.</span><span class="n">TOA</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">landsatSensorBandDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">whichC</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">toaOrSR</span><span class="p">],</span>
            <span class="n">landsatSensorBandNameDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">toaOrSR</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;sr&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying scale factors for </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="n">whichC</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">image</span><span class="p">:</span> <span class="n">applyScaleFactors</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">getLandsatCollections</span><span class="p">(</span><span class="n">toaOrSR</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span><span class="p">):</span>
        <span class="c1"># Get Landsat data</span>
        <span class="n">l4s</span> <span class="o">=</span> <span class="n">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="s2">&quot;L4&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">)</span>
        <span class="n">l5s</span> <span class="o">=</span> <span class="n">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="s2">&quot;L5&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">defringeL5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Defringing L4 and L5&quot;</span><span class="p">)</span>
            <span class="n">l4s</span> <span class="o">=</span> <span class="n">l4s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">defringeLandsat</span><span class="p">)</span>
            <span class="n">l5s</span> <span class="o">=</span> <span class="n">l5s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">defringeLandsat</span><span class="p">)</span>

        <span class="n">l8s</span> <span class="o">=</span> <span class="n">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="s2">&quot;L8&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">)</span>

        <span class="c1">#   var ls; var l7s;</span>
        <span class="k">if</span> <span class="n">includeSLCOffL7</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Including All Landsat 7&quot;</span><span class="p">)</span>
            <span class="n">l7s</span> <span class="o">=</span> <span class="n">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="s2">&quot;L7&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only including SLC On Landsat 7&quot;</span><span class="p">)</span>
            <span class="n">l7s</span> <span class="o">=</span> <span class="n">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="s2">&quot;L7&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">)</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="mi">1998</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="c1"># Merge collections</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">l4s</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l5s</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l7s</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l8s</span><span class="p">))</span>

        <span class="c1"># Bring in Landsat 9 if using Collection 2</span>
        <span class="k">if</span> <span class="n">landsatCollectionVersion</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;c2&quot;</span><span class="p">:</span>
            <span class="n">l9s</span> <span class="o">=</span> <span class="n">getLandsatCollection</span><span class="p">(</span><span class="n">landsatCollectionVersion</span><span class="p">,</span> <span class="s2">&quot;L9&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">)</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l9s</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ls</span>

    <span class="n">ls</span> <span class="o">=</span> <span class="n">getLandsatCollections</span><span class="p">(</span><span class="n">toaOrSR</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span><span class="p">)</span>
    <span class="c1"># If TOA and Fmask need to merge Fmask qa bits with toa- this gets the qa band from the sr collections</span>
    <span class="k">if</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;toa&quot;</span> <span class="ow">and</span> <span class="n">addPixelQA</span> <span class="ow">and</span> <span class="n">landsatCollectionVersion</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;c1&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acquiring SR qa bands for applying Fmask to TOA data&quot;</span><span class="p">)</span>
        <span class="n">l4sTOAFMASK</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">landsatCollectionDict</span><span class="p">[</span><span class="s2">&quot;C1_L4_SR&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="s2">&quot;WRS_ROW&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsatSensorBandNameDict</span><span class="p">[</span><span class="s2">&quot;C1_SRFMASK&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">l5sTOAFMASK</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">landsatCollectionDict</span><span class="p">[</span><span class="s2">&quot;C1_L5_SR&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="s2">&quot;WRS_ROW&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsatSensorBandNameDict</span><span class="p">[</span><span class="s2">&quot;C1_SRFMASK&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">l8sTOAFMASK</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">landsatCollectionDict</span><span class="p">[</span><span class="s2">&quot;C1_L8_SR&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
            <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="s2">&quot;WRS_ROW&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsatSensorBandNameDict</span><span class="p">[</span><span class="s2">&quot;C1_SRFMASK&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">includeSLCOffL7</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Including All Landsat 7 for TOA QA&quot;</span><span class="p">)</span>
            <span class="n">l7sTOAFMASK</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">landsatCollectionDict</span><span class="p">[</span><span class="s2">&quot;C1_L7_SR&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="s2">&quot;WRS_ROW&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsatSensorBandNameDict</span><span class="p">[</span><span class="s2">&quot;C1_SRFMASK&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only including SLC On Landsat 7 for TOA QA&quot;</span><span class="p">)</span>
            <span class="n">l7sTOAFMASK</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">landsatCollectionDict</span><span class="p">[</span><span class="s2">&quot;C1_L7_SR&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="mi">1998</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="s2">&quot;WRS_ROW&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsatSensorBandNameDict</span><span class="p">[</span><span class="s2">&quot;C1_SRFMASK&quot;</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">lsTOAFMASK</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">l4sTOAFMASK</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l5sTOAFMASK</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l7sTOAFMASK</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l8sTOAFMASK</span><span class="p">))</span>

        <span class="c1"># Join the TOA with SR QA bands</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Joining TOA with SR QA bands&quot;</span><span class="p">)</span>
        <span class="c1"># print(ls.size(), lsTOAFMASK.size())</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">joinCollections</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">lsTOAFMASK</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system:index&quot;</span><span class="p">)</span>
        <span class="c1"># lsTOAFMASK = getLandsat(&#39;SR&#39;).select([&#39;pixel_qa&#39;])</span>
        <span class="c1"># #Join the TOA with SR QA bands</span>
        <span class="c1"># print(&#39;Joining TOA with SR QA bands&#39;)</span>
        <span class="c1"># ls = joinCollections(ls.select([0,1,2,3,4,5,6]),lsTOAFMASK)</span>

    <span class="k">def</span> <span class="nf">dataInAllBands</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="c1"># return img.multiply(multImageDict[toaOrSR]).copyProperties(img,[&#39;system:time_start&#39;]).copyProperties(img)</span>

    <span class="c1"># Make sure all bands have data</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dataInAllBands</span><span class="p">)</span>

    <span class="c1"># Set resampling method - only sets to non nearest-neighbor for continuous bands</span>
    <span class="k">def</span> <span class="nf">setResample</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resampleMethod</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resampleMethod</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting resample method to &quot;</span><span class="p">,</span> <span class="n">resampleMethod</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsat_continuous_bands</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resampleMethod</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">resampleMethod</span> <span class="o">==</span> <span class="s2">&quot;aggregate&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting to aggregate instead of resample &quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">landsat_continuous_bands</span><span class="p">)</span><span class="o">.</span><span class="n">reduceResolution</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ls</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<span class="n">getImageCollection</span> <span class="o">=</span> <span class="n">getLandsat</span>


<span class="c1">###########################################################################</span>
<span class="c1"># Helper function to apply an expression and linearly rescale the output.</span>
<span class="c1"># Used in the landsatCloudScore function below.</span>
<div class="viewcode-block" id="rescale">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.rescale">[docs]</a>
<span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rescales pixel values in an image using a min-max normalization.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>
<span class="sd">        thresholds: A tuple containing the minimum and maximum values for rescaling.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A rescaled Earth Engine image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>



<span class="c1">###########################################################################</span>
<span class="c1"># /***</span>
<span class="c1">#  * Implementation of Basic cloud shadow shift</span>
<span class="c1">#  *</span>
<span class="c1">#  * Author: Gennadii Donchyts</span>
<span class="c1">#  * License: Apache 2.0</span>
<span class="c1">#  */</span>
<span class="c1"># Cloud heights added by Ian Housman</span>
<span class="c1"># yMult bug fix adapted from code written by Noel Gorelick by Ian Housman</span>
<span class="k">def</span> <span class="nf">projectShadows</span><span class="p">(</span>
    <span class="n">cloudMask</span><span class="p">,</span>
    <span class="n">image</span><span class="p">,</span>
    <span class="n">irSumThresh</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="p">,</span>
    <span class="n">cloudHeights</span><span class="p">,</span>
    <span class="n">yMult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">yMult</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">yMult</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">IsEqual</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">projection</span><span class="p">(),</span> <span class="n">ee</span><span class="o">.</span><span class="n">Projection</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)),</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">meanAzimuth</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MEAN_SOLAR_AZIMUTH_ANGLE&quot;</span><span class="p">)</span>
    <span class="n">meanZenith</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MEAN_SOLAR_ZENITH_ANGLE&quot;</span><span class="p">)</span>
    <span class="c1">##################################################</span>
    <span class="c1"># print(&#39;a&#39;,meanAzimuth)</span>
    <span class="c1"># print(&#39;z&#39;,meanZenith)</span>

    <span class="c1"># Find dark pixels</span>
    <span class="n">darkPixels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">irSumThresh</span><span class="p">)</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">contractPixels</span><span class="p">)</span><span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">dilatePixels</span><span class="p">)</span>
    <span class="c1"># .gte(1)</span>

    <span class="c1"># Get scale of image</span>
    <span class="n">nominalScale</span> <span class="o">=</span> <span class="n">cloudMask</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span><span class="o">.</span><span class="n">nominalScale</span><span class="p">()</span>
    <span class="c1"># Find where cloud shadows should be based on solar geometry</span>
    <span class="c1"># Convert to radians</span>
    <span class="n">azR</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">meanAzimuth</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">PI</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">180.0</span><span class="p">)</span>
    <span class="n">zenR</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">meanZenith</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">PI</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">180.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">castShadows</span><span class="p">(</span><span class="n">cloudHeight</span><span class="p">):</span>
        <span class="n">cloudHeight</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">cloudHeight</span><span class="p">)</span>
        <span class="n">shadowCastedDistance</span> <span class="o">=</span> <span class="n">zenR</span><span class="o">.</span><span class="n">tan</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">cloudHeight</span><span class="p">)</span>  <span class="c1"># Distance shadow is cast</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">azR</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">shadowCastedDistance</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">nominalScale</span><span class="p">)</span>  <span class="c1"># X distance of shadow</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">azR</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">shadowCastedDistance</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">nominalScale</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yMult</span><span class="p">)</span>
        <span class="c1"># Y distance of shadow</span>
        <span class="k">return</span> <span class="n">cloudMask</span><span class="o">.</span><span class="n">changeProj</span><span class="p">(</span><span class="n">cloudMask</span><span class="o">.</span><span class="n">projection</span><span class="p">(),</span> <span class="n">cloudMask</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="c1"># Find the shadows</span>
    <span class="n">shadows</span> <span class="o">=</span> <span class="n">cloudHeights</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">castShadows</span><span class="p">)</span>

    <span class="n">shadowMask</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">shadows</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Create shadow mask</span>
    <span class="n">shadowMask</span> <span class="o">=</span> <span class="n">shadowMask</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">cloudMask</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span>
    <span class="n">shadowMask</span> <span class="o">=</span> <span class="n">shadowMask</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">darkPixels</span><span class="p">)</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">contractPixels</span><span class="p">)</span><span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">dilatePixels</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(cloudMask.updateMask(cloudMask),{&#39;min&#39;:1,&#39;max&#39;:1,&#39;palette&#39;:&#39;88F&#39;},&#39;Cloud mask&#39;)</span>
    <span class="c1"># Map.addLayer(shadowMask.updateMask(shadowMask),{&#39;min&#39;:1,&#39;max&#39;:1,&#39;palette&#39;:&#39;880&#39;},&#39;Shadow mask&#39;)</span>

    <span class="n">cloudShadowMask</span> <span class="o">=</span> <span class="n">shadowMask</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">cloudMask</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">cloudShadowMask</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">shadowMask</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudShadowMask&quot;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">projectShadowsWrapper</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">cloudThresh</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">irSumThresh</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">cloudHeights</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
<span class="p">):</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">cloudMask</span> <span class="o">=</span> <span class="n">sentinel2CloudScore</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">cloudThresh</span><span class="p">)</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">contractPixels</span><span class="p">)</span><span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">dilatePixels</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">projectShadows</span><span class="p">(</span><span class="n">cloudMask</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">irSumThresh</span><span class="p">,</span> <span class="n">contractPixels</span><span class="p">,</span> <span class="n">dilatePixels</span><span class="p">,</span> <span class="n">cloudHeights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to mask clouds using the Sentinel-2 QA band.</span>
<div class="viewcode-block" id="maskS2clouds">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.maskS2clouds">[docs]</a>
<span class="k">def</span> <span class="nf">maskS2clouds</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Masks clouds in a Sentinel-2 image using the QA60 band.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Sentinel-2 image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cloud-masked image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;QA60&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

    <span class="c1"># Bits 10 and 11 are clouds and cirrus, respectively.</span>
    <span class="n">cloudBitMask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">cirrusBitMask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>

    <span class="c1"># Both flags should be set to zero, indicating clear conditions.</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">cloudBitMask</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">cirrusBitMask</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Return the masked and scaled data.</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Compute a cloud score and adds a band that represents the cloud mask.</span>
<span class="c1"># This expects the input image to have the common band names:</span>
<span class="c1"># [&quot;red&quot;, &quot;blue&quot;, etc], so it can work across sensors.</span>
<div class="viewcode-block" id="landsatCloudScore">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.landsatCloudScore">[docs]</a>
<span class="k">def</span> <span class="nf">landsatCloudScore</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes a cloud score for a Landsat image and adds a band that represents the cloud mask. This expects the input image to have the common band names: [&quot;red&quot;, &quot;blue&quot;, etc], so it can work across sensors.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Landsat image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An image with a cloud score band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute several indicators of cloudiness and take the minimum of them.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="c1"># Clouds are reasonably bright in the blue band.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">]),</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]))</span>

    <span class="c1"># Clouds are reasonably bright in all visible bands.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>

    <span class="c1"># Clouds are reasonably bright in all infrared bands.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>

    <span class="c1"># Clouds are reasonably cool in temperature.</span>
    <span class="c1"># Unmask temperature to a cold cold temp so it doesn&#39;t exclude the pixels entirely</span>
    <span class="c1"># This is an issue largely with SR data where a suspected cloud temperature value is masked out</span>
    <span class="n">tempUnmasked</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;temp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="mi">270</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">tempUnmasked</span><span class="p">,</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">290</span><span class="p">]))</span>

    <span class="c1"># However, clouds are not snow.</span>
    <span class="n">ndsi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">ndsi</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]))</span>

    <span class="c1"># ss = snowScore(img).select([&#39;snowScore&#39;])</span>
    <span class="c1"># score = score.min(rescale(ss, &#39;img&#39;, [0.3, 0]))</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Wrapper for applying cloudScore function</span>
<div class="viewcode-block" id="applyCloudScoreAlgorithm">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.applyCloudScoreAlgorithm">[docs]</a>
<span class="k">def</span> <span class="nf">applyCloudScoreAlgorithm</span><span class="p">(</span>
    <span class="n">collection</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span>
    <span class="n">cloudScoreFunction</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
    <span class="n">cloudScoreThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">preComputedCloudScoreOffset</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies a cloud score algorithm to an image collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection: The input Earth Engine image collection.</span>
<span class="sd">        cloudScoreFunction: A function to calculate the cloud score for an image.</span>
<span class="sd">        cloudScoreThresh: The cloud score threshold for masking (default: 20).</span>
<span class="sd">        cloudScorePctl: The percentile for computing the cloud score offset (default: 10).</span>
<span class="sd">        contractPixels: The contraction kernel size (default: 1.5).</span>
<span class="sd">        dilatePixels: The dilation kernel size (default: 3.5).</span>
<span class="sd">        performCloudScoreOffset: Whether to perform cloud score offsetting (default: True).</span>
<span class="sd">        preComputedCloudScoreOffset: A pre-computed cloud score offset image (optional).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image collection with cloud masks applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Add cloudScore</span>
    <span class="k">def</span> <span class="nf">cloudScoreWrapper</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">cloudScoreFunction</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

    <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cloudScoreWrapper</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">performCloudScoreOffset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">preComputedCloudScoreOffset</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Find low cloud score pctl for each pixel to avoid commission errors</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing cloudScore offset&quot;</span><span class="p">)</span>
            <span class="n">minCloudScore</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span><span class="n">cloudScorePctl</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed cloudScore offset&quot;</span><span class="p">)</span>
            <span class="n">minCloudScore</span> <span class="o">=</span> <span class="n">preComputedCloudScoreOffset</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not computing cloudScore offset&quot;</span><span class="p">)</span>
        <span class="n">minCloudScore</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span>

    <span class="c1"># Apply cloudScore</span>
    <span class="k">def</span> <span class="nf">cloudScoreBusterWrapper</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">cloudMask</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">minCloudScore</span><span class="p">)</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">cloudScoreThresh</span><span class="p">)</span><span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">contractPixels</span><span class="p">)</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">dilatePixels</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudMask&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">cloudMask</span><span class="p">)</span>

    <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cloudScoreBusterWrapper</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">collection</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Functions for applying fmask to SR data</span>
<span class="n">fmaskBitDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cloud&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;shadow&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;snow&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
    <span class="s2">&quot;C2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cloud&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;shadow&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;snow&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
<span class="p">}</span>


<span class="c1"># LSC updated 4/16/19 to add medium and high confidence cloud masks</span>
<span class="c1"># Supported fmaskClass options: &#39;cloud&#39;, &#39;shadow&#39;, &#39;snow&#39;, &#39;high_confidence_cloud&#39;, &#39;med_confidence_cloud&#39;</span>
<div class="viewcode-block" id="cFmask">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.cFmask">[docs]</a>
<span class="k">def</span> <span class="nf">cFmask</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">fmaskClass</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bitMaskBandName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the CFMask algorithm to a Landsat image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Landsat image.</span>
<span class="sd">        fmaskClass: The CFMask class to apply (e.g., &#39;cloud&#39;, &#39;shadow&#39;, &#39;snow&#39;).</span>
<span class="sd">        bitMaskBandName: The name of the QA band (default: &quot;QA_PIXEL&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cloud-masked image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bitMaskBandName</span><span class="p">)</span><span class="o">.</span><span class="n">uint16</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fmaskClass</span> <span class="o">==</span> <span class="s2">&quot;high_confidence_cloud&quot;</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">fmaskClass</span> <span class="o">==</span> <span class="s2">&quot;med_confidence_cloud&quot;</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">fmaskBitDict</span><span class="p">[</span><span class="n">fmaskClass</span><span class="p">])</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span></div>



<span class="c1"># Method for applying a single bit bit mask</span>
<div class="viewcode-block" id="applyBitMask">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.applyBitMask">[docs]</a>
<span class="k">def</span> <span class="nf">applyBitMask</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">bit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bitMaskBandName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies a bitmask to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input image.</span>
<span class="sd">        bit: The bit position to mask.</span>
<span class="sd">        bitMaskBandName: The name of the QA band (default: &quot;QA_PIXEL&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The masked image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bitMaskBandName</span><span class="p">])</span><span class="o">.</span><span class="n">uint16</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span></div>



<div class="viewcode-block" id="cFmaskCloud">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.cFmaskCloud">[docs]</a>
<span class="k">def</span> <span class="nf">cFmaskCloud</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bitMaskBandName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the CFMask cloud mask to a Landsat image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Landsat image.</span>
<span class="sd">        landsatCollectionVersion: The Landsat collection version (e.g., &#39;C1&#39;, &#39;C2&#39;).</span>
<span class="sd">        bitMaskBandName: The name of the QA band (default: &quot;QA_PIXEL&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cloud-masked image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">applyBitMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fmaskBitDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">][</span><span class="s2">&quot;cloud&quot;</span><span class="p">],</span> <span class="n">bitMaskBandName</span><span class="p">)</span></div>



<div class="viewcode-block" id="cFmaskCloudShadow">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.cFmaskCloudShadow">[docs]</a>
<span class="k">def</span> <span class="nf">cFmaskCloudShadow</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bitMaskBandName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;QA_PIXEL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the CFMask cloud shadow mask to a Landsat image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Landsat image.</span>
<span class="sd">        landsatCollectionVersion: The Landsat collection version (e.g., &#39;C1&#39;, &#39;C2&#39;).</span>
<span class="sd">        bitMaskBandName: The name of the QA band (default: &quot;QA_PIXEL&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cloud shadow masked image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">applyBitMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fmaskBitDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">][</span><span class="s2">&quot;shadow&quot;</span><span class="p">],</span> <span class="n">bitMaskBandName</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for finding dark outliers in time series.</span>
<span class="c1"># Original concept written by Carson Stam and adapted by Ian Housman.</span>
<span class="c1"># Adds a band that is a mask of pixels that are dark, and dark outliers.</span>
<div class="viewcode-block" id="simpleTDOM2">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.simpleTDOM2">[docs]</a>
<span class="k">def</span> <span class="nf">simpleTDOM2</span><span class="p">(</span>
    <span class="n">collection</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span>
    <span class="n">zScoreThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
    <span class="n">preComputedTDOMIRMean</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRStdDev</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies a simple temporal dark object differencing (TDOM) algorithm to an image collection. Adds a band that is a mask of pixels that are dark, and dark outliers.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection: The input Earth Engine image collection.</span>
<span class="sd">        zScoreThresh: The z-score threshold for dark outliers (default: -1).</span>
<span class="sd">        shadowSumThresh: The shadow sum threshold (default: 0.35).</span>
<span class="sd">        contractPixels: The contraction kernel size (default: 1.5).</span>
<span class="sd">        dilatePixels: The dilation kernel size (default: 3.5).</span>
<span class="sd">        shadowSumBands: The bands used for shadow sum calculation (default: [&quot;nir&quot;, &quot;swir1&quot;]).</span>
<span class="sd">        preComputedTDOMIRMean: Precomputed mean of the shadow sum bands (optional).</span>
<span class="sd">        preComputedTDOMIRStdDev: Precomputed standard deviation of the shadow sum bands (optional).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image collection with dark outliers masked.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="c1"># Get some pixel-wise stats for the time series</span>
    <span class="k">if</span> <span class="n">preComputedTDOMIRMean</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing irMean for TDOM&quot;</span><span class="p">)</span>
        <span class="n">irMean</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">shadowSumBands</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed irMean for TDOM&quot;</span><span class="p">)</span>
        <span class="n">irMean</span> <span class="o">=</span> <span class="n">preComputedTDOMIRMean</span>

    <span class="k">if</span> <span class="n">preComputedTDOMIRStdDev</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing irStdDev for TDOM&quot;</span><span class="p">)</span>
        <span class="n">irStdDev</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">shadowSumBands</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">stdDev</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed irStdDev for TDOM&quot;</span><span class="p">)</span>
        <span class="n">irStdDev</span> <span class="o">=</span> <span class="n">preComputedTDOMIRStdDev</span>

    <span class="k">def</span> <span class="nf">zThresholder</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">zScore</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">shadowSumBands</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">irMean</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">irStdDev</span><span class="p">)</span>
        <span class="n">irSum</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">shadowSumBands</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">TDOMMask</span> <span class="o">=</span> <span class="n">zScore</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">zScoreThresh</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shadowSumBands</span><span class="p">))</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">irSum</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">shadowSumThresh</span><span class="p">))</span>
        <span class="n">TDOMMask</span> <span class="o">=</span> <span class="n">TDOMMask</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">contractPixels</span><span class="p">)</span><span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">dilatePixels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">TDOMMask</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span>

    <span class="c1"># Mask out dark dark outliers</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">zThresholder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">collection</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to add common (and less common) spectral indices to an image.</span>
<span class="c1"># Includes the Normalized Difference Spectral Vector from (Angiuli and Trianni, 2014)</span>
<div class="viewcode-block" id="addIndices">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addIndices">[docs]</a>
<span class="k">def</span> <span class="nf">addIndices</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds various spectral indices to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added spectral indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add Normalized Difference Spectral Vector (NDSV)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_blue_green&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_blue_red&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_blue_nir&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_blue_swir1&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_blue_swir2&quot;</span><span class="p">]))</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_green_red&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_green_nir&quot;</span><span class="p">]))</span>  <span class="c1"># NDWBI</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_green_swir1&quot;</span><span class="p">]))</span>  <span class="c1"># NDSI, MNDWI</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_green_swir2&quot;</span><span class="p">]))</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_red_swir1&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_red_swir2&quot;</span><span class="p">]))</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_nir_red&quot;</span><span class="p">]))</span>  <span class="c1"># NDVI</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_nir_swir1&quot;</span><span class="p">]))</span>  <span class="c1"># NDWI, LSWI, -NDBI</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_nir_swir2&quot;</span><span class="p">]))</span>  <span class="c1"># NBR, MNDVI</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;ND_swir1_swir2&quot;</span><span class="p">]))</span>

    <span class="c1"># Add ratios</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;R_swir1_nir&quot;</span><span class="p">]))</span>  <span class="c1"># ratio 5/4</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;R_red_swir1&quot;</span><span class="p">]))</span>  <span class="c1"># ratio 3/5</span>

    <span class="c1"># Add Enhanced Vegetation Index (EVI)</span>
    <span class="n">evi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">evi</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;EVI&quot;</span><span class="p">))</span>

    <span class="c1"># Add Soil Adjust Vegetation Index (SAVI)</span>
    <span class="c1"># using L = 0.5;</span>
    <span class="n">savi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;(NIR - RED) * (1 + 0.5)/(NIR + RED + 0.5)&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span> <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">savi</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;SAVI&quot;</span><span class="p">]))</span>

    <span class="c1"># Add Index-Based Built-Up Index (IBI)</span>
    <span class="n">ibi_a</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;2*SWIR1/(SWIR1 + NIR)&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;SWIR1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir1&quot;</span><span class="p">),</span> <span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">)},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;IBI_A&quot;</span><span class="p">])</span>

    <span class="n">ibi_b</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;(NIR/(NIR + RED)) + (GREEN/(GREEN + SWIR1))&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
            <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SWIR1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir1&quot;</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;IBI_B&quot;</span><span class="p">])</span>

    <span class="n">ibi_a</span> <span class="o">=</span> <span class="n">ibi_a</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ibi_b</span><span class="p">)</span>
    <span class="n">ibi</span> <span class="o">=</span> <span class="n">ibi_a</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;IBI_A&quot;</span><span class="p">,</span> <span class="s2">&quot;IBI_B&quot;</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ibi</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;IBI&quot;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">img</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to  add SAVI and EVI</span>
<div class="viewcode-block" id="addSAVIandEVI">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addSAVIandEVI">[docs]</a>
<span class="k">def</span> <span class="nf">addSAVIandEVI</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds SAVI and EVI indices to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added SAVI and EVI indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add Enhanced Vegetation Index (EVI)</span>
    <span class="n">evi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">evi</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;EVI&quot;</span><span class="p">]))</span>

    <span class="c1"># Add Soil Adjust Vegetation Index (SAVI)</span>
    <span class="c1"># using L = 0.5</span>
    <span class="n">savi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;(NIR - RED) * (1 + 0.5)/(NIR + RED + 0.5)&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span> <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="c1">#########################################################################</span>
    <span class="c1"># NIRv: Badgley, G., Field, C. B., &amp; Berry, J. A. (2017). Canopy near-infrared reflectance and terrestrial photosynthesis. Science Advances, 3, e1602244.</span>
    <span class="c1"># https://www.researchgate.net/publication/315534107_Canopy_near-infrared_reflectance_and_terrestrial_photosynthesis</span>
    <span class="c1"># NIRv function: &#39;image&#39; is a 2 band stack of NDVI and NIR</span>
    <span class="c1">#########################################################################</span>
    <span class="n">NIRv</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;NDVI&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mf">0.08</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">]))</span>  <span class="c1"># .multiply(0.0001))</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">savi</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;SAVI&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">NIRv</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;NIRv&quot;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">img</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">###############################################################</span>
<span class="c1"># Apply bloom detection algorithm</span>
<div class="viewcode-block" id="HoCalcAlgorithm2">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.HoCalcAlgorithm2">[docs]</a>
<span class="k">def</span> <span class="nf">HoCalcAlgorithm2</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies an algal detection algorithm based on:</span>
<span class="sd">    Matthews, M. (2011) A current review of empirical procedures</span>
<span class="sd">    of remote sensing in inland and near-coastal transitional</span>
<span class="sd">    waters, International Journal of Remote Sensing, 32:21,</span>
<span class="sd">    6855-6899, DOI: 10.1080/01431161.2010.512947.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added bloom2 and NDGI bands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Algorithm 2 based on:</span>
    <span class="c1"># Matthews, M. (2011) A current review of empirical procedures</span>
    <span class="c1">#  of remote sensing in inland and near-coastal transitional</span>
    <span class="c1">#  waters, International Journal of Remote Sensing, 32:21,</span>
    <span class="c1">#  6855-6899, DOI: 10.1080/01431161.2010.512947</span>

    <span class="c1"># Apply algorithm 2: B2/B1</span>
    <span class="n">bloom2</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;bloom2&quot;</span><span class="p">])</span>
    <span class="n">ndgi</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;NDGI&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">bloom2</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ndgi</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1"># Function for only adding common indices</span>
<div class="viewcode-block" id="simpleAddIndices">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.simpleAddIndices">[docs]</a>
<span class="k">def</span> <span class="nf">simpleAddIndices</span><span class="p">(</span><span class="n">in_image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds common spectral indices to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_image: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added NDVI, NBR, NDMI, and NDSI indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">in_image</span> <span class="o">=</span> <span class="n">in_image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">in_image</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;NDVI&quot;</span><span class="p">]))</span>
    <span class="n">in_image</span> <span class="o">=</span> <span class="n">in_image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">in_image</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;NBR&quot;</span><span class="p">]))</span>
    <span class="n">in_image</span> <span class="o">=</span> <span class="n">in_image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">in_image</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;NDMI&quot;</span><span class="p">]))</span>
    <span class="n">in_image</span> <span class="o">=</span> <span class="n">in_image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">in_image</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;NDSI&quot;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">in_image</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for adding common indices</span>
<span class="c1">#########################################################################</span>
<div class="viewcode-block" id="addSoilIndices">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addSoilIndices">[docs]</a>
<span class="k">def</span> <span class="nf">addSoilIndices</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds soil-related indices to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added soil indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;NDCI&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;NDII&quot;</span><span class="p">]))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;NDFI&quot;</span><span class="p">]))</span>

    <span class="n">bsi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;((SWIR1 + RED) - (NIR + BLUE)) / ((SWIR1 + RED) + (NIR + BLUE))&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
            <span class="s2">&quot;NIR&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SWIR1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir1&quot;</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">bsi</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;BSI&quot;</span><span class="p">]))</span>

    <span class="n">hi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="s2">&quot;SWIR1 / SWIR2&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;SWIR1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir1&quot;</span><span class="p">),</span> <span class="s2">&quot;SWIR2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir2&quot;</span><span class="p">)})</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">hi</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;HI&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to compute the Tasseled Cap transformation and return an image</span>
<span class="c1"># with the following bands added: [&#39;brightness&#39;, &#39;greenness&#39;, &#39;wetness&#39;,</span>
<span class="c1">#&#39;fourth&#39;, &#39;fifth&#39;, &#39;sixth&#39;]</span>
<div class="viewcode-block" id="getTasseledCap">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getTasseledCap">[docs]</a>
<span class="k">def</span> <span class="nf">getTasseledCap</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the Tasseled Cap transformation for an image using the Crist 1985 coefficients.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added Tasseled Cap components.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span>
    <span class="c1">#   // // Kauth-Thomas coefficients for Thematic Mapper data</span>
    <span class="c1">#   // var coefficients = ee.Array([</span>
    <span class="c1">#   //   [0.3037, 0.2793, 0.4743, 0.5585, 0.5082, 0.1863],</span>
    <span class="c1">#   //   [-0.2848, -0.2435, -0.5436, 0.7243, 0.0840, -0.1800],</span>
    <span class="c1">#   //   [0.1509, 0.1973, 0.3279, 0.3406, -0.7112, -0.4572],</span>
    <span class="c1">#   //   [-0.8242, 0.0849, 0.4392, -0.0580, 0.2012, -0.2768],</span>
    <span class="c1">#   //   [-0.3280, 0.0549, 0.1075, 0.1855, -0.4357, 0.8085],</span>
    <span class="c1">#   //   [0.1084, -0.9022, 0.4120, 0.0573, -0.0251, 0.0238]</span>
    <span class="c1">#   // ]);</span>

    <span class="c1"># Crist 1985 coeffs - TOA refl (http://www.gis.usu.edu/~doug/RS5750/assign/OLD/RSE(17)-301.pdf)</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.2043</span><span class="p">,</span> <span class="mf">0.4158</span><span class="p">,</span> <span class="mf">0.5524</span><span class="p">,</span> <span class="mf">0.5741</span><span class="p">,</span> <span class="mf">0.3124</span><span class="p">,</span> <span class="mf">0.2303</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.1603</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2819</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4934</span><span class="p">,</span> <span class="mf">0.7940</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0002</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1446</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.0315</span><span class="p">,</span> <span class="mf">0.2021</span><span class="p">,</span> <span class="mf">0.3102</span><span class="p">,</span> <span class="mf">0.1594</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6806</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6109</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.2117</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0284</span><span class="p">,</span> <span class="mf">0.1302</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1007</span><span class="p">,</span> <span class="mf">0.6529</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7078</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.8669</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1835</span><span class="p">,</span> <span class="mf">0.3856</span><span class="p">,</span> <span class="mf">0.0408</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1132</span><span class="p">,</span> <span class="mf">0.2272</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.3677</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8200</span><span class="p">,</span> <span class="mf">0.4354</span><span class="p">,</span> <span class="mf">0.0518</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0066</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0104</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># Make an Array Image, with a 1-D Array per pixel.</span>
    <span class="n">arrayImage1D</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>

    <span class="c1"># Make an Array Image with a 2-D Array per pixel, 6x1.</span>
    <span class="n">arrayImage2D</span> <span class="o">=</span> <span class="n">arrayImage1D</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">componentsImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">matrixMultiply</span><span class="p">(</span><span class="n">arrayImage2D</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;brightness&quot;</span><span class="p">,</span> <span class="s2">&quot;greenness&quot;</span><span class="p">,</span> <span class="s2">&quot;wetness&quot;</span><span class="p">,</span> <span class="s2">&quot;fourth&quot;</span><span class="p">,</span> <span class="s2">&quot;fifth&quot;</span><span class="p">,</span> <span class="s2">&quot;sixth&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">componentsImage</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<div class="viewcode-block" id="simpleGetTasseledCap">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.simpleGetTasseledCap">[docs]</a>
<span class="k">def</span> <span class="nf">simpleGetTasseledCap</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the Tasseled Cap transformation for an image, including only brightness, greenness, and wetness using the Crist 1985 coefficients.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added brightness, greenness, and wetness bands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span>
    <span class="c1">#   // // Kauth-Thomas coefficients for Thematic Mapper data</span>
    <span class="c1">#   // var coefficients = ee.Array([</span>
    <span class="c1">#   //   [0.3037, 0.2793, 0.4743, 0.5585, 0.5082, 0.1863],</span>
    <span class="c1">#   //   [-0.2848, -0.2435, -0.5436, 0.7243, 0.0840, -0.1800],</span>
    <span class="c1">#   //   [0.1509, 0.1973, 0.3279, 0.3406, -0.7112, -0.4572],</span>
    <span class="c1">#   //   [-0.8242, 0.0849, 0.4392, -0.0580, 0.2012, -0.2768],</span>
    <span class="c1">#   //   [-0.3280, 0.0549, 0.1075, 0.1855, -0.4357, 0.8085],</span>
    <span class="c1">#   //   [0.1084, -0.9022, 0.4120, 0.0573, -0.0251, 0.0238]</span>
    <span class="c1">#   // ]);</span>

    <span class="c1"># Crist 1985 coeffs - TOA refl (http://www.gis.usu.edu/~doug/RS5750/assign/OLD/RSE(17)-301.pdf)</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.2043</span><span class="p">,</span> <span class="mf">0.4158</span><span class="p">,</span> <span class="mf">0.5524</span><span class="p">,</span> <span class="mf">0.5741</span><span class="p">,</span> <span class="mf">0.3124</span><span class="p">,</span> <span class="mf">0.2303</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.1603</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2819</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4934</span><span class="p">,</span> <span class="mf">0.7940</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0002</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1446</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.0315</span><span class="p">,</span> <span class="mf">0.2021</span><span class="p">,</span> <span class="mf">0.3102</span><span class="p">,</span> <span class="mf">0.1594</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6806</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6109</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># Make an Array Image, with a 1-D Array per pixel.</span>
    <span class="n">arrayImage1D</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>

    <span class="c1"># Make an Array Image with a 2-D Array per pixel, 6x1.</span>
    <span class="n">arrayImage2D</span> <span class="o">=</span> <span class="n">arrayImage1D</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">componentsImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">matrixMultiply</span><span class="p">(</span><span class="n">arrayImage2D</span><span class="p">)</span><span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;brightness&quot;</span><span class="p">,</span> <span class="s2">&quot;greenness&quot;</span><span class="p">,</span> <span class="s2">&quot;wetness&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">componentsImage</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to add Tasseled Cap angles and distances to an image.</span>
<span class="c1"># Assumes image has bands: &#39;brightness&#39;, &#39;greenness&#39;, and &#39;wetness&#39;.</span>
<div class="viewcode-block" id="addTCAngles">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addTCAngles">[docs]</a>
<span class="k">def</span> <span class="nf">addTCAngles</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds Tasseled Cap angles and distances to an image.</span>
<span class="sd">    Assumes image has bands: &#39;brightness&#39;, &#39;greenness&#39;, and &#39;wetness&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image with brightness, greenness, and wetness bands.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added Tasseled Cap angles and distances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select brightness, greenness, and wetness bands</span>
    <span class="n">brightness</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;brightness&quot;</span><span class="p">])</span>
    <span class="n">greenness</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;greenness&quot;</span><span class="p">])</span>
    <span class="n">wetness</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;wetness&quot;</span><span class="p">])</span>

    <span class="c1"># Calculate Tasseled Cap angles and distances</span>
    <span class="n">tcAngleBG</span> <span class="o">=</span> <span class="n">brightness</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">greenness</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcAngleBG&quot;</span><span class="p">])</span>
    <span class="n">tcAngleGW</span> <span class="o">=</span> <span class="n">greenness</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">wetness</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcAngleGW&quot;</span><span class="p">])</span>
    <span class="n">tcAngleBW</span> <span class="o">=</span> <span class="n">brightness</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">wetness</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcAngleBW&quot;</span><span class="p">])</span>
    <span class="n">tcDistBG</span> <span class="o">=</span> <span class="n">brightness</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">greenness</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcDistBG&quot;</span><span class="p">])</span>
    <span class="n">tcDistGW</span> <span class="o">=</span> <span class="n">greenness</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">wetness</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcDistGW&quot;</span><span class="p">])</span>
    <span class="n">tcDistBW</span> <span class="o">=</span> <span class="n">brightness</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">wetness</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcDistBW&quot;</span><span class="p">])</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcAngleBG</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcAngleGW</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcAngleBW</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcDistBG</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcDistGW</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcDistBW</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Only adds tc bg angle as in Powell et al 2009</span>
<span class="c1"># https://www.sciencedirect.com/science/article/pii/S0034425709003745?via%3Dihub</span>
<div class="viewcode-block" id="simpleAddTCAngles">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.simpleAddTCAngles">[docs]</a>
<span class="k">def</span> <span class="nf">simpleAddTCAngles</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the Tasseled Cap brightness-greenness angle to an image as in Powell et al 2009.</span>
<span class="sd">    Assumes image has bands: &#39;brightness&#39;, &#39;greenness&#39;, and &#39;wetness&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine image with brightness and greenness bands.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added brightness-greenness angle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select brightness, greenness, and wetness bands</span>
    <span class="n">brightness</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;brightness&quot;</span><span class="p">])</span>
    <span class="n">greenness</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;greenness&quot;</span><span class="p">])</span>
    <span class="n">wetness</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;wetness&quot;</span><span class="p">])</span>

    <span class="c1"># Calculate Tasseled Cap angles and distances</span>
    <span class="n">tcAngleBG</span> <span class="o">=</span> <span class="n">brightness</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">greenness</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;tcAngleBG&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">tcAngleBG</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to add solar zenith and azimuth in radians as bands to image</span>
<div class="viewcode-block" id="addZenithAzimuth">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.addZenithAzimuth">[docs]</a>
<span class="k">def</span> <span class="nf">addZenithAzimuth</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">zenithDict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;SUN_ELEVATION&quot;</span><span class="p">,</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="s2">&quot;SOLAR_ZENITH_ANGLE&quot;</span><span class="p">},</span>
    <span class="n">azimuthDict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TOA&quot;</span><span class="p">:</span> <span class="s2">&quot;SUN_AZIMUTH&quot;</span><span class="p">,</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="s2">&quot;SOLAR_AZIMUTH_ANGLE&quot;</span><span class="p">},</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds solar zenith and azimuth angles in radians to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine image.</span>
<span class="sd">        toaOrSR: Whether the image is TOA or SR.</span>
<span class="sd">        zenithDict: A dictionary mapping toaOrSR to the zenith band name.</span>
<span class="sd">        azimuthDict: A dictionary mapping toaOrSR to the azimuth band name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The image with added zenith and azimuth bands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zenith</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">zenithDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">]))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;zenith&quot;</span><span class="p">])</span>

    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azimuthDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">]))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;azimuth&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">zenith</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for computing the mean squared difference medoid from an image collection</span>
<span class="c1"># As the data are not normalized in this method, ensuring the medoidIncludeBands have roughly comparable ranges of values</span>
<span class="c1"># helps the function work properly. For example, if temperature is included, it will account for most of the variance</span>
<span class="c1"># thus resulting in a medoid mosaic that will more or less choose values closest to the median temperature only, rather than</span>
<span class="c1"># all the bands</span>
<div class="viewcode-block" id="medoidMosaicMSD">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.medoidMosaicMSD">[docs]</a>
<span class="k">def</span> <span class="nf">medoidMosaicMSD</span><span class="p">(</span><span class="n">inCollection</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">medoidIncludeBands</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a medoid mosaic using the Mean Squared Difference (MSD) (euclidean distance) method.</span>

<span class="sd">    This function calculates the medoid image from an image collection based on minimizing the sum of squared differences between pixel values.</span>

<span class="sd">    Args:</span>
<span class="sd">        inCollection: The input Earth Engine ImageCollection to create the mosaic from.</span>
<span class="sd">        medoidIncludeBands: A list of band names to include in the MSD calculation. If None, all bands are used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine Image representing the medoid mosaic.</span>

<span class="sd">    Note:</span>
<span class="sd">        * As the data are not normalized in this method, ensuring the medoidIncludeBands have roughly comparable ranges of values helps the function work properly. For example, if temperature is included, it will account for most of the variance thus resulting in a medoid mosaic that will more or less choose values closest to the median temperature only, rather than all the bands</span>

<span class="sd">        * The function assumes that the image collection has consistent band names and data types.</span>


<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CO&quot;]</span>
<span class="sd">    &gt;&gt;&gt; s2s = gil.superSimpleGetS2(studyArea, &quot;2024-01-01&quot;, &quot;2024-12-31&quot;, 190, 250)</span>
<span class="sd">    &gt;&gt;&gt; median_composite = s2s.median()</span>
<span class="sd">    &gt;&gt;&gt; medoid_composite = gil.medoidMosaicMSD(s2s, [&quot;green&quot;, &quot;red&quot;, &quot;nir&quot;, &quot;swir1&quot;, &quot;swir2&quot;])</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(median_composite, gil.vizParamsFalse10k, &quot;Sentinel-2 Median Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(medoid_composite, gil.vizParamsFalse10k, &quot;Sentinel-2 Medoid Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;canQuery&quot;: False}, &quot;Study Area&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">medoidIncludeBands</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">medoidIncludeBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">inCollection</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>

    <span class="c1"># Find the median</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">inCollection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">medoidIncludeBands</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1"># Find the squared difference from the median for each image</span>
    <span class="c1"># Multiply by -1 so quality mosaic function can be used</span>
    <span class="k">def</span> <span class="nf">msdGetter</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">medoidIncludeBands</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">median</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">addYearBand</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">addJulianDayBand</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">diff</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">medoid</span> <span class="o">=</span> <span class="n">inCollection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">msdGetter</span><span class="p">)</span>

    <span class="c1"># Minimize the distance across all bands by finding the pixels that correspond to the minimum distance (multiplied by -1 above)</span>
    <span class="n">medoid</span> <span class="o">=</span> <span class="n">medoid</span><span class="o">.</span><span class="n">qualityMosaic</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
    <span class="n">medoid</span> <span class="o">=</span> <span class="n">medoid</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">medoid</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">medoid</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to export a provided image to an EE asset</span>
<span class="c1"># For earthengine-api version 0.1.226</span>
<span class="c1"># There was an issue with the region with this new version.</span>
<span class="c1"># From earthengine-api batch.Export.toAsset documentation: &quot;region: The lon,lat coordinates for a LinearRing or Polygon specifying the region to export.</span>
<span class="c1">#     Can be specified as a nested lists of numbers or a serialized string. Defaults to the image&#39;s region.&quot;</span>
<div class="viewcode-block" id="exportToAssetWrapper">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.exportToAssetWrapper">[docs]</a>
<span class="k">def</span> <span class="nf">exportToAssetWrapper</span><span class="p">(</span>
    <span class="n">imageForExport</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">assetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">assetPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pyramidingPolicyObject</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">roi</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exports an image to an Earth Engine asset.</span>

<span class="sd">    This function provides a wrapper for exporting images to Earth Engine assets with additional features like handling existing assets and setting the pyramiding policy.</span>

<span class="sd">    Args:</span>
<span class="sd">        imageForExport: The Earth Engine Image to export.</span>
<span class="sd">        assetName: The desired name for the asset.</span>
<span class="sd">        assetPath: The full path for the asset in the Earth Engine asset tree.</span>
<span class="sd">        pyramidingPolicyObject: An optional dictionary specifying the pyramiding policy for the exported asset.</span>
<span class="sd">        roi: An optional Earth Engine Geometry defining the region of interest for export.</span>
<span class="sd">        scale: The desired export scale in meters.</span>
<span class="sd">        crs: The desired coordinate reference system for the export.</span>
<span class="sd">        transform: The desired transform for the export.</span>
<span class="sd">        overwrite: A boolean indicating whether to overwrite an existing asset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None. The function starts the export task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get rid of any spaces</span>
    <span class="n">assetName</span> <span class="o">=</span> <span class="n">assetName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\s+/g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">assetPath</span> <span class="o">=</span> <span class="n">assetPath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\s+/g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="c1"># Pull geometry if feature or featureCollection</span>
    <span class="k">if</span> <span class="n">roi</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">imageForExport</span> <span class="o">=</span> <span class="n">imageForExport</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
        <span class="n">outRegion</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outRegion</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">transform</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&lt;type &#39;list&#39;&gt;&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&lt;class &#39;list&#39;&gt;&quot;</span><span class="p">):</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pyramidingPolicyObject</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pyramidingPolicyObject</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.default&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pyramidingPolicyObject</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">pyramidingPolicyObject</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.default&quot;</span><span class="p">:</span> <span class="n">pyramidingPolicyObject</span><span class="p">}</span>
    <span class="c1"># pyramidingPolicyObject = json.dumps(pyramidingPolicyObject)</span>
    <span class="c1"># print(&#39;pyramiding object:&#39;,pyramidingPolicyObject)</span>

    <span class="c1"># Handle different instances of an asset either already existing or currently being exported and whether it should be overwritten</span>
    <span class="n">currently_exporting</span> <span class="o">=</span> <span class="n">assetName</span> <span class="ow">in</span> <span class="n">tml</span><span class="o">.</span><span class="n">getTasks</span><span class="p">()[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">assetName</span> <span class="ow">in</span> <span class="n">tml</span><span class="o">.</span><span class="n">getTasks</span><span class="p">()[</span><span class="s2">&quot;ready&quot;</span><span class="p">]</span>
    <span class="n">currently_exists</span> <span class="o">=</span> <span class="n">aml</span><span class="o">.</span><span class="n">ee_asset_exists</span><span class="p">(</span><span class="n">assetPath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">currently_exists</span><span class="p">:</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">deleteAsset</span><span class="p">(</span><span class="n">assetPath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">currently_exporting</span><span class="p">:</span>
        <span class="n">tml</span><span class="o">.</span><span class="n">cancelByName</span><span class="p">(</span><span class="n">assetName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">currently_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">currently_exporting</span><span class="p">):</span>

        <span class="c1"># LSC 1/6/20 was getting error: &quot;ee.ee_exception.EEException: JSON provided for reductionPolicy must be an object.&quot; Getting rid of json.dumps() seemed to fix the problem</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">Export</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">toAsset</span><span class="p">(</span>
            <span class="n">imageForExport</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">assetName</span><span class="p">,</span>
            <span class="n">assetId</span><span class="o">=</span><span class="n">assetPath</span><span class="p">,</span>
            <span class="n">pyramidingPolicy</span><span class="o">=</span><span class="n">pyramidingPolicyObject</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">crsTransform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">maxPixels</span><span class="o">=</span><span class="mf">1e13</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting:&quot;</span><span class="p">,</span> <span class="n">assetName</span><span class="p">)</span>
        <span class="c1"># print(t)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assetName</span><span class="si">}</span><span class="s2"> currently exists or is being exported and overwrite = False. Set overwite = True if you would like to overwite any existing asset or asset exporting task&quot;</span><span class="p">)</span></div>

    <span class="c1"># Map.addLayer(imageForExport,vizParamsFalse,assetName)</span>


<span class="c1">#########################################################################</span>
<div class="viewcode-block" id="exportToDriveWrapper">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.exportToDriveWrapper">[docs]</a>
<span class="k">def</span> <span class="nf">exportToDriveWrapper</span><span class="p">(</span><span class="n">imageForExport</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">outputName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">driveFolderName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roi</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outputNoData</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exports an image to Google Drive.</span>

<span class="sd">    This function exports an Earth Engine Image to a specified Google Drive folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        imageForExport: The Earth Engine Image to export.</span>
<span class="sd">        outputName: The desired name for the exported file.</span>
<span class="sd">        driveFolderName: The name of the Google Drive folder to export to.</span>
<span class="sd">        roi: The Earth Engine Geometry defining the region of interest.</span>
<span class="sd">        scale: The desired export scale in meters.</span>
<span class="sd">        crs: The desired coordinate reference system for the export.</span>
<span class="sd">        transform: The desired transform for the export.</span>
<span class="sd">        outputNoData: The no data value to use for the export.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None. The function starts the export task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outputName</span> <span class="o">=</span> <span class="n">outputName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\s+/g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>  <span class="c1"># Get rid of any spaces</span>

    <span class="c1"># Pull geometry if feature or featureCollection</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">e</span>

    <span class="c1"># Make sure image is clipped to roi in case it&#39;s a multi-part polygon</span>
    <span class="n">imageForExport</span> <span class="o">=</span> <span class="n">imageForExport</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">outputNoData</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transform</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&lt;type &#39;list&#39;&gt;&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&lt;class &#39;list&#39;&gt;&quot;</span><span class="p">):</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="c1"># Ensure bounds are in export projection</span>
    <span class="n">outRegion</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Map.addLayer(imageForExport,{},outputName,False)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">Export</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">toDrive</span><span class="p">(</span>
        <span class="n">imageForExport</span><span class="p">,</span>
        <span class="n">outputName</span><span class="p">,</span>
        <span class="n">driveFolderName</span><span class="p">,</span>
        <span class="n">outputName</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">outRegion</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">,</span>
        <span class="n">crs</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">,</span>
        <span class="mf">1e13</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting:&quot;</span><span class="p">,</span> <span class="n">outputName</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>



<span class="c1">#########################################################################</span>
<div class="viewcode-block" id="exportToCloudStorageWrapper">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.exportToCloudStorageWrapper">[docs]</a>
<span class="k">def</span> <span class="nf">exportToCloudStorageWrapper</span><span class="p">(</span>
    <span class="n">imageForExport</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
    <span class="n">outputName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bucketName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">roi</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputNoData</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">,</span>
    <span class="n">fileFormat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GeoTIFF&quot;</span><span class="p">,</span>
    <span class="n">formatOptions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cloudOptimized&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exports an image to Google Cloud Storage.</span>

<span class="sd">    This function exports an Earth Engine Image to a specified Google Cloud Storage bucket.</span>

<span class="sd">    Args:</span>
<span class="sd">        imageForExport: The Earth Engine Image to export.</span>
<span class="sd">        outputName: The desired name for the exported file.</span>
<span class="sd">        bucketName: The name of the Google Cloud Storage bucket.</span>
<span class="sd">        roi: The Earth Engine Geometry defining the region of interest.</span>
<span class="sd">        scale: The desired export scale in meters.</span>
<span class="sd">        crs: The desired coordinate reference system for the export.</span>
<span class="sd">        transform: The desired transform for the export.</span>
<span class="sd">        outputNoData: The no data value to use for the export.</span>
<span class="sd">        fileFormat: The desired output file format (e.g., &quot;GeoTIFF&quot;, &quot;TFRecord&quot;).</span>
<span class="sd">        formatOptions: Additional format options for the export.</span>
<span class="sd">        overwrite: A boolean indicating whether to overwrite an existing file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None. The function starts the export task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outputName</span> <span class="o">=</span> <span class="n">outputName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\s+/g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>  <span class="c1"># Get rid of any spaces</span>

    <span class="n">extension_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GeoTIFF&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;.tif&quot;</span><span class="p">],</span> <span class="s2">&quot;TFRecord&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;.tfrecord&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">]}</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="n">extension_dict</span><span class="p">[</span><span class="n">fileFormat</span><span class="p">]</span>
    <span class="c1"># Pull geometry if feature or featureCollection</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">e</span>

    <span class="c1"># Make sure image is clipped to roi in case it&#39;s a multi-part polygon</span>
    <span class="n">imageForExport</span> <span class="o">=</span> <span class="n">imageForExport</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">outputNoData</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transform</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&lt;type &#39;list&#39;&gt;&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&lt;class &#39;list&#39;&gt;&quot;</span><span class="p">):</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="c1"># Ensure bounds are in export projection</span>
    <span class="n">outRegion</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Handle different instances of an blob either already existing or currently being exported and whether it should be overwritten</span>
    <span class="n">currently_exporting</span> <span class="o">=</span> <span class="n">outputName</span> <span class="ow">in</span> <span class="n">tml</span><span class="o">.</span><span class="n">getTasks</span><span class="p">()[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">outputName</span> <span class="ow">in</span> <span class="n">tml</span><span class="o">.</span><span class="n">getTasks</span><span class="p">()[</span><span class="s2">&quot;ready&quot;</span><span class="p">]</span>
    <span class="n">currently_exists</span> <span class="o">=</span> <span class="n">cml</span><span class="o">.</span><span class="n">gcs_exists</span><span class="p">(</span><span class="n">bucketName</span><span class="p">,</span> <span class="n">outputName</span> <span class="o">+</span> <span class="n">extensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">currently_exists</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="n">cml</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">bucketName</span><span class="p">,</span> <span class="n">outputName</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">currently_exporting</span><span class="p">:</span>
        <span class="n">tml</span><span class="o">.</span><span class="n">cancelByName</span><span class="p">(</span><span class="n">outputName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">currently_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">currently_exporting</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">Export</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">toCloudStorage</span><span class="p">(</span>
            <span class="n">imageForExport</span><span class="p">,</span>
            <span class="n">outputName</span><span class="p">,</span>
            <span class="n">bucketName</span><span class="p">,</span>
            <span class="n">outputName</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">outRegion</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="p">,</span>
            <span class="mf">1e13</span><span class="p">,</span>
            <span class="n">fileFormat</span><span class="o">=</span><span class="n">fileFormat</span><span class="p">,</span>
            <span class="n">formatOptions</span><span class="o">=</span><span class="n">formatOptions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting:&quot;</span><span class="p">,</span> <span class="n">outputName</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for wrapping dates when the startJulian &lt; endJulian</span>
<span class="c1"># Checks for year with majority of the days and the wrapOffset</span>
<div class="viewcode-block" id="wrapDates">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.wrapDates">[docs]</a>
<span class="k">def</span> <span class="nf">wrapDates</span><span class="p">(</span><span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wraps dates when the startJulian is greater than the endJulian.</span>

<span class="sd">    This function handles cases where the start Julian day is later in the year than the end Julian day.</span>

<span class="sd">    Args:</span>
<span class="sd">        startJulian: The start Julian day.</span>
<span class="sd">        endJulian: The end Julian day.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list containing the wrap offset and the year with the majority of days.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up date wrapping</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">yearWithMajority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">startJulian</span> <span class="o">&gt;</span> <span class="n">endJulian</span><span class="p">:</span>
        <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">365</span>
        <span class="n">y1NDays</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">-</span> <span class="n">startJulian</span>
        <span class="n">y2NDays</span> <span class="o">=</span> <span class="n">endJulian</span>
        <span class="k">if</span> <span class="n">y2NDays</span> <span class="o">&gt;</span> <span class="n">y1NDays</span><span class="p">:</span>
            <span class="n">yearWithMajority</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">wrapOffset</span><span class="p">,</span> <span class="n">yearWithMajority</span><span class="p">]</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Create composites for each year within startYear and endYear range</span>
<div class="viewcode-block" id="compositeTimeSeries">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.compositeTimeSeries">[docs]</a>
<span class="k">def</span> <span class="nf">compositeTimeSeries</span><span class="p">(</span>
    <span class="n">ls</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timebuffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">compositingMethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">compositingReducer</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates composites for each year within a specified date range.</span>

<span class="sd">    This function generates annual composites from an image collection, allowing for time buffering and weighted averaging.</span>


<span class="sd">    Args:</span>
<span class="sd">        ls: The input Earth Engine image collection.</span>
<span class="sd">        startYear: The start year of the composite period.</span>
<span class="sd">        endYear: The end year of the composite period.</span>
<span class="sd">        startJulian: The start Julian day of the composite period.</span>
<span class="sd">        endJulian: The end Julian day of the composite period.</span>
<span class="sd">        timebuffer: The number of years to include in the composite (default: 0).</span>
<span class="sd">        weights: The weights for the composite (default: [1]).</span>
<span class="sd">        compositingMethod: The compositing method (e.g., &#39;median&#39;, &#39;medoid&#39;) (optional).</span>
<span class="sd">        compositingReducer: A custom compositing reducer (optional).</span>

<span class="sd">    Returns:</span>
<span class="sd">        An Earth Engine image collection containing the composites.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="n">dateWrapping</span> <span class="o">=</span> <span class="n">wrapDates</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">)</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="n">dateWrapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yearWithMajority</span> <span class="o">=</span> <span class="n">dateWrapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">yearCompositeGetter</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>

        <span class="c1"># Set up dates</span>
        <span class="n">startYearT</span> <span class="o">=</span> <span class="n">year</span> <span class="o">-</span> <span class="n">timebuffer</span>
        <span class="n">endYearT</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">timebuffer</span>
        <span class="n">startDateT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYearT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
        <span class="n">endDateT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">endYearT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

        <span class="c1"># print(year,startDateT,endDateT)</span>

        <span class="c1"># Set up weighted moving widow</span>
        <span class="n">yearsT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYearT</span><span class="p">,</span> <span class="n">endYearT</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">zipper</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">yearsT</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="n">yearsTT</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">zipper</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># print(&#39;Weighted composite years for year:&#39;,year,yearsTT.getInfo())</span>

        <span class="c1"># Iterate across each year in list</span>
        <span class="k">def</span> <span class="nf">yrGetter</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
            <span class="c1"># Set up dates</span>
            <span class="n">startDateT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
            <span class="n">endDateT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

            <span class="c1"># Filter images for given date range</span>
            <span class="n">lsT</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDateT</span><span class="p">,</span> <span class="n">endDateT</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span>
            <span class="n">lsT</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">lsT</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lsT</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">yearsTT</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">yrGetter</span><span class="p">)</span>
        <span class="n">lsT</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">lsT</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">count</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;compositeObsCount&quot;</span><span class="p">])</span>
        <span class="c1"># Compute median or medoid or apply reducer</span>
        <span class="k">if</span> <span class="n">compositingReducer</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">lsT</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">compositingReducer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">compositingMethod</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">lsT</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">medoidMosaicMSD</span><span class="p">(</span><span class="n">lsT</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">composite</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;system:time_start&quot;</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span>
                <span class="s2">&quot;startDate&quot;</span><span class="p">:</span> <span class="n">startDateT</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span>
                <span class="s2">&quot;endDate&quot;</span><span class="p">:</span> <span class="n">endDateT</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span>
                <span class="s2">&quot;startJulian&quot;</span><span class="p">:</span> <span class="n">startJulian</span><span class="p">,</span>
                <span class="s2">&quot;endJulian&quot;</span><span class="p">:</span> <span class="n">endJulian</span><span class="p">,</span>
                <span class="s2">&quot;yearBuffer&quot;</span><span class="p">:</span> <span class="n">timebuffer</span><span class="p">,</span>
                <span class="s2">&quot;yearWeights&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
                <span class="s2">&quot;yrOriginal&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                <span class="s2">&quot;yrUsed&quot;</span><span class="p">:</span> <span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Iterate across each year</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">[</span><span class="n">yearCompositeGetter</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span> <span class="o">+</span> <span class="n">timebuffer</span><span class="p">,</span> <span class="n">endYear</span> <span class="o">-</span> <span class="n">timebuffer</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ts</span></div>



<span class="c1"># ////////////////////////////////////////////////////////////////////////////////</span>
<span class="c1"># Function to calculate illumination condition (IC). Function by Patrick Burns</span>
<span class="c1"># (pb463@nau.edu) and Matt Macander</span>
<span class="c1"># (mmacander@abrinc.com)</span>
<span class="k">def</span> <span class="nf">illuminationCorrection</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">bandList</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the Sun-Canopy-Sensor + C (SCSc) correction method to an image.</span>

<span class="sd">    This function corrects for topographic effects on image reflectance.</span>

<span class="sd">    Args:</span>
<span class="sd">        img: The input Earth Engine Image.</span>
<span class="sd">        scale: The scale for the reduction region.</span>
<span class="sd">        studyArea: The study area.</span>
<span class="sd">        bandList: A list of bands to correct.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The corrected Earth Engine Image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract solar zenith and azimuth bands</span>
    <span class="n">SZ_rad</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;zenith&quot;</span><span class="p">)</span>
    <span class="n">SA_rad</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;azimuth&quot;</span><span class="p">)</span>

    <span class="c1"># Creat terrain layers</span>
    <span class="c1"># dem = ee.Image(&#39;CGIAR/SRTM90_V4&#39;)</span>
    <span class="n">dem</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;USGS/NED&quot;</span><span class="p">)</span>
    <span class="n">slp</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Terrain</span><span class="o">.</span><span class="n">slope</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span>
    <span class="n">slp_rad</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Terrain</span><span class="o">.</span><span class="n">slope</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">asp_rad</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Terrain</span><span class="o">.</span><span class="n">aspect</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>

    <span class="c1"># Calculate the Illumination Condition (IC)</span>
    <span class="c1"># slope part of the illumination condition</span>
    <span class="n">cosZ</span> <span class="o">=</span> <span class="n">SZ_rad</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">cosS</span> <span class="o">=</span> <span class="n">slp_rad</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">slope_illumination</span> <span class="o">=</span> <span class="n">cosS</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="s2">&quot;cosZ * cosS&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;cosZ&quot;</span><span class="p">:</span> <span class="n">cosZ</span><span class="p">,</span> <span class="s2">&quot;cosS&quot;</span><span class="p">:</span> <span class="n">cosS</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;slope&quot;</span><span class="p">)})</span>
    <span class="c1"># aspect part of the illumination condition</span>
    <span class="n">sinZ</span> <span class="o">=</span> <span class="n">SZ_rad</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="n">sinS</span> <span class="o">=</span> <span class="n">slp_rad</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="n">cosAziDiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">SA_rad</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">asp_rad</span><span class="p">))</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">aspect_illumination</span> <span class="o">=</span> <span class="n">sinZ</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
        <span class="s2">&quot;sinZ * sinS * cosAziDiff&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;sinZ&quot;</span><span class="p">:</span> <span class="n">sinZ</span><span class="p">,</span> <span class="s2">&quot;sinS&quot;</span><span class="p">:</span> <span class="n">sinS</span><span class="p">,</span> <span class="s2">&quot;cosAziDiff&quot;</span><span class="p">:</span> <span class="n">cosAziDiff</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="c1"># full illumination condition (IC)</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="n">slope_illumination</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aspect_illumination</span><span class="p">)</span>

    <span class="c1"># Add IC to original image</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;IC&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">cosZ</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;cosZ&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">cosS</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;cosS&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">slp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;slope&quot;</span><span class="p">))</span>


<span class="c1">########################################</span>
<span class="c1"># Function to apply the Sun-Canopy-Sensor + C (SCSc) correction method to each</span>
<span class="c1"># image. Function by Patrick Burns (pb463@nau.edu) and Matt Macander</span>
<span class="c1"># (mmacander@s.com)</span>
<span class="k">def</span> <span class="nf">illuminationCorrection</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">,</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">],</span>
<span class="p">):</span>

    <span class="n">props</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">toDictionary</span><span class="p">()</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span>
    <span class="n">img_plus_ic</span> <span class="o">=</span> <span class="n">img</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">img_plus_ic</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;slope&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img_plus_ic</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img_plus_ic</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">))</span>
    <span class="n">img_plus_ic_mask2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img_plus_ic</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mask2</span><span class="p">))</span>

    <span class="c1"># Specify Bands to topographically correct</span>
    <span class="n">compositeBands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">nonCorrectBands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compositeBands</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">bandList</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">apply_SCSccorr</span><span class="p">(</span><span class="n">bandList</span><span class="p">):</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;SCSc&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">img_plus_ic_mask2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IC&quot;</span><span class="p">,</span> <span class="n">bandList</span><span class="p">)</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s2">&quot;reducer&quot;</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">linearFit</span><span class="p">(),</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">studyArea</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span>
                <span class="s2">&quot;maxPixels&quot;</span><span class="p">:</span> <span class="mf">1e13</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">out_a</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">))</span>
        <span class="n">out_b</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">))</span>
        <span class="n">out_c</span> <span class="o">=</span> <span class="n">out_b</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">out_a</span><span class="p">)</span>
        <span class="c1"># Apply the SCSc correction</span>
        <span class="n">SCSc_output</span> <span class="o">=</span> <span class="n">img_plus_ic_mask2</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
            <span class="s2">&quot;((image * (cosB * cosZ + cvalue)) / (ic + cvalue))&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">img_plus_ic_mask2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandList</span><span class="p">),</span>
                <span class="s2">&quot;ic&quot;</span><span class="p">:</span> <span class="n">img_plus_ic_mask2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IC&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cosB&quot;</span><span class="p">:</span> <span class="n">img_plus_ic_mask2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;cosS&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cosZ&quot;</span><span class="p">:</span> <span class="n">img_plus_ic_mask2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;cosZ&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cvalue&quot;</span><span class="p">:</span> <span class="n">out_c</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">SCSc_output</span>

    <span class="n">img_SCSccorr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">bandList</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_SCSccorr</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img_plus_ic</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IC&quot;</span><span class="p">))</span>
    <span class="n">bandList_IC</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="n">bandList</span><span class="p">,</span> <span class="s2">&quot;IC&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">img_SCSccorr</span> <span class="o">=</span> <span class="n">img_SCSccorr</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">img_plus_ic</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandList_IC</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bandList</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img_SCSccorr</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">nonCorrectBands</span><span class="p">)</span><span class="o">.</span><span class="n">setMulti</span><span class="p">(</span><span class="n">props</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># A function to mask out pixels that did not have observations for MODIS.</span>
<div class="viewcode-block" id="maskEmptyPixels">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.maskEmptyPixels">[docs]</a>
<span class="k">def</span> <span class="nf">maskEmptyPixels</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Masks pixels without observations in an image.</span>

<span class="sd">    This function masks pixels where the number of observations is zero.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine Image with a &quot;num_observations_1km&quot; band.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The masked Earth Engine Image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find pixels that had observations.</span>
    <span class="n">withObs</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;num_observations_1km&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">withObs</span><span class="p">))</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># A function that returns an image containing just the specified QA bits.</span>
<span class="c1">#</span>
<span class="c1"># Args:</span>
<span class="c1">#   image - The QA Image to get bits from.</span>
<span class="c1">#   start - The first bit position, 0-based.</span>
<span class="c1">#   end   - The last bit position, inclusive.</span>
<span class="c1">#   name  - A name for the output image.</span>


<div class="viewcode-block" id="getQABits">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getQABits">[docs]</a>
<span class="k">def</span> <span class="nf">getQABits</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts specific bits from a QA band.</span>

<span class="sd">    This function extracts a range of bits from a QA band and creates a new band.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The input Earth Engine Image with a QA band.</span>
<span class="sd">        start: The starting bit position (0-based).</span>
<span class="sd">        end: The ending bit position.</span>
<span class="sd">        name: The name for the output band.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The Earth Engine Image with the extracted bits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the bits we need to extract.</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="c1"># Return a single band image of the extracted QA bits, giving the band a new name.</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">newName</span><span class="p">])</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">rightShift</span><span class="p">(</span><span class="n">start</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># A function to mask out cloudy pixels.</span>
<span class="k">def</span> <span class="nf">maskCloudsWQA</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="c1"># Select the QA band.</span>
    <span class="n">QA</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;state_1km&quot;</span><span class="p">)</span>
    <span class="c1"># Get the internal_cloud_algorithm_flag bit.</span>
    <span class="n">internalCloud</span> <span class="o">=</span> <span class="n">getQABits</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;internal_cloud_algorithm_flag&quot;</span><span class="p">)</span>
    <span class="c1"># Return an image masking out cloudy areas.</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">internalCloud</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Source: code.earthengine.google.com</span>
<span class="c1"># Compute a cloud score.  This expects the input image to have the common</span>
<span class="c1"># band names: [&quot;red&quot;, &quot;blue&quot;, etc], so it can work across sensors.</span>
<span class="k">def</span> <span class="nf">modisCloudScore</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>

    <span class="n">useTempInCloudMask</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Compute several indicators of cloudyness and take the minimum of them.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Clouds are reasonably bright in the blue band.</span>
    <span class="c1"># score = score.min(rescale(img, &#39;img.blue&#39;, [0.1, 0.3]))</span>
    <span class="c1"># Clouds are reasonably bright in all visible bands.</span>
    <span class="n">vizSum</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vizSum</span><span class="p">)</span>

    <span class="c1"># Clouds are reasonably bright in all infrared bands.</span>
    <span class="c1"># irSum =rescale(img, &#39;img.nir + img.swir2&#39;, [0.3, 0.7])</span>
    <span class="n">irSum</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">irSum</span><span class="p">)</span>

    <span class="c1"># However, clouds are not snow.</span>
    <span class="n">ndsi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span>
    <span class="n">snowScore</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">ndsi</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">snowScore</span><span class="p">)</span>

    <span class="c1"># For MODIS, provide the option of not using thermal since it introduces</span>
    <span class="c1"># a precomputed mask that may or may not be wanted</span>
    <span class="k">if</span> <span class="n">useTempInCloudMask</span><span class="p">:</span>
        <span class="c1"># Clouds are reasonably cool in temperature.</span>
        <span class="c1"># tempScore = rescale(img, &#39;img.temp&#39;, [305, 300])</span>
        <span class="c1"># Map.addLayer(tempScore,{},&#39;tempscore&#39;)</span>
        <span class="c1"># score = score.min(tempScore)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;temp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">score</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Cloud masking algorithm for Sentinel2</span>
<span class="c1"># Built on ideas from Landsat cloudScore algorithm</span>
<span class="c1"># Currently in beta and may need tweaking for individual study areas</span>
<span class="k">def</span> <span class="nf">sentinel2CloudScore</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="c1"># Compute several indicators of cloudyness and take the minimum of them.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">blueCirrusScore</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Clouds are reasonably bright in the blue or cirrus bands.</span>
    <span class="c1"># Use .max as a pseudo OR conditional</span>
    <span class="n">blueCirrusScore</span> <span class="o">=</span> <span class="n">blueCirrusScore</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">]),</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span>
    <span class="n">blueCirrusScore</span> <span class="o">=</span> <span class="n">blueCirrusScore</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cb&quot;</span><span class="p">]),</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span>
    <span class="c1"># blueCirrusScore = blueCirrusScore.max(rescale(img, &#39;img.cirrus&#39;, [0.1, 0.3]))</span>

    <span class="c1"># reSum = rescale(img,&#39;(img.re1+img.re2+img.re3)/3&#39;,[0.5, 0.7])</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">blueCirrusScore</span><span class="p">)</span>

    <span class="c1"># Clouds are reasonably bright in all visible bands.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>

    <span class="c1"># Clouds are reasonably bright in all infrared bands.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>

    <span class="c1"># However, clouds are not snow.</span>
    <span class="n">ndsi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rescale</span><span class="p">(</span><span class="n">ndsi</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]))</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;cloudScore&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">score</span>


<span class="c1">#########################################################################</span>
<span class="c1"># Adapted from: https://earth.esa.int/documents/10174/3166008/ESA_Training_Vilnius_07072017_SAR_Optical_Snow_Ice_Exercises.pdf</span>
<span class="k">def</span> <span class="nf">sentinel2SnowMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
    <span class="n">ndsi</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">])</span>

    <span class="c1"># IF NDSI &gt; 0.40 AND ρ(NIR) &gt; 0.11 THEN snow in open land</span>
    <span class="c1"># IF 0.1 &lt; NDSI &lt; 0.4 THEN snow in forest</span>
    <span class="n">snowOpenLand</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;nir&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mf">0.11</span><span class="p">))</span>
    <span class="n">snowForest</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">ndsi</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.4</span><span class="p">))</span>

    <span class="c1"># Map.addLayer(snowOpenLand.selfMask(),{&#39;min&#39;:1,&#39;max&#39;:1,&#39;palette&#39;:&#39;88F&#39;},&#39;Snow Open Land&#39;)</span>
    <span class="c1"># Map.addLayer(snowForest.selfMask(),{&#39;min&#39;:1,&#39;max&#39;:1,&#39;palette&#39;:&#39;00F&#39;},&#39;Snow Forest&#39;)</span>
    <span class="c1"># Fractional snow cover (FSC, 0 % - 100% snow) can be detected by the approach of Salomonson</span>
    <span class="c1"># and Appel (2004, 2006), which was originally developed for MODIS data:</span>
    <span class="c1"># FSC = –0.01 + 1.45 * NDSI</span>
    <span class="n">fsc</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">1.45</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="c1"># Map.addLayer(fsc,{&#39;min&#39;:0,&#39;max&#39;:1,&#39;palette&#39;:&#39;080,008&#39;},&#39;Fractional Snow Cover&#39;)</span>
    <span class="n">snowMask</span> <span class="o">=</span> <span class="p">((</span><span class="n">snowOpenLand</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">snowForest</span><span class="p">))</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">dilatePixels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">snowMask</span><span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># MODIS processing</span>
<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Some globals to deal with multi-spectral MODIS</span>
<span class="c1"># wTempSelectOrder = [2,3,0,1,4,6,5]#Band order to select to be Landsat 5-like if thermal is included</span>
<span class="c1"># wTempStdNames = [&#39;blue&#39;, &#39;green&#39;, &#39;red&#39;, &#39;nir&#39;, &#39;swir1&#39;,&#39;temp&#39;,&#39;swir2&#39;]</span>

<span class="c1"># woTempSelectOrder = [2,3,0,1,4,5]#Band order to select to be Landsat 5-like if thermal is excluded</span>
<span class="c1"># woTempStdNames = [&#39;blue&#39;, &#39;green&#39;, &#39;red&#39;, &#39;nir&#39;, &#39;swir1&#39;,&#39;swir2&#39;]</span>
<span class="n">modis250SelectBands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sur_refl_b01&quot;</span><span class="p">,</span> <span class="s2">&quot;sur_refl_b02&quot;</span><span class="p">]</span>
<span class="n">modis250BandNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">]</span>

<span class="n">modis500SelectBands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sur_refl_b03&quot;</span><span class="p">,</span> <span class="s2">&quot;sur_refl_b04&quot;</span><span class="p">,</span> <span class="s2">&quot;sur_refl_b06&quot;</span><span class="p">,</span> <span class="s2">&quot;sur_refl_b07&quot;</span><span class="p">]</span>
<span class="n">modis500BandNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">]</span>

<span class="n">combinedModisBandNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">]</span>

<span class="n">dailyViewAngleBandNames</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;SensorZenith&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SensorAzimuth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SolarZenith&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SolarAzimuth&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">compositeViewAngleBandNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SolarZenith&quot;</span><span class="p">,</span> <span class="s2">&quot;ViewZenith&quot;</span><span class="p">,</span> <span class="s2">&quot;RelativeAzimuth&quot;</span><span class="p">]</span>
<span class="c1"># Dictionary of MODIS collections</span>
<span class="n">modisCDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;eightDayNDVIA&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD13Q1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDayNDVIT&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD13Q1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDaySR250A&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD09Q1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDaySR250T&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD09Q1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDaySR500A&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD09A1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDaySR500T&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD09A1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDayLST1000A&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD11A2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eightDayLST1000T&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD11A2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dailySR250A&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD09GQ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dailySR250T&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD09GQ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dailySR500A&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD09GA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dailySR500T&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD09GA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dailyLST1000A&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MYD11A1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dailyLST1000T&quot;</span><span class="p">:</span> <span class="s2">&quot;MODIS/061/MOD11A1&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">multModisDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tempNoAngleDaily&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;Emis_31&quot;</span><span class="p">,</span> <span class="s2">&quot;Emis_32&quot;</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;tempNoAngleComposite&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;Emis_31&quot;</span><span class="p">,</span> <span class="s2">&quot;Emis_32&quot;</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;tempAngleDaily&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">[</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SensorZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SensorAzimuth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolarZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolarAzimuth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emis_31&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emis_32&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;tempAngleComposite&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">[</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolarZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ViewZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RelativeAzimuth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emis_31&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emis_32&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;noTempNoAngleDaily&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">]),</span>
        <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;noTempNoAngleComposite&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">]),</span>
        <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;noTempAngleDaily&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">[</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SensorZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SensorAzimuth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolarZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolarAzimuth&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;noTempAngleComposite&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">[</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolarZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ViewZenith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RelativeAzimuth&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">}</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Helper function to join two collections- Source: code.earthengine.google.com</span>
<span class="k">def</span> <span class="nf">joinCollections</span><span class="p">(</span>
    <span class="n">c1</span><span class="p">,</span>
    <span class="n">c2</span><span class="p">,</span>
    <span class="n">maskAnyNullValues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">joinProperty</span><span class="o">=</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span>
    <span class="n">joinPropertySecondary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="n">joinPropertySecondary</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">joinPropertySecondary</span> <span class="o">=</span> <span class="n">joinProperty</span>

    <span class="k">def</span> <span class="nf">MergeBands</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="c1"># A function to merge the bands together.</span>
        <span class="c1"># After a join, results are in &#39;primary&#39; and &#39;secondary&#39; properties.</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">),</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;secondary&quot;</span><span class="p">))</span>

    <span class="n">join</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
    <span class="n">joinFilter</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">joinProperty</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">joinPropertySecondary</span><span class="p">)</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">joinFilter</span><span class="p">))</span>

    <span class="n">joined</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">MergeBands</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">maskAnyNullValues</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">nuller</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">nuller</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">joined</span>


<span class="k">def</span> <span class="nf">smartJoin</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">hourDiff</span><span class="p">):</span>
    <span class="n">millis</span> <span class="o">=</span> <span class="n">hourDiff</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="c1"># Create a time filter to define a match as overlapping timestamps.</span>
    <span class="n">maxDiffFilter</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">maxDifference</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;difference&quot;</span><span class="p">:</span> <span class="n">millis</span><span class="p">,</span>
            <span class="s2">&quot;leftField&quot;</span><span class="p">:</span> <span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rightField&quot;</span><span class="p">:</span> <span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># Define the join.</span>
    <span class="n">saveBestJoin</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">saveBest</span><span class="p">({</span><span class="s2">&quot;matchKey&quot;</span><span class="p">:</span> <span class="s2">&quot;bestImage&quot;</span><span class="p">,</span> <span class="s2">&quot;measureKey&quot;</span><span class="p">:</span> <span class="s2">&quot;timeDiff&quot;</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">MergeBands</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="c1"># A function to merge the bands together.</span>
        <span class="c1"># After a join, results are in &#39;primary&#39; and &#39;secondary&#39; properties.</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bestImage&quot;</span><span class="p">))</span>

    <span class="c1"># Apply the join.</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">saveBestJoin</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">maxDiffFilter</span><span class="p">)</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">MergeBands</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">joined</span>


<span class="c1">#########################################################################</span>
<span class="c1"># Join collections by space (intersection) and time (specified by user)</span>
<span class="k">def</span> <span class="nf">spatioTemporalJoin</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">hourDiff</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">outKey</span><span class="o">=</span><span class="s2">&quot;secondary&quot;</span><span class="p">):</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">hourDiff</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="n">outBns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">secondary</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outKey</span><span class="p">))</span>
    <span class="c1"># Define a spatial filter as geometries that intersect.</span>
    <span class="n">spatioTemporalFilter</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">And</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">maxDifference</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;difference&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                <span class="s2">&quot;leftField&quot;</span><span class="p">:</span> <span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rightField&quot;</span><span class="p">:</span> <span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">intersects</span><span class="p">({</span><span class="s2">&quot;leftField&quot;</span><span class="p">:</span> <span class="s2">&quot;.geo&quot;</span><span class="p">,</span> <span class="s2">&quot;rightField&quot;</span><span class="p">:</span> <span class="s2">&quot;.geo&quot;</span><span class="p">,</span> <span class="s2">&quot;maxError&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}),</span>
    <span class="p">)</span>
    <span class="c1"># Define a save all join.</span>
    <span class="n">saveBestJoin</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">saveBest</span><span class="p">({</span><span class="s2">&quot;matchKey&quot;</span><span class="p">:</span> <span class="n">outKey</span><span class="p">,</span> <span class="s2">&quot;measureKey&quot;</span><span class="p">:</span> <span class="s2">&quot;timeDiff&quot;</span><span class="p">})</span>

    <span class="c1"># Apply the join.</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">saveBestJoin</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">spatioTemporalFilter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MergeBands</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="c1"># A function to merge the bands together.</span>
        <span class="c1"># After a join, results are in &#39;primary&#39; and &#39;secondary&#39; properties.</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">outKey</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">outBns</span><span class="p">))</span>

    <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">MergeBands</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">joined</span>


<span class="c1"># Simple inner join function for featureCollections</span>
<span class="c1"># Matches features based on an exact match of the fieldName parameter</span>
<span class="c1"># An optional different field name can be provided for the second featureCollection</span>
<span class="c1"># Retains the geometry of the primary, but copies the properties of the secondary collection</span>
<span class="k">def</span> <span class="nf">joinFeatureCollections</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">fieldName</span><span class="p">,</span> <span class="n">fieldNameSecondary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fieldNameSecondary</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fieldNameSecondary</span> <span class="o">=</span> <span class="n">fieldName</span>
    <span class="c1"># Use an equals filter to specify how the collections match.</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">fieldName</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fieldNameSecondary</span><span class="p">)</span>

    <span class="c1"># Define the join.</span>
    <span class="n">innerJoin</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="s2">&quot;secondary&quot;</span><span class="p">)</span>

    <span class="c1"># Apply the join.</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">innerJoin</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;secondary&quot;</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">joined</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Method for removing spikes in time series</span>
<span class="k">def</span> <span class="nf">despikeCollection</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">absoluteSpike</span><span class="p">,</span> <span class="n">bandNo</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Get book ends for adding back at the end</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Slice the left, center, and right for the moving window</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Find how many images there are to compare</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Compare the center to the left and right images</span>
    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">lt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">ct</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">center</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">time_start</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span>
        <span class="n">time_end</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_end&quot;</span><span class="p">)</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">)</span>

        <span class="n">diff1</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bandNo</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">lt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bandNo</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">diff2</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bandNo</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">rt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">bandNo</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">highSpike</span> <span class="o">=</span> <span class="n">diff1</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">absoluteSpike</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">diff2</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">absoluteSpike</span><span class="p">))</span>
        <span class="n">lowSpike</span> <span class="o">=</span> <span class="n">diff1</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="o">-</span><span class="n">absoluteSpike</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">diff2</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="o">-</span><span class="n">absoluteSpike</span><span class="p">))</span>
        <span class="n">BinarySpike</span> <span class="o">=</span> <span class="n">highSpike</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">lowSpike</span><span class="p">)</span>

        <span class="n">originalMask</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">BinarySpike</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">doNotMask</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">rt</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span>
        <span class="n">lrMean</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
        <span class="n">lrMean</span> <span class="o">=</span> <span class="n">lrMean</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># out = ct.mask(doNotMask.Not().And(ct.mask()))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BinarySpike</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">doNotMask</span><span class="o">.</span><span class="n">Not</span><span class="p">()),</span> <span class="n">lrMean</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">time_start</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_end&quot;</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>

    <span class="n">outCollection</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>

    <span class="c1"># Add the bookends back on</span>
    <span class="n">outCollection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="n">first</span><span class="p">,</span> <span class="n">outCollection</span><span class="p">,</span> <span class="n">last</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">outCollection</span><span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to get MODIS data from various collections</span>
<span class="c1"># Will pull from daily or 8-day composite collections based on the boolean variable &quot;daily&quot;</span>
<div class="viewcode-block" id="getModisData">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getModisData">[docs]</a>
<span class="k">def</span> <span class="nf">getModisData</span><span class="p">(</span>
    <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">daily</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">maskWQA</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zenithThresh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
    <span class="n">useTempInCloudMask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">addLookAngleBands</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">resampleMethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;near&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves MODIS imagery from Earth Engine for a specified period. Handles joining all MODIS collections for Terra and Aqua and aligning band names</span>

<span class="sd">    Args:</span>
<span class="sd">        startYear (int): The starting year for the data collection.</span>
<span class="sd">        endYear (int): The ending year for the data collection.</span>
<span class="sd">        startJulian (int): The starting Julian day of year for the data collection (1-366).</span>
<span class="sd">        endJulian (int): The ending Julian day of year for the data collection (1-366).</span>
<span class="sd">        daily (bool, optional): Determines whether to retrieve daily or 8-day composite data. Defaults to False (8-day composite).</span>
<span class="sd">        maskWQA (bool, optional): Controls whether to mask pixels based on the Quality Assurance (QA) band. Only applicable for daily data (daily=True). Defaults to False.</span>
<span class="sd">        zenithThresh (float, optional): Sets the threshold for solar zenith angle in degrees. Pixels with zenith angle exceeding this threshold will be masked out. Defaults to 90.</span>
<span class="sd">        useTempInCloudMask (bool, optional): Determines whether to use the thermal band for cloud masking. Defaults to True.</span>
<span class="sd">        addLookAngleBands (bool, optional): Controls whether to include view angle bands in the output. Defaults to False.</span>
<span class="sd">        resampleMethod (str, optional): Specifies the resampling method to apply to the imagery. Valid options include &quot;near&quot;, &quot;bilinear&quot;, and &quot;bicubic&quot;. Defaults to &quot;near&quot; (nearest neighbor).</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of MODIS imagery for the specified criteria.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; crs = gil.common_projections[&quot;NLCD_CONUS&quot;][&quot;crs&quot;]</span>
<span class="sd">    &gt;&gt;&gt; transform = gil.common_projections[&quot;NLCD_CONUS&quot;][&quot;transform&quot;]</span>
<span class="sd">    &gt;&gt;&gt; scale = 240</span>
<span class="sd">    &gt;&gt;&gt; transform[0] = scale</span>
<span class="sd">    &gt;&gt;&gt; transform[4] = -scale</span>
<span class="sd">    &gt;&gt;&gt; composite = gil.getModisData(2024, 2024, 190, 250, resampleMethod=&quot;bicubic&quot;).median().reproject(crs, transform)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(composite, gil.vizParamsFalse, &quot;MODIS Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.setCenter(-111, 41, 7)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find which collections to pull from based on daily or 8-day</span>
    <span class="k">if</span> <span class="n">daily</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">a250C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;eightDaySR250A&quot;</span><span class="p">]</span>
        <span class="n">t250C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;eightDaySR250T&quot;</span><span class="p">]</span>
        <span class="n">a500C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;eightDaySR500A&quot;</span><span class="p">]</span>
        <span class="n">t500C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;eightDaySR500T&quot;</span><span class="p">]</span>
        <span class="n">a1000C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;eightDayLST1000A&quot;</span><span class="p">]</span>
        <span class="n">t1000C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;eightDayLST1000T&quot;</span><span class="p">]</span>
        <span class="n">viewAngleBandNames</span> <span class="o">=</span> <span class="n">compositeViewAngleBandNames</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a250C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;dailySR250A&quot;</span><span class="p">]</span>
        <span class="n">t250C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;dailySR250T&quot;</span><span class="p">]</span>
        <span class="n">a500C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;dailySR500A&quot;</span><span class="p">]</span>
        <span class="n">t500C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;dailySR500T&quot;</span><span class="p">]</span>
        <span class="n">a1000C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;dailyLST1000A&quot;</span><span class="p">]</span>
        <span class="n">t1000C</span> <span class="o">=</span> <span class="n">modisCDict</span><span class="p">[</span><span class="s2">&quot;dailyLST1000T&quot;</span><span class="p">]</span>
        <span class="n">viewAngleBandNames</span> <span class="o">=</span> <span class="n">dailyViewAngleBandNames</span>

    <span class="c1"># Pull images from each of the collections</span>
    <span class="n">a250</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">a250C</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">modis250SelectBands</span><span class="p">,</span> <span class="n">modis250BandNames</span><span class="p">)</span>

    <span class="n">t250</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">t250C</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">modis250SelectBands</span><span class="p">,</span> <span class="n">modis250BandNames</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">addLookAngleBands</span><span class="p">:</span>
        <span class="n">modis500SelectBandsT</span> <span class="o">=</span> <span class="n">modis500SelectBands</span> <span class="o">+</span> <span class="n">viewAngleBandNames</span>
        <span class="n">modis500BandNamesT</span> <span class="o">=</span> <span class="n">modis500BandNames</span> <span class="o">+</span> <span class="n">viewAngleBandNames</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">modis500SelectBandsT</span> <span class="o">=</span> <span class="n">modis500SelectBands</span>
        <span class="n">modis500BandNamesT</span> <span class="o">=</span> <span class="n">modis500BandNames</span>

    <span class="k">def</span> <span class="nf">get500</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">applyZenith</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;SensorZenith&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">zenithThresh</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">maskWQA</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">maskCloudsWQA</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>

        <span class="c1"># Mask pixels above a certain zenith</span>
        <span class="k">if</span> <span class="n">daily</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maskWQA</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Masking with QA band:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">applyZenith</span><span class="p">)</span>

        <span class="c1">#     images = images.select(modis500SelectBands, modis500BandNames)</span>
        <span class="c1"># else:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">modis500SelectBandsT</span><span class="p">,</span> <span class="n">modis500BandNamesT</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">images</span>

    <span class="n">a500</span> <span class="o">=</span> <span class="n">get500</span><span class="p">(</span><span class="n">a500C</span><span class="p">)</span>
    <span class="n">t500</span> <span class="o">=</span> <span class="n">get500</span><span class="p">(</span><span class="n">t500C</span><span class="p">)</span>

    <span class="c1"># If thermal collection is wanted, pull it as well</span>
    <span class="n">tempbandNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;Emis_31&quot;</span><span class="p">,</span> <span class="s2">&quot;Emis_32&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">useTempInCloudMask</span><span class="p">:</span>
        <span class="n">t1000</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">t1000C</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">tempbandNames</span><span class="p">)</span>

        <span class="n">a1000</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">a1000C</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">tempbandNames</span><span class="p">)</span>

    <span class="c1"># Now all collections are pulled, start joining them</span>
    <span class="c1"># First join the 250 and 500 m Aqua</span>
    <span class="c1"># a = joinCollections(a250, a500, False)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a250</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">a500</span><span class="p">,</span> <span class="n">modis500BandNamesT</span><span class="p">)</span>

    <span class="c1"># Then Terra</span>
    <span class="c1"># t = joinCollections(t250, t500, False)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t250</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">t500</span><span class="p">,</span> <span class="n">modis500BandNamesT</span><span class="p">)</span>
    <span class="c1"># If temp was pulled, join that in as well</span>
    <span class="c1"># Also select the bands in an L5-like order and give descriptive names</span>
    <span class="k">if</span> <span class="n">useTempInCloudMask</span><span class="p">:</span>
        <span class="c1"># a = joinCollections(a, a1000, False)</span>
        <span class="c1"># t = joinCollections(t, t1000, False)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">a1000</span><span class="p">,</span> <span class="n">tempbandNames</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">t1000</span><span class="p">,</span> <span class="n">tempbandNames</span><span class="p">)</span>
    <span class="c1">#   tSelectOrder = wTempSelectOrder</span>
    <span class="c1">#   tStdNames = wTempStdNames</span>

    <span class="c1"># #If no thermal was pulled, leave that out</span>
    <span class="c1"># else:</span>
    <span class="c1">#   tSelectOrder = woTempSelectOrder</span>
    <span class="c1">#   tStdNames = woTempStdNames</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;aqua&quot;</span><span class="p">}))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;terra&quot;</span><span class="p">}))</span>

    <span class="k">if</span> <span class="n">daily</span><span class="p">:</span>
        <span class="n">dailyPiece</span> <span class="o">=</span> <span class="s2">&quot;Daily&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dailyPiece</span> <span class="o">=</span> <span class="s2">&quot;Composite&quot;</span>

    <span class="k">if</span> <span class="n">useTempInCloudMask</span><span class="p">:</span>
        <span class="n">tempPiece</span> <span class="o">=</span> <span class="s2">&quot;temp&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tempPiece</span> <span class="o">=</span> <span class="s2">&quot;noTemp&quot;</span>
    <span class="k">if</span> <span class="n">addLookAngleBands</span><span class="p">:</span>
        <span class="n">anglePiece</span> <span class="o">=</span> <span class="s2">&quot;Angle&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anglePiece</span> <span class="o">=</span> <span class="s2">&quot;NoAngle&quot;</span>
    <span class="n">multKey</span> <span class="o">=</span> <span class="n">tempPiece</span> <span class="o">+</span> <span class="n">anglePiece</span> <span class="o">+</span> <span class="n">dailyPiece</span>

    <span class="n">mult</span> <span class="o">=</span> <span class="n">multModisDict</span><span class="p">[</span><span class="n">multKey</span><span class="p">]</span>
    <span class="n">multImage</span> <span class="o">=</span> <span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">multNames</span> <span class="o">=</span> <span class="n">mult</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Join Terra and Aqua</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>  <span class="c1"># .select(tSelectOrder,tStdNames)</span>

    <span class="k">def</span> <span class="nf">multiplyImg</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">multImage</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">multNames</span><span class="p">)</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="s2">&quot;system:time_end&quot;</span><span class="p">,</span> <span class="s2">&quot;system:index&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setResample</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resampleMethod</span><span class="p">)</span>

    <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">multiplyImg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resampleMethod</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting resample method to &quot;</span><span class="p">,</span> <span class="n">resampleMethod</span><span class="p">)</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">setResample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">joined</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to get cloud, cloud shadow busted modis images</span>
<span class="c1"># Takes care of matching different modis collections as well</span>
<div class="viewcode-block" id="getProcessedModis">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getProcessedModis">[docs]</a>
<span class="k">def</span> <span class="nf">getProcessedModis</span><span class="p">(</span>
    <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">zenithThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
    <span class="n">addLookAngleBands</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">applyCloudScore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">applyTDOM</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">useTempInCloudMask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScoreThresh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">zScoreThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">],</span>
    <span class="n">resampleMethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">,</span>
    <span class="n">preComputedCloudScoreOffset</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRMean</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRStdDev</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">addToMap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves, processes, and filters MODIS imagery for a specified period.</span>

<span class="sd">    This function retrieves daily MODIS imagery from Earth Engine, applies various cloud and</span>
<span class="sd">    cloud shadow masking techniques, and returns a collection of processed images.</span>

<span class="sd">    Args:</span>
<span class="sd">        startYear (int): The starting year for the data collection.</span>
<span class="sd">        endYear (int): The ending year for the data collection.</span>
<span class="sd">        startJulian (int): The starting Julian day of year for the data collection (1-366).</span>
<span class="sd">        endJulian (int): The ending Julian day of year for the data collection (1-366).</span>
<span class="sd">        zenithThresh (float, optional): Sets the threshold for solar zenith angle in degrees. Pixels with zenith angle exceeding this threshold will be masked out. Defaults to 90.</span>
<span class="sd">        addLookAngleBands (bool, optional): Controls whether to include view angle bands in the output. Defaults to True.</span>
<span class="sd">        applyCloudScore (bool, optional): Determines whether to apply cloud masking based on the CloudScore simple algorithm adapted to MODIS. Defaults to True.</span>
<span class="sd">        applyTDOM (bool, optional): Determines whether to apply the TDOM (Temporal Dark Outlier Mask)</span>
<span class="sd">        technique for cloud shadow masking. Defaults to True.</span>
<span class="sd">        useTempInCloudMask (bool, optional): Determines whether to use the thermal band for cloud masking during MODIS data retrieval. Defaults to True.</span>
<span class="sd">        cloudScoreThresh (int, optional): Threshold for the CloudScore simple algorithm to classify a pixel as cloudy. Lower number masks out more. Defaults to 20.</span>
<span class="sd">        performCloudScoreOffset (bool, optional): Controls whether to perform an offset correction on the Cloud Score data over bright surfaces. Only use this if bright areas are being masked as clouds. Do not use this in persistently cloud areas. Defaults to True.</span>
<span class="sd">        cloudScorePctl (int, optional): Percentile of the Cloud Score product to use for the offset correction. Defaults to 10.</span>
<span class="sd">        zScoreThresh (float, optional): Threshold for the z-score used in TDOM cloud shadow masking. Pixels with z-scores below this threshold are masked. Defaults to -1.</span>
<span class="sd">        shadowSumThresh (float, optional): Threshold for the sum of reflectance in shadow bands used in TDOM cloud shadow masking. Pixels below this threshold and the zScoreThresh are masked as dark outliers (likely cloud shadows). Defaults to 0.35.</span>
<span class="sd">        contractPixels (int, optional): Number of pixels to contract cloud and shadow masks by. Defaults to 0.</span>
<span class="sd">        dilatePixels (float, optional): Number of pixels to dilate cloud and shadow masks by. Defaults to 2.5.</span>
<span class="sd">        shadowSumBands (list[str], optional): List of band names to use for calculating the sum of reflectance in TDOM cloud shadow masking. Defaults to [&quot;nir&quot;, &quot;swir2&quot;].</span>
<span class="sd">        resampleMethod (str, optional): Specifies the resampling method to apply to the imagery. Valid options include &quot;near&quot;, &quot;bilinear&quot;, and &quot;bicubic&quot;. Defaults to &quot;bicubic&quot;.</span>
<span class="sd">        preComputedCloudScoreOffset (float | None, optional): Pre-computed Cloud Score offset value to avoid redundant calculations. Defaults to None (automatic calculation).</span>
<span class="sd">        preComputedTDOMIRMean (float | None, optional): Pre-computed mean of the IR band used in TDOM cloud shadow masking to avoid redundant calculations. Defaults to None (automatic calculation).</span>
<span class="sd">        preComputedTDOMIRStdDev (float | None, optional): Pre-computed standard deviation of the IR band used in TDOM cloud shadow masking to avoid redundant calculations. Defaults to None (automatic calculation).</span>
<span class="sd">        addToMap (bool, optional): Controls whether to add intermediate processing steps (masked medians) to the Earth Engine map for visualization purposes. Defaults to False.</span>
<span class="sd">        crs (str, optional): Only used if addToMap is True. Coordinate Reference System (CRS) for the output imagery. Defaults to &quot;EPSG:4326&quot;.</span>
<span class="sd">        scale (int | None, optional): Only used if addToMap is True. Scale (resolution) of the output imagery in meters. Defaults to 250.</span>
<span class="sd">        transform (list | None, optional): Only used if addToMap is True. Optional transformation matrix to apply to the output imagery. Defaults to None.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; crs = gil.common_projections[&quot;NLCD_CONUS&quot;][&quot;crs&quot;]</span>
<span class="sd">    &gt;&gt;&gt; transform = gil.common_projections[&quot;NLCD_CONUS&quot;][&quot;transform&quot;]</span>
<span class="sd">    &gt;&gt;&gt; scale = 240</span>
<span class="sd">    &gt;&gt;&gt; transform[0] = scale</span>
<span class="sd">    &gt;&gt;&gt; transform[4] = -scale</span>
<span class="sd">    &gt;&gt;&gt; composite = gil.getProcessedModis(2024, 2024, 190, 250).median().reproject(crs, transform)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(composite, gil.vizParamsFalse, &quot;MODIS Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.setCenter(-111, 41, 7)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="c1"># Get joined modis collection</span>
    <span class="n">modisImages</span> <span class="o">=</span> <span class="n">getModisData</span><span class="p">(</span>
        <span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="p">,</span>
        <span class="n">daily</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">maskWQA</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zenithThresh</span><span class="o">=</span><span class="n">zenithThresh</span><span class="p">,</span>
        <span class="n">useTempInCloudMask</span><span class="o">=</span><span class="n">useTempInCloudMask</span><span class="p">,</span>
        <span class="n">addLookAngleBands</span><span class="o">=</span><span class="n">addLookAngleBands</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">resampleMethod</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">addToMap</span><span class="p">:</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
            <span class="n">modisImages</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
            <span class="n">vizParamsFalse</span><span class="p">,</span>
            <span class="s2">&quot;Raw Median&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyCloudScore</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying cloudScore&quot;</span><span class="p">)</span>
        <span class="n">modisImages</span> <span class="o">=</span> <span class="n">applyCloudScoreAlgorithm</span><span class="p">(</span>
            <span class="n">modisImages</span><span class="p">,</span>
            <span class="n">modisCloudScore</span><span class="p">,</span>
            <span class="n">cloudScoreThresh</span><span class="p">,</span>
            <span class="n">cloudScorePctl</span><span class="p">,</span>
            <span class="n">contractPixels</span><span class="p">,</span>
            <span class="n">dilatePixels</span><span class="p">,</span>
            <span class="n">performCloudScoreOffset</span><span class="p">,</span>
            <span class="n">preComputedCloudScoreOffset</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">addToMap</span><span class="p">:</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
                <span class="n">modisImages</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
                <span class="n">vizParamsFalse</span><span class="p">,</span>
                <span class="s2">&quot;Cloud Masked Median&quot;</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
                <span class="n">modisImages</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
                <span class="n">vizParamsFalse</span><span class="p">,</span>
                <span class="s2">&quot;Cloud Masked Min&quot;</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyTDOM</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying TDOM&quot;</span><span class="p">)</span>
        <span class="c1"># Find and mask out dark outliers</span>
        <span class="n">modisImages</span> <span class="o">=</span> <span class="n">simpleTDOM2</span><span class="p">(</span>
            <span class="n">modisImages</span><span class="p">,</span>
            <span class="n">zScoreThresh</span><span class="p">,</span>
            <span class="n">shadowSumThresh</span><span class="p">,</span>
            <span class="n">contractPixels</span><span class="p">,</span>
            <span class="n">dilatePixels</span><span class="p">,</span>
            <span class="n">shadowSumBands</span><span class="p">,</span>
            <span class="n">preComputedTDOMIRMean</span><span class="p">,</span>
            <span class="n">preComputedTDOMIRStdDev</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">addToMap</span><span class="p">:</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
                <span class="n">modisImages</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
                <span class="n">vizParamsFalse</span><span class="p">,</span>
                <span class="s2">&quot;Cloud/Cloud Shadow Masked Median&quot;</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span>
                <span class="n">modisImages</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
                <span class="n">vizParamsFalse</span><span class="p">,</span>
                <span class="s2">&quot;Cloud/Cloud Shadow Masked Min&quot;</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">modisImages</span> <span class="o">=</span> <span class="n">modisImages</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddIndices</span><span class="p">)</span>
    <span class="n">modisImages</span> <span class="o">=</span> <span class="n">modisImages</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">modisImages</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1"># Function to take images and create a median composite every n days</span>
<span class="k">def</span> <span class="nf">nDayComposites</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">,</span> <span class="n">compositePeriod</span><span class="p">):</span>

    <span class="c1"># create dummy image for with no values</span>
    <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="c1"># convert to composites as defined above</span>
    <span class="k">def</span> <span class="nf">getYrImages</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
        <span class="c1"># take the year of the image</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="c1"># filter out images for the year</span>
        <span class="n">yrImages</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>

        <span class="c1"># use dummy image to fill in gaps for GEE processing</span>
        <span class="n">yrImages</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">yrImages</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yrImages</span>

    <span class="c1"># Get images for a specified start day</span>
    <span class="k">def</span> <span class="nf">getJdImages</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yrImages</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;yyyy-MM-dd&quot;</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">compositePeriod</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>
        <span class="n">jdImages</span> <span class="o">=</span> <span class="n">yrImages</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
        <span class="n">jdImages</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">jdImages</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">)</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">jdImages</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">composite</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;system:index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s2">&quot;system:time_start&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">millis</span><span class="p">()})</span>

    <span class="c1"># Set up wrappers</span>
    <span class="k">def</span> <span class="nf">jdWrapper</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yrImages</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">,</span> <span class="n">compositePeriod</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">start</span><span class="p">:</span> <span class="n">getJdImages</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yrImages</span><span class="p">,</span> <span class="n">start</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">yrWrapper</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
        <span class="n">yrImages</span> <span class="o">=</span> <span class="n">getYrImages</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jdWrapper</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yrImages</span><span class="p">)</span>

    <span class="n">composites</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yr</span><span class="p">:</span> <span class="n">yrWrapper</span><span class="p">(</span><span class="n">yr</span><span class="p">)))</span>
    <span class="c1"># return the composites as an image collection</span>
    <span class="n">composites</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">composites</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">composites</span>


<span class="c1">###############################################################</span>
<span class="c1">#########################################################################</span>
<span class="k">def</span> <span class="nf">exportCollection</span><span class="p">(</span>
    <span class="n">exportPathRoot</span><span class="p">,</span>
    <span class="n">outputName</span><span class="p">,</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">,</span>
    <span class="n">collection</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">compositingReducer</span><span class="p">,</span>
    <span class="n">timebuffer</span><span class="p">,</span>
    <span class="n">exportBands</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># Take care of date wrapping</span>
    <span class="n">dateWrapping</span> <span class="o">=</span> <span class="n">wrapDates</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">)</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="n">dateWrapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yearWithMajority</span> <span class="o">=</span> <span class="n">dateWrapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Clean up output name</span>
    <span class="n">outputName</span> <span class="o">=</span> <span class="n">outputName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\s+/g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">outputName</span> <span class="o">=</span> <span class="n">outputName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\//g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="c1"># Select bands for export</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exportBands</span><span class="p">)</span>

    <span class="c1"># Iterate across each year and export image</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span> <span class="o">+</span> <span class="n">timebuffer</span><span class="p">,</span> <span class="n">endYear</span> <span class="o">-</span> <span class="n">timebuffer</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting:&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
        <span class="c1"># Set up dates</span>
        <span class="n">startYearT</span> <span class="o">=</span> <span class="n">year</span> <span class="o">-</span> <span class="n">timebuffer</span>
        <span class="n">endYearT</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">timebuffer</span> <span class="o">+</span> <span class="n">yearWithMajority</span>

        <span class="c1"># Get yearly composite</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>

        <span class="c1"># Add metadata, cast to integer, and export composite</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;system:time_start&quot;</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span>
                <span class="s2">&quot;yearBuffer&quot;</span><span class="p">:</span> <span class="n">timebuffer</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Export the composite</span>
        <span class="c1"># Set up export name and path</span>
        <span class="n">exportName</span> <span class="o">=</span> <span class="n">outputName</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">startYearT</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endYearT</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">startJulian</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endJulian</span><span class="p">))</span>

        <span class="n">exportPath</span> <span class="o">=</span> <span class="n">exportPathRoot</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">exportName</span>

        <span class="n">exportToAssetWrapper</span><span class="p">(</span>
            <span class="n">composite</span><span class="p">,</span>
            <span class="n">exportName</span><span class="p">,</span>
            <span class="n">exportPath</span><span class="p">,</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="n">studyArea</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to export composite collection</span>
<span class="k">def</span> <span class="nf">exportCompositeCollection</span><span class="p">(</span>
    <span class="n">collection</span><span class="p">,</span>
    <span class="n">exportPathRoot</span><span class="p">,</span>
    <span class="n">outputName</span><span class="p">,</span>
    <span class="n">origin</span><span class="p">,</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">compositingMethod</span><span class="p">,</span>
    <span class="n">timebuffer</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="p">,</span>
    <span class="n">nonDivideBands</span><span class="p">,</span>
    <span class="n">exportBands</span><span class="p">,</span>
    <span class="n">additionalPropertyDict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">pyramidingPolicy</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
    <span class="n">dateWrapping</span> <span class="o">=</span> <span class="n">wrapDates</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">)</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="n">dateWrapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yearWithMajority</span> <span class="o">=</span> <span class="n">dateWrapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Clean up output name</span>
    <span class="n">outputName</span> <span class="o">=</span> <span class="n">outputName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\s+/g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">outputName</span> <span class="o">=</span> <span class="n">outputName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/\//g&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exportBands</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span> <span class="o">+</span> <span class="n">timebuffer</span><span class="p">,</span> <span class="n">endYear</span> <span class="o">-</span> <span class="n">timebuffer</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">():</span>
        <span class="c1"># Set up dates</span>
        <span class="n">startYearT</span> <span class="o">=</span> <span class="n">year</span> <span class="o">-</span> <span class="n">timebuffer</span>
        <span class="n">endYearT</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">timebuffer</span> <span class="o">+</span> <span class="n">yearWithMajority</span>

        <span class="c1"># Get yearly composite</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

        <span class="c1"># Reformat data for export</span>
        <span class="n">compositeBands</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nonDivideBands</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">composite10k</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compositeBands</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">nonDivideBands</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">composite10k</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nonDivideBands</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compositeBands</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

        <span class="n">startYearComposite</span> <span class="o">=</span> <span class="n">startYearT</span>
        <span class="n">endYearComposite</span> <span class="o">=</span> <span class="n">endYearT</span>
        <span class="n">systemTimeStartYear</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">yearWithMajority</span>
        <span class="n">yearOriginal</span> <span class="o">=</span> <span class="n">year</span>
        <span class="n">yearUsed</span> <span class="o">=</span> <span class="n">systemTimeStartYear</span>
        <span class="c1"># args[&#39;system:time_start&#39;] = ee.Date.fromYMD(systemTimeStartYear, 6, 1).millis()</span>

        <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">formatArgs</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

        <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">systemTimeStartYear</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">additionalPropertyDict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">additionalPropertyDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">additionalPropertyDict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">formatArgs</span><span class="p">(</span><span class="n">additionalPropertyDict</span><span class="p">))</span>

        <span class="c1"># Export the composite</span>
        <span class="c1"># Set up export name and path</span>
        <span class="n">exportName</span> <span class="o">=</span> <span class="n">outputName</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">toaOrSR</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">compositingMethod</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">startYearT</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endYearT</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">startJulian</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endJulian</span><span class="p">))</span>
        <span class="n">exportPath</span> <span class="o">=</span> <span class="n">exportPathRoot</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">exportName</span>

        <span class="n">exportToAssetWrapper</span><span class="p">(</span>
            <span class="n">imageForExport</span><span class="o">=</span><span class="n">composite</span><span class="p">,</span>
            <span class="n">assetName</span><span class="o">=</span><span class="n">exportName</span><span class="p">,</span>
            <span class="n">assetPath</span><span class="o">=</span><span class="n">exportPath</span><span class="p">,</span>
            <span class="n">pyramidingPolicyObject</span><span class="o">=</span><span class="n">pyramidingPolicy</span><span class="p">,</span>
            <span class="n">roi</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Wrapper function for getting Landsat imagery</span>
<span class="k">def</span> <span class="nf">getLandsatWrapper</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">timebuffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">compositingMethod</span><span class="o">=</span><span class="s2">&quot;medoid&quot;</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="o">=</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span>
    <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">defringeL5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyFmaskCloudMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyTDOM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyFmaskCloudShadowMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyFmaskSnowMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">zScoreThresh</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">correctIllumination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">correctScale</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">exportComposites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">outputName</span><span class="o">=</span><span class="s2">&quot;Landsat-Composite&quot;</span><span class="p">,</span>
    <span class="n">exportPathRoot</span><span class="o">=</span><span class="s2">&quot;users/username/test&quot;</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:5070&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2361915.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mf">3177735.0</span><span class="p">],</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resampleMethod</span><span class="o">=</span><span class="s2">&quot;near&quot;</span><span class="p">,</span>
    <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">compositingReducer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">harmonizeOLI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Landsat&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="c1"># Prepare dates</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">startJulian</span> <span class="o">&gt;</span> <span class="n">endJulian</span><span class="p">:</span>
        <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">endYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

    <span class="c1"># Get Landsat image collection and apply cloud masking</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">getProcessedLandsatScenes</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="n">includeSLCOffL7</span><span class="p">,</span>
        <span class="n">defringeL5</span><span class="o">=</span><span class="n">defringeL5</span><span class="p">,</span>
        <span class="n">applyCloudScore</span><span class="o">=</span><span class="n">applyCloudScore</span><span class="p">,</span>
        <span class="n">applyFmaskCloudMask</span><span class="o">=</span><span class="n">applyFmaskCloudMask</span><span class="p">,</span>
        <span class="n">applyTDOM</span><span class="o">=</span><span class="n">applyTDOM</span><span class="p">,</span>
        <span class="n">applyFmaskCloudShadowMask</span><span class="o">=</span><span class="n">applyFmaskCloudShadowMask</span><span class="p">,</span>
        <span class="n">applyFmaskSnowMask</span><span class="o">=</span><span class="n">applyFmaskSnowMask</span><span class="p">,</span>
        <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
        <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
        <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
        <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
        <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
        <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
        <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">resampleMethod</span><span class="p">,</span>
        <span class="n">harmonizeOLI</span><span class="o">=</span><span class="n">harmonizeOLI</span><span class="p">,</span>
        <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedCloudScoreOffset</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="n">preComputedTDOMIRMean</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedTDOMIRStdDev</span><span class="p">,</span>
        <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="n">landsatCollectionVersion</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add zenith and azimuth</span>
    <span class="k">if</span> <span class="n">correctIllumination</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding zenith and azimuth for terrain correction&quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">addZenithAzimuth</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">))</span>

    <span class="c1"># Create composite time series</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">compositeTimeSeries</span><span class="p">(</span>
        <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">timebuffer</span><span class="o">=</span><span class="n">timebuffer</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">compositingMethod</span><span class="o">=</span><span class="n">compositingMethod</span><span class="p">,</span>
        <span class="n">compositingReducer</span><span class="o">=</span><span class="n">compositingReducer</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Correct illumination</span>
    <span class="k">if</span> <span class="n">correctIllumination</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correcting illumination&quot;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">illuminationCondition</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">illuminationCorrection</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">correctScale</span><span class="p">,</span> <span class="n">studyArea</span><span class="p">))</span>

    <span class="c1"># Export composites</span>
    <span class="k">if</span> <span class="n">exportComposites</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">compositingMethod</span> <span class="o">==</span> <span class="s2">&quot;medoid&quot;</span><span class="p">:</span>
            <span class="n">exportBands</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sensor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;julianDay&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">nonDivideBands</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sensor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;julianDay&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exportBands</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">nonDivideBands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">]</span>

        <span class="n">exportCompositeCollection</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span>
            <span class="n">exportPathRoot</span><span class="o">=</span><span class="n">exportPathRoot</span><span class="p">,</span>
            <span class="n">outputName</span><span class="o">=</span><span class="n">outputName</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
            <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
            <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
            <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
            <span class="n">compositingMethod</span><span class="o">=</span><span class="n">compositingMethod</span><span class="p">,</span>
            <span class="n">timebuffer</span><span class="o">=</span><span class="n">timebuffer</span><span class="p">,</span>
            <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
            <span class="n">nonDivideBands</span><span class="o">=</span><span class="n">nonDivideBands</span><span class="p">,</span>
            <span class="n">exportBands</span><span class="o">=</span><span class="n">exportBands</span><span class="p">,</span>
            <span class="c1"># weights = weights,</span>
            <span class="c1"># defringeL5 = False,</span>
            <span class="c1"># includeSLCOffL7 = includeSLCOffL7,</span>
            <span class="c1"># convertToDailyMosaics = &#39;NA&#39;,</span>
            <span class="c1"># applyQABand = False,</span>
            <span class="c1"># applyCloudScore = applyCloudScore,</span>
            <span class="c1"># applyFmaskCloudMask = applyFmaskCloudMask,</span>
            <span class="c1"># applyCloudProbability = &#39;NA&#39;,</span>
            <span class="c1"># applyTDOM = applyTDOM,</span>
            <span class="c1"># applyFmaskCloudShadowMask = applyFmaskCloudShadowMask,</span>
            <span class="c1"># applyFmaskSnowMask = applyFmaskSnowMask,</span>
            <span class="c1"># applyShadowShift = &#39;NA&#39;,</span>
            <span class="c1"># cloudHeights = cloudHeights,</span>
            <span class="c1"># cloudScoreThresh = cloudScoreThresh,</span>
            <span class="c1"># performCloudScoreOffset = performCloudScoreOffset,</span>
            <span class="c1"># cloudScorePctl = cloudScorePctl,</span>
            <span class="c1"># zScoreThresh = zScoreThresh,</span>
            <span class="c1"># shadowSumThresh = shadowSumThresh,</span>
            <span class="c1"># contractPixels = contractPixels,</span>
            <span class="c1"># dilatePixels = dilatePixels,</span>
            <span class="c1"># correctIllumination = correctIllumination,</span>
            <span class="c1"># correctScale = correctScale,</span>
            <span class="c1"># nonDivideBands = nonDivideBands,</span>
            <span class="c1"># exportBands = exportBands,</span>
            <span class="c1"># resampleMethod = resampleMethod,</span>
            <span class="c1"># runChastainHarmonization = &#39;NA&#39;,</span>
            <span class="n">additionalPropertyDict</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;processedScenes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls</span>
    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;processedComposites&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>

    <span class="k">return</span> <span class="n">args</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Wrapper function for getting Landsat imagery</span>
<div class="viewcode-block" id="getProcessedLandsatScenes">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getProcessedLandsatScenes">[docs]</a>
<span class="k">def</span> <span class="nf">getProcessedLandsatScenes</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SR&quot;</span><span class="p">,</span>
    <span class="n">includeSLCOffL7</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">defringeL5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">applyFmaskCloudMask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">applyTDOM</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">applyFmaskCloudShadowMask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">applyFmaskSnowMask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cloudScoreThresh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">zScoreThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
    <span class="n">resampleMethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;near&quot;</span><span class="p">,</span>
    <span class="n">harmonizeOLI</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">preComputedCloudScoreOffset</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRMean</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRStdDev</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">landsatCollectionVersion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves, processes, and filters Landsat scenes for a specified area and time period.</span>

<span class="sd">    This function retrieves Landsat scenes from Earth Engine, applies various cloud,</span>
<span class="sd">    cloud shadow, and snow masking techniques, calculates common indices, and returns</span>
<span class="sd">    a collection of processed images.</span>

<span class="sd">    Args:</span>
<span class="sd">        studyArea (ee.Geometry): The geographic area of interest (study area) as an Earth Engine geometry, Feature, or FeatureCollection object.</span>
<span class="sd">        startYear (int): The starting year for the data collection.</span>
<span class="sd">        endYear (int): The ending year for the data collection.</span>
<span class="sd">        startJulian (int): The starting Julian day of year for the data collection (1-365).</span>
<span class="sd">        endJulian (int): The ending Julian day of year for the data collection (1-365).</span>
<span class="sd">        toaOrSR (str, optional): Flag indicating desired reflectance type: &quot;TOA&quot; (Top Of Atmosphere) or &quot;SR&quot; (Surface Reflectance). Defaults to &quot;SR&quot;.</span>
<span class="sd">        includeSLCOffL7 (bool, optional): Determines whether to include Landsat 7 SLC-off scenes. Defaults to False.</span>
<span class="sd">        defringeL5 (bool, optional): Determines whether to defringe Landsat 5 scenes. Defaults to False.</span>
<span class="sd">        applyCloudScore (bool, optional): Determines whether to apply cloud masking based on the CloudScore simple algorithm. Defaults to False.</span>
<span class="sd">        applyFmaskCloudMask (bool, optional): Determines whether to apply the Fmask cloud mask. Defaults to True.</span>
<span class="sd">        applyTDOM (bool, optional): Determines whether to apply the TDOM (Temporal Dark Outlier Mask) technique for cloud shadow masking. Defaults to False.</span>
<span class="sd">        applyFmaskCloudShadowMask (bool, optional): Determines whether to apply the Fmask cloud shadow mask. Defaults to True.</span>
<span class="sd">        applyFmaskSnowMask (bool, optional): Determines whether to apply the Fmask snow mask. Defaults to False.</span>
<span class="sd">        cloudScoreThresh (int, optional): Threshold for the CloudScore simple algorithm to classify a pixel as cloudy. Lower number masks out more. Defaults to 10.</span>
<span class="sd">        performCloudScoreOffset (bool, optional): Controls whether to perform an offset correction on the Cloud Score data over bright surfaces. Only use this if bright areas are being masked as clouds. Do not use this in persistently cloud areas. Defaults to True.</span>
<span class="sd">        cloudScorePctl (int, optional): Percentile of the Cloud Score product to use for the offset correction. Defaults to 10.</span>
<span class="sd">        zScoreThresh (float, optional): Threshold for the z-score used in TDOM cloud shadow masking. Pixels with z-scores below this threshold are masked. Defaults to -1.</span>
<span class="sd">        shadowSumThresh (float, optional): Threshold for the sum of reflectance in shadow bands used in TDOM cloud shadow masking. Pixels below this threshold and the zScoreThresh are masked as dark outliers (likely cloud shadows). Defaults to 0.35.</span>
<span class="sd">        contractPixels (float, optional): Number of pixels to contract cloud and shadow masks by. Defaults to 1.5.</span>
<span class="sd">        dilatePixels (float, optional): Number of pixels to dilate cloud and shadow masks by. Defaults to 3.5.</span>
<span class="sd">        shadowSumBands (list[str], optional): List of band names to use for calculating the sum of reflectance in TDOM cloud shadow masking. Defaults to [&quot;nir&quot;, &quot;swir1&quot;].</span>
<span class="sd">        resampleMethod (str, optional): Specifies the resampling method to apply to the imagery. Valid options include &quot;near&quot;, &quot;bilinear&quot;, and &quot;bicubic&quot;. Defaults to &quot;near&quot;.</span>
<span class="sd">        harmonizeOLI (bool, optional): Determines whether to harmonize OLI data to match TM/ETM+ spectral response. Defaults to False.</span>
<span class="sd">        preComputedCloudScoreOffset (float | None, optional): Pre-computed Cloud Score offset value to avoid redundant calculations. Defaults to None (automatic calculation).</span>
<span class="sd">        preComputedTDOMIRMean (float | None, optional): Pre-computed mean of the IR band used in TDOM cloud shadow masking to avoid redundant calculations. Defaults to None (automatic calculation).</span>
<span class="sd">        preComputedTDOMIRStdDev (float | None, optional): Pre-computed standard deviation of the IR band used in TDOM cloud shadow masking to avoid redundant calculations. Defaults to None (automatic calculation).</span>
<span class="sd">        landsatCollectionVersion (str, optional): Specifies the Landsat collection version to use (e.g., &quot;C1&quot;, &quot;C2&quot;). Defaults to &quot;C2&quot;.</span>
<span class="sd">        verbose (bool, optional): Controls whether to print additional information during processing. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of analysis ready, cloud and cloud shadow asked Landsat scenes with common band names.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CO&quot;]</span>
<span class="sd">    &gt;&gt;&gt; composite = gil.getProcessedLandsatScenes(studyArea, 2023, 2023, 190, 250).median()</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(composite, gil.vizParamsFalse, &quot;Landsat Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;canQuery&quot;: False}, &quot;Study Area&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Landsat&quot;</span>
    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;toa&quot;</span> <span class="ow">and</span> <span class="n">landsatCollectionVersion</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;c1&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">applyFmaskCloudMask</span> <span class="ow">or</span> <span class="n">applyFmaskCloudShadowMask</span> <span class="ow">or</span> <span class="n">applyFmaskSnowMask</span><span class="p">):</span>
        <span class="n">addPixelQA</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">addPixelQA</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Prepare dates</span>
    <span class="c1"># Wrap the dates if needed</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">startJulian</span> <span class="o">&gt;</span> <span class="n">endJulian</span><span class="p">:</span>
        <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">endYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get Processed Landsat: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Start date:&quot;</span><span class="p">,</span>
        <span class="n">startDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MMM dd yyyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
        <span class="s2">&quot;, End date:&quot;</span><span class="p">,</span>
        <span class="n">endDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MMM dd yyyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>

    <span class="c1"># Get Landsat image collection</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">getLandsat</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startDate</span><span class="o">=</span><span class="n">startDate</span><span class="p">,</span>
        <span class="n">endDate</span><span class="o">=</span><span class="n">endDate</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="n">includeSLCOffL7</span><span class="p">,</span>
        <span class="n">defringeL5</span><span class="o">=</span><span class="n">defringeL5</span><span class="p">,</span>
        <span class="n">addPixelQA</span><span class="o">=</span><span class="n">addPixelQA</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">resampleMethod</span><span class="p">,</span>
        <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="n">landsatCollectionVersion</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Apply relevant cloud masking methods</span>
    <span class="k">if</span> <span class="n">applyCloudScore</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Cloud Score&quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">applyCloudScoreAlgorithm</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
            <span class="n">cloudScoreFunction</span><span class="o">=</span><span class="n">landsatCloudScore</span><span class="p">,</span>
            <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
            <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
            <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
            <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
            <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
            <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedCloudScoreOffset</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyFmaskCloudMask</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Fmask Cloud Mask&quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">applyBitMask</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span>
                <span class="n">fmaskBitDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">][</span><span class="s2">&quot;cloud&quot;</span><span class="p">],</span>
                <span class="n">landsatFmaskBandNameDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyTDOM</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying TDOM Shadow Mask&quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">simpleTDOM2</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
            <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
            <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
            <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
            <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
            <span class="n">shadowSumBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
            <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="n">preComputedTDOMIRMean</span><span class="p">,</span>
            <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedTDOMIRStdDev</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyFmaskCloudShadowMask</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Fmask Shadow Mask&quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">applyBitMask</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span>
                <span class="n">fmaskBitDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">][</span><span class="s2">&quot;shadow&quot;</span><span class="p">],</span>
                <span class="n">landsatFmaskBandNameDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyFmaskSnowMask</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Fmask snow mask&quot;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">applyBitMask</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span>
                <span class="n">fmaskBitDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">][</span><span class="s2">&quot;snow&quot;</span><span class="p">],</span>
                <span class="n">landsatFmaskBandNameDict</span><span class="p">[</span><span class="n">landsatCollectionVersion</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Add common indices</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddIndices</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getTasseledCap</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddTCAngles</span><span class="p">)</span>

    <span class="c1"># Add Sensor Band</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">addSensorBand</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">landsatCollectionVersion</span> <span class="o">+</span> <span class="s2">&quot;_landsat&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ls</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Wrapper function for getting Sentinel2 imagery</span>
<span class="k">def</span> <span class="nf">getProcessedSentinel2Scenes</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">applyQABand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyShadowShift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyTDOM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">cloudHeights</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="n">zScoreThresh</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
    <span class="n">resampleMethod</span><span class="o">=</span><span class="s2">&quot;aggregate&quot;</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="o">=</span><span class="s2">&quot;TOA&quot;</span><span class="p">,</span>
    <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyCloudProbability</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cloudProbThresh</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScorePlus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
    <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Sentinel2&quot;</span>
    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="c1"># Prepare dates</span>
    <span class="c1"># Wrap the dates if needed</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">startJulian</span> <span class="o">&gt;</span> <span class="n">endJulian</span><span class="p">:</span>
        <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">endYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get Processed Sentinel2: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Start date:&quot;</span><span class="p">,</span>
        <span class="n">startDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MMM dd yyyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
        <span class="s2">&quot;, End date:&quot;</span><span class="p">,</span>
        <span class="n">endDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MMM dd yyyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>

    <span class="c1"># Get Sentinel2 image collection</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">getS2</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startDate</span><span class="o">=</span><span class="n">startDate</span><span class="p">,</span>
        <span class="n">endDate</span><span class="o">=</span><span class="n">endDate</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">resampleMethod</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="n">convertToDailyMosaics</span><span class="p">,</span>
        <span class="n">addCloudProbability</span><span class="o">=</span><span class="n">applyCloudProbability</span><span class="p">,</span>
        <span class="n">addCloudScorePlus</span><span class="o">=</span><span class="n">applyCloudScorePlus</span><span class="p">,</span>
        <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="n">cloudScorePlusScore</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyQABand</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying QA Band Cloud Mask&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">maskS2clouds</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">applyCloudScore</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Cloud Score&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">applyCloudScoreAlgorithm</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">s2s</span><span class="p">,</span>
            <span class="n">cloudScoreFunction</span><span class="o">=</span><span class="n">sentinel2CloudScore</span><span class="p">,</span>
            <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
            <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
            <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
            <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
            <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
            <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedCloudScoreOffset</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyCloudProbability</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Cloud Probability&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cloud_probability&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">cloudProbThresh</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">applyCloudScorePlus</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying cloudScore+&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cloudScorePlus&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">cloudScorePlusThresh</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">applyShadowShift</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Shadow Shift&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">projectShadowsWrapper</span><span class="p">(</span>
                <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
                <span class="n">cloudThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
                <span class="n">irSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
                <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
                <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
                <span class="n">cloudHeights</span><span class="o">=</span><span class="n">cloudHeights</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">applyTDOM</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying TDOM&quot;</span><span class="p">)</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">simpleTDOM2</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">s2s</span><span class="p">,</span>
            <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
            <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
            <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
            <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
            <span class="n">shadowSumBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
            <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="n">preComputedTDOMIRMean</span><span class="p">,</span>
            <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedTDOMIRStdDev</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Add common indices</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddIndices</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getTasseledCap</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddTCAngles</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">normalizedDifference</span><span class="p">([</span><span class="s2">&quot;re1&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;NDCI&quot;</span><span class="p">])))</span>
    <span class="c1"># Add Sensor Band</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">addSensorBand</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s2">&quot;sentinel2&quot;</span><span class="p">,</span> <span class="n">toaOrSR</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">s2s</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<div class="viewcode-block" id="superSimpleGetS2">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.superSimpleGetS2">[docs]</a>
<span class="k">def</span> <span class="nf">superSimpleGetS2</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">,</span>
    <span class="n">startDate</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">endDate</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">365</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TOA&quot;</span><span class="p">,</span>
    <span class="n">applyCloudScorePlus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePlusThresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="n">cloudScorePlusScore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cs&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves Sentinel-2 satellite imagery from Earth Engine for a specified study area and date range.</span>
<span class="sd">    It applies the cloudScore+ algorithm unless told otherwise.</span>

<span class="sd">    Args:</span>
<span class="sd">        studyArea (ee.Geometry): An Earth Engine geometry object representing the area of interest.</span>
<span class="sd">        startDate (ee.Date, datetime.datetime, or str): The start date for the image collection in YYYY-MM-DD format.</span>
<span class="sd">        endDate (ee.Date, datetime.datetime, or str): The end date for the image collection in YYYY-MM-DD format.</span>
<span class="sd">        startJulian (int, optional): The start Julian day of the desired data. Defaults to 1.</span>
<span class="sd">        endJulian (int, optional): The end Julian day of the desired data. Defaults to 365.</span>
<span class="sd">        toaOrSR (str, optional): Specifies whether to retrieve data in Top-Of-Atmosphere (TOA) reflectance or Surface Reflectance (SR). Defaults to &quot;TOA&quot;.</span>
<span class="sd">        applyCloudScorePlus (bool, optional): Determines whether to apply cloud filtering based on the Cloud Score Plus product. Defaults to True.</span>
<span class="sd">        cloudScorePlusThresh (float, optional): Sets the threshold for cloud cover percentage based on Cloud Score Plus. Images with cloud cover exceeding this threshold will be masked out if `applyCloudScorePlus` is True. A higher value will mask out more pixels (call them cloud/cloud-shadow). Defaults to 0.6.</span>
<span class="sd">        cloudScorePlusScore (str, optional): One of &quot;cs&quot; - Tends to mask out more. Commits ephemeral water, but doesn&#39;t omit cloud shadows as much or &quot;cs_cdf&quot; - Tends to mask out less, notably fewer water bodies and shadows. This can result in omitting cloud shadows, but not committing ephemeral water as a cloud shadow. Specifies the band name within the Cloud Score Plus product containing the cloud cover information. Defaults to &quot;cs&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: A collection of cloud and cloud-shadow-free Sentinel-2 satellite images filtered by the specified criteria.</span>


<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CA&quot;]</span>
<span class="sd">    &gt;&gt;&gt; composite = gil.superSimpleGetS2(studyArea, &quot;2024-01-01&quot;, &quot;2024-12-31&quot;, 190, 250).median()</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(composite, gil.vizParamsFalse10k, &quot;Sentinel-2 Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;canQuery&quot;: False}, &quot;Study Area&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">startDate</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">endDate</span><span class="p">)</span>

    <span class="n">s2s</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">s2CollectionDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span><span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span>

    <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sensorBandDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">],</span> <span class="n">sensorBandNameDict</span><span class="p">[</span><span class="n">toaOrSR</span><span class="p">])</span>

    <span class="n">cloudScorePlus</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">cloudScorePlusScore</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;cloudScorePlus&quot;</span><span class="p">])</span>

    <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">linkCollection</span><span class="p">(</span><span class="n">cloudScorePlus</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cloudScorePlus&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">applyCloudScorePlus</span><span class="p">:</span>
        <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cloudScorePlus&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">cloudScorePlusThresh</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">s2s</span></div>



<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Wrapper function for getting Sentinel 2 imagery</span>
<span class="k">def</span> <span class="nf">getSentinel2Wrapper</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">timebuffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">compositingMethod</span><span class="o">=</span><span class="s2">&quot;medoid&quot;</span><span class="p">,</span>
    <span class="n">applyQABand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyShadowShift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyTDOM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">cloudHeights</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="n">zScoreThresh</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
    <span class="n">correctIllumination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">correctScale</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">exportComposites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">outputName</span><span class="o">=</span><span class="s2">&quot;Sentinel2-Composite&quot;</span><span class="p">,</span>
    <span class="n">exportPathRoot</span><span class="o">=</span><span class="s2">&quot;users/username/test&quot;</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:5070&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2361915.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mf">3177735.0</span><span class="p">],</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resampleMethod</span><span class="o">=</span><span class="s2">&quot;aggregate&quot;</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="o">=</span><span class="s2">&quot;TOA&quot;</span><span class="p">,</span>
    <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyCloudProbability</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cloudProbThresh</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScorePlus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
    <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Sentinel2&quot;</span>
    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="n">s2s</span> <span class="o">=</span> <span class="n">getProcessedSentinel2Scenes</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">applyQABand</span><span class="o">=</span><span class="n">applyQABand</span><span class="p">,</span>
        <span class="n">applyCloudScore</span><span class="o">=</span><span class="n">applyCloudScore</span><span class="p">,</span>
        <span class="n">applyShadowShift</span><span class="o">=</span><span class="n">applyShadowShift</span><span class="p">,</span>
        <span class="n">applyTDOM</span><span class="o">=</span><span class="n">applyTDOM</span><span class="p">,</span>
        <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
        <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
        <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
        <span class="n">cloudHeights</span><span class="o">=</span><span class="n">cloudHeights</span><span class="p">,</span>
        <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
        <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
        <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
        <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
        <span class="n">shadowSumBands</span><span class="o">=</span><span class="n">shadowSumBands</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">resampleMethod</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="n">convertToDailyMosaics</span><span class="p">,</span>
        <span class="n">applyCloudProbability</span><span class="o">=</span><span class="n">applyCloudProbability</span><span class="p">,</span>
        <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedCloudScoreOffset</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="n">preComputedTDOMIRMean</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedTDOMIRStdDev</span><span class="p">,</span>
        <span class="n">cloudProbThresh</span><span class="o">=</span><span class="n">cloudProbThresh</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">applyCloudScorePlus</span><span class="o">=</span><span class="n">applyCloudScorePlus</span><span class="p">,</span>
        <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="n">cloudScorePlusThresh</span><span class="p">,</span>
        <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="n">cloudScorePlusScore</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add zenith and azimuth</span>
    <span class="c1"># if correctIllumination:</span>
    <span class="c1">#  s2s = s2s.map(function(img){</span>
    <span class="c1">#    return addZenithAzimuth(img,&#39;TOA&#39;,{&#39;TOA&#39;:&#39;MEAN_SOLAR_ZENITH_ANGLE&#39;},{&#39;TOA&#39;:&#39;MEAN_SOLAR_AZIMUTH_ANGLE&#39;});</span>
    <span class="c1">#  });</span>
    <span class="c1"># }</span>

    <span class="c1"># Create composite time series</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">compositeTimeSeries</span><span class="p">(</span>
        <span class="n">ls</span><span class="o">=</span><span class="n">s2s</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">timebuffer</span><span class="o">=</span><span class="n">timebuffer</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">compositingMethod</span><span class="o">=</span><span class="n">compositingMethod</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Correct illumination</span>
    <span class="c1"># if (correctIllumination){</span>
    <span class="c1">#   f = ee.Image(ts.first());</span>
    <span class="c1">#   Map.addLayer(f,vizParamsFalse,&#39;First-non-illuminated&#39;,false);</span>

    <span class="c1">#   print(&#39;Correcting illumination&#39;);</span>
    <span class="c1">#   ts = ts.map(illuminationCondition)</span>
    <span class="c1">#     .map(function(img){</span>
    <span class="c1">#       return illuminationCorrection(img, correctScale,studyArea,[ &#39;blue&#39;, &#39;green&#39;, &#39;red&#39;,&#39;nir&#39;,&#39;swir1&#39;, &#39;swir2&#39;]);</span>
    <span class="c1">#     });</span>
    <span class="c1">#   f = ee.Image(ts.first());</span>
    <span class="c1">#   Map.addLayer(f,vizParamsFalse,&#39;First-illuminated&#39;,false);</span>

    <span class="c1"># Export composites</span>
    <span class="k">if</span> <span class="n">exportComposites</span><span class="p">:</span>
        <span class="n">exportBandDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SR_medoid&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;cb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;waterVapor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sensor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;julianDay&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;SR_median&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;cb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;waterVapor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;TOA_medoid&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;cb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;waterVapor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cirrus&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sensor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;julianDay&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;TOA_median&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;cb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;waterVapor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cirrus&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="n">nonDivideBandDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;medoid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span> <span class="s2">&quot;sensor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;julianDay&quot;</span><span class="p">],</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;compositeObsCount&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">exportBands</span> <span class="o">=</span> <span class="n">exportBandDict</span><span class="p">[</span><span class="n">toaOrSR</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">compositingMethod</span><span class="p">]</span>
        <span class="n">nonDivideBands</span> <span class="o">=</span> <span class="n">nonDivideBandDict</span><span class="p">[</span><span class="n">compositingMethod</span><span class="p">]</span>

        <span class="n">exportCompositeCollection</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span>
            <span class="n">exportPathRoot</span><span class="o">=</span><span class="n">exportPathRoot</span><span class="p">,</span>
            <span class="n">outputName</span><span class="o">=</span><span class="n">outputName</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
            <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
            <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
            <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
            <span class="n">compositingMethod</span><span class="o">=</span><span class="n">compositingMethod</span><span class="p">,</span>
            <span class="n">timebuffer</span><span class="o">=</span><span class="n">timebuffer</span><span class="p">,</span>
            <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
            <span class="n">nonDivideBands</span><span class="o">=</span><span class="n">nonDivideBands</span><span class="p">,</span>
            <span class="n">exportBands</span><span class="o">=</span><span class="n">exportBands</span><span class="p">,</span>
            <span class="n">additionalPropertyDict</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;processedScenes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2s</span>
    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;processedComposites&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>

    <span class="k">return</span> <span class="n">args</span>


<span class="c1"># Hybrid get Landsat and Sentinel 2 processed scenes</span>
<span class="c1"># Handles getting processed scenes  with Landsat and Sentinel 2</span>
<span class="k">def</span> <span class="nf">getProcessedLandsatAndSentinel2Scenes</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="o">=</span><span class="s2">&quot;TOA&quot;</span><span class="p">,</span>
    <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">defringeL5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyQABand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudProbability</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyShadowShift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScoreLandsat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScoreSentinel2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyTDOMLandsat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyTDOMSentinel2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyFmaskCloudMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyFmaskCloudShadowMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyFmaskSnowMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cloudHeights</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">zScoreThresh</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
    <span class="n">landsatResampleMethod</span><span class="o">=</span><span class="s2">&quot;near&quot;</span><span class="p">,</span>
    <span class="n">sentinel2ResampleMethod</span><span class="o">=</span><span class="s2">&quot;aggregate&quot;</span><span class="p">,</span>
    <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">runChastainHarmonization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">correctIllumination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">correctScale</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">preComputedLandsatCloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedLandsatTDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedLandsatTDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedSentinel2CloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedSentinel2TDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedSentinel2TDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cloudProbThresh</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScorePlus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
    <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="n">toaOrSR</span> <span class="o">==</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span>
        <span class="n">runChastainHarmonization</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Landsat-Sentinel2-Hybrid&quot;</span>
    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="c1"># Prepare dates</span>
    <span class="c1"># Wrap the dates if needed</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">startJulian</span> <span class="o">&gt;</span> <span class="n">endJulian</span><span class="p">:</span>
        <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">endYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get Processed Landsat and Sentinel2 Scenes: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Start date:&quot;</span><span class="p">,</span>
        <span class="n">startDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MMM dd yyyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
        <span class="s2">&quot;, End date:&quot;</span><span class="p">,</span>
        <span class="n">endDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MMM dd yyyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>

    <span class="c1"># Get Landsat</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">getProcessedLandsatScenes</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="n">includeSLCOffL7</span><span class="p">,</span>
        <span class="n">defringeL5</span><span class="o">=</span><span class="n">defringeL5</span><span class="p">,</span>
        <span class="n">applyCloudScore</span><span class="o">=</span><span class="n">applyCloudScoreLandsat</span><span class="p">,</span>
        <span class="n">applyFmaskCloudMask</span><span class="o">=</span><span class="n">applyFmaskCloudMask</span><span class="p">,</span>
        <span class="n">applyTDOM</span><span class="o">=</span><span class="n">applyTDOMLandsat</span><span class="p">,</span>
        <span class="n">applyFmaskCloudShadowMask</span><span class="o">=</span><span class="n">applyFmaskCloudShadowMask</span><span class="p">,</span>
        <span class="n">applyFmaskSnowMask</span><span class="o">=</span><span class="n">applyFmaskSnowMask</span><span class="p">,</span>
        <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
        <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
        <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
        <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
        <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
        <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
        <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
        <span class="n">shadowSumBands</span><span class="o">=</span><span class="n">shadowSumBands</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">landsatResampleMethod</span><span class="p">,</span>
        <span class="c1"># harmonizeOLI = harmonizeOLI,</span>
        <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedLandsatCloudScoreOffset</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="n">preComputedLandsatTDOMIRMean</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedSentinel2TDOMIRStdDev</span><span class="p">,</span>
        <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="n">landsatCollectionVersion</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get Sentinel 2</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">getProcessedSentinel2Scenes</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">applyQABand</span><span class="o">=</span><span class="n">applyQABand</span><span class="p">,</span>
        <span class="n">applyCloudScore</span><span class="o">=</span><span class="n">applyCloudScoreSentinel2</span><span class="p">,</span>
        <span class="n">applyShadowShift</span><span class="o">=</span><span class="n">applyShadowShift</span><span class="p">,</span>
        <span class="n">applyTDOM</span><span class="o">=</span><span class="n">applyTDOMSentinel2</span><span class="p">,</span>
        <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
        <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
        <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
        <span class="n">cloudHeights</span><span class="o">=</span><span class="n">cloudHeights</span><span class="p">,</span>
        <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
        <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
        <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
        <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
        <span class="n">shadowSumBands</span><span class="o">=</span><span class="n">shadowSumBands</span><span class="p">,</span>
        <span class="n">resampleMethod</span><span class="o">=</span><span class="n">sentinel2ResampleMethod</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="n">convertToDailyMosaics</span><span class="p">,</span>
        <span class="n">applyCloudProbability</span><span class="o">=</span><span class="n">applyCloudProbability</span><span class="p">,</span>
        <span class="n">preComputedCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedSentinel2CloudScoreOffset</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRMean</span><span class="o">=</span><span class="n">preComputedSentinel2TDOMIRMean</span><span class="p">,</span>
        <span class="n">preComputedTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedSentinel2TDOMIRStdDev</span><span class="p">,</span>
        <span class="n">cloudProbThresh</span><span class="o">=</span><span class="n">cloudProbThresh</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">applyCloudScorePlus</span><span class="o">=</span><span class="n">applyCloudScorePlus</span><span class="p">,</span>
        <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="n">cloudScorePlusThresh</span><span class="p">,</span>
        <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="n">cloudScorePlusScore</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Select off common bands between Landsat and Sentinel 2</span>
    <span class="n">commonBands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">,</span> <span class="s2">&quot;swir2&quot;</span><span class="p">,</span> <span class="s2">&quot;sensor&quot;</span><span class="p">]</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">commonBands</span><span class="p">)</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">s2s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">commonBands</span><span class="p">)</span>
    <span class="c1"># Fill in any empty collections</span>
    <span class="c1"># If they&#39;re both empty, this will not work</span>
    <span class="n">dummyImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ls</span><span class="p">,</span> <span class="n">s2s</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">)</span>
    <span class="n">s2s</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">s2s</span><span class="p">,</span> <span class="n">dummyImage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">runChastainHarmonization</span> <span class="ow">and</span> <span class="n">toaOrSR</span> <span class="o">==</span> <span class="s2">&quot;TOA&quot;</span><span class="p">:</span>

        <span class="c1"># Separate each sensor</span>

        <span class="n">tm</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">inList</span><span class="p">(</span><span class="s2">&quot;SENSOR_ID&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;TM&quot;</span><span class="p">,</span> <span class="s2">&quot;ETM&quot;</span><span class="p">]))</span>
        <span class="n">oli</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;SENSOR_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;OLI_TIRS&quot;</span><span class="p">))</span>
        <span class="c1"># else:</span>
        <span class="c1">#   tm = ls.filter(ee.Filter.inList(&#39;sensor&#39;,[&#39;LANDSAT_4&#39;,&#39;LANDSAT_5&#39;,&#39;LANDSAT_7&#39;]))</span>
        <span class="c1">#   oli = ls.filter(ee.Filter.eq(&#39;sensor&#39;,&#39;LANDSAT_8&#39;))</span>
        <span class="n">msi</span> <span class="o">=</span> <span class="n">s2s</span>

        <span class="c1"># Fill if no images exist for particular Landsat sensor</span>
        <span class="c1"># Allow it to fail of no images exist for Sentinel 2 since the point</span>
        <span class="c1"># of this method is to include S2</span>
        <span class="n">tm</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">first</span><span class="p">()))</span>
        <span class="n">oli</span> <span class="o">=</span> <span class="n">fillEmptyCollections</span><span class="p">(</span><span class="n">oli</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">first</span><span class="p">()))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Chastain et al 2019 harmonization&quot;</span><span class="p">)</span>

        <span class="c1"># Apply correction</span>
        <span class="c1"># Currently coded to go to ETM+</span>

        <span class="c1"># No need to correct ETM to ETM</span>
        <span class="c1"># tm = tm.map(function(img){return getImagesLib.harmonizationChastain(img, &#39;ETM&#39;,&#39;ETM&#39;)})</span>
        <span class="c1"># etm = etm.map(function(img){return getImagesLib.harmonizationChastain(img, &#39;ETM&#39;,&#39;ETM&#39;)})</span>

        <span class="c1"># Harmonize the other two</span>
        <span class="n">oli</span> <span class="o">=</span> <span class="n">oli</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">harmonizationChastain</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s2">&quot;OLI&quot;</span><span class="p">,</span> <span class="s2">&quot;ETM&quot;</span><span class="p">))</span>
        <span class="n">msi</span> <span class="o">=</span> <span class="n">msi</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">harmonizationChastain</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s2">&quot;MSI&quot;</span><span class="p">,</span> <span class="s2">&quot;ETM&quot;</span><span class="p">))</span>

        <span class="n">s2s</span> <span class="o">=</span> <span class="n">msi</span>

        <span class="c1"># Merge Landsat back together</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">oli</span><span class="p">))</span>

    <span class="c1"># Merge Landsat and S2</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">s2s</span><span class="p">))</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddIndices</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getTasseledCap</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simpleAddTCAngles</span><span class="p">)</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">merged</span>


<span class="c1">#################################################################################</span>
<span class="c1"># Function to register an imageCollection to images within it</span>
<span class="c1"># Always uses the first image as the reference image</span>
<span class="k">def</span> <span class="nf">coRegisterCollection</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">referenceBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">]):</span>
    <span class="n">referenceImageIndex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">referenceImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="n">referenceImageIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">referenceImageIndex</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">referenceBands</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registerImage</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="c1"># Determine the displacement by matching only the referenceBand bands.</span>
        <span class="n">displacement_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;referenceImage&quot;</span><span class="p">:</span> <span class="n">referenceImage</span><span class="p">,</span>
            <span class="s2">&quot;maxOffset&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
            <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;patchWidth&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
            <span class="s2">&quot;stiffness&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">referenceBands</span><span class="p">)</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="o">**</span><span class="n">displacement_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">displace</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">registerImage</span><span class="p">))</span>  <span class="c1"># (ee.Image(images.toList(10000,0).get(1)),referenceImage)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1">#################################################################################</span>
<span class="c1"># Function to find a subset of a collection</span>
<span class="c1"># For each group (e.g. tile or orbit or path), all images within that group will be registered</span>
<span class="c1"># As single collection is returned</span>
<span class="k">def</span> <span class="nf">coRegisterGroups</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">fieldName</span><span class="o">=</span><span class="s2">&quot;SENSING_ORBIT_NUMBER&quot;</span><span class="p">,</span> <span class="n">fieldIsNumeric</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">aggregate_histogram</span><span class="p">(</span><span class="n">fieldName</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fieldIsNumeric</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">group</span><span class="p">:</span> <span class="n">coRegisterCollection</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">fieldName</span><span class="p">,</span> <span class="n">group</span><span class="p">)))))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1">#################################################################################</span>
<span class="k">def</span> <span class="nf">getLandsatAndSentinel2HybridWrapper</span><span class="p">(</span>
    <span class="n">studyArea</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">,</span>
    <span class="n">timebuffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">compositingMethod</span><span class="o">=</span><span class="s2">&quot;medoid&quot;</span><span class="p">,</span>
    <span class="n">toaOrSR</span><span class="o">=</span><span class="s2">&quot;TOA&quot;</span><span class="p">,</span>
    <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">defringeL5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyQABand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudProbability</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyShadowShift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScoreLandsat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScoreSentinel2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyTDOMLandsat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyTDOMSentinel2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyFmaskCloudMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyFmaskCloudShadowMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applyFmaskSnowMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cloudHeights</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePctl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">zScoreThresh</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shadowSumThresh</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dilatePixels</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">shadowSumBands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nir&quot;</span><span class="p">,</span> <span class="s2">&quot;swir1&quot;</span><span class="p">],</span>
    <span class="n">landsatResampleMethod</span><span class="o">=</span><span class="s2">&quot;near&quot;</span><span class="p">,</span>
    <span class="n">sentinel2ResampleMethod</span><span class="o">=</span><span class="s2">&quot;aggregate&quot;</span><span class="p">,</span>
    <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">runChastainHarmonization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">correctIllumination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">correctScale</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">exportComposites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">outputName</span><span class="o">=</span><span class="s2">&quot;Landsat-Sentinel2-Hybrid&quot;</span><span class="p">,</span>
    <span class="n">exportPathRoot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:5070&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2361915.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mf">3177735.0</span><span class="p">],</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedLandsatCloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedLandsatTDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedLandsatTDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedSentinel2CloudScoreOffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedSentinel2TDOMIRMean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preComputedSentinel2TDOMIRStdDev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cloudProbThresh</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">applyCloudScorePlusSentinel2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
    <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Landsat-Sentinel2-Hybrid&quot;</span>
    <span class="n">toaOrSR</span> <span class="o">=</span> <span class="n">toaOrSR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">getProcessedLandsatAndSentinel2Scenes</span><span class="p">(</span>
        <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
        <span class="n">includeSLCOffL7</span><span class="o">=</span><span class="n">includeSLCOffL7</span><span class="p">,</span>
        <span class="n">defringeL5</span><span class="o">=</span><span class="n">defringeL5</span><span class="p">,</span>
        <span class="n">applyQABand</span><span class="o">=</span><span class="n">applyQABand</span><span class="p">,</span>
        <span class="n">applyCloudProbability</span><span class="o">=</span><span class="n">applyCloudProbability</span><span class="p">,</span>
        <span class="n">applyShadowShift</span><span class="o">=</span><span class="n">applyShadowShift</span><span class="p">,</span>
        <span class="n">applyCloudScoreLandsat</span><span class="o">=</span><span class="n">applyCloudScoreLandsat</span><span class="p">,</span>
        <span class="n">applyCloudScoreSentinel2</span><span class="o">=</span><span class="n">applyCloudScoreSentinel2</span><span class="p">,</span>
        <span class="n">applyTDOMLandsat</span><span class="o">=</span><span class="n">applyTDOMLandsat</span><span class="p">,</span>
        <span class="n">applyTDOMSentinel2</span><span class="o">=</span><span class="n">applyTDOMSentinel2</span><span class="p">,</span>
        <span class="n">applyFmaskCloudMask</span><span class="o">=</span><span class="n">applyFmaskCloudMask</span><span class="p">,</span>
        <span class="n">applyFmaskCloudShadowMask</span><span class="o">=</span><span class="n">applyFmaskCloudShadowMask</span><span class="p">,</span>
        <span class="n">applyFmaskSnowMask</span><span class="o">=</span><span class="n">applyFmaskSnowMask</span><span class="p">,</span>
        <span class="n">cloudHeights</span><span class="o">=</span><span class="n">cloudHeights</span><span class="p">,</span>
        <span class="n">cloudScoreThresh</span><span class="o">=</span><span class="n">cloudScoreThresh</span><span class="p">,</span>
        <span class="n">performCloudScoreOffset</span><span class="o">=</span><span class="n">performCloudScoreOffset</span><span class="p">,</span>
        <span class="n">cloudScorePctl</span><span class="o">=</span><span class="n">cloudScorePctl</span><span class="p">,</span>
        <span class="n">zScoreThresh</span><span class="o">=</span><span class="n">zScoreThresh</span><span class="p">,</span>
        <span class="n">shadowSumThresh</span><span class="o">=</span><span class="n">shadowSumThresh</span><span class="p">,</span>
        <span class="n">contractPixels</span><span class="o">=</span><span class="n">contractPixels</span><span class="p">,</span>
        <span class="n">dilatePixels</span><span class="o">=</span><span class="n">dilatePixels</span><span class="p">,</span>
        <span class="n">shadowSumBands</span><span class="o">=</span><span class="n">shadowSumBands</span><span class="p">,</span>
        <span class="n">landsatResampleMethod</span><span class="o">=</span><span class="n">landsatResampleMethod</span><span class="p">,</span>
        <span class="n">sentinel2ResampleMethod</span><span class="o">=</span><span class="n">sentinel2ResampleMethod</span><span class="p">,</span>
        <span class="n">convertToDailyMosaics</span><span class="o">=</span><span class="n">convertToDailyMosaics</span><span class="p">,</span>
        <span class="n">runChastainHarmonization</span><span class="o">=</span><span class="n">runChastainHarmonization</span><span class="p">,</span>
        <span class="n">correctIllumination</span><span class="o">=</span><span class="n">correctIllumination</span><span class="p">,</span>
        <span class="n">correctScale</span><span class="o">=</span><span class="n">correctScale</span><span class="p">,</span>
        <span class="n">preComputedLandsatCloudScoreOffset</span><span class="o">=</span><span class="n">preComputedLandsatCloudScoreOffset</span><span class="p">,</span>
        <span class="n">preComputedLandsatTDOMIRMean</span><span class="o">=</span><span class="n">preComputedLandsatTDOMIRMean</span><span class="p">,</span>
        <span class="n">preComputedLandsatTDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedLandsatTDOMIRStdDev</span><span class="p">,</span>
        <span class="n">preComputedSentinel2CloudScoreOffset</span><span class="o">=</span><span class="n">preComputedSentinel2CloudScoreOffset</span><span class="p">,</span>
        <span class="n">preComputedSentinel2TDOMIRMean</span><span class="o">=</span><span class="n">preComputedSentinel2TDOMIRMean</span><span class="p">,</span>
        <span class="n">preComputedSentinel2TDOMIRStdDev</span><span class="o">=</span><span class="n">preComputedSentinel2TDOMIRStdDev</span><span class="p">,</span>
        <span class="n">cloudProbThresh</span><span class="o">=</span><span class="n">cloudProbThresh</span><span class="p">,</span>
        <span class="n">landsatCollectionVersion</span><span class="o">=</span><span class="n">landsatCollectionVersion</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">applyCloudScorePlus</span><span class="o">=</span><span class="n">applyCloudScorePlusSentinel2</span><span class="p">,</span>
        <span class="n">cloudScorePlusThresh</span><span class="o">=</span><span class="n">cloudScorePlusThresh</span><span class="p">,</span>
        <span class="n">cloudScorePlusScore</span><span class="o">=</span><span class="n">cloudScorePlusScore</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create hybrid composites</span>
    <span class="n">composites</span> <span class="o">=</span> <span class="n">compositeTimeSeries</span><span class="p">(</span>
        <span class="n">ls</span><span class="o">=</span><span class="n">merged</span><span class="p">,</span>
        <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
        <span class="n">timebuffer</span><span class="o">=</span><span class="n">timebuffer</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">compositingMethod</span><span class="o">=</span><span class="n">compositingMethod</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Export composite collection</span>
    <span class="k">if</span> <span class="n">exportComposites</span><span class="p">:</span>

        <span class="n">exportBandDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;medoid&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sensor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;julianDay&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;swir2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="n">nonDivideBandDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;medoid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;compositeObsCount&quot;</span><span class="p">,</span> <span class="s2">&quot;sensor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;julianDay&quot;</span><span class="p">],</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;compositeObsCount&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">exportBands</span> <span class="o">=</span> <span class="n">exportBandDict</span><span class="p">[</span><span class="n">compositingMethod</span><span class="p">]</span>
        <span class="n">nonDivideBands</span> <span class="o">=</span> <span class="n">nonDivideBandDict</span><span class="p">[</span><span class="n">compositingMethod</span><span class="p">]</span>

        <span class="n">exportCompositeCollection</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">composites</span><span class="p">,</span>
            <span class="n">exportPathRoot</span><span class="o">=</span><span class="n">exportPathRoot</span><span class="p">,</span>
            <span class="n">outputName</span><span class="o">=</span><span class="n">outputName</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">studyArea</span><span class="o">=</span><span class="n">studyArea</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">startYear</span><span class="o">=</span><span class="n">startYear</span><span class="p">,</span>
            <span class="n">endYear</span><span class="o">=</span><span class="n">endYear</span><span class="p">,</span>
            <span class="n">startJulian</span><span class="o">=</span><span class="n">startJulian</span><span class="p">,</span>
            <span class="n">endJulian</span><span class="o">=</span><span class="n">endJulian</span><span class="p">,</span>
            <span class="n">compositingMethod</span><span class="o">=</span><span class="n">compositingMethod</span><span class="p">,</span>
            <span class="n">timebuffer</span><span class="o">=</span><span class="n">timebuffer</span><span class="p">,</span>
            <span class="n">toaOrSR</span><span class="o">=</span><span class="n">toaOrSR</span><span class="p">,</span>
            <span class="n">nonDivideBands</span><span class="o">=</span><span class="n">nonDivideBands</span><span class="p">,</span>
            <span class="n">exportBands</span><span class="o">=</span><span class="n">exportBands</span><span class="p">,</span>
            <span class="n">additionalPropertyDict</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;processedScenes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>
    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;processedComposites&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">composites</span>

    <span class="k">return</span> <span class="n">args</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Harmonic regression</span>
<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to give year.dd image and harmonics list (e.g. [1,2,3,...])</span>
<span class="k">def</span> <span class="nf">getHarmonicList</span><span class="p">(</span><span class="n">yearDateImg</span><span class="p">,</span> <span class="n">transformBandName</span><span class="p">,</span> <span class="n">harmonicList</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">yearDateImg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">transformBandName</span><span class="p">])</span>
    <span class="n">selectBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">harmonicList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sinCat</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;sin_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">transformBandName</span><span class="p">)</span>

    <span class="n">sinNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">sinCat</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">harmonicList</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">cosCat</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;cos_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">transformBandName</span><span class="p">)</span>

    <span class="n">cosNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">cosCat</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">harmonicList</span><span class="p">))</span>

    <span class="n">multipliers</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">harmonicList</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">sinInd</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)))</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selectBands</span><span class="p">,</span> <span class="n">sinNames</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">cosInd</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)))</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selectBands</span><span class="p">,</span> <span class="n">cosNames</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">yearDateImg</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">sinInd</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">cosInd</span><span class="p">))</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Takes a dependent and independent variable and returns the dependent,</span>
<span class="c1"># sin of ind, and cos of ind</span>
<span class="c1"># Intended for harmonic regression</span>
<span class="k">def</span> <span class="nf">getHarmonics2</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">transformBandName</span><span class="p">,</span> <span class="n">harmonicList</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">depBandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">transformBandName</span><span class="p">)</span>
    <span class="n">depBandNumbers</span> <span class="o">=</span> <span class="n">depBandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dbn</span><span class="p">:</span> <span class="n">depBandNames</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="n">dbn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">harmWrap</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">outT</span> <span class="o">=</span> <span class="n">getHarmonicList</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">transformBandName</span><span class="p">,</span> <span class="n">harmonicList</span><span class="p">)</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="s2">&quot;system:time_end&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">outT</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">harmWrap</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">outBandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">removeAll</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">outBandNames</span><span class="p">)</span>

    <span class="n">indBandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">depBandNames</span><span class="p">)</span>
    <span class="n">indBandNumbers</span> <span class="o">=</span> <span class="n">indBandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ind</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;indBandNames&quot;</span><span class="p">:</span> <span class="n">indBandNames</span><span class="p">,</span>
            <span class="s2">&quot;depBandNames&quot;</span><span class="p">:</span> <span class="n">depBandNames</span><span class="p">,</span>
            <span class="s2">&quot;indBandNumbers&quot;</span><span class="p">:</span> <span class="n">indBandNumbers</span><span class="p">,</span>
            <span class="s2">&quot;depBandNumbers&quot;</span><span class="p">:</span> <span class="n">depBandNumbers</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Simplifies the use of the robust linear regression reducer</span>
<span class="c1"># Assumes the dependent is the first band and all subsequent bands are independents</span>
<span class="k">def</span> <span class="nf">newRobustMultipleLinear2</span><span class="p">(</span><span class="n">dependentsIndependents</span><span class="p">):</span>
    <span class="c1"># Set up the band names</span>

    <span class="n">dependentBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">dependentsIndependents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depBandNumbers&quot;</span><span class="p">))</span>
    <span class="n">independentBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">dependentsIndependents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indBandNumbers&quot;</span><span class="p">))</span>
    <span class="n">bns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">dependentsIndependents</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">dependents</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">dependentsIndependents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depBandNames&quot;</span><span class="p">))</span>
    <span class="n">independents</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">dependentsIndependents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indBandNames&quot;</span><span class="p">))</span>

    <span class="c1"># dependent = bns.slice(0,1)</span>
    <span class="c1"># independents = bns.slice(1,null)</span>
    <span class="n">noIndependents</span> <span class="o">=</span> <span class="n">independents</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noDependents</span> <span class="o">=</span> <span class="n">dependents</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>

    <span class="n">outNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s2">&quot;intercept&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">independents</span><span class="p">)</span>

    <span class="c1"># Add constant band for intercept and reorder for</span>
    <span class="c1"># syntax: constant, ind1,ind2,ind3,indn,dependent</span>
    <span class="k">def</span> <span class="nf">forFitFun</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">independents</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">dependents</span><span class="p">))</span>

    <span class="n">forFit</span> <span class="o">=</span> <span class="n">dependentsIndependents</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">forFitFun</span><span class="p">)</span>

    <span class="c1"># Apply reducer, and convert back to image with respective bandNames</span>
    <span class="n">reducerOut</span> <span class="o">=</span> <span class="n">forFit</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">linearRegression</span><span class="p">(</span><span class="n">noIndependents</span><span class="p">,</span> <span class="n">noDependents</span><span class="p">))</span>
    <span class="c1"># // test = forFit.reduce(ee.Reducer.robustLinearRegression(noIndependents,noDependents,0.2))</span>
    <span class="c1"># // resids = test</span>
    <span class="c1"># // .select([1],[&#39;residuals&#39;]).arrayFlatten([dependents]);</span>
    <span class="c1"># // Map.addLayer(resids,{},&#39;residsImage&#39;);</span>
    <span class="c1"># // Map.addLayer(reducerOut.select([0]),{},&#39;coefficients&#39;);</span>
    <span class="c1"># // Map.addLayer(test.select([1]),{},&#39;tresiduals&#39;);</span>
    <span class="c1"># // Map.addLayer(reducerOut.select([1]),{},&#39;roresiduals&#39;);</span>
    <span class="n">reducerOut</span> <span class="o">=</span> <span class="n">reducerOut</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;coefficients&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">arrayTranspose</span><span class="p">()</span><span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([</span><span class="n">dependents</span><span class="p">,</span> <span class="n">outNames</span><span class="p">])</span>
    <span class="n">reducerOut</span> <span class="o">=</span> <span class="n">reducerOut</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;noDependents&quot;</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">noDependents</span><span class="p">),</span>
            <span class="s2">&quot;modelLength&quot;</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">noIndependents</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">reducerOut</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Code for finding the date of peak of green</span>
<span class="c1"># Also converts it to Julian day, month, and day of month</span>
<span class="n">monthRemap</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">monthDayRemap</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">julianDay</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">,</span>
    <span class="mi">32</span><span class="p">,</span>
    <span class="mi">33</span><span class="p">,</span>
    <span class="mi">34</span><span class="p">,</span>
    <span class="mi">35</span><span class="p">,</span>
    <span class="mi">36</span><span class="p">,</span>
    <span class="mi">37</span><span class="p">,</span>
    <span class="mi">38</span><span class="p">,</span>
    <span class="mi">39</span><span class="p">,</span>
    <span class="mi">40</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">,</span>
    <span class="mi">42</span><span class="p">,</span>
    <span class="mi">43</span><span class="p">,</span>
    <span class="mi">44</span><span class="p">,</span>
    <span class="mi">45</span><span class="p">,</span>
    <span class="mi">46</span><span class="p">,</span>
    <span class="mi">47</span><span class="p">,</span>
    <span class="mi">48</span><span class="p">,</span>
    <span class="mi">49</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">,</span>
    <span class="mi">51</span><span class="p">,</span>
    <span class="mi">52</span><span class="p">,</span>
    <span class="mi">53</span><span class="p">,</span>
    <span class="mi">54</span><span class="p">,</span>
    <span class="mi">55</span><span class="p">,</span>
    <span class="mi">56</span><span class="p">,</span>
    <span class="mi">57</span><span class="p">,</span>
    <span class="mi">58</span><span class="p">,</span>
    <span class="mi">59</span><span class="p">,</span>
    <span class="mi">60</span><span class="p">,</span>
    <span class="mi">61</span><span class="p">,</span>
    <span class="mi">62</span><span class="p">,</span>
    <span class="mi">63</span><span class="p">,</span>
    <span class="mi">64</span><span class="p">,</span>
    <span class="mi">65</span><span class="p">,</span>
    <span class="mi">66</span><span class="p">,</span>
    <span class="mi">67</span><span class="p">,</span>
    <span class="mi">68</span><span class="p">,</span>
    <span class="mi">69</span><span class="p">,</span>
    <span class="mi">70</span><span class="p">,</span>
    <span class="mi">71</span><span class="p">,</span>
    <span class="mi">72</span><span class="p">,</span>
    <span class="mi">73</span><span class="p">,</span>
    <span class="mi">74</span><span class="p">,</span>
    <span class="mi">75</span><span class="p">,</span>
    <span class="mi">76</span><span class="p">,</span>
    <span class="mi">77</span><span class="p">,</span>
    <span class="mi">78</span><span class="p">,</span>
    <span class="mi">79</span><span class="p">,</span>
    <span class="mi">80</span><span class="p">,</span>
    <span class="mi">81</span><span class="p">,</span>
    <span class="mi">82</span><span class="p">,</span>
    <span class="mi">83</span><span class="p">,</span>
    <span class="mi">84</span><span class="p">,</span>
    <span class="mi">85</span><span class="p">,</span>
    <span class="mi">86</span><span class="p">,</span>
    <span class="mi">87</span><span class="p">,</span>
    <span class="mi">88</span><span class="p">,</span>
    <span class="mi">89</span><span class="p">,</span>
    <span class="mi">90</span><span class="p">,</span>
    <span class="mi">91</span><span class="p">,</span>
    <span class="mi">92</span><span class="p">,</span>
    <span class="mi">93</span><span class="p">,</span>
    <span class="mi">94</span><span class="p">,</span>
    <span class="mi">95</span><span class="p">,</span>
    <span class="mi">96</span><span class="p">,</span>
    <span class="mi">97</span><span class="p">,</span>
    <span class="mi">98</span><span class="p">,</span>
    <span class="mi">99</span><span class="p">,</span>
    <span class="mi">100</span><span class="p">,</span>
    <span class="mi">101</span><span class="p">,</span>
    <span class="mi">102</span><span class="p">,</span>
    <span class="mi">103</span><span class="p">,</span>
    <span class="mi">104</span><span class="p">,</span>
    <span class="mi">105</span><span class="p">,</span>
    <span class="mi">106</span><span class="p">,</span>
    <span class="mi">107</span><span class="p">,</span>
    <span class="mi">108</span><span class="p">,</span>
    <span class="mi">109</span><span class="p">,</span>
    <span class="mi">110</span><span class="p">,</span>
    <span class="mi">111</span><span class="p">,</span>
    <span class="mi">112</span><span class="p">,</span>
    <span class="mi">113</span><span class="p">,</span>
    <span class="mi">114</span><span class="p">,</span>
    <span class="mi">115</span><span class="p">,</span>
    <span class="mi">116</span><span class="p">,</span>
    <span class="mi">117</span><span class="p">,</span>
    <span class="mi">118</span><span class="p">,</span>
    <span class="mi">119</span><span class="p">,</span>
    <span class="mi">120</span><span class="p">,</span>
    <span class="mi">121</span><span class="p">,</span>
    <span class="mi">122</span><span class="p">,</span>
    <span class="mi">123</span><span class="p">,</span>
    <span class="mi">124</span><span class="p">,</span>
    <span class="mi">125</span><span class="p">,</span>
    <span class="mi">126</span><span class="p">,</span>
    <span class="mi">127</span><span class="p">,</span>
    <span class="mi">128</span><span class="p">,</span>
    <span class="mi">129</span><span class="p">,</span>
    <span class="mi">130</span><span class="p">,</span>
    <span class="mi">131</span><span class="p">,</span>
    <span class="mi">132</span><span class="p">,</span>
    <span class="mi">133</span><span class="p">,</span>
    <span class="mi">134</span><span class="p">,</span>
    <span class="mi">135</span><span class="p">,</span>
    <span class="mi">136</span><span class="p">,</span>
    <span class="mi">137</span><span class="p">,</span>
    <span class="mi">138</span><span class="p">,</span>
    <span class="mi">139</span><span class="p">,</span>
    <span class="mi">140</span><span class="p">,</span>
    <span class="mi">141</span><span class="p">,</span>
    <span class="mi">142</span><span class="p">,</span>
    <span class="mi">143</span><span class="p">,</span>
    <span class="mi">144</span><span class="p">,</span>
    <span class="mi">145</span><span class="p">,</span>
    <span class="mi">146</span><span class="p">,</span>
    <span class="mi">147</span><span class="p">,</span>
    <span class="mi">148</span><span class="p">,</span>
    <span class="mi">149</span><span class="p">,</span>
    <span class="mi">150</span><span class="p">,</span>
    <span class="mi">151</span><span class="p">,</span>
    <span class="mi">152</span><span class="p">,</span>
    <span class="mi">153</span><span class="p">,</span>
    <span class="mi">154</span><span class="p">,</span>
    <span class="mi">155</span><span class="p">,</span>
    <span class="mi">156</span><span class="p">,</span>
    <span class="mi">157</span><span class="p">,</span>
    <span class="mi">158</span><span class="p">,</span>
    <span class="mi">159</span><span class="p">,</span>
    <span class="mi">160</span><span class="p">,</span>
    <span class="mi">161</span><span class="p">,</span>
    <span class="mi">162</span><span class="p">,</span>
    <span class="mi">163</span><span class="p">,</span>
    <span class="mi">164</span><span class="p">,</span>
    <span class="mi">165</span><span class="p">,</span>
    <span class="mi">166</span><span class="p">,</span>
    <span class="mi">167</span><span class="p">,</span>
    <span class="mi">168</span><span class="p">,</span>
    <span class="mi">169</span><span class="p">,</span>
    <span class="mi">170</span><span class="p">,</span>
    <span class="mi">171</span><span class="p">,</span>
    <span class="mi">172</span><span class="p">,</span>
    <span class="mi">173</span><span class="p">,</span>
    <span class="mi">174</span><span class="p">,</span>
    <span class="mi">175</span><span class="p">,</span>
    <span class="mi">176</span><span class="p">,</span>
    <span class="mi">177</span><span class="p">,</span>
    <span class="mi">178</span><span class="p">,</span>
    <span class="mi">179</span><span class="p">,</span>
    <span class="mi">180</span><span class="p">,</span>
    <span class="mi">181</span><span class="p">,</span>
    <span class="mi">182</span><span class="p">,</span>
    <span class="mi">183</span><span class="p">,</span>
    <span class="mi">184</span><span class="p">,</span>
    <span class="mi">185</span><span class="p">,</span>
    <span class="mi">186</span><span class="p">,</span>
    <span class="mi">187</span><span class="p">,</span>
    <span class="mi">188</span><span class="p">,</span>
    <span class="mi">189</span><span class="p">,</span>
    <span class="mi">190</span><span class="p">,</span>
    <span class="mi">191</span><span class="p">,</span>
    <span class="mi">192</span><span class="p">,</span>
    <span class="mi">193</span><span class="p">,</span>
    <span class="mi">194</span><span class="p">,</span>
    <span class="mi">195</span><span class="p">,</span>
    <span class="mi">196</span><span class="p">,</span>
    <span class="mi">197</span><span class="p">,</span>
    <span class="mi">198</span><span class="p">,</span>
    <span class="mi">199</span><span class="p">,</span>
    <span class="mi">200</span><span class="p">,</span>
    <span class="mi">201</span><span class="p">,</span>
    <span class="mi">202</span><span class="p">,</span>
    <span class="mi">203</span><span class="p">,</span>
    <span class="mi">204</span><span class="p">,</span>
    <span class="mi">205</span><span class="p">,</span>
    <span class="mi">206</span><span class="p">,</span>
    <span class="mi">207</span><span class="p">,</span>
    <span class="mi">208</span><span class="p">,</span>
    <span class="mi">209</span><span class="p">,</span>
    <span class="mi">210</span><span class="p">,</span>
    <span class="mi">211</span><span class="p">,</span>
    <span class="mi">212</span><span class="p">,</span>
    <span class="mi">213</span><span class="p">,</span>
    <span class="mi">214</span><span class="p">,</span>
    <span class="mi">215</span><span class="p">,</span>
    <span class="mi">216</span><span class="p">,</span>
    <span class="mi">217</span><span class="p">,</span>
    <span class="mi">218</span><span class="p">,</span>
    <span class="mi">219</span><span class="p">,</span>
    <span class="mi">220</span><span class="p">,</span>
    <span class="mi">221</span><span class="p">,</span>
    <span class="mi">222</span><span class="p">,</span>
    <span class="mi">223</span><span class="p">,</span>
    <span class="mi">224</span><span class="p">,</span>
    <span class="mi">225</span><span class="p">,</span>
    <span class="mi">226</span><span class="p">,</span>
    <span class="mi">227</span><span class="p">,</span>
    <span class="mi">228</span><span class="p">,</span>
    <span class="mi">229</span><span class="p">,</span>
    <span class="mi">230</span><span class="p">,</span>
    <span class="mi">231</span><span class="p">,</span>
    <span class="mi">232</span><span class="p">,</span>
    <span class="mi">233</span><span class="p">,</span>
    <span class="mi">234</span><span class="p">,</span>
    <span class="mi">235</span><span class="p">,</span>
    <span class="mi">236</span><span class="p">,</span>
    <span class="mi">237</span><span class="p">,</span>
    <span class="mi">238</span><span class="p">,</span>
    <span class="mi">239</span><span class="p">,</span>
    <span class="mi">240</span><span class="p">,</span>
    <span class="mi">241</span><span class="p">,</span>
    <span class="mi">242</span><span class="p">,</span>
    <span class="mi">243</span><span class="p">,</span>
    <span class="mi">244</span><span class="p">,</span>
    <span class="mi">245</span><span class="p">,</span>
    <span class="mi">246</span><span class="p">,</span>
    <span class="mi">247</span><span class="p">,</span>
    <span class="mi">248</span><span class="p">,</span>
    <span class="mi">249</span><span class="p">,</span>
    <span class="mi">250</span><span class="p">,</span>
    <span class="mi">251</span><span class="p">,</span>
    <span class="mi">252</span><span class="p">,</span>
    <span class="mi">253</span><span class="p">,</span>
    <span class="mi">254</span><span class="p">,</span>
    <span class="mi">255</span><span class="p">,</span>
    <span class="mi">256</span><span class="p">,</span>
    <span class="mi">257</span><span class="p">,</span>
    <span class="mi">258</span><span class="p">,</span>
    <span class="mi">259</span><span class="p">,</span>
    <span class="mi">260</span><span class="p">,</span>
    <span class="mi">261</span><span class="p">,</span>
    <span class="mi">262</span><span class="p">,</span>
    <span class="mi">263</span><span class="p">,</span>
    <span class="mi">264</span><span class="p">,</span>
    <span class="mi">265</span><span class="p">,</span>
    <span class="mi">266</span><span class="p">,</span>
    <span class="mi">267</span><span class="p">,</span>
    <span class="mi">268</span><span class="p">,</span>
    <span class="mi">269</span><span class="p">,</span>
    <span class="mi">270</span><span class="p">,</span>
    <span class="mi">271</span><span class="p">,</span>
    <span class="mi">272</span><span class="p">,</span>
    <span class="mi">273</span><span class="p">,</span>
    <span class="mi">274</span><span class="p">,</span>
    <span class="mi">275</span><span class="p">,</span>
    <span class="mi">276</span><span class="p">,</span>
    <span class="mi">277</span><span class="p">,</span>
    <span class="mi">278</span><span class="p">,</span>
    <span class="mi">279</span><span class="p">,</span>
    <span class="mi">280</span><span class="p">,</span>
    <span class="mi">281</span><span class="p">,</span>
    <span class="mi">282</span><span class="p">,</span>
    <span class="mi">283</span><span class="p">,</span>
    <span class="mi">284</span><span class="p">,</span>
    <span class="mi">285</span><span class="p">,</span>
    <span class="mi">286</span><span class="p">,</span>
    <span class="mi">287</span><span class="p">,</span>
    <span class="mi">288</span><span class="p">,</span>
    <span class="mi">289</span><span class="p">,</span>
    <span class="mi">290</span><span class="p">,</span>
    <span class="mi">291</span><span class="p">,</span>
    <span class="mi">292</span><span class="p">,</span>
    <span class="mi">293</span><span class="p">,</span>
    <span class="mi">294</span><span class="p">,</span>
    <span class="mi">295</span><span class="p">,</span>
    <span class="mi">296</span><span class="p">,</span>
    <span class="mi">297</span><span class="p">,</span>
    <span class="mi">298</span><span class="p">,</span>
    <span class="mi">299</span><span class="p">,</span>
    <span class="mi">300</span><span class="p">,</span>
    <span class="mi">301</span><span class="p">,</span>
    <span class="mi">302</span><span class="p">,</span>
    <span class="mi">303</span><span class="p">,</span>
    <span class="mi">304</span><span class="p">,</span>
    <span class="mi">305</span><span class="p">,</span>
    <span class="mi">306</span><span class="p">,</span>
    <span class="mi">307</span><span class="p">,</span>
    <span class="mi">308</span><span class="p">,</span>
    <span class="mi">309</span><span class="p">,</span>
    <span class="mi">310</span><span class="p">,</span>
    <span class="mi">311</span><span class="p">,</span>
    <span class="mi">312</span><span class="p">,</span>
    <span class="mi">313</span><span class="p">,</span>
    <span class="mi">314</span><span class="p">,</span>
    <span class="mi">315</span><span class="p">,</span>
    <span class="mi">316</span><span class="p">,</span>
    <span class="mi">317</span><span class="p">,</span>
    <span class="mi">318</span><span class="p">,</span>
    <span class="mi">319</span><span class="p">,</span>
    <span class="mi">320</span><span class="p">,</span>
    <span class="mi">321</span><span class="p">,</span>
    <span class="mi">322</span><span class="p">,</span>
    <span class="mi">323</span><span class="p">,</span>
    <span class="mi">324</span><span class="p">,</span>
    <span class="mi">325</span><span class="p">,</span>
    <span class="mi">326</span><span class="p">,</span>
    <span class="mi">327</span><span class="p">,</span>
    <span class="mi">328</span><span class="p">,</span>
    <span class="mi">329</span><span class="p">,</span>
    <span class="mi">330</span><span class="p">,</span>
    <span class="mi">331</span><span class="p">,</span>
    <span class="mi">332</span><span class="p">,</span>
    <span class="mi">333</span><span class="p">,</span>
    <span class="mi">334</span><span class="p">,</span>
    <span class="mi">335</span><span class="p">,</span>
    <span class="mi">336</span><span class="p">,</span>
    <span class="mi">337</span><span class="p">,</span>
    <span class="mi">338</span><span class="p">,</span>
    <span class="mi">339</span><span class="p">,</span>
    <span class="mi">340</span><span class="p">,</span>
    <span class="mi">341</span><span class="p">,</span>
    <span class="mi">342</span><span class="p">,</span>
    <span class="mi">343</span><span class="p">,</span>
    <span class="mi">344</span><span class="p">,</span>
    <span class="mi">345</span><span class="p">,</span>
    <span class="mi">346</span><span class="p">,</span>
    <span class="mi">347</span><span class="p">,</span>
    <span class="mi">348</span><span class="p">,</span>
    <span class="mi">349</span><span class="p">,</span>
    <span class="mi">350</span><span class="p">,</span>
    <span class="mi">351</span><span class="p">,</span>
    <span class="mi">352</span><span class="p">,</span>
    <span class="mi">353</span><span class="p">,</span>
    <span class="mi">354</span><span class="p">,</span>
    <span class="mi">355</span><span class="p">,</span>
    <span class="mi">356</span><span class="p">,</span>
    <span class="mi">357</span><span class="p">,</span>
    <span class="mi">358</span><span class="p">,</span>
    <span class="mi">359</span><span class="p">,</span>
    <span class="mi">360</span><span class="p">,</span>
    <span class="mi">361</span><span class="p">,</span>
    <span class="mi">362</span><span class="p">,</span>
    <span class="mi">363</span><span class="p">,</span>
    <span class="mi">364</span><span class="p">,</span>
    <span class="mi">365</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for getting the date of the peak of veg vigor- can handle bands negatively correlated to veg in</span>
<span class="c1"># changeDirDict dictionary above</span>
<span class="k">def</span> <span class="nf">getPeakDate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">peakDirection</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">sin</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Find where in cycle slope is zero</span>
    <span class="n">greenDate</span> <span class="o">=</span> <span class="p">((</span><span class="n">sin</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">cos</span><span class="p">))</span><span class="o">.</span><span class="n">atan</span><span class="p">())</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;peakDate&quot;</span><span class="p">])</span>
    <span class="n">greenDateLater</span> <span class="o">=</span> <span class="n">greenDate</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># Check which d1 slope = 0 is the max by predicting out the value</span>
    <span class="n">predicted1</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sin</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">greenDate</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cos</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">greenDate</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;predicted&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">peakDirection</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">greenDate</span><span class="p">)</span>
    <span class="n">predicted2</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sin</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">greenDateLater</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cos</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">greenDateLater</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()))</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;predicted&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">peakDirection</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">greenDateLater</span><span class="p">)</span>
    <span class="n">finalGreenDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">([</span><span class="n">predicted1</span><span class="p">,</span> <span class="n">predicted2</span><span class="p">])</span><span class="o">.</span><span class="n">qualityMosaic</span><span class="p">(</span><span class="s2">&quot;predicted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;peakDate&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;peakJulianDay&quot;</span><span class="p">])</span>

    <span class="n">finalGreenDate</span> <span class="o">=</span> <span class="n">finalGreenDate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">finalGreenDate</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">greenDate</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span><span class="o">.</span><span class="n">int16</span><span class="p">()</span>

    <span class="c1"># Convert to month and day of month</span>
    <span class="n">greenMonth</span> <span class="o">=</span> <span class="n">finalGreenDate</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">julianDay</span><span class="p">,</span> <span class="n">monthRemap</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;peakMonth&quot;</span><span class="p">])</span>
    <span class="n">greenMonthDay</span> <span class="o">=</span> <span class="n">finalGreenDate</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">julianDay</span><span class="p">,</span> <span class="n">monthDayRemap</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;peakDayOfMonth&quot;</span><span class="p">])</span>
    <span class="n">greenStack</span> <span class="o">=</span> <span class="n">finalGreenDate</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">greenMonth</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">greenMonthDay</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">greenStack</span>
    <span class="c1"># Map.addLayer(greenStack,{&#39;min&#39;:1,&#39;max&#39;:12},&#39;greenMonth&#39;,False)</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for getting left sum under the curve for a single growing season</span>
<span class="c1"># Takes care of normalization by forcing the min value along the curve 0</span>
<span class="c1"># by taking the amplitude as the intercept</span>
<span class="c1"># Assumes the sin and cos coeffs are the harmCoeffs</span>
<span class="c1"># t0 is the start time (defaults to 0)(min value should be but doesn&#39;t have to be 0)</span>
<span class="c1"># t1 is the end time (defaults to 1)(max value should be but doesn&#39;t have to be 1)</span>


<span class="c1"># Example of what this code is doing can be found here:</span>
<span class="c1">#  http://www.wolframalpha.com/input/?i=integrate+0.15949074923992157+%2B+-0.08287599*sin(2+PI+T)+%2B+-0.11252010613*cos(2+PI+T)++from+0+to+1</span>
<span class="k">def</span> <span class="nf">getAreaUnderCurve</span><span class="p">(</span><span class="n">harmCoeffs</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="c1"># Pull apart the model</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">intereceptNormalized</span> <span class="o">=</span> <span class="n">amplitude</span>  <span class="c1"># When making the min 0, the intercept becomes the amplitude (the hypotenuse)</span>
    <span class="n">sin</span> <span class="o">=</span> <span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Find the sum from - infinity to 0</span>
    <span class="n">sum0</span> <span class="o">=</span> <span class="n">intereceptNormalized</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sin</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t0</span><span class="p">)))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cos</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t0</span><span class="p">)))</span>
    <span class="c1"># Find the sum from - infinity to 1</span>
    <span class="n">sum1</span> <span class="o">=</span> <span class="n">intereceptNormalized</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sin</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t1</span><span class="p">)))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cos</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t1</span><span class="p">)))</span>
    <span class="c1"># Find the difference</span>
    <span class="n">leftSum</span> <span class="o">=</span> <span class="n">sum1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sum0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;AUC&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">leftSum</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="k">def</span> <span class="nf">getPhaseAmplitudePeak</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Parse the model</span>
    <span class="n">bandNames</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">bandNumber</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="n">noDependents</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noDependents&quot;</span><span class="p">))</span>
    <span class="n">modelLength</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modelLength&quot;</span><span class="p">))</span>
    <span class="n">interceptBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bandNumber</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">modelLength</span><span class="p">)</span>

    <span class="n">models</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noDependents</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">modelGetter</span><span class="p">(</span><span class="n">mn</span><span class="p">):</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">mn</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">modelLength</span><span class="p">),</span> <span class="n">mn</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">modelLength</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">modelLength</span><span class="p">))</span>

    <span class="n">parsedModel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">modelGetter</span><span class="p">)</span>

    <span class="c1"># print(&#39;Parsed harmonic regression model&#39;,parsedModel)</span>

    <span class="c1"># Iterate across models to convert to phase, amplitude, and peak</span>
    <span class="k">def</span> <span class="nf">papGetter</span><span class="p">(</span><span class="n">pm</span><span class="p">):</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>
        <span class="n">modelCoeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>

        <span class="n">intercept</span> <span class="o">=</span> <span class="n">modelCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_intercept&quot;</span><span class="p">)</span>
        <span class="n">harmCoeffs</span> <span class="o">=</span> <span class="n">modelCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;.*_200_year&quot;</span><span class="p">)</span>
        <span class="n">outName</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">changeDirDict</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">outName</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="n">outName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_amplitude&quot;</span><span class="p">)])</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">harmCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">unitScale</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="n">outName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_phase&quot;</span><span class="p">)])</span>

        <span class="c1"># Get peak date info</span>
        <span class="n">peakDate</span> <span class="o">=</span> <span class="n">getPeakDate</span><span class="p">(</span><span class="n">harmCoeffs</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span>
        <span class="n">peakDateBandNames</span> <span class="o">=</span> <span class="n">peakDate</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
        <span class="n">peakDateBandNames</span> <span class="o">=</span> <span class="n">peakDateBandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">outName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">))))</span>

        <span class="c1"># Get the left sum</span>
        <span class="n">leftSum</span> <span class="o">=</span> <span class="n">getAreaUnderCurve</span><span class="p">(</span><span class="n">harmCoeffs</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">leftSumBandNames</span> <span class="o">=</span> <span class="n">leftSum</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
        <span class="n">leftSumBandNames</span> <span class="o">=</span> <span class="n">leftSumBandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="n">outName</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">amplitude</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">peakDate</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">peakDateBandNames</span><span class="p">))</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">leftSum</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">leftSumBandNames</span><span class="p">))</span>

    <span class="c1"># Convert to an image</span>
    <span class="n">phaseAmplitude</span> <span class="o">=</span> <span class="n">parsedModel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">papGetter</span><span class="p">)</span>

    <span class="n">phaseAmplitude</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">phaseAmplitude</span><span class="p">)</span>

    <span class="n">phaseAmplitude</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">collectionToImage</span><span class="p">(</span><span class="n">phaseAmplitude</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">])</span>
    <span class="c1"># print(&#39;pa&#39;,phaseAmplitude);</span>
    <span class="k">return</span> <span class="n">phaseAmplitude</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function for applying harmonic regression model to set of predictor sets</span>
<span class="k">def</span> <span class="nf">newPredict</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">harmonics</span><span class="p">):</span>
    <span class="c1"># Parse the model</span>
    <span class="n">bandNames</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">bandNumber</span> <span class="o">=</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="n">noDependents</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noDependents&quot;</span><span class="p">))</span>
    <span class="n">modelLength</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modelLength&quot;</span><span class="p">))</span>
    <span class="n">interceptBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bandNumber</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">modelLength</span><span class="p">)</span>
    <span class="n">timeBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">harmonics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indBandNames&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">actualBands</span> <span class="o">=</span> <span class="n">harmonics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depBandNumbers&quot;</span><span class="p">)</span>
    <span class="n">indBands</span> <span class="o">=</span> <span class="n">harmonics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indBandNumbers&quot;</span><span class="p">)</span>
    <span class="n">indBandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">harmonics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indBandNames&quot;</span><span class="p">))</span>
    <span class="n">depBandNames</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">harmonics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depBandNames&quot;</span><span class="p">))</span>
    <span class="n">predictedBandNames</span> <span class="o">=</span> <span class="n">depBandNames</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">depbnms</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">depbnms</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_predicted&quot;</span><span class="p">))</span>
    <span class="n">predictedBandNumbers</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">predictedBandNames</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">models</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noDependents</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">mnGetter</span><span class="p">(</span><span class="n">mn</span><span class="p">):</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bandNames</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">mn</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">modelLength</span><span class="p">),</span> <span class="n">mn</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">modelLength</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">modelLength</span><span class="p">))</span>

    <span class="n">parsedModel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mnGetter</span><span class="p">)</span>

    <span class="c1"># print(&#39;Parsed harmonic regression model&#39;,parsedModel,predictedBandNames)</span>

    <span class="c1"># Apply parsed model</span>
    <span class="k">def</span> <span class="nf">predGetter</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">timeBand</span><span class="p">)</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">actualBands</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">predictorBands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">indBandNames</span><span class="p">)</span>

        <span class="c1"># Iterate across each model for each dependent variable</span>
        <span class="k">def</span> <span class="nf">pmGetter</span><span class="p">(</span><span class="n">pm</span><span class="p">):</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>
            <span class="n">modelCoeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>
            <span class="n">outName</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_predicted&quot;</span><span class="p">)</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">modelCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">modelCoeffs</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">others</span> <span class="o">=</span> <span class="n">modelCoeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">modelCoeffs</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

            <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictorBands</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">others</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">predicted</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="n">predictedList</span> <span class="o">=</span> <span class="n">parsedModel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pmGetter</span><span class="p">)</span>

        <span class="c1"># Convert to an image</span>
        <span class="n">predictedList</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">predictedList</span><span class="p">)</span>
        <span class="n">predictedImage</span> <span class="o">=</span> <span class="n">collectionToImage</span><span class="p">(</span><span class="n">predictedList</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">predictedBandNumbers</span><span class="p">,</span> <span class="n">predictedBandNames</span><span class="p">)</span>

        <span class="c1"># Set some metadata</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">predictedImage</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="s2">&quot;system:time_end&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">predicted</span> <span class="o">=</span> <span class="n">harmonics</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">predGetter</span><span class="p">)</span>

    <span class="n">predicted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>

    <span class="c1"># Map.addLayer(predicted,{},&#39;predicted&#39;,False)</span>

    <span class="k">return</span> <span class="n">predicted</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Function to get a dummy image stack for synthetic time series</span>
<span class="k">def</span> <span class="nf">getDateStack</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">,</span> <span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">yrGetter</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">dGetter</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dGetter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="n">dateSets</span> <span class="o">=</span> <span class="n">years</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">yrGetter</span><span class="p">)</span>

    <span class="n">l</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexNames</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">indexNames</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">dateSets</span> <span class="o">=</span> <span class="n">dateSets</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dtGetter</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">getFraction</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_end&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">i</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="n">dateSets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dtGetter</span><span class="p">)</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stack</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="k">def</span> <span class="nf">getHarmonicCoefficientsAndFit</span><span class="p">(</span><span class="n">allImages</span><span class="p">,</span> <span class="n">indexNames</span><span class="p">,</span> <span class="n">whichHarmonics</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># Select desired bands</span>
    <span class="n">allIndices</span> <span class="o">=</span> <span class="n">allImages</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">indexNames</span><span class="p">)</span>

    <span class="c1"># Add date band</span>
    <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">allIndices</span> <span class="o">=</span> <span class="n">allIndices</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">addDateBand</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allIndices</span> <span class="o">=</span> <span class="n">allIndices</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">addYearFractionBand</span><span class="p">)</span>

    <span class="c1"># Add independent predictors (harmonics)</span>
    <span class="n">withHarmonics</span> <span class="o">=</span> <span class="n">getHarmonics2</span><span class="p">(</span><span class="n">allIndices</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">whichHarmonics</span><span class="p">,</span> <span class="n">detrend</span><span class="p">)</span>
    <span class="n">withHarmonicsBns</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">withHarmonics</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indexNames</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Optionally chart the collection with harmonics</span>

    <span class="c1"># Fit a linear regression model</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">newRobustMultipleLinear2</span><span class="p">(</span><span class="n">withHarmonics</span><span class="p">)</span>

    <span class="c1"># Can visualize the phase and amplitude if only the first ([2]) harmonic is chosen</span>
    <span class="c1"># if whichHarmonics == 2{</span>
    <span class="c1">#    pa = getPhaseAmplitude(coeffs);</span>
    <span class="c1">#  // Turn the HSV data into an RGB image and add it to the map.</span>
    <span class="c1">#  seasonality = pa.select([1,0]).addBands(allIndices.select([indexNames[0]]).mean()).hsvToRgb();</span>
    <span class="c1">#  // Map.addLayer(seasonality, {}, &#39;Seasonality&#39;);</span>
    <span class="c1">#  }</span>

    <span class="c1"># Map.addLayer(coeffs,{},&#39;Harmonic Regression Coefficients&#39;,False)</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">newPredict</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">withHarmonics</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">predicted</span><span class="p">]</span>


<span class="c1">#########################################################################</span>
<span class="c1">#########################################################################</span>
<span class="c1"># Simple predict function for harmonic coefficients</span>
<span class="c1"># Expects coeffs from getHarmonicCoefficientsAndFit function</span>
<span class="c1"># Date image is expected to be yyyy.dd where dd is the day of year / 365 (proportion of year)</span>
<span class="c1"># ex. synthImage(coeffs,ee.Image([2019.6]),[&#39;blue&#39;,&#39;green&#39;,&#39;red&#39;,&#39;nir&#39;,&#39;swir1&#39;,&#39;swir2&#39;,&#39;NBR&#39;,&#39;NDVI&#39;],[2,4],true)</span>
<span class="k">def</span> <span class="nf">synthImage</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">dateImage</span><span class="p">,</span> <span class="n">indexNames</span><span class="p">,</span> <span class="n">harmonics</span><span class="p">,</span> <span class="n">detrend</span><span class="p">):</span>
    <span class="c1"># Set up constant image to multiply coeffs by</span>
    <span class="n">constImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">constImage</span> <span class="o">=</span> <span class="n">constImage</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">dateImage</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">harm</span> <span class="ow">in</span> <span class="n">harmonics</span><span class="p">:</span>
        <span class="n">constImage</span> <span class="o">=</span> <span class="n">constImage</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="n">dateImage</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">harm</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_sin&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">harm</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)]))</span>
    <span class="k">for</span> <span class="n">harm</span> <span class="ow">in</span> <span class="n">harmonics</span><span class="p">:</span>
        <span class="n">constImage</span> <span class="o">=</span> <span class="n">constImage</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">([</span><span class="n">dateImage</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">harm</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()])</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_cos&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">harm</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)]))</span>

    <span class="c1"># coeffssBn = coeffs.select(ee.String(indexNames[0]).cat(&#39;_.*&#39;))</span>
    <span class="c1"># print(constImage.bandNames().getInfo(),coeffssBn.bandNames().getInfo())</span>
    <span class="c1"># Predict values for each band</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predictWrapper</span><span class="p">(</span><span class="n">bn</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
        <span class="n">bn</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span>
        <span class="c1"># Select coeffs for that band</span>
        <span class="n">coeffssBn</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">))</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">constImage</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">coeffssBn</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">indexNames</span><span class="p">)</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">predictWrapper</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1">#####################################################################</span>
<span class="c1"># Wrapper function to get climate data</span>
<span class="c1"># Supports:</span>
<span class="c1"># NASA/ORNL/DAYMET_V3</span>
<span class="c1"># NASA/ORNL/DAYMET_V4</span>
<span class="c1"># UCSB-CHG/CHIRPS/DAILY (precipitation only)</span>
<span class="c1"># and possibly others</span>
<div class="viewcode-block" id="getClimateWrapper">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.getClimateWrapper">[docs]</a>
<span class="k">def</span> <span class="nf">getClimateWrapper</span><span class="p">(</span>
    <span class="n">collectionName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">studyArea</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">Feature</span> <span class="o">|</span> <span class="n">ee</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">,</span>
    <span class="n">startYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endYear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">startJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endJulian</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">timebuffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compositingReducer</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exportComposites</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">exportPathRoot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exportBands</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exportNamePrefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function to retrieve and process climate data from various Earth Engine collections.</span>

<span class="sd">    This function supports retrieving climate data from collections like NASA/ORNL/DAYMET_V3,</span>
<span class="sd">    NASA/ORNL/DAYMET_V4, UCSB-CHG/CHIRPS/DAILY (precipitation only), and potentially others. It allows</span>
<span class="sd">    filtering by date, study area, and Julian day, specifying a compositing reducer, and optionally</span>
<span class="sd">    exporting the resulting time series.</span>

<span class="sd">    Args:</span>
<span class="sd">        collectionName (str): Name of the Earth Engine collection containing climate data.</span>
<span class="sd">        studyArea (ee.Geometry | ee.Feature | ee.FeatureCollection): The geographic area of interest (study area) as an Earth Engine geometry object.</span>
<span class="sd">        startYear (int): The starting year for the data collection.</span>
<span class="sd">        endYear (int): The ending year for the data collection.</span>
<span class="sd">        startJulian (int): The starting Julian day of year for the data collection (1-365).</span>
<span class="sd">        endJulian (int): The ending Julian day of year for the data collection (1-365).</span>
<span class="sd">        timebuffer (int, optional): Number of years to buffer around each year. Defaults to 0.</span>
<span class="sd">        weights (ee.List | list| None, optional): List of weights for weighted compositing (if applicable</span>
<span class="sd">            to the chosen collection). Defaults to None (equal weights).</span>
<span class="sd">        compositingReducer (ee.Reducer | None, optional): Earth Engine reducer used for compositing</span>
<span class="sd">            daily data into the desired temporal resolution. Defaults to None (may require a reducer</span>
<span class="sd">            depending on the collection).</span>
<span class="sd">        exportComposites (bool, optional): Flag indicating whether to export the resulting time series.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        exportPathRoot (str | None, optional): Root path for exporting the composites (if exportComposites</span>
<span class="sd">            is True). Defaults to None (no export).</span>
<span class="sd">        crs (str | None, optional): Earth Engine projection object for the exported composites</span>
<span class="sd">            (if exportComposites is True). Defaults to None (uses the source collection&#39;s projection).</span>
<span class="sd">        transform (list[int] | None, optional): Earth Engine transform object for the exported</span>
<span class="sd">            composites (if exportComposites is True). Defaults to None (uses the source collection&#39;s transform).</span>
<span class="sd">        scale (int | None, optional): Scale in meters for the exported composites (if exportComposites</span>
<span class="sd">            is True). Defaults to None (uses the source collection&#39;s scale).</span>
<span class="sd">        exportBands (ee.List | list | None, optional): List of band names to export from the composites (if</span>
<span class="sd">            exportComposites is True). Defaults to None (all bands from the first image in the collection).</span>
<span class="sd">        exportNamePrefix (str,optional): Name to place before default name of exported image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.ImageCollection: The time series collection of processed climate data.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CO&quot;]</span>
<span class="sd">    &gt;&gt;&gt; startJulian = 274</span>
<span class="sd">    &gt;&gt;&gt; endJulian = 273</span>
<span class="sd">    &gt;&gt;&gt; startYear = 2016</span>
<span class="sd">    &gt;&gt;&gt; endYear = 2023</span>
<span class="sd">    &gt;&gt;&gt; timebuffer = 0</span>
<span class="sd">    &gt;&gt;&gt; weights = [1]</span>
<span class="sd">    &gt;&gt;&gt; compositingReducer = ee.Reducer.mean()</span>
<span class="sd">    &gt;&gt;&gt; collectionName = &quot;NASA/ORNL/DAYMET_V4&quot;</span>
<span class="sd">    &gt;&gt;&gt; exportComposites = False</span>
<span class="sd">    &gt;&gt;&gt; exportPathRoot = &quot;users/username/someCollection&quot;</span>
<span class="sd">    &gt;&gt;&gt; exportBands = [&quot;prcp.*&quot;, &quot;tmax.*&quot;, &quot;tmin.*&quot;]</span>
<span class="sd">    &gt;&gt;&gt; exportNamePrefix = &#39;Colorado_Test_Area_&#39;</span>
<span class="sd">    &gt;&gt;&gt; crs = &quot;EPSG:5070&quot;</span>
<span class="sd">    &gt;&gt;&gt; transform = [1000, 0, -2361915.0, 0, -1000, 3177735.0]</span>
<span class="sd">    &gt;&gt;&gt; scale = None</span>
<span class="sd">    &gt;&gt;&gt; climateComposites = gil.getClimateWrapper(collectionName, studyArea, startYear, endYear, startJulian, endJulian, timebuffer, weights, compositingReducer, exportComposites, exportPathRoot, crs, transform, scale, exportBands, exportNamePrefix)</span>
<span class="sd">    &gt;&gt;&gt; Map.addTimeLapse(climateComposites.select(exportBands), {}, &quot;Climate Composite Time Lapse&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;strokeColor&quot;: &quot;0000FF&quot;, &quot;canQuery&quot;: False}, &quot;Study Area&quot;, True)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">formatArgs</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># Prepare dates</span>
    <span class="c1"># Wrap the dates if needed</span>
    <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">startJulian</span> <span class="o">&gt;</span> <span class="n">endJulian</span><span class="p">:</span>
        <span class="n">wrapOffset</span> <span class="o">=</span> <span class="mi">365</span>

    <span class="n">startDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">startJulian</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">fromYMD</span><span class="p">(</span><span class="n">endYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">endJulian</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wrapOffset</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Start and end dates:&quot;</span><span class="p">,</span>
        <span class="n">startDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYY-MM-dd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
        <span class="n">endDate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YYYY-MM-dd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Julian days are:&quot;</span><span class="p">,</span> <span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">)</span>

    <span class="c1"># Get climate data</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">collectionName</span><span class="p">)</span><span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">studyArea</span><span class="p">)</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">calendarRange</span><span class="p">(</span><span class="n">startJulian</span><span class="p">,</span> <span class="n">endJulian</span><span class="p">))</span>

    <span class="c1"># Set to appropriate resampling method</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;bicubic&quot;</span><span class="p">))</span>
    <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;Raw Climate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Create composite time series</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">compositeTimeSeries</span><span class="p">(</span>
        <span class="n">c</span><span class="p">,</span>
        <span class="n">startYear</span><span class="p">,</span>
        <span class="n">endYear</span><span class="p">,</span>
        <span class="n">startJulian</span><span class="p">,</span>
        <span class="n">endJulian</span><span class="p">,</span>
        <span class="n">timebuffer</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">compositingReducer</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">float</span><span class="p">()))</span>

    <span class="c1"># Export composite collection</span>
    <span class="k">if</span> <span class="n">exportComposites</span><span class="p">:</span>
        <span class="c1"># Set up export bands if not specified</span>
        <span class="k">if</span> <span class="n">exportBands</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exportBands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">bandNames</span><span class="p">())</span>

        <span class="n">exportCollection</span><span class="p">(</span>
            <span class="n">exportPathRoot</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exportNamePrefix</span><span class="si">}{</span><span class="n">collectionName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">studyArea</span><span class="p">,</span>
            <span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">ts</span><span class="p">,</span>
            <span class="n">startYear</span><span class="p">,</span>
            <span class="n">endYear</span><span class="p">,</span>
            <span class="n">startJulian</span><span class="p">,</span>
            <span class="n">endJulian</span><span class="p">,</span>
            <span class="n">compositingReducer</span><span class="p">,</span>
            <span class="n">timebuffer</span><span class="p">,</span>
            <span class="n">exportBands</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ts</span></div>



<span class="c1">#####################################################################</span>
<span class="c1"># Adds absolute difference from a specified band summarized by a provided percentile</span>
<span class="c1"># Intended for custom sorting across collections</span>
<span class="k">def</span> <span class="nf">addAbsDiff</span><span class="p">(</span><span class="n">inCollection</span><span class="p">,</span> <span class="n">qualityBand</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">sign</span><span class="p">):</span>
    <span class="n">bestQuality</span> <span class="o">=</span> <span class="n">inCollection</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">qualityBand</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span><span class="n">percentile</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">qualityBand</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">bestQuality</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">inCollection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1">#####################################################################</span>
<span class="c1"># Method for applying the qualityMosaic function using a specified percentile</span>
<span class="c1"># Useful when the max of the quality band is not what is wanted</span>
<span class="k">def</span> <span class="nf">customQualityMosaic</span><span class="p">(</span><span class="n">inCollection</span><span class="p">,</span> <span class="n">qualityBand</span><span class="p">,</span> <span class="n">percentile</span><span class="p">):</span>
    <span class="c1"># Add an absolute difference from the specified percentile</span>
    <span class="c1"># This is inverted for the qualityMosaic function to properly prioritize</span>
    <span class="n">inCollectionDelta</span> <span class="o">=</span> <span class="n">addAbsDiff</span><span class="p">(</span><span class="n">inCollection</span><span class="p">,</span> <span class="n">qualityBand</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Apply the qualityMosaic function</span>
    <span class="k">return</span> <span class="n">inCollectionDelta</span><span class="o">.</span><span class="n">qualityMosaic</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span>


<span class="c1">#####################################################################</span>
<div class="viewcode-block" id="simpleWaterMask">
<a class="viewcode-back" href="../../modules.html#geeViz.getImagesLib.simpleWaterMask">[docs]</a>
<span class="k">def</span> <span class="nf">simpleWaterMask</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
    <span class="n">contractPixels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">slope_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">elevationImagePath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;USGS/3DEP/10m&quot;</span><span class="p">,</span>
    <span class="n">elevationFocalMeanRadius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a basic on-the-fly water masking for TOA reflectance imagery.</span>

<span class="sd">    This function creates a water mask based on thresholds applied to Tasseled Cap angles, brightness, and slope.</span>
<span class="sd">    It&#39;s designed for time-sensitive analysis and works well when wet snow is absent. However, wet snow in flat areas</span>
<span class="sd">    can lead to false positives. SR data might cause false negatives (omissions).</span>

<span class="sd">    Args:</span>
<span class="sd">        img (ee.Image): The input Earth Engine image (TOA reflectance data recommended) with Tasseled Cap transformation bands added. You may need to run `getTasseledCap` to add these bands.</span>
<span class="sd">        contractPixels (int, optional): Number of pixels to contract the water mask by for morphological closing. Defaults to 0 (no contraction).</span>
<span class="sd">        slope_thresh (float, optional): Threshold for slope (degrees) to identify flat areas suitable for water masking. Defaults to 10.</span>
<span class="sd">        elevationImagePath (str, optional): Path to the Earth Engine image containing elevation data. Defaults to &quot;USGS/3DEP/10m&quot; (10m DEM from USGS 3D Elevation Program).</span>
<span class="sd">        elevationFocalMeanRadius (float, optional): Radius (in pixels) for the focal mean filter applied to the elevation data before calculating slope. Defaults to 5.5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ee.Image: The water mask image with a single band named &quot;waterMask&quot;.</span>

<span class="sd">    &gt;&gt;&gt; import geeViz.getImagesLib as gil</span>
<span class="sd">    &gt;&gt;&gt; Map = gil.Map</span>
<span class="sd">    &gt;&gt;&gt; ee = gil.ee</span>
<span class="sd">    &gt;&gt;&gt; studyArea = gil.testAreas[&quot;CO&quot;]</span>
<span class="sd">    &gt;&gt;&gt; s2s = gil.superSimpleGetS2(studyArea, &quot;2024-01-01&quot;, &quot;2024-12-31&quot;, 190, 250).map(lambda img: gil.getTasseledCap(img.resample(&quot;bicubic&quot;).divide(10000)))</span>
<span class="sd">    &gt;&gt;&gt; median_composite = s2s.median()</span>
<span class="sd">    &gt;&gt;&gt; water = gil.simpleWaterMask(median_composite).rename(&quot;Water&quot;)</span>
<span class="sd">    &gt;&gt;&gt; water = water.selfMask().set({&quot;Water_class_values&quot;: [1], &quot;Water_class_names&quot;: [&quot;Water&quot;], &quot;Water_class_palette&quot;: [&quot;0000DD&quot;]})</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(median_composite.reproject(&quot;EPSG:32613&quot;, None, 10), gil.vizParamsFalse, &quot;Sentinel-2 Median Composite&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(water.reproject(&quot;EPSG:32613&quot;, None, 10), {&quot;autoViz&quot;: True}, &quot;Water Mask&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.addLayer(studyArea, {&quot;canQuery&quot;: False}, &quot;Study Area&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Map.centerObject(studyArea, 12)</span>
<span class="sd">    &gt;&gt;&gt; Map.turnOnInspector()</span>
<span class="sd">    &gt;&gt;&gt; Map.view()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Add Tasseled Cap angles to the image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">addTCAngles</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="c1"># Load and resample elevation data</span>
    <span class="n">ned</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">elevationImagePath</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;bicubic&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate slope using focal mean filtered elevation</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Terrain</span><span class="o">.</span><span class="n">slope</span><span class="p">(</span><span class="n">ned</span><span class="o">.</span><span class="n">focal_mean</span><span class="p">(</span><span class="n">elevationFocalMeanRadius</span><span class="p">))</span>

    <span class="c1"># Identify flat areas based on slope threshold</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="n">slope</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">slope_thresh</span><span class="p">)</span>  <span class="c1"># Less than or equal to threshold</span>

    <span class="c1"># Define water mask conditions based on Tasseled Cap angles, brightness, and slope</span>
    <span class="n">waterMask</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;tcAngleBW&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;tcAngleBG&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="mf">0.05</span><span class="p">))</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;brightness&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>

    <span class="c1"># Apply morphological closing with focal minimum filter</span>
    <span class="n">waterMask</span> <span class="o">=</span> <span class="n">waterMask</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="n">contractPixels</span><span class="p">)</span>

    <span class="c1"># Rename the water mask band</span>
    <span class="k">return</span> <span class="n">waterMask</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;waterMask&quot;</span><span class="p">])</span>  <span class="c1">####################</span></div>



<span class="c1"># Jeff Ho Method for algal bloom detection</span>
<span class="c1"># https://www.nature.com/articles/s41586-019-1648-7</span>

<span class="c1"># Simplified Script for Landsat Water Quality</span>
<span class="c1"># Produces a map of an algal bloom in Lake Erie on 2011/9/3</span>
<span class="c1"># Created on 12/7/2015 by Jeff Ho</span>


<span class="c1"># Specifies a threshold for hue to estimate &quot;green&quot; pixels</span>
<span class="c1"># this is used as an additional filter to refine the algorithm above</span>
<span class="k">def</span> <span class="nf">HoCalcGreenness</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="c1"># map r, g, and b for more readable algebra below</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">])</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;blue&quot;</span><span class="p">])</span>

    <span class="c1"># calculate intensity, hue</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">])</span>
    <span class="n">mins</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;mins&quot;</span><span class="p">])</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">mins</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mins</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mins</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mins</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span>

    <span class="c1"># pixels with hue below 1.6 more likely to be bloom and not suspended sediment</span>
    <span class="n">Hthresh</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="mf">1.6</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">H</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span>


<span class="c1"># Apply bloom detection algorithm</span>
<span class="k">def</span> <span class="nf">HoCalcAlgorithm1</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="n">truecolor</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># show true color image as well</span>
    <span class="n">testThresh</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># add a binary image classifying into &quot;bloom&quot;and &quot;non-bloom</span>
    <span class="n">bloomThreshold</span> <span class="o">=</span> <span class="mf">0.02346</span>  <span class="c1"># threshold for classification fit based on other data</span>
    <span class="n">greenessThreshold</span> <span class="o">=</span> <span class="mf">1.6</span>

    <span class="c1"># Algorithm 1 based on:</span>
    <span class="c1"># Wang, M., &amp; Shi, W. (2007). The NIR-SWIR combined atmospheric</span>
    <span class="c1">#  correction approach for MODIS ocean color data processing.</span>
    <span class="c1">#  Optics Express, 15(24), 15722–15733.</span>

    <span class="c1"># Add secondary filter using greenness function below</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">HoCalcGreenness</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

    <span class="c1"># Apply algorithm 1: B4 - 1.03*B5</span>
    <span class="c1"># bloom1 = image.select(&#39;nir&#39;).subtract(image.select(&#39;swir1&#39;).multiply(1.03)).rename(&#39;bloom1&#39;)</span>

    <span class="c1"># Get binary image by applying the threshold</span>
    <span class="n">bloom1_mask</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">greenessThreshold</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">([</span><span class="s2">&quot;bloom1_mask&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">bloom1</span><span class="p">)</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">bloom1_mask</span><span class="p">)</span>


<span class="c1"># //////////////////////////////////////////////////////////////////////////</span>
<span class="c1"># // END FUNCTIONS</span>
<span class="c1"># ////////////////////////////////////////////////////////////////////////////////</span>


<span class="n">testAreas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">testAreas</span><span class="p">[</span><span class="s2">&quot;CO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">108.28630509064759</span><span class="p">,</span> <span class="mf">38.085343638120925</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">108.28630509064759</span><span class="p">,</span> <span class="mf">37.18051220092945</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">106.74821915314759</span><span class="p">,</span> <span class="mf">37.18051220092945</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">106.74821915314759</span><span class="p">,</span> <span class="mf">38.085343638120925</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">],</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">testAreas</span><span class="p">[</span><span class="s2">&quot;CO_North&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">106.41977869339524</span><span class="p">,</span> <span class="mf">40.97947702393234</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">106.41977869339524</span><span class="p">,</span> <span class="mf">39.96406321814001</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">105.20578943558274</span><span class="p">,</span> <span class="mf">39.96406321814001</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">105.20578943558274</span><span class="p">,</span> <span class="mf">40.97947702393234</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">],</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">testAreas</span><span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">119.96383760287506</span><span class="p">,</span> <span class="mf">37.138150574108714</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">119.96383760287506</span><span class="p">,</span> <span class="mf">36.40774412106424</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">117.95333955600006</span><span class="p">,</span> <span class="mf">36.40774412106424</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">117.95333955600006</span><span class="p">,</span> <span class="mf">37.138150574108714</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">],</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">testAreas</span><span class="p">[</span><span class="s2">&quot;CA_Small&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">123.22566968374625</span><span class="p">,</span> <span class="mf">39.677209599269155</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">123.22566968374625</span><span class="p">,</span> <span class="mf">38.993179504697586</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">122.60494214468375</span><span class="p">,</span> <span class="mf">38.993179504697586</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">122.60494214468375</span><span class="p">,</span> <span class="mf">39.677209599269155</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">],</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">testAreas</span><span class="p">[</span><span class="s2">&quot;HI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">160.50824874450544</span><span class="p">,</span> <span class="mf">22.659814513909474</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">160.50824874450544</span><span class="p">,</span> <span class="mf">18.54750309959827</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">154.35590499450544</span><span class="p">,</span> <span class="mf">18.54750309959827</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">154.35590499450544</span><span class="p">,</span> <span class="mf">22.659814513909474</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">],</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Ian Housman, Josh Heyer
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://www.redcastleresources.com/" aria-label="RedCastle Resources Inc"><img src='https://apps.fs.usda.gov/lcms-viewer/src/assets/images/RCR-logo.jpg'  alt='RedCastle Inc. Logo' href='#' title='Click to learn more about RedCastle Resources Inc.'></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=11dc0bc8"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>